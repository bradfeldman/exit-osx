generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Workspace {
  id                   String               @id @default(cuid())
  name                 String
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")
  billingCycle         BillingCycle?        @map("billing_cycle")
  planTier             PlanTier             @default(FOUNDATION) @map("plan_tier")
  stripeCustomerId     String?              @unique @map("stripe_customer_id")
  stripeSubscriptionId String?              @unique @map("stripe_subscription_id")
  subscriptionStatus   SubscriptionStatus   @default(ACTIVE) @map("subscription_status")
  trialEndsAt          DateTime?            @map("trial_ends_at")
  trialStartedAt       DateTime?            @map("trial_started_at")
  companies            Company[]
  invites              WorkspaceInvite[]
  members              WorkspaceMember[]

  @@map("workspaces")
}

model User {
  id                       String                    @id @default(cuid())
  authId                   String                    @unique @map("auth_id")
  email                    String                    @unique
  emailVerified            Boolean                   @default(false) @map("email_verified")
  name                     String?
  avatarUrl                String?                   @map("avatar_url")
  isSuperAdmin             Boolean                   @default(false) @map("is_super_admin")
  userType                 UserType                  @default(SUBSCRIBER) @map("user_type")
  exposureState            ExposureState             @default(LEARNING) @map("exposure_state")
  createdAt                DateTime                  @default(now()) @map("created_at")
  updatedAt                DateTime                  @updatedAt @map("updated_at")
  advisorProfile           AdvisorProfile?
  auditLogs                AuditLog[]                @relation("AuditActor")
  deletionRequests         DataDeletionRequest[]
  dataExports              DataExportRequest[]
  documentVersionsUploaded DataRoomDocumentVersion[]
  documentsUploaded        DataRoomDocument[]        @relation("DocumentUploader")
  dataRoomNotifications    DataRoomNotification[]    @relation("NotificationRecipient")
  impersonationsAsAdmin    ImpersonationSession[]    @relation("ImpersonationAdmin")
  impersonationsAsTarget   ImpersonationSession[]    @relation("ImpersonationTarget")
  sentInvites              WorkspaceInvite[]
  workspaces               WorkspaceMember[]
  ticketsAssigned          SupportTicket[]           @relation("TicketAssignee")
  ticketsCreated           SupportTicket[]           @relation("TicketUser")
  taskAssignments          TaskAssignment[]
  taskInvitesSent          TaskInvite[]              @relation("TaskInvitesSent")
  primaryTasks             Task[]                    @relation("TaskPrimaryAssignee")
  taskNotes                TaskNote[]
  ticketMessages           TicketMessage[]
  twoFactorAuth            TwoFactorAuth?
  consents                 UserConsent[]
  sessions                 UserSession[]
  createdSnapshots         ValuationSnapshot[]
  // Company ownership & access relations
  companyOwnerships        CompanyOwnership[]
  companyStaffAccess       CompanyStaffAccess[]
  accessRequestsSubmitted  AccessRequest[]           @relation("AccessRequester")
  accessRequestsReceived   AccessRequest[]           @relation("AccessOwner")
  alerts                   Alert[]
  companyInvitesSent       CompanyInvite[]           @relation("CompanyInviter")
  confirmedSignals         Signal[]                  @relation("SignalConfirmer")
  accountabilityPartners   AccountabilityPartner[]
  emailPreference          EmailPreference?
  emailLogs                EmailLog[]
  companyMembers           CompanyMember[]
  companyMemberAssignments CompanyMember[]            @relation("CompanyMemberAssigner")
  personalFinancials       PersonalFinancials?

  @@map("users")
}

model TwoFactorAuth {
  id              String    @id @default(cuid())
  userId          String    @unique @map("user_id")
  encryptedSecret String    @map("encrypted_secret")
  backupCodes     String[]  @map("backup_codes")
  usedBackupCodes Int[]     @default([]) @map("used_backup_codes")
  enabled         Boolean   @default(false)
  verifiedAt      DateTime? @map("verified_at")
  lastUsedAt      DateTime? @map("last_used_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_auth")
}

model UserSession {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  sessionToken String    @unique @map("session_token")
  userAgent    String?   @map("user_agent")
  ipAddress    String?   @map("ip_address")
  location     String?
  deviceType   String?   @map("device_type")
  browser      String?
  os           String?
  lastActiveAt DateTime  @default(now()) @map("last_active_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  expiresAt    DateTime  @map("expires_at")
  revokedAt    DateTime? @map("revoked_at")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
  @@index([sessionToken])
  @@map("user_sessions")
}

model WorkspaceMember {
  id                   String               @id @default(cuid())
  workspaceId          String               @map("workspace_id")
  userId               String               @map("user_id")
  workspaceRole        WorkspaceRole        @default(MEMBER) @map("workspace_role")
  functionalCategories FunctionalCategory[] @map("functional_categories")
  joinedAt             DateTime             @default(now()) @map("joined_at")
  isExternalAdvisor    Boolean              @default(false) @map("is_external_advisor")
  roleTemplateId       String?              @map("role_template_id")
  customPermissions    MemberPermission[]
  workspace            Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  roleTemplate         RoleTemplate?        @relation(fields: [roleTemplateId], references: [id])
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@map("workspace_members")
}

model WorkspaceInvite {
  id                   String               @id @default(cuid())
  workspaceId          String               @map("workspace_id")
  email                String
  role                 WorkspaceRole        @default(MEMBER)
  functionalCategories FunctionalCategory[] @map("functional_categories")
  invitedBy            String               @map("invited_by")
  token                String               @unique @default(cuid())
  expiresAt            DateTime             @map("expires_at")
  acceptedAt           DateTime?            @map("accepted_at")
  createdAt            DateTime             @default(now()) @map("created_at")
  customPermissions    Json?                @map("custom_permissions")
  isExternalAdvisor    Boolean              @default(false) @map("is_external_advisor")
  roleTemplateId       String?              @map("role_template_id")
  inviter              User                 @relation(fields: [invitedBy], references: [id])
  workspace            Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  roleTemplate         RoleTemplate?        @relation(fields: [roleTemplateId], references: [id])

  @@unique([workspaceId, email])
  @@map("workspace_invites")
}

model Company {
  id                       String                       @id @default(cuid())
  workspaceId              String                       @map("workspace_id")
  name                     String
  icbIndustry              String                       @map("icb_industry")
  icbSuperSector           String                       @map("icb_super_sector")
  icbSector                String                       @map("icb_sector")
  icbSubSector             String                       @map("icb_sub_sector")
  gicsIndustryGroup        String?                      @map("gics_industry_group")
  gicsSector               String?                      @map("gics_sector")
  gicsSubIndustry          String?                      @map("gics_sub_industry")
  classificationMethod     String?                      @map("classification_method")
  classificationConfidence Decimal?                     @map("classification_confidence") @db.Decimal(3, 2)
  annualRevenue            Decimal                      @map("annual_revenue") @db.Decimal(15, 2)
  annualEbitda             Decimal                      @map("annual_ebitda") @db.Decimal(15, 2)
  ownerCompensation        Decimal                      @default(0) @map("owner_compensation") @db.Decimal(15, 2)
  briWeights               Json?                        @map("bri_weights")
  createdAt                DateTime                     @default(now()) @map("created_at")
  updatedAt                DateTime                     @updatedAt @map("updated_at")
  deletedAt                DateTime?                    @map("deleted_at")
  deleteReason             String?                      @map("delete_reason")
  fiscalYearEndDay         Int                          @default(31) @map("fiscal_year_end_day")
  fiscalYearEndMonth       Int                          @default(12) @map("fiscal_year_end_month")
  businessDescription      String?                      @map("business_description")
  businessProfile          Json?                        @map("business_profile")
  profileQuestionsAnswered Json?                        @map("profile_questions_answered")
  assessments              Assessment[]
  buyerProspects           BuyerProspect[]
  workspace                Workspace                    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  questionPriorities       CompanyQuestionPriority[]
  coreFactors              CoreFactors?
  dataRoomDocuments        DataRoomDocument[]
  dataRoomTags             DataRoomTag[]
  dataRoom                 DataRoom?
  dcfAssumptions           DCFAssumptions?
  ebitdaAdjustments        EbitdaAdjustment[]
  financialPeriods         FinancialPeriod[]
  integrations             Integration[]
  projectAssessments       ProjectAssessment[]
  prospectImports          ProspectImportBatch[]
  prospectiveBuyers        ProspectiveBuyer[]
  tasks                    Task[]
  valuationSnapshots       ValuationSnapshot[]
  // Company ownership & access relations
  ownerships               CompanyOwnership[]
  staffAccess              CompanyStaffAccess[]
  accessRequests           AccessRequest[]
  companyInvites           CompanyInvite[]
  members                  CompanyMember[]
  // Contact System - deals where this company is the seller
  deals                    Deal[]
  // Deal Room
  dealRoomActivatedAt      DateTime?                    @map("deal_room_activated_at")
  // Operations Diagnosis - AI-generated diagnostics and tasks
  diagnosticQuestions      CompanyDiagnosticQuestions[]
  diagnosticResponses      CompanyDiagnosticResponses[]
  operationsTasks          CompanyOperationsTask[]
  weeklyProgress           CompanyWeeklyProgress[]
  // Signal Architecture & Value Ledger
  signals                  Signal[]
  valueLedgerEntries       ValueLedgerEntry[]
  disclosurePromptSets     DisclosurePromptSet[]
  driftReports             DriftReport[]
  weeklyCheckIns           WeeklyCheckIn[]
  accountabilityPartner    AccountabilityPartner?
  // Company Dossier - adaptive intelligence engine
  dossiers                 CompanyDossier[]
  aiGeneratedQuestions     Question[]
  emailLogs                EmailLog[]
  // Assessment Cadence Control (PROD-017)
  assessmentCadence        String                       @default("monthly") @map("assessment_cadence") // 'weekly' | 'monthly' | 'manual'
  cadencePromptsShownAt    DateTime[]                   @default([]) @map("cadence_prompts_shown_at") // Timestamps of prompts shown (for weekly limit)
  taskRefinementEvents     TaskRefinementEvent[]

  @@map("companies")
}

model RoleTemplate {
  id                 String               @id @default(cuid())
  slug               String               @unique
  name               String
  description        String?
  icon               String?
  defaultPermissions Json
  isBuiltIn          Boolean              @default(true) @map("is_built_in")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  invites            WorkspaceInvite[]
  members            WorkspaceMember[]

  @@map("role_templates")
}

model MemberPermission {
  id                 String          @id @default(cuid())
  workspaceMemberId  String          @map("organization_user_id")
  permission         String
  granted            Boolean
  workspaceMember    WorkspaceMember @relation(fields: [workspaceMemberId], references: [id], onDelete: Cascade)

  @@unique([workspaceMemberId, permission])
  @@map("member_permissions")
}

model AdvisorProfile {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  firmName  String?  @map("firm_name")
  specialty String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("advisor_profiles")
}

model PersonalFinancials {
  id                  String   @id @default(cuid())
  retirementAccounts  Json?    @map("retirement_accounts")
  totalRetirement     Decimal? @map("total_retirement") @db.Decimal(15, 2)
  personalAssets      Json?    @map("personal_assets")
  personalLiabilities Json?    @map("personal_liabilities")
  netWorth            Decimal? @map("net_worth") @db.Decimal(15, 2)
  exitGoalAmount      Decimal? @map("exit_goal_amount") @db.Decimal(15, 2)
  retirementAge       Int?     @map("retirement_age")
  currentAge          Int?     @map("current_age")
  businessOwnership   Json?    @map("business_ownership")
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  userId              String   @unique @map("user_id")
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("personal_financials")
}

model EbitdaAdjustment {
  id          String           @id @default(cuid())
  companyId   String           @map("company_id")
  periodId    String?          @map("period_id")
  description String
  amount      Decimal          @db.Decimal(15, 2)
  type        String
  frequency   String           @default("ANNUAL")
  category    String?          @map("category")
  aiSuggested Boolean          @default(false) @map("ai_suggested")
  createdAt   DateTime         @default(now()) @map("created_at")
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  period      FinancialPeriod? @relation(fields: [periodId], references: [id])

  @@index([companyId, periodId])
  @@map("ebitda_adjustments")
}

model CoreFactors {
  id                  String                @id @default(cuid())
  companyId           String                @unique @map("company_id")
  revenueSizeCategory RevenueSizeCategory   @map("revenue_size_category")
  revenueModel        RevenueModelType      @map("revenue_model")
  grossMarginProxy    GrossMarginCategory   @map("gross_margin_proxy")
  laborIntensity      LaborIntensityLevel   @map("labor_intensity")
  assetIntensity      AssetIntensityLevel   @map("asset_intensity")
  ownerInvolvement    OwnerInvolvementLevel @map("owner_involvement")
  updatedAt           DateTime              @updatedAt @map("updated_at")
  company             Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("core_factors")
}

model Question {
  id              String               @id @default(cuid())
  companyId       String?              @map("company_id")
  briCategory     BriCategory          @map("bri_category")
  issueTier       IssueTier            @default(OPTIMIZATION) @map("issue_tier")
  questionText    String               @map("question_text")
  helpText        String?              @map("help_text")
  buyerLogic      String?              @map("buyer_logic") @db.VarChar(200)
  displayOrder    Int                  @map("display_order")
  maxImpactPoints Decimal              @map("max_impact_points") @db.Decimal(5, 2)
  isActive        Boolean              @default(true) @map("is_active")
  riskDriverName  String?              @map("risk_driver_name")
  responses       AssessmentResponse[]
  options         QuestionOption[]
  company         Company?             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([issueTier])
  @@index([companyId, isActive])
  @@map("questions")
}

model QuestionOption {
  id                 String               @id @default(cuid())
  questionId         String               @map("question_id")
  optionText         String               @map("option_text")
  scoreValue         Decimal              @map("score_value") @db.Decimal(3, 2)
  displayOrder       Int                  @map("display_order")
  effectiveResponses AssessmentResponse[] @relation("EffectiveOption")
  responses          AssessmentResponse[] @relation("SelectedOption")
  question           Question             @relation(fields: [questionId], references: [id], onDelete: Cascade)
  tasksUpgradingFrom Task[]               @relation("TaskUpgradeFrom")
  tasksUpgradingTo   Task[]               @relation("TaskUpgradeTo")

  @@map("question_options")
}

model Assessment {
  id             String               @id @default(cuid())
  companyId      String               @map("company_id")
  assessmentType AssessmentType       @map("assessment_type")
  completedAt    DateTime?            @map("completed_at")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  responses      AssessmentResponse[]
  company        Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("assessments")
}

model AssessmentResponse {
  id                String          @id @default(cuid())
  assessmentId      String          @map("assessment_id")
  questionId        String          @map("question_id")
  selectedOptionId  String?         @map("selected_option_id")
  effectiveOptionId String?         @map("effective_option_id")
  confidenceLevel   ConfidenceLevel @map("confidence_level")
  notes             String?
  evidenceUploaded  Boolean         @default(false) @map("evidence_uploaded")
  evidenceUrls      String[]        @map("evidence_urls")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  assessment        Assessment      @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  effectiveOption   QuestionOption? @relation("EffectiveOption", fields: [effectiveOptionId], references: [id])
  question          Question        @relation(fields: [questionId], references: [id])
  selectedOption    QuestionOption? @relation("SelectedOption", fields: [selectedOptionId], references: [id])

  @@unique([assessmentId, questionId])
  @@map("assessment_responses")
}

model ValuationSnapshot {
  id                   String   @id @default(cuid())
  companyId            String   @map("company_id")
  createdByUserId      String?  @map("created_by_user_id")
  adjustedEbitda       Decimal  @map("adjusted_ebitda") @db.Decimal(15, 2)
  industryMultipleLow  Decimal  @map("industry_multiple_low") @db.Decimal(6, 2)
  industryMultipleHigh Decimal  @map("industry_multiple_high") @db.Decimal(6, 2)
  coreScore            Decimal  @map("core_score") @db.Decimal(5, 4)
  briScore             Decimal  @map("bri_score") @db.Decimal(5, 4)
  briFinancial         Decimal  @map("bri_financial") @db.Decimal(5, 4)
  briTransferability   Decimal  @map("bri_transferability") @db.Decimal(5, 4)
  briOperational       Decimal  @map("bri_operational") @db.Decimal(5, 4)
  briMarket            Decimal  @map("bri_market") @db.Decimal(5, 4)
  briLegalTax          Decimal  @map("bri_legal_tax") @db.Decimal(5, 4)
  briPersonal          Decimal  @map("bri_personal") @db.Decimal(5, 4)
  baseMultiple         Decimal  @map("base_multiple") @db.Decimal(6, 2)
  discountFraction     Decimal  @map("discount_fraction") @db.Decimal(5, 4)
  finalMultiple        Decimal  @map("final_multiple") @db.Decimal(6, 2)
  currentValue         Decimal  @map("current_value") @db.Decimal(15, 2)
  potentialValue       Decimal  @map("potential_value") @db.Decimal(15, 2)
  valueGap             Decimal  @map("value_gap") @db.Decimal(15, 2)
  alphaConstant        Decimal  @default(1.40) @map("alpha_constant") @db.Decimal(6, 2)
  snapshotReason       String?  @map("snapshot_reason")
  // Auto-DCF fields (nullable â€” only populated when cash flow data is available)
  dcfEnterpriseValue     Decimal?  @map("dcf_enterprise_value") @db.Decimal(15, 2)
  dcfEquityValue         Decimal?  @map("dcf_equity_value") @db.Decimal(15, 2)
  dcfWacc                Decimal?  @map("dcf_wacc") @db.Decimal(5, 4)
  dcfBaseFcf             Decimal?  @map("dcf_base_fcf") @db.Decimal(15, 2)
  dcfGrowthRates         Json?     @map("dcf_growth_rates")
  dcfTerminalMethod      String?   @map("dcf_terminal_method")
  dcfPerpetualGrowthRate Decimal?  @map("dcf_perpetual_growth_rate") @db.Decimal(5, 4)
  dcfNetDebt             Decimal?  @map("dcf_net_debt") @db.Decimal(15, 2)
  dcfImpliedMultiple     Decimal?  @map("dcf_implied_multiple") @db.Decimal(6, 2)
  dcfCompanySpecificRisk Decimal?  @map("dcf_company_specific_risk") @db.Decimal(5, 4)
  dcfEbitdaTier          String?   @map("dcf_ebitda_tier")
  dcfSource              String?   @map("dcf_source") // 'auto' | 'manual'
  createdAt            DateTime @default(now()) @map("created_at")
  company              Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy            User?    @relation(fields: [createdByUserId], references: [id])

  @@index([companyId, createdAt])
  @@map("valuation_snapshots")
}

model DriftReport {
  id                  String    @id @default(cuid())
  companyId           String    @map("company_id")
  periodStart         DateTime  @map("period_start")
  periodEnd           DateTime  @map("period_end")
  briScoreStart       Decimal   @map("bri_score_start") @db.Decimal(5, 4)
  briScoreEnd         Decimal   @map("bri_score_end") @db.Decimal(5, 4)
  valuationStart      Decimal   @map("valuation_start") @db.Decimal(15, 2)
  valuationEnd        Decimal   @map("valuation_end") @db.Decimal(15, 2)
  signalsCount        Int       @map("signals_count")
  tasksCompletedCount Int       @map("tasks_completed_count")
  tasksAddedCount     Int       @map("tasks_added_count")
  driftCategories     Json      @map("drift_categories")
  topSignals          Json      @map("top_signals")
  summary             String
  emailSentAt         DateTime? @map("email_sent_at")
  viewedAt            DateTime? @map("viewed_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, periodEnd])
  @@map("drift_reports")
}

model Task {
  id                   String             @id @default(cuid())
  companyId            String             @map("company_id")
  title                String
  description          String
  richDescription      Json?              @map("rich_description")
  actionType           ActionItemType     @map("action_type")
  briCategory          BriCategory        @map("bri_category")
  linkedQuestionId     String?            @map("linked_question_id")
  rawImpact            Decimal            @map("raw_impact") @db.Decimal(15, 2)
  normalizedValue      Decimal            @map("normalized_value") @db.Decimal(15, 2)
  effortLevel          EffortLevel        @map("effort_level")
  complexity           ComplexityLevel
  estimatedHours       Int?               @map("estimated_hours")
  issueTier            IssueTier?         @map("issue_tier")
  status               TaskStatus         @default(PENDING)
  deferredUntil        DateTime?          @map("deferred_until")
  deferralReason       String?            @map("deferral_reason")
  blockedAt            DateTime?          @map("blocked_at")
  blockedReason        String?            @map("blocked_reason")
  completedAt          DateTime?          @map("completed_at")
  completionNotes      String?            @map("completion_notes")
  dueDate              DateTime?          @map("due_date")
  primaryAssigneeId    String?            @map("primary_assignee_id")
  upgradesFromOptionId String?            @map("upgrades_from_option_id")
  upgradesToOptionId   String?            @map("upgrades_to_option_id")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")
  difficultyLevel      DifficultyLevel    @default(MEDIUM) @map("difficulty_level")
  impactLevel          ImpactLevel        @default(MEDIUM) @map("impact_level")
  inActionPlan         Boolean            @default(false) @map("in_action_plan")
  priorityRank         Int                @default(10) @map("priority_rank")
  buyerConsequence     String?            @map("buyer_consequence")
  taskProgress         Json?              @map("task_progress")
  completedValue       Decimal?           @map("completed_value") @db.Decimal(15, 2)
  startedAt            DateTime?          @map("started_at")
  assigneeRole         String?            @map("assignee_role")
  sourceType           TaskSourceType     @default(ASSESSMENT) @map("source_type")
  supersededById       String?            @map("superseded_by_id")
  proofDocuments       DataRoomDocument[] @relation("TaskProofDocuments")
  assignments          TaskAssignment[]
  invites              TaskInvite[]
  subSteps             TaskSubStep[]
  notes                TaskNote[]
  company              Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  primaryAssignee      User?              @relation("TaskPrimaryAssignee", fields: [primaryAssigneeId], references: [id])
  upgradesFromOption   QuestionOption?    @relation("TaskUpgradeFrom", fields: [upgradesFromOptionId], references: [id])
  upgradesToOption     QuestionOption?    @relation("TaskUpgradeTo", fields: [upgradesToOptionId], references: [id])
  supersededBy         Task?              @relation("TaskSupersedes", fields: [supersededById], references: [id])
  supersedes           Task[]             @relation("TaskSupersedes")
  valueLedgerEntries   ValueLedgerEntry[]

  @@index([companyId, status])
  @@index([primaryAssigneeId])
  @@index([primaryAssigneeId, status])
  @@map("tasks")
}

model TaskAssignment {
  id         String   @id @default(cuid())
  taskId     String   @map("task_id")
  userId     String   @map("user_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@map("task_assignments")
}

model TaskInvite {
  id          String    @id @default(cuid())
  taskId      String    @map("task_id")
  email       String
  invitedById String    @map("invited_by_id")
  token       String    @unique @default(cuid())
  isPrimary   Boolean   @default(true) @map("is_primary")
  expiresAt   DateTime  @map("expires_at")
  acceptedAt  DateTime? @map("accepted_at")
  declinedAt  DateTime? @map("declined_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  invitedBy   User      @relation("TaskInvitesSent", fields: [invitedById], references: [id])
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, email])
  @@index([token])
  @@index([email])
  @@map("task_invites")
}

model TaskSubStep {
  id              String      @id @default(cuid())
  taskId          String      @map("task_id")
  title           String
  order           Int         @default(0)
  completed       Boolean     @default(false)
  completedAt     DateTime?   @map("completed_at")
  subTaskType     SubTaskType @default(CHECKBOX) @map("sub_task_type")
  responseText    String?     @map("response_text") @db.Text
  responseJson    Json?       @map("response_json")
  linkedDocId     String?     @map("linked_doc_id")
  integrationKey  String?     @map("integration_key")
  placeholder     String?
  acceptedTypes   String?     @map("accepted_types")
  questionOptions Json?       @map("question_options")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  task            Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, order])
  @@map("task_sub_steps")
}

model TaskNote {
  id        String   @id @default(cuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  content   String   @db.Text
  noteType  String   @default("GENERAL") @map("note_type") // GENERAL, COMPLETION, BLOCKER, PROGRESS
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([taskId, createdAt])
  @@index([userId])
  @@map("task_notes")
}

model TaskRefinementEvent {
  id            String      @id @default(cuid())
  companyId     String      @map("company_id")
  briCategory   BriCategory @map("bri_category")
  tasksAdded    Int         @default(0) @map("tasks_added")
  tasksUpdated  Int         @default(0) @map("tasks_updated")
  tasksRemoved  Int         @default(0) @map("tasks_removed")
  details       Json?
  dismissedAt   DateTime?   @map("dismissed_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, dismissedAt])
  @@map("task_refinement_events")
}

model IndustryMultiple {
  id                  String   @id @default(cuid())
  icbIndustry         String   @map("icb_industry")
  icbSuperSector      String   @map("icb_super_sector")
  icbSector           String   @map("icb_sector")
  icbSubSector        String   @map("icb_sub_sector")
  revenueMultipleLow  Decimal  @map("revenue_multiple_low") @db.Decimal(6, 2)
  revenueMultipleHigh Decimal  @map("revenue_multiple_high") @db.Decimal(6, 2)
  ebitdaMultipleLow   Decimal  @map("ebitda_multiple_low") @db.Decimal(6, 2)
  ebitdaMultipleHigh  Decimal  @map("ebitda_multiple_high") @db.Decimal(6, 2)
  ebitdaMarginLow     Decimal? @map("ebitda_margin_low") @db.Decimal(5, 2)
  ebitdaMarginHigh    Decimal? @map("ebitda_margin_high") @db.Decimal(5, 2)
  effectiveDate       DateTime @map("effective_date")
  source              String?
  gicsSubIndustry     String?  @map("gics_sub_industry")
  lastResearchedAt    DateTime? @map("last_researched_at")
  researchSources     Json?    @map("research_sources")

  @@unique([icbSubSector, effectiveDate])
  @@map("industry_multiples")
}

model DataRoom {
  id            String                 @id @default(cuid())
  companyId     String                 @unique @map("company_id")
  name          String                 @default("Data Room")
  stage         DataRoomStage          @default(PREPARATION)
  createdAt     DateTime               @default(now()) @map("created_at")
  updatedAt     DateTime               @updatedAt @map("updated_at")
  accessGrants  DataRoomAccess[]
  activities    DataRoomActivity[]
  folders       DataRoomFolder[]
  notifications DataRoomNotification[]
  questions     DataRoomQuestion[]
  company       Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("data_rooms")
}

model DataRoomFolder {
  id          String             @id @default(cuid())
  dataRoomId  String             @map("data_room_id")
  parentId    String?            @map("parent_id")
  name        String
  description String?
  category    DataRoomCategory
  sortOrder   Int                @default(0) @map("sort_order")
  minStage    DataRoomStage      @default(PREPARATION) @map("min_stage")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  documents   DataRoomDocument[]
  dataRoom    DataRoom           @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  parent      DataRoomFolder?    @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    DataRoomFolder[]   @relation("FolderHierarchy")

  @@index([dataRoomId, parentId])
  @@index([dataRoomId, category])
  @@map("data_room_folders")
}

model DataRoomDocument {
  id                String                    @id @default(cuid())
  companyId         String                    @map("company_id")
  category          DataRoomCategory
  documentName      String                    @map("document_name")
  description       String?
  linkedTaskId      String?                   @map("linked_task_id")
  fileUrl           String?                   @map("file_url")
  filePath          String?                   @map("file_path")
  fileName          String?                   @map("file_name")
  fileSize          Int?                      @map("file_size")
  mimeType          String?                   @map("mime_type")
  updateFrequency   UpdateFrequency           @default(AS_NEEDED) @map("update_frequency")
  lastUpdatedAt     DateTime?                 @map("last_updated_at")
  nextUpdateDue     DateTime?                 @map("next_update_due")
  status            DocumentStatus            @default(CURRENT)
  isRequired        Boolean                   @default(false) @map("is_required")
  isCustom          Boolean                   @default(false) @map("is_custom")
  displayOrder      Int                       @default(0) @map("display_order")
  uploadedByUserId  String?                   @map("uploaded_by_user_id")
  notes             String?
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")
  allowDownload     Boolean                   @default(true) @map("allow_download")
  folderId          String?                   @map("folder_id")
  isConfidential    Boolean                   @default(false) @map("is_confidential")
  previousVersionId String?                   @map("previous_version_id")
  version           Int                       @default(1)
  evidenceCategory  String?                   @map("evidence_category")
  expectedDocumentId String?                  @map("expected_document_id")
  evidenceSource    String?                   @map("evidence_source")
  tags              DataRoomDocumentTag[]
  versions          DataRoomDocumentVersion[]
  views             DataRoomDocumentView[]
  company           Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  folder            DataRoomFolder?           @relation(fields: [folderId], references: [id])
  linkedTask        Task?                     @relation("TaskProofDocuments", fields: [linkedTaskId], references: [id])
  previousVersion   DataRoomDocument?         @relation("DocumentVersions", fields: [previousVersionId], references: [id])
  newerVersions     DataRoomDocument[]        @relation("DocumentVersions")
  uploadedBy        User?                     @relation("DocumentUploader", fields: [uploadedByUserId], references: [id])

  @@index([companyId, category])
  @@index([companyId, status])
  @@index([folderId])
  @@index([linkedTaskId])
  @@map("data_room_documents")
}

model DataRoomDocumentVersion {
  id               String           @id @default(cuid())
  documentId       String           @map("document_id")
  version          Int
  filePath         String           @map("file_path")
  fileName         String           @map("file_name")
  fileSize         Int              @map("file_size")
  mimeType         String?          @map("mime_type")
  uploadedByUserId String?          @map("uploaded_by_user_id")
  uploadedAt       DateTime         @map("uploaded_at")
  archivedAt       DateTime         @default(now()) @map("archived_at")
  document         DataRoomDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  uploadedBy       User?            @relation(fields: [uploadedByUserId], references: [id])

  @@index([documentId])
  @@map("data_room_document_versions")
}

model DataRoomTag {
  id        String                @id @default(cuid())
  companyId String                @map("company_id")
  name      String
  color     String                @default("#6B7280")
  createdAt DateTime              @default(now()) @map("created_at")
  documents DataRoomDocumentTag[]
  company   Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@map("data_room_tags")
}

model DataRoomDocumentTag {
  id         String           @id @default(cuid())
  documentId String           @map("document_id")
  tagId      String           @map("tag_id")
  createdAt  DateTime         @default(now()) @map("created_at")
  document   DataRoomDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tag        DataRoomTag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([documentId, tagId])
  @@map("data_room_document_tags")
}

model DataRoomAccess {
  id           String              @id @default(cuid())
  dataRoomId   String              @map("data_room_id")
  userId       String?             @map("user_id")
  email        String
  accessLevel  DataRoomAccessLevel @default(VIEWER) @map("access_level")
  maxStage     DataRoomStage       @default(POST_NDA) @map("max_stage")
  folderIds    String[]            @map("folder_ids")
  expiresAt    DateTime?           @map("expires_at")
  ndaSignedAt  DateTime?           @map("nda_signed_at")
  invitedById  String              @map("invited_by_id")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")
  buyerContact    BuyerContact?
  dataRoom        DataRoom            @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  // Contact System - link to deal contact
  dealContact     DealContact?
  dealParticipant DealParticipant?

  @@unique([dataRoomId, email])
  @@index([dataRoomId, userId])
  @@map("data_room_access")
}

model DataRoomActivity {
  id         String         @id @default(cuid())
  dataRoomId String         @map("data_room_id")
  userId     String         @map("user_id")
  userEmail  String         @map("user_email")
  action     DataRoomAction
  documentId String?        @map("document_id")
  folderId   String?        @map("folder_id")
  metadata   Json?
  ipAddress  String?        @map("ip_address")
  userAgent  String?        @map("user_agent")
  createdAt  DateTime       @default(now()) @map("created_at")
  dataRoom   DataRoom       @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)

  @@index([dataRoomId, createdAt])
  @@index([dataRoomId, userId])
  @@index([documentId])
  @@index([documentId, userId])
  @@map("data_room_activities")
}

model DataRoomDocumentView {
  id            String           @id @default(cuid())
  documentId    String           @map("document_id")
  userId        String           @map("user_id")
  userEmail     String           @map("user_email")
  viewCount     Int              @default(1) @map("view_count")
  totalDuration Int              @default(0) @map("total_duration")
  lastViewedAt  DateTime         @default(now()) @map("last_viewed_at")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  document      DataRoomDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
  @@index([documentId])
  @@map("data_room_document_views")
}

model DataRoomQuestion {
  id            String           @id @default(cuid())
  dataRoomId    String           @map("data_room_id")
  documentId    String?          @map("document_id")
  folderId      String?          @map("folder_id")
  question      String
  askedByEmail  String           @map("asked_by_email")
  askedByUserId String?          @map("asked_by_user_id")
  status        String           @default("open")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  answers       DataRoomAnswer[]
  dataRoom      DataRoom         @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)

  @@index([dataRoomId, status])
  @@map("data_room_questions")
}

model DataRoomAnswer {
  id               String           @id @default(cuid())
  questionId       String           @map("question_id")
  answer           String
  answeredByEmail  String           @map("answered_by_email")
  answeredByUserId String?          @map("answered_by_user_id")
  isInternal       Boolean          @default(false) @map("is_internal")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  question         DataRoomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("data_room_answers")
}

model DataRoomNotification {
  id              String    @id @default(cuid())
  dataRoomId      String    @map("data_room_id")
  recipientUserId String    @map("recipient_user_id")
  type            String
  documentId      String?   @map("document_id")
  questionId      String?   @map("question_id")
  folderId        String?   @map("folder_id")
  title           String
  message         String
  actorEmail      String    @map("actor_email")
  actorUserId     String?   @map("actor_user_id")
  isRead          Boolean   @default(false) @map("is_read")
  readAt          DateTime? @map("read_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  dataRoom        DataRoom  @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  recipient       User      @relation("NotificationRecipient", fields: [recipientUserId], references: [id], onDelete: Cascade)

  @@index([recipientUserId, isRead])
  @@index([dataRoomId])
  @@map("data_room_notifications")
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model Integration {
  id                  String               @id @default(cuid())
  companyId           String               @map("company_id")
  provider            IntegrationProvider
  accessToken         String               @map("access_token")
  refreshToken        String               @map("refresh_token")
  tokenExpiresAt      DateTime             @map("token_expires_at")
  realmId             String?              @map("realm_id")
  providerCompanyName String?              @map("provider_company_name")
  autoSyncEnabled     Boolean              @default(true) @map("auto_sync_enabled")
  lastSyncAt          DateTime?            @map("last_sync_at")
  lastSyncStatus      SyncStatus           @default(IDLE) @map("last_sync_status")
  lastSyncError       String?              @map("last_sync_error")
  connectedAt         DateTime             @default(now()) @map("connected_at")
  disconnectedAt      DateTime?            @map("disconnected_at")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  syncLogs            IntegrationSyncLog[]
  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, provider])
  @@index([companyId])
  @@map("integrations")
}

model IntegrationSyncLog {
  id             String      @id @default(cuid())
  integrationId  String      @map("integration_id")
  syncType       String      @map("sync_type")
  status         SyncStatus
  startedAt      DateTime    @default(now()) @map("started_at")
  completedAt    DateTime?   @map("completed_at")
  periodsCreated Int         @default(0) @map("periods_created")
  periodsUpdated Int         @default(0) @map("periods_updated")
  errorMessage   String?     @map("error_message")
  errorDetails   Json?       @map("error_details")
  integration    Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId, startedAt])
  @@map("integration_sync_logs")
}

model FinancialPeriod {
  id                String             @id @default(cuid())
  companyId         String             @map("company_id")
  periodType        PeriodType         @map("period_type")
  fiscalYear        Int                @map("fiscal_year")
  quarter           Quarter?
  month             Int?
  startDate         DateTime           @map("start_date")
  endDate           DateTime           @map("end_date")
  label             String?
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  balanceSheet      BalanceSheet?
  cashFlowStatement CashFlowStatement?
  adjustments       EbitdaAdjustment[]
  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  incomeStatement   IncomeStatement?

  @@unique([companyId, fiscalYear, periodType, quarter, month])
  @@index([companyId, fiscalYear])
  @@map("financial_periods")
}

model IncomeStatement {
  id                String          @id @default(cuid())
  periodId          String          @unique @map("period_id")
  grossRevenue      Decimal         @map("gross_revenue") @db.Decimal(15, 2)
  cogs              Decimal         @db.Decimal(15, 2)
  operatingExpenses Decimal         @map("operating_expenses") @db.Decimal(15, 2)
  grossProfit       Decimal         @map("gross_profit") @db.Decimal(15, 2)
  grossMarginPct    Decimal         @map("gross_margin_pct") @db.Decimal(5, 4)
  ebitda            Decimal         @db.Decimal(15, 2)
  ebitdaMarginPct   Decimal         @map("ebitda_margin_pct") @db.Decimal(5, 4)
  depreciation      Decimal?        @db.Decimal(15, 2)
  amortization      Decimal?        @db.Decimal(15, 2)
  interestExpense   Decimal?        @map("interest_expense") @db.Decimal(15, 2)
  taxExpense        Decimal?        @map("tax_expense") @db.Decimal(15, 2)
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  period            FinancialPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@map("income_statements")
}

model BalanceSheet {
  id                       String          @id @default(cuid())
  periodId                 String          @unique @map("period_id")
  cash                     Decimal         @db.Decimal(15, 2)
  accountsReceivable       Decimal         @map("accounts_receivable") @db.Decimal(15, 2)
  inventory                Decimal         @db.Decimal(15, 2)
  prepaidExpenses          Decimal         @map("prepaid_expenses") @db.Decimal(15, 2)
  otherCurrentAssets       Decimal         @map("other_current_assets") @db.Decimal(15, 2)
  ppeGross                 Decimal         @map("ppe_gross") @db.Decimal(15, 2)
  accumulatedDepreciation  Decimal         @map("accumulated_depreciation") @db.Decimal(15, 2)
  intangibleAssets         Decimal         @map("intangible_assets") @db.Decimal(15, 2)
  otherLongTermAssets      Decimal         @map("other_long_term_assets") @db.Decimal(15, 2)
  accountsPayable          Decimal         @map("accounts_payable") @db.Decimal(15, 2)
  accruedExpenses          Decimal         @map("accrued_expenses") @db.Decimal(15, 2)
  currentPortionLtd        Decimal         @map("current_portion_ltd") @db.Decimal(15, 2)
  otherCurrentLiabilities  Decimal         @map("other_current_liabilities") @db.Decimal(15, 2)
  longTermDebt             Decimal         @map("long_term_debt") @db.Decimal(15, 2)
  deferredTaxLiabilities   Decimal         @map("deferred_tax_liabilities") @db.Decimal(15, 2)
  otherLongTermLiabilities Decimal         @map("other_long_term_liabilities") @db.Decimal(15, 2)
  retainedEarnings         Decimal         @map("retained_earnings") @db.Decimal(15, 2)
  ownersEquity             Decimal         @map("owners_equity") @db.Decimal(15, 2)
  totalCurrentAssets       Decimal         @map("total_current_assets") @db.Decimal(15, 2)
  totalLongTermAssets      Decimal         @map("total_long_term_assets") @db.Decimal(15, 2)
  totalAssets              Decimal         @map("total_assets") @db.Decimal(15, 2)
  totalCurrentLiabilities  Decimal         @map("total_current_liabilities") @db.Decimal(15, 2)
  totalLongTermLiabilities Decimal         @map("total_long_term_liabilities") @db.Decimal(15, 2)
  totalLiabilities         Decimal         @map("total_liabilities") @db.Decimal(15, 2)
  totalEquity              Decimal         @map("total_equity") @db.Decimal(15, 2)
  workingCapital           Decimal         @map("working_capital") @db.Decimal(15, 2)
  createdAt                DateTime        @default(now()) @map("created_at")
  updatedAt                DateTime        @updatedAt @map("updated_at")
  period                   FinancialPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@map("balance_sheets")
}

model CashFlowStatement {
  id                               String          @id @default(cuid())
  periodId                         String          @unique @map("period_id")
  priorPeriodId                    String?         @map("prior_period_id")
  netIncome                        Decimal         @map("net_income") @db.Decimal(15, 2)
  depreciation                     Decimal         @db.Decimal(15, 2)
  amortization                     Decimal         @db.Decimal(15, 2)
  changeInAccountsReceivable       Decimal         @map("change_in_accounts_receivable") @db.Decimal(15, 2)
  changeInInventory                Decimal         @map("change_in_inventory") @db.Decimal(15, 2)
  changeInPrepaidExpenses          Decimal         @map("change_in_prepaid_expenses") @db.Decimal(15, 2)
  changeInOtherCurrentAssets       Decimal         @map("change_in_other_current_assets") @db.Decimal(15, 2)
  changeInAccountsPayable          Decimal         @map("change_in_accounts_payable") @db.Decimal(15, 2)
  changeInAccruedExpenses          Decimal         @map("change_in_accrued_expenses") @db.Decimal(15, 2)
  changeInOtherCurrentLiabilities  Decimal         @map("change_in_other_current_liabilities") @db.Decimal(15, 2)
  changeInDeferredTaxLiabilities   Decimal         @map("change_in_deferred_tax_liabilities") @db.Decimal(15, 2)
  otherOperatingAdjustments        Decimal         @default(0) @map("other_operating_adjustments") @db.Decimal(15, 2)
  cashFromOperations               Decimal         @map("cash_from_operations") @db.Decimal(15, 2)
  capitalExpenditures              Decimal         @map("capital_expenditures") @db.Decimal(15, 2)
  changeInIntangibleAssets         Decimal         @map("change_in_intangible_assets") @db.Decimal(15, 2)
  changeInOtherLongTermAssets      Decimal         @map("change_in_other_long_term_assets") @db.Decimal(15, 2)
  otherInvestingActivities         Decimal         @default(0) @map("other_investing_activities") @db.Decimal(15, 2)
  cashFromInvesting                Decimal         @map("cash_from_investing") @db.Decimal(15, 2)
  changeInCurrentPortionLtd        Decimal         @map("change_in_current_portion_ltd") @db.Decimal(15, 2)
  changeInLongTermDebt             Decimal         @map("change_in_long_term_debt") @db.Decimal(15, 2)
  changeInOtherLongTermLiabilities Decimal         @map("change_in_other_long_term_liabilities") @db.Decimal(15, 2)
  changeInOwnersEquity             Decimal         @map("change_in_owners_equity") @db.Decimal(15, 2)
  otherFinancingActivities         Decimal         @default(0) @map("other_financing_activities") @db.Decimal(15, 2)
  cashFromFinancing                Decimal         @map("cash_from_financing") @db.Decimal(15, 2)
  netChangeInCash                  Decimal         @map("net_change_in_cash") @db.Decimal(15, 2)
  beginningCash                    Decimal         @map("beginning_cash") @db.Decimal(15, 2)
  endingCash                       Decimal         @map("ending_cash") @db.Decimal(15, 2)
  freeCashFlow                     Decimal         @map("free_cash_flow") @db.Decimal(15, 2)
  createdAt                        DateTime        @default(now()) @map("created_at")
  updatedAt                        DateTime        @updatedAt @map("updated_at")
  period                           FinancialPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@map("cash_flow_statements")
}

model DCFAssumptions {
  id                         String   @id @default(cuid())
  companyId                  String   @unique @map("company_id")
  baseFCF                    Decimal? @map("base_fcf") @db.Decimal(15, 2) // Base Free Cash Flow (Year 0) for DCF calculation
  riskFreeRate               Decimal  @map("risk_free_rate") @db.Decimal(5, 4)
  marketRiskPremium          Decimal  @map("market_risk_premium") @db.Decimal(5, 4)
  beta                       Decimal  @db.Decimal(6, 2)
  sizeRiskPremium            Decimal  @map("size_risk_premium") @db.Decimal(5, 4)
  companySpecificRisk        Decimal? @map("company_specific_risk") @db.Decimal(5, 4)
  costOfDebtOverride         Decimal? @map("cost_of_debt_override") @db.Decimal(5, 4)
  taxRateOverride            Decimal? @map("tax_rate_override") @db.Decimal(5, 4)
  debtWeightOverride         Decimal? @map("debt_weight_override") @db.Decimal(5, 4)
  growthAssumptions          Json     @map("growth_assumptions")
  terminalMethod             String   @map("terminal_method")
  perpetualGrowthRate        Decimal  @map("perpetual_growth_rate") @db.Decimal(5, 4)
  exitMultiple               Decimal? @map("exit_multiple") @db.Decimal(6, 2)
  calculatedWACC             Decimal? @map("calculated_wacc") @db.Decimal(5, 4)
  enterpriseValue            Decimal? @map("enterprise_value") @db.Decimal(15, 2)
  equityValue                Decimal? @map("equity_value") @db.Decimal(15, 2)
  useMidYearConvention       Boolean  @default(true) @map("use_mid_year_convention")
  ebitdaTier                 String?  @map("ebitda_tier")
  useDCFValue                Boolean  @default(false) @map("use_dcf_value") // When true, scorecard uses DCF value instead of EBITDA multiple
  isManuallyConfigured       Boolean  @default(false) @map("is_manually_configured") // When true, auto-DCF is skipped
  ebitdaMultipleLowOverride  Decimal? @map("ebitda_multiple_low_override") @db.Decimal(6, 2)
  ebitdaMultipleHighOverride Decimal? @map("ebitda_multiple_high_override") @db.Decimal(6, 2)
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @updatedAt @map("updated_at")
  company                    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("dcf_assumptions")
}

model ProjectQuestion {
  id                 String                      @id @default(cuid())
  moduleId           String                      @unique @map("module_id")
  questionId         String                      @unique @map("question_id")
  questionText       String                      @map("question_text")
  briCategory        BriCategory                 @map("bri_category")
  subCategory        String                      @map("sub_category")
  questionImpact     QuestionImpact              @map("question_impact")
  buyerSensitivity   BuyerSensitivity            @map("buyer_sensitivity")
  definitionNote     String?                     @map("definition_note")
  helpText           String?                     @map("help_text")
  riskDefinition     String?                     @map("risk_definition")
  primaryValueLever  String?                     @map("primary_value_lever")
  relatedQuestionIds String[]                    @map("related_question_ids")
  relatedModules     String[]                    @map("related_modules")
  isActive           Boolean                     @default(true) @map("is_active")
  createdAt          DateTime                    @default(now()) @map("created_at")
  updatedAt          DateTime                    @updatedAt @map("updated_at")
  companyPriorities  CompanyQuestionPriority[]
  assessmentLinks    ProjectAssessmentQuestion[]
  responses          ProjectAssessmentResponse[]
  options            ProjectQuestionOption[]
  strategies         ProjectStrategy[]

  @@index([briCategory, questionImpact])
  @@map("project_questions")
}

model ProjectQuestionOption {
  id                  String                      @id @default(cuid())
  questionId          String                      @map("question_id")
  optionId            String                      @map("option_id")
  optionText          String                      @map("option_text")
  scoreValue          Decimal                     @map("score_value") @db.Decimal(3, 2)
  buyerInterpretation String?                     @map("buyer_interpretation")
  displayOrder        Int                         @map("display_order")
  effectiveResponses  ProjectAssessmentResponse[] @relation("EffectiveProjectOption")
  selectedResponses   ProjectAssessmentResponse[] @relation("SelectedProjectOption")
  question            ProjectQuestion             @relation(fields: [questionId], references: [id], onDelete: Cascade)
  tasksUpgradingFrom  ProjectTaskTemplate[]       @relation("ProjectTaskUpgradeFrom")
  tasksUpgradingTo    ProjectTaskTemplate[]       @relation("ProjectTaskUpgradeTo")

  @@unique([questionId, optionId])
  @@map("project_question_options")
}

model ProjectStrategy {
  id                  String                @id @default(cuid())
  questionId          String                @map("question_id")
  strategyId          String                @map("strategy_id")
  strategyName        String                @map("strategy_name")
  strategyDescription String?               @map("strategy_description")
  strategyType        StrategyType          @map("strategy_type")
  upgradeFromScore    Decimal               @map("upgrade_from_score") @db.Decimal(3, 2)
  maxScoreAchievable  Decimal               @map("max_score_achievable") @db.Decimal(3, 2)
  estimatedEffort     String                @map("estimated_effort")
  estimatedTimeline   String?               @map("estimated_timeline")
  applicableWhen      String?               @map("applicable_when")
  question            ProjectQuestion       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  taskTemplates       ProjectTaskTemplate[]

  @@unique([questionId, strategyId])
  @@map("project_strategies")
}

model ProjectTaskTemplate {
  id                   String                 @id @default(cuid())
  strategyId           String                 @map("strategy_id")
  taskId               String                 @map("task_id")
  sequence             Int
  title                String
  primaryVerb          String                 @map("primary_verb")
  verbTier             Int                    @map("verb_tier")
  object               String
  outcome              String?
  ownerRole            OwnerRole              @map("owner_role")
  timebox              Timebox
  effortLevel          EffortLevel            @map("effort_level")
  complexity           ComplexityLevel
  estimatedHours       Int?                   @map("estimated_hours")
  deliverables         String[]
  evidence             String[]
  riskCategory         BriCategory            @map("risk_category")
  dependencies         String[]
  blockedBy            String[]               @map("blocked_by")
  upgradesFromScore    Decimal?               @map("upgrades_from_score") @db.Decimal(3, 2)
  upgradesToScore      Decimal?               @map("upgrades_to_score") @db.Decimal(3, 2)
  upgradesFromOptionId String?                @map("upgrades_from_option_id")
  upgradesToOptionId   String?                @map("upgrades_to_option_id")
  deferReasonCode      String?                @map("defer_reason_code")
  companionVerbs       String[]               @map("companion_verbs")
  reEvaluationDate     String?                @map("re_evaluation_date")
  valueImpactState     String?                @map("value_impact_state")
  mitigationSummary    String?                @map("mitigation_summary")
  strategy             ProjectStrategy        @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  upgradesFromOption   ProjectQuestionOption? @relation("ProjectTaskUpgradeFrom", fields: [upgradesFromOptionId], references: [id])
  upgradesToOption     ProjectQuestionOption? @relation("ProjectTaskUpgradeTo", fields: [upgradesToOptionId], references: [id])

  @@unique([strategyId, taskId])
  @@map("project_task_templates")
}

model ProjectAssessment {
  id                  String                      @id @default(cuid())
  companyId           String                      @map("company_id")
  assessmentNumber    Int                         @map("assessment_number")
  primaryCategory     BriCategory?                @map("primary_category")
  title               String?
  status              ProjectAssessmentStatus     @default(IN_PROGRESS)
  startedAt           DateTime                    @default(now()) @map("started_at")
  completedAt         DateTime?                   @map("completed_at")
  briScoreBefore      Decimal?                    @map("bri_score_before") @db.Decimal(5, 4)
  briScoreAfter       Decimal?                    @map("bri_score_after") @db.Decimal(5, 4)
  scoreImpact         Decimal?                    @map("score_impact") @db.Decimal(5, 4)
  actionPlanGenerated Boolean                     @default(false) @map("action_plan_generated")
  createdAt           DateTime                    @default(now()) @map("created_at")
  updatedAt           DateTime                    @updatedAt @map("updated_at")
  questions           ProjectAssessmentQuestion[]
  responses           ProjectAssessmentResponse[]
  company             Company                     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, assessmentNumber])
  @@index([companyId, status])
  @@map("project_assessments")
}

model ProjectAssessmentQuestion {
  id              String            @id @default(cuid())
  assessmentId    String            @map("assessment_id")
  questionId      String            @map("question_id")
  displayOrder    Int               @map("display_order")
  selectionReason String?           @map("selection_reason")
  priorityScore   Decimal           @map("priority_score") @db.Decimal(5, 2)
  skipped         Boolean           @default(false)
  skippedAt       DateTime?         @map("skipped_at")
  assessment      ProjectAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question        ProjectQuestion   @relation(fields: [questionId], references: [id])

  @@unique([assessmentId, questionId])
  @@map("project_assessment_questions")
}

model ProjectAssessmentResponse {
  id                String                 @id @default(cuid())
  assessmentId      String                 @map("assessment_id")
  questionId        String                 @map("question_id")
  selectedOptionId  String                 @map("selected_option_id")
  effectiveOptionId String?                @map("effective_option_id")
  estimatedScore    Decimal?               @map("estimated_score") @db.Decimal(3, 2)
  actualScore       Decimal                @map("actual_score") @db.Decimal(3, 2)
  scoreImpact       Decimal?               @map("score_impact") @db.Decimal(4, 3)
  confidenceLevel   ConfidenceLevel        @map("confidence_level")
  notes             String?
  evidenceUrls      String[]               @map("evidence_urls")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  assessment        ProjectAssessment      @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  effectiveOption   ProjectQuestionOption? @relation("EffectiveProjectOption", fields: [effectiveOptionId], references: [id])
  question          ProjectQuestion        @relation(fields: [questionId], references: [id])
  selectedOption    ProjectQuestionOption  @relation("SelectedProjectOption", fields: [selectedOptionId], references: [id])

  @@unique([assessmentId, questionId])
  @@index([assessmentId, createdAt(sort: Desc)])
  @@map("project_assessment_responses")
}

model CompanyQuestionPriority {
  id             String          @id @default(cuid())
  companyId      String          @map("company_id")
  questionId     String          @map("question_id")
  impactScore    Decimal         @map("impact_score") @db.Decimal(5, 2)
  relevanceScore Decimal         @map("relevance_score") @db.Decimal(5, 2)
  urgencyScore   Decimal         @map("urgency_score") @db.Decimal(5, 2)
  priorityScore  Decimal         @map("priority_score") @db.Decimal(5, 2)
  hasBeenAsked   Boolean         @default(false) @map("has_been_asked")
  askedAt        DateTime?       @map("asked_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  question       ProjectQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([companyId, questionId])
  @@index([companyId, priorityScore])
  @@map("company_question_priorities")
}

model UserConsent {
  id          String        @id @default(cuid())
  userId      String        @map("user_id")
  consentType ConsentType   @map("consent_type")
  action      ConsentAction
  version     String?
  ipAddress   String?       @map("ip_address")
  userAgent   String?       @map("user_agent")
  createdAt   DateTime      @default(now()) @map("created_at")
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, consentType])
  @@index([userId, createdAt])
  @@map("user_consents")
}

model DataDeletionRequest {
  id                String                @id @default(cuid())
  userId            String                @map("user_id")
  status            DeletionRequestStatus @default(PENDING)
  reason            String?
  requestedAt       DateTime              @default(now()) @map("requested_at")
  scheduledFor      DateTime              @map("scheduled_for")
  processedAt       DateTime?             @map("processed_at")
  cancelledAt       DateTime?             @map("cancelled_at")
  confirmationToken String                @unique @map("confirmation_token")
  confirmedAt       DateTime?             @map("confirmed_at")
  dataDeleted       Json?                 @map("data_deleted")
  deletedBy         String?               @map("deleted_by")
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([status, scheduledFor])
  @@map("data_deletion_requests")
}

model DataExportRequest {
  id                 String              @id @default(cuid())
  userId             String              @map("user_id")
  status             ExportRequestStatus @default(PENDING)
  requestedAt        DateTime            @default(now()) @map("requested_at")
  processedAt        DateTime?           @map("processed_at")
  downloadedAt       DateTime?           @map("downloaded_at")
  expiresAt          DateTime?           @map("expires_at")
  filePath           String?             @map("file_path")
  fileSize           Int?                @map("file_size")
  downloadToken      String?             @unique @map("download_token")
  downloadCount      Int                 @default(0) @map("download_count")
  includeProfile     Boolean             @default(true) @map("include_profile")
  includeCompanies   Boolean             @default(true) @map("include_companies")
  includeAssessments Boolean             @default(true) @map("include_assessments")
  includeDocuments   Boolean             @default(false) @map("include_documents")
  errorMessage       String?             @map("error_message")
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([downloadToken])
  @@map("data_export_requests")
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String   @map("actor_id")
  actorEmail String   @map("actor_email")
  action     String
  targetType String   @map("target_type")
  targetId   String?  @map("target_id")
  metadata   Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  actor      User     @relation("AuditActor", fields: [actorId], references: [id])

  @@index([actorId])
  @@index([targetType, targetId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model ImpersonationSession {
  id           String    @id @default(cuid())
  adminId      String    @map("admin_id")
  targetUserId String    @map("target_user_id")
  reason       String
  startedAt    DateTime  @default(now()) @map("started_at")
  endedAt      DateTime? @map("ended_at")
  ipAddress    String?   @map("ip_address")
  admin        User      @relation("ImpersonationAdmin", fields: [adminId], references: [id])
  targetUser   User      @relation("ImpersonationTarget", fields: [targetUserId], references: [id])

  @@index([adminId])
  @@index([targetUserId])
  @@map("impersonation_sessions")
}

model SupportTicket {
  id           String          @id @default(cuid())
  ticketNumber String          @unique @map("ticket_number")
  userId       String?         @map("user_id")
  userEmail    String          @map("user_email")
  subject      String
  status       String          @default("open")
  priority     String          @default("normal")
  category     String?
  assignedToId String?         @map("assigned_to_id")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  resolvedAt   DateTime?       @map("resolved_at")
  assignedTo   User?           @relation("TicketAssignee", fields: [assignedToId], references: [id])
  user         User?           @relation("TicketUser", fields: [userId], references: [id])
  messages     TicketMessage[]

  @@index([userId])
  @@index([status])
  @@index([assignedToId])
  @@map("support_tickets")
}

model TicketMessage {
  id          String        @id @default(cuid())
  ticketId    String        @map("ticket_id")
  authorId    String?       @map("author_id")
  authorEmail String        @map("author_email")
  content     String
  isInternal  Boolean       @default(false) @map("is_internal")
  createdAt   DateTime      @default(now()) @map("created_at")
  author      User?         @relation(fields: [authorId], references: [id])
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("ticket_messages")
}

model ProspectiveBuyer {
  id               String             @id @default(cuid())
  companyId        String             @map("company_id")
  name             String
  buyerType        BuyerType          @map("buyer_type")
  tier             BuyerTier          @default(B_TIER)
  website          String?
  description      String?
  industry         String?
  location         String?
  currentStage     DealStage          @default(IDENTIFIED) @map("current_stage")
  stageUpdatedAt   DateTime           @default(now()) @map("stage_updated_at")
  approvedAt       DateTime?          @map("approved_at")
  ndaExecutedAt    DateTime?          @map("nda_executed_at")
  ioiReceivedAt    DateTime?          @map("ioi_received_at")
  loiReceivedAt    DateTime?          @map("loi_received_at")
  closedAt         DateTime?          @map("closed_at")
  withdrawnAt      DateTime?          @map("withdrawn_at")
  approvalStatus   String?            @map("approval_status")
  approvalNotes    String?            @map("approval_notes")
  approvalById     String?            @map("approval_by_id")
  ioiAmount        Decimal?           @map("ioi_amount") @db.Decimal(15, 2)
  loiAmount        Decimal?           @map("loi_amount") @db.Decimal(15, 2)
  ioiDeadline      DateTime?          @map("ioi_deadline")
  loiDeadline      DateTime?          @map("loi_deadline")
  exclusivityStart DateTime?          @map("exclusivity_start")
  exclusivityEnd   DateTime?          @map("exclusivity_end")
  internalNotes    String?            @map("internal_notes")
  tags             String[]
  createdById      String             @map("created_by_id")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  prospectId       String?            @map("prospect_id")
  contacts         BuyerContact[]
  activities       DealActivity[]
  documents        DealDocument[]
  meetings         DealMeeting[]
  stageHistory     DealStageHistory[]
  company          Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  prospect         BuyerProspect?     @relation(fields: [prospectId], references: [id])

  @@unique([companyId, name])
  @@index([companyId, currentStage])
  @@index([prospectId])
  @@map("prospective_buyers")
}

model BuyerContact {
  id               String           @id @default(cuid())
  buyerId          String           @map("buyer_id")
  email            String
  firstName        String           @map("first_name")
  lastName         String           @map("last_name")
  title            String?
  phone            String?
  role             BuyerContactRole @default(DEAL_LEAD)
  isPrimary        Boolean          @default(false) @map("is_primary")
  dataRoomAccessId String?          @unique @map("data_room_access_id")
  isActive         Boolean          @default(true) @map("is_active")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  buyer            ProspectiveBuyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  dataRoomAccess   DataRoomAccess?  @relation(fields: [dataRoomAccessId], references: [id])

  @@unique([buyerId, email])
  @@index([buyerId])
  @@map("buyer_contacts")
}

model DealStageHistory {
  id          String           @id @default(cuid())
  buyerId     String           @map("buyer_id")
  fromStage   DealStage?       @map("from_stage")
  toStage     DealStage        @map("to_stage")
  notes       String?
  changedById String           @map("changed_by_id")
  changedAt   DateTime         @default(now()) @map("changed_at")
  buyer       ProspectiveBuyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, changedAt])
  @@map("deal_stage_history")
}

model DealActivity {
  id            String           @id @default(cuid())
  buyerId       String           @map("buyer_id")
  activityType  String           @map("activity_type")
  description   String
  metadata      Json?
  performedById String?          @map("performed_by_id")
  performedAt   DateTime         @default(now()) @map("performed_at")
  buyer         ProspectiveBuyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, performedAt])
  @@map("deal_activities")
}

model DealDocument {
  id           String           @id @default(cuid())
  buyerId      String           @map("buyer_id")
  documentType DealDocumentType @map("document_type")
  name         String
  description  String?
  filePath     String?          @map("file_path")
  fileName     String?          @map("file_name")
  fileSize     Int?             @map("file_size")
  mimeType     String?          @map("mime_type")
  receivedAt   DateTime?        @map("received_at")
  sentAt       DateTime?        @map("sent_at")
  uploadedById String           @map("uploaded_by_id")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  buyer        ProspectiveBuyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, documentType])
  @@map("deal_documents")
}

model DealMeeting {
  id          String           @id @default(cuid())
  buyerId     String           @map("buyer_id")
  meetingType MeetingType      @map("meeting_type")
  title       String
  description String?
  scheduledAt DateTime         @map("scheduled_at")
  duration    Int?
  location    String?
  meetingLink String?          @map("meeting_link")
  status      String           @default("scheduled")
  completedAt DateTime?        @map("completed_at")
  notes       String?
  attendees   Json?
  createdById String           @map("created_by_id")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  buyer       ProspectiveBuyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, scheduledAt])
  @@map("deal_meetings")
}

model BuyerProspect {
  id                   String                 @id @default(cuid())
  companyId            String                 @map("company_id")
  name                 String
  domain               String?
  website              String?
  headquartersLocation String?                @map("headquarters_location")
  buyerType            BuyerType              @map("buyer_type")
  relevanceDescription String?                @map("relevance_description")
  approvalStatus       ProspectApprovalStatus @default(UNDECIDED) @map("approval_status")
  statusChangedAt      DateTime?              @map("status_changed_at")
  statusChangedBy      String?                @map("status_changed_by")
  denialReason         String?                @map("denial_reason")
  source               ProspectSource         @default(MANUAL)
  importBatchId        String?                @map("import_batch_id")
  notes                String?
  createdAt            DateTime               @default(now()) @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")
  createdById          String                 @map("created_by_id")
  company              Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importBatch          ProspectImportBatch?   @relation(fields: [importBatchId], references: [id])
  buyers               ProspectiveBuyer[]

  @@unique([companyId, name])
  @@index([companyId, approvalStatus])
  @@index([domain])
  @@map("buyer_prospects")
}

model ProspectImportBatch {
  id             String          @id @default(cuid())
  companyId      String          @map("company_id")
  filename       String?
  totalRows      Int             @default(0) @map("total_rows")
  successfulRows Int             @default(0) @map("successful_rows")
  failedRows     Int             @default(0) @map("failed_rows")
  errorLog       Json?           @map("error_log")
  status         String          @default("processing")
  createdAt      DateTime        @default(now()) @map("created_at")
  createdById    String          @map("created_by_id")
  prospects      BuyerProspect[]
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("prospect_import_batches")
}

// ============================================
// Company Ownership & Access Models
// ============================================

model CompanyOwnership {
  id                 String              @id @default(cuid())
  companyId          String              @map("company_id")
  userId             String              @map("user_id")
  ownershipPercent   Decimal?            @map("ownership_percent") @db.Decimal(5, 2)
  isSubscribingOwner Boolean             @default(false) @map("is_subscribing_owner")
  invitedById        String?             @map("invited_by_id")
  status             CompanyMemberStatus @default(ACTIVE)
  createdAt          DateTime            @default(now()) @map("created_at")
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([userId])
  @@map("company_ownerships")
}

model CompanyStaffAccess {
  id                  String              @id @default(cuid())
  companyId           String              @map("company_id")
  userId              String              @map("user_id")
  invitedById         String              @map("invited_by_id")
  hasPFSAccess        Boolean             @default(false) @map("has_pfs_access")
  hasRetirementAccess Boolean             @default(false) @map("has_retirement_access")
  hasLoansAccess      Boolean             @default(false) @map("has_loans_access")
  status              CompanyMemberStatus @default(ACTIVE)
  createdAt           DateTime            @default(now()) @map("created_at")
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([userId])
  @@map("company_staff_access")
}

model AccessRequest {
  id          String              @id @default(cuid())
  companyId   String              @map("company_id")
  requesterId String              @map("requester_id")
  ownerId     String              @map("owner_id")
  featureKey  String              @map("feature_key") // 'pfs' | 'retirement' | 'loans'
  status      AccessRequestStatus @default(PENDING)
  reason      String?
  respondedAt DateTime?           @map("responded_at")
  expiresAt   DateTime            @map("expires_at")
  createdAt   DateTime            @default(now()) @map("created_at")
  company     Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  requester   User                @relation("AccessRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  owner       User                @relation("AccessOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([ownerId, status])
  @@index([requesterId])
  @@map("access_requests")
}

model Alert {
  id          String    @id @default(cuid())
  recipientId String    @map("recipient_id")
  type        AlertType
  title       String
  message     String
  actionUrl   String?   @map("action_url")
  metadata    Json?
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  persistent  Boolean   @default(false) @map("is_persistent")
  createdAt   DateTime  @default(now()) @map("created_at")
  recipient   User      @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId, isRead])
  @@index([recipientId, createdAt])
  @@map("alerts")
}

model CompanyMember {
  id           String      @id @default(cuid())
  companyId    String      @map("company_id")
  userId       String      @map("user_id")
  role         CompanyRole @default(CONTRIBUTOR)
  assignedById String?     @map("assigned_by_id")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  company      Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedBy   User?       @relation("CompanyMemberAssigner", fields: [assignedById], references: [id])

  @@unique([companyId, userId])
  @@index([userId])
  @@map("company_members")
}

model CompanyInvite {
  id               String            @id @default(cuid())
  companyId        String            @map("company_id")
  email            String
  inviteType       CompanyInviteType @default(STAFF) @map("invite_type")
  ownershipPercent Decimal?          @map("ownership_percent") @db.Decimal(5, 2)
  invitedById      String            @map("invited_by_id")
  token            String            @unique @default(cuid())
  expiresAt        DateTime          @map("expires_at")
  acceptedAt       DateTime?         @map("accepted_at")
  createdAt        DateTime          @default(now()) @map("created_at")
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inviter          User              @relation("CompanyInviter", fields: [invitedById], references: [id])

  @@unique([companyId, email])
  @@index([token])
  @@map("company_invites")
}

enum FunctionalCategory {
  OWNER
  FINANCE
  OPERATIONS
  HR
  LEGAL
  SALES_MARKETING
  IT
  EXTERNAL
}

enum RevenueSizeCategory {
  UNDER_500K
  FROM_500K_TO_1M
  FROM_1M_TO_3M
  FROM_3M_TO_10M
  FROM_10M_TO_25M
  OVER_25M
}

enum RevenueModelType {
  PROJECT_BASED
  TRANSACTIONAL
  RECURRING_CONTRACTS
  SUBSCRIPTION_SAAS
}

enum GrossMarginCategory {
  LOW
  MODERATE
  GOOD
  EXCELLENT
}

enum LaborIntensityLevel {
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

enum AssetIntensityLevel {
  ASSET_LIGHT
  MODERATE
  ASSET_HEAVY
}

enum OwnerInvolvementLevel {
  MINIMAL
  LOW
  MODERATE
  HIGH
  CRITICAL
}

enum ConfidenceLevel {
  UNCERTAIN
  SOMEWHAT_CONFIDENT
  CONFIDENT
  VERIFIED
  NOT_APPLICABLE
}

enum BriCategory {
  FINANCIAL
  TRANSFERABILITY
  OPERATIONAL
  MARKET
  LEGAL_TAX
  PERSONAL
}

enum ActionItemType {
  TYPE_I_EVIDENCE
  TYPE_II_DOCUMENTATION
  TYPE_III_OPERATIONAL
  TYPE_IV_INSTITUTIONALIZE
  TYPE_V_RISK_REDUCTION
  TYPE_VI_ALIGNMENT
  TYPE_VII_READINESS
  TYPE_VIII_SIGNALING
  TYPE_IX_OPTIONS
  TYPE_X_DEFER
}

enum EffortLevel {
  MINIMAL
  LOW
  MODERATE
  HIGH
  MAJOR
}

enum ComplexityLevel {
  SIMPLE
  MODERATE
  COMPLEX
  STRATEGIC
}

enum ImpactLevel {
  NONE
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum DifficultyLevel {
  NONE
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  BLOCKED
  COMPLETED
  DEFERRED
  CANCELLED
  NOT_APPLICABLE
}

enum AssessmentType {
  INITIAL
  QUARTERLY_CHECK_IN
  AD_HOC
}

enum IssueTier {
  CRITICAL
  SIGNIFICANT
  OPTIMIZATION
}

enum SubTaskType {
  CHECKBOX
  FILE_UPLOAD
  TEXT_INPUT
  QUESTION_ANSWER
  CONNECTION
}

enum TaskSourceType {
  ONBOARDING_PRELIMINARY
  ASSESSMENT
  AI_ENRICHMENT
}

enum PeriodType {
  ANNUAL
  QUARTERLY
  MONTHLY
}

enum Quarter {
  Q1
  Q2
  Q3
  Q4
}

enum QuestionImpact {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum BuyerSensitivity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum StrategyType {
  FULL_FIX
  PARTIAL_MITIGATION
  RISK_ACCEPTANCE
}

enum OwnerRole {
  FOUNDER
  CFO_FINANCE
  OPS_LEADER
  SALES_MKTG
  HR_PEOPLE
  LEGAL_COMPLIANCE
  IT_SECURITY
  ADVISOR
}

enum Timebox {
  IMMEDIATE_0_30
  NEAR_30_90
  LONG_90_365
}

enum ProjectAssessmentStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum DataRoomCategory {
  FINANCIAL
  LEGAL
  OPERATIONS
  CUSTOMERS
  EMPLOYEES
  IP
  CUSTOM
  TASK_PROOF
  TAX
  SALES_MARKETING
  TECHNOLOGY
  REAL_ESTATE
  ENVIRONMENTAL
  INSURANCE
  CORPORATE
}

enum DataRoomStage {
  PREPARATION
  TEASER
  POST_NDA
  DUE_DILIGENCE
  CLOSED
}

enum DataRoomAccessLevel {
  VIEWER
  DOWNLOADER
  CONTRIBUTOR
  ADMIN
}

enum DataRoomAction {
  VIEWED_FOLDER
  VIEWED_DOCUMENT
  DOWNLOADED_DOCUMENT
  UPLOADED_DOCUMENT
  DELETED_DOCUMENT
  UPDATED_DOCUMENT
  CREATED_FOLDER
  DELETED_FOLDER
  GRANTED_ACCESS
  REVOKED_ACCESS
  ASKED_QUESTION
  ANSWERED_QUESTION
  EXPORTED_REPORT
  STAGE_CHANGED
}

enum UpdateFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
  AS_NEEDED
  ONE_TIME
}

// Document status for data room documents.
// CURRENT: Document is up-to-date and within its refresh window.
// NEEDS_UPDATE: Document is approaching its next update due date (within 7 days).
// OVERDUE: Document has passed its next update due date.
// NOTE: There is no ARCHIVED status. To archive a document, soft-delete it or use a custom field.
enum DocumentStatus {
  CURRENT
  NEEDS_UPDATE
  OVERDUE
}

enum PlanTier {
  FOUNDATION
  GROWTH
  EXIT_READY
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum IntegrationProvider {
  QUICKBOOKS_ONLINE
}

enum SyncStatus {
  IDLE
  SYNCING
  SUCCESS
  FAILED
}

enum ConsentType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  MARKETING_EMAILS
  ANALYTICS_COOKIES
  FUNCTIONAL_COOKIES
  MARKETING_COOKIES
}

enum ConsentAction {
  GRANTED
  WITHDRAWN
  UPDATED
}

enum DeletionRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

enum ExportRequestStatus {
  PENDING
  PROCESSING
  READY
  DOWNLOADED
  EXPIRED
  FAILED
}

enum DealStage {
  IDENTIFIED
  SELLER_REVIEWING
  APPROVED
  DECLINED
  TEASER_SENT
  INTERESTED
  PASSED
  NDA_SENT
  NDA_NEGOTIATING
  NDA_EXECUTED
  CIM_ACCESS
  LEVEL_2_ACCESS
  LEVEL_3_ACCESS
  MANAGEMENT_MEETING_SCHEDULED
  MANAGEMENT_MEETING_COMPLETED
  IOI_REQUESTED
  IOI_RECEIVED
  IOI_ACCEPTED
  IOI_DECLINED
  LOI_REQUESTED
  LOI_RECEIVED
  LOI_SELECTED
  LOI_BACKUP
  DUE_DILIGENCE
  PA_DRAFTING
  PA_NEGOTIATING
  CLOSING
  CLOSED
  WITHDRAWN
  TERMINATED
}

enum BuyerType {
  STRATEGIC
  FINANCIAL
  INDIVIDUAL
  MANAGEMENT
  ESOP
  OTHER
}

enum ProspectApprovalStatus {
  UNDECIDED
  APPROVED
  DENIED
}

enum ProspectSource {
  MANUAL
  CSV_IMPORT
}

enum BuyerTier {
  A_TIER
  B_TIER
  C_TIER
  D_TIER
}

enum BuyerContactRole {
  PRIMARY
  DECISION_MAKER
  DEAL_LEAD
  DILIGENCE
  LEGAL
  FINANCE
  OPERATIONS
}

enum ParticipantSide {
  BUYER
  SELLER
  NEUTRAL
}

enum ParticipantRole {
  // Buyer roles
  DEAL_LEAD
  DECISION_MAKER
  DILIGENCE
  BUYER_LEGAL
  BUYER_FINANCE
  BUYER_OPERATIONS
  // Advisory (seller-side)
  CPA
  ATTORNEY
  BROKER
  MA_ADVISOR
  WEALTH_PLANNER
  // Internal (seller-side)
  COO
  CFO
  GM
  KEY_EMPLOYEE
  BOARD_MEMBER
  // External (neutral)
  BANKER
  ESCROW_AGENT
  INSURANCE_BROKER
  // Generic
  PRIMARY_CONTACT
  OTHER
}

enum DealDocumentType {
  TEASER
  NDA_TEMPLATE
  NDA_SIGNED
  CIM
  PROCESS_LETTER
  IOI_RECEIVED
  LOI_RECEIVED
  PURCHASE_AGREEMENT
  OTHER
}

enum MeetingType {
  INTRO_CALL
  MANAGEMENT_PRESENTATION
  SITE_VISIT
  EXPERT_SESSION
  NEGOTIATION
  OTHER
}

enum UserType {
  SUBSCRIBER
  GUEST
  COMPED
}

enum ExposureState {
  LEARNING
  VIEWING
  ACTING
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED
}

enum AlertType {
  ACCESS_REQUEST
  ACCESS_GRANTED
  ACCESS_DENIED
  STAFF_PAUSED
  OWNERSHIP_TRANSFER
  TRIAL_ENDING
  TRIAL_EXPIRED
  PARTNER_NUDGE
  ACTION_PLAN_UPDATED
  ONBOARDING_TOUR
  ONBOARDING_ASSESSMENT
}

enum CompanyMemberStatus {
  ACTIVE
  PAUSED
}

enum CompanyInviteType {
  STAFF
  GUEST_OWNER
}

enum WorkspaceRole {
  OWNER
  ADMIN
  BILLING
  MEMBER
}

enum CompanyRole {
  LEAD
  CONTRIBUTOR
  VIEWER
}

// ============================================
// Visit Tracking for Returning User Experience
// ============================================

model CompanyVisitLog {
  id                     String   @id @default(cuid())
  companyId              String   @map("company_id")
  userId                 String   @map("user_id")
  visitedAt              DateTime @default(now()) @map("visited_at")
  briScore               Float?   @map("bri_score")
  valuation              Float?
  tasksCompleted         Int      @default(0) @map("tasks_completed")
  criticalTasksCompleted Int      @default(0) @map("critical_tasks_completed")

  @@index([companyId, userId, visitedAt(sort: Desc)])
  @@map("company_visit_logs")
}

// ============================================
// CONTACT SYSTEM - CANONICAL LAYER
// ============================================
// These models persist across all deals and represent
// the "source of truth" for companies and people.
// ============================================

// --------------------------------------------
// CANONICAL COMPANY
// --------------------------------------------
// Represents a buyer organization that persists across deals.
// A single canonical company can be a prospect in multiple deals.

model CanonicalCompany {
  id String @id @default(cuid())

  // Identity
  name           String
  normalizedName String  @map("normalized_name") // Lowercase, stripped for matching
  legalName      String? @map("legal_name")

  // Online presence
  website     String?
  linkedInUrl String? @map("linkedin_url")

  // Classification
  companyType  BuyerType @default(OTHER) @map("company_type")
  industryCode String?   @map("industry_code") // ICB or SIC
  industryName String?   @map("industry_name")

  // Location
  headquarters String?
  country      String?

  // Firmographics
  employeeCount Int?     @map("employee_count")
  foundedYear   Int?     @map("founded_year")
  aum           Decimal? @db.Decimal(15, 2) // Assets under management (for PE/VC)
  description   String?

  // Data quality tracking
  dataQuality      DataQuality @default(PROVISIONAL) @map("data_quality")
  verifiedAt       DateTime?   @map("verified_at")
  verifiedByUserId String?     @map("verified_by_user_id")

  // Merge tracking (for deduplication)
  mergedIntoId String?   @map("merged_into_id")
  mergedAt     DateTime? @map("merged_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  domains                 CanonicalDomain[]
  people                  CanonicalPerson[]    @relation("CurrentEmployer")
  employmentHistory       PersonEmployment[]
  companyGroupMemberships CompanyGroupMember[]
  dealBuyers              DealBuyer[]

  // Self-reference for merges
  mergedInto CanonicalCompany?  @relation("CompanyMerge", fields: [mergedIntoId], references: [id])
  mergedFrom CanonicalCompany[] @relation("CompanyMerge")

  @@index([normalizedName])
  @@index([website])
  @@index([dataQuality])
  @@index([companyType])
  @@index([mergedIntoId])
  @@map("canonical_companies")
}

// --------------------------------------------
// CANONICAL PERSON
// --------------------------------------------
// Represents a contact person that persists across deals.
// Their employment may change, but they remain the same entity.

model CanonicalPerson {
  id String @id @default(cuid())

  // Identity
  firstName      String @map("first_name")
  lastName       String @map("last_name")
  normalizedName String @map("normalized_name") // For matching

  // Contact info
  email         String? @unique
  emailVerified Boolean @default(false) @map("email_verified")
  phone         String? // Legacy â€” use phoneWork/phoneCell instead
  phoneWork     String? @map("phone_work")
  phoneCell     String? @map("phone_cell")
  linkedInUrl   String? @map("linkedin_url")

  // Address
  addressLine1  String? @map("address_line1")
  addressLine2  String? @map("address_line2")
  city          String? @map("city")
  state         String? @map("state")
  zip           String? @map("zip")

  // Current position (denormalized for quick access)
  currentTitle     String? @map("current_title")
  currentCompanyId String? @map("current_company_id")

  // Data quality
  dataQuality DataQuality @default(PROVISIONAL) @map("data_quality")
  verifiedAt  DateTime?   @map("verified_at")

  // Merge tracking
  mergedIntoId String?   @map("merged_into_id")
  mergedAt     DateTime? @map("merged_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  currentCompany    CanonicalCompany?  @relation("CurrentEmployer", fields: [currentCompanyId], references: [id])
  employmentHistory PersonEmployment[]
  dealContacts      DealContact[]
  dealParticipants  DealParticipant[]
  activities        DealActivity2[]
  emailAttempts     EmailAttempt[]

  // Self-reference for merges
  mergedInto CanonicalPerson?  @relation("PersonMerge", fields: [mergedIntoId], references: [id])
  mergedFrom CanonicalPerson[] @relation("PersonMerge")

  @@index([normalizedName])
  @@index([email])
  @@index([currentCompanyId])
  @@index([mergedIntoId])
  @@map("canonical_people")
}

// --------------------------------------------
// CANONICAL DOMAIN
// --------------------------------------------
// Maps email domains to canonical companies.
// Used for automatic company detection from email addresses.

model CanonicalDomain {
  id        String  @id @default(cuid())
  domain    String  @unique // e.g., "kkr.com"
  isPrimary Boolean @default(true) @map("is_primary")

  companyId String           @map("company_id")
  company   CanonicalCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId])
  @@map("canonical_domains")
}

// --------------------------------------------
// PERSON EMPLOYMENT
// --------------------------------------------
// Tracks employment history for canonical people.
// Enables "institutional memory" across deals.

model PersonEmployment {
  id String @id @default(cuid())

  personId String          @map("person_id")
  person   CanonicalPerson @relation(fields: [personId], references: [id], onDelete: Cascade)

  companyId String           @map("company_id")
  company   CanonicalCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  title     String
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")
  isCurrent Boolean   @default(true) @map("is_current")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([personId])
  @@index([companyId])
  @@index([personId, isCurrent])
  @@map("person_employment")
}

// --------------------------------------------
// COMPANY GROUP
// --------------------------------------------
// Groups related companies (e.g., "KKR Family" includes
// KKR & Co, KKR Credit, portfolio companies, etc.)

model CompanyGroup {
  id          String           @id @default(cuid())
  name        String // e.g., "KKR Family", "Blackstone Group"
  description String?
  groupType   CompanyGroupType @default(OTHER) @map("group_type")

  members CompanyGroupMember[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("company_groups")
}

model CompanyGroupMember {
  id String @id @default(cuid())

  groupId String       @map("group_id")
  group   CompanyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  companyId String           @map("company_id")
  company   CanonicalCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  relationship CompanyGroupRelationship @default(MEMBER)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([groupId, companyId])
  @@map("company_group_members")
}

// --------------------------------------------
// DUPLICATE CANDIDATES
// --------------------------------------------
// Stores potential duplicates for admin review.

model DuplicateCandidate {
  id         String              @id @default(cuid())
  entityType DuplicateEntityType @map("entity_type")

  // For companies
  companyAId String? @map("company_a_id")
  companyBId String? @map("company_b_id")

  // For people
  personAId String? @map("person_a_id")
  personBId String? @map("person_b_id")

  // Match details
  confidence   Float // 0-1
  matchReasons Json  @map("match_reasons") // Array of reason strings

  // Resolution
  status           DuplicateStatus      @default(PENDING)
  resolvedAt       DateTime?            @map("resolved_at")
  resolvedByUserId String?              @map("resolved_by_user_id")
  resolution       DuplicateResolution? // MERGED, NOT_DUPLICATE, SKIPPED

  createdAt DateTime @default(now()) @map("created_at")

  @@index([entityType, status])
  @@index([confidence])
  @@map("duplicate_candidates")
}

// ============================================
// CONTACT SYSTEM - DEAL LAYER
// ============================================
// These models are scoped to specific deals.
// ============================================

// --------------------------------------------
// DEAL
// --------------------------------------------
// Represents a specific M&A engagement for a company.
// One company can have multiple deals over time.

model Deal {
  id String @id @default(cuid())

  // Link to the company being sold
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Deal identity
  codeName    String     @map("code_name") // "Project Atlas"
  description String?
  status      DealStatus @default(ACTIVE)

  // Key dates
  startedAt       DateTime  @default(now()) @map("started_at")
  targetCloseDate DateTime? @map("target_close_date")
  closedAt        DateTime? @map("closed_at")
  terminatedAt    DateTime? @map("terminated_at")

  // Settings
  requireSellerApproval Boolean @default(true) @map("require_seller_approval")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdByUserId String   @map("created_by_user_id")

  // Relationships
  buyers       DealBuyer[]
  participants DealParticipant[]
  activities   DealActivity2[]

  @@unique([companyId, codeName])
  @@index([companyId])
  @@index([status])
  @@map("deals")
}

// --------------------------------------------
// DEAL BUYER
// --------------------------------------------
// A buyer's participation in a specific deal.
// Links to canonical company for identity.

model DealBuyer {
  id String @id @default(cuid())

  // Deal association
  dealId String @map("deal_id")
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  // Link to canonical company (the buyer's identity)
  canonicalCompanyId String           @map("canonical_company_id")
  canonicalCompany   CanonicalCompany @relation(fields: [canonicalCompanyId], references: [id])

  // Deal-specific context
  tier           BuyerTier @default(B_TIER)
  buyerRationale String?   @map("buyer_rationale") // Why this buyer for this deal

  // Current stage
  currentStage   DealStage @default(IDENTIFIED) @map("current_stage")
  stageUpdatedAt DateTime  @default(now()) @map("stage_updated_at")

  // Seller approval (deal-specific)
  approvalStatus   ApprovalStatus @default(PENDING) @map("approval_status")
  approvalNote     String?        @map("approval_note")
  approvedAt       DateTime?      @map("approved_at")
  approvedByUserId String?        @map("approved_by_user_id")

  // Key milestone dates
  teaserSentAt  DateTime? @map("teaser_sent_at")
  ndaExecutedAt DateTime? @map("nda_executed_at")
  cimAccessAt   DateTime? @map("cim_access_at")
  ioiReceivedAt DateTime? @map("ioi_received_at")
  loiReceivedAt DateTime? @map("loi_received_at")
  closedAt      DateTime? @map("closed_at")
  exitedAt      DateTime? @map("exited_at")
  exitReason    String?   @map("exit_reason")

  // Financial tracking
  ioiAmount        Decimal?  @map("ioi_amount") @db.Decimal(15, 2)
  ioiDeadline      DateTime? @map("ioi_deadline")
  loiAmount        Decimal?  @map("loi_amount") @db.Decimal(15, 2)
  loiDeadline      DateTime? @map("loi_deadline")
  exclusivityStart DateTime? @map("exclusivity_start")
  exclusivityEnd   DateTime? @map("exclusivity_end")

  // Internal notes (not visible to seller)
  internalNotes String?  @map("internal_notes")
  tags          String[]

  // Quality assessment
  qualityScore  Int? @map("quality_score") // 1 (best) to 5 (worst)

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdByUserId String   @map("created_by_user_id")

  // Relationships
  contacts      DealContact[]
  participants  DealParticipant[]
  stageHistory  DealStageHistory2[]
  activities    DealActivity2[]
  documents     DealDocument2[]
  meetings      DealMeeting2[]
  emailAttempts EmailAttempt[]

  @@unique([dealId, canonicalCompanyId]) // One record per company per deal
  @@index([dealId, currentStage])
  @@index([dealId, approvalStatus])
  @@index([canonicalCompanyId])
  @@map("deal_buyers")
}

// --------------------------------------------
// DEAL CONTACT
// --------------------------------------------
// A contact's participation in a specific deal buyer.
// Links to canonical person for identity.

model DealContact {
  id String @id @default(cuid())

  // Deal buyer association
  dealBuyerId String    @map("deal_buyer_id")
  dealBuyer   DealBuyer @relation(fields: [dealBuyerId], references: [id], onDelete: Cascade)

  // Link to canonical person
  canonicalPersonId String          @map("canonical_person_id")
  canonicalPerson   CanonicalPerson @relation(fields: [canonicalPersonId], references: [id])

  // Deal-specific role
  role      BuyerContactRole @default(DEAL_LEAD)
  isPrimary Boolean          @default(false) @map("is_primary")

  // VDR access (links to existing DataRoomAccess)
  dataRoomAccessId   String?         @unique @map("data_room_access_id")
  dataRoomAccess     DataRoomAccess? @relation(fields: [dataRoomAccessId], references: [id])
  vdrAccessLevel     VDRAccessLevel? @map("vdr_access_level")
  vdrAccessGrantedAt DateTime?       @map("vdr_access_granted_at")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([dealBuyerId, canonicalPersonId]) // One record per person per buyer
  @@index([canonicalPersonId])
  @@map("deal_contacts")
}

// --------------------------------------------
// DEAL PARTICIPANT (unified contacts)
// --------------------------------------------
// Supports buyer-side, seller-side, and neutral contacts at the deal level.

model DealParticipant {
  id String @id @default(cuid())

  // Always linked to a deal
  dealId String @map("deal_id")
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  // Optional buyer link (null for seller-side / neutral)
  dealBuyerId String?    @map("deal_buyer_id")
  dealBuyer   DealBuyer? @relation(fields: [dealBuyerId], references: [id], onDelete: Cascade)

  // Canonical person
  canonicalPersonId String          @map("canonical_person_id")
  canonicalPerson   CanonicalPerson @relation(fields: [canonicalPersonId], references: [id])

  // Classification
  side      ParticipantSide @default(SELLER)
  role      ParticipantRole @default(OTHER)
  isPrimary Boolean         @default(false) @map("is_primary")

  // Simplified category
  category    String?  @map("category")      // PROSPECT, MANAGEMENT, ADVISOR, OTHER
  description String?  @map("description")   // Free text: "patents attorney", "CPA", etc.
  notes       String?  @map("notes")         // Multi-line freeform notes

  // VDR access
  dataRoomAccessId   String?         @unique @map("data_room_access_id")
  dataRoomAccess     DataRoomAccess? @relation(fields: [dataRoomAccessId], references: [id])
  vdrAccessLevel     VDRAccessLevel? @map("vdr_access_level")
  vdrAccessGrantedAt DateTime?       @map("vdr_access_granted_at")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([dealId, dealBuyerId, canonicalPersonId])
  @@index([dealId, side])
  @@index([dealBuyerId])
  @@index([canonicalPersonId])
  @@map("deal_participants")
}

// --------------------------------------------
// DEAL STAGE HISTORY (v2)
// --------------------------------------------
// Immutable audit trail of stage changes.

model DealStageHistory2 {
  id String @id @default(cuid())

  dealBuyerId String    @map("deal_buyer_id")
  dealBuyer   DealBuyer @relation(fields: [dealBuyerId], references: [id], onDelete: Cascade)

  fromStage DealStage? @map("from_stage")
  toStage   DealStage  @map("to_stage")
  note      String?

  changedAt       DateTime @default(now()) @map("changed_at")
  changedByUserId String   @map("changed_by_user_id")

  @@index([dealBuyerId, changedAt])
  @@map("deal_stage_history_v2")
}

// --------------------------------------------
// DEAL ACTIVITY (v2)
// --------------------------------------------
// Activity log for deal buyers.
//
// IMPORTANT: This model uses `performedAt` (NOT `createdAt`) for the activity timestamp.
// REQUIRED FIELDS when creating:
//   - performedByUserId: User ID who performed the action (use 'system' for automated actions)
//   - performedAt: Defaults to now(), but can be set explicitly for backdated activities
//
// Common pitfall: Do not rely on a `createdAt` field - it does not exist on this model.

model DealActivity2 {
  id String @id @default(cuid())

  // Can be linked to deal buyer OR deal directly
  dealBuyerId String?    @map("deal_buyer_id")
  dealBuyer   DealBuyer? @relation(fields: [dealBuyerId], references: [id], onDelete: Cascade)

  dealId String @map("deal_id")
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  // Activity details
  activityType ActivityType     @map("activity_type")
  subject      String
  description  String?
  outcome      ActivityOutcome?

  // Related entities
  personId   String?          @map("person_id")
  person     CanonicalPerson? @relation(fields: [personId], references: [id])
  documentId String?          @map("document_id")
  meetingId  String?          @map("meeting_id")

  // Metadata (flexible JSON for activity-specific data)
  metadata Json?

  // Timestamps
  performedAt       DateTime @default(now()) @map("performed_at")
  performedByUserId String   @map("performed_by_user_id")

  @@index([dealBuyerId, performedAt])
  @@index([dealId, performedAt])
  @@index([activityType])
  @@map("deal_activities_v2")
}

// --------------------------------------------
// DEAL DOCUMENT (v2)
// --------------------------------------------

model DealDocument2 {
  id String @id @default(cuid())

  dealBuyerId String    @map("deal_buyer_id")
  dealBuyer   DealBuyer @relation(fields: [dealBuyerId], references: [id], onDelete: Cascade)

  documentType DealDocumentType @map("document_type")
  name         String
  description  String?

  // File info
  filePath String? @map("file_path")
  fileName String? @map("file_name")
  fileSize Int?    @map("file_size")
  mimeType String? @map("mime_type")

  // Tracking
  receivedAt DateTime? @map("received_at")
  sentAt     DateTime? @map("sent_at")

  // Timestamps
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  uploadedByUserId String   @map("uploaded_by_user_id")

  @@index([dealBuyerId, documentType])
  @@map("deal_documents_v2")
}

// --------------------------------------------
// DEAL MEETING (v2)
// --------------------------------------------

model DealMeeting2 {
  id String @id @default(cuid())

  dealBuyerId String    @map("deal_buyer_id")
  dealBuyer   DealBuyer @relation(fields: [dealBuyerId], references: [id], onDelete: Cascade)

  meetingType MeetingType @map("meeting_type")
  title       String
  description String?

  // Scheduling
  scheduledAt DateTime @map("scheduled_at")
  duration    Int? // minutes
  location    String?
  meetingLink String?  @map("meeting_link")

  // Status
  status      MeetingStatus @default(SCHEDULED)
  completedAt DateTime?     @map("completed_at")
  cancelledAt DateTime?     @map("cancelled_at")

  // Content
  notes     String?
  attendees Json? // Array of attendee info

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdByUserId String   @map("created_by_user_id")

  @@index([dealBuyerId, scheduledAt])
  @@index([status])
  @@map("deal_meetings_v2")
}

// --------------------------------------------
// EMAIL ATTEMPT
// --------------------------------------------
// Tracks outreach emails for a deal buyer.

model EmailAttempt {
  id String @id @default(cuid())

  dealBuyerId String    @map("deal_buyer_id")
  dealBuyer   DealBuyer @relation(fields: [dealBuyerId], references: [id], onDelete: Cascade)

  // Recipient
  personId String          @map("person_id")
  person   CanonicalPerson @relation(fields: [personId], references: [id])
  toEmail  String          @map("to_email")

  // Email content
  subject      String
  templateUsed String? @map("template_used")

  // Tracking timestamps
  sentAt       DateTime? @map("sent_at")
  deliveredAt  DateTime? @map("delivered_at")
  openedAt     DateTime? @map("opened_at")
  clickedAt    DateTime? @map("clicked_at")
  repliedAt    DateTime? @map("replied_at")
  bouncedAt    DateTime? @map("bounced_at")
  bounceReason String?   @map("bounce_reason")

  // Status
  status EmailStatus @default(DRAFT)

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  createdByUserId String   @map("created_by_user_id")

  @@index([dealBuyerId])
  @@index([personId])
  @@index([status])
  @@map("email_attempts")
}

// ============================================
// CONTACT SYSTEM ENUMS
// ============================================

enum DataQuality {
  PROVISIONAL // Just entered, not verified
  SUGGESTED // System suggested match, awaiting confirmation
  VERIFIED // Human verified
  ENRICHED // Third-party data added
}

enum CompanyGroupType {
  PE_FAMILY // PE firm + portfolio companies
  CONGLOMERATE // Corporate parent + subsidiaries
  ALLIANCE // Strategic alliance members
  OTHER
}

enum CompanyGroupRelationship {
  PARENT
  SUBSIDIARY
  PORTFOLIO_COMPANY
  FUND
  AFFILIATE
  MEMBER
}

enum DuplicateEntityType {
  COMPANY
  PERSON
}

enum DuplicateStatus {
  PENDING
  RESOLVED
  SKIPPED
}

enum DuplicateResolution {
  MERGED
  NOT_DUPLICATE
  SKIPPED
}

enum DealStatus {
  ACTIVE
  CLOSED
  TERMINATED
  ON_HOLD
}

enum ApprovalStatus {
  PENDING // Awaiting seller review
  APPROVED // Cleared for outreach
  HOLD // Temporarily paused
  DENIED // Seller rejected
}

enum VDRAccessLevel {
  NONE
  TEASER
  POST_NDA
  LEVEL_2
  LEVEL_3
  FULL
}

enum ActivityType {
  EMAIL_SENT
  EMAIL_RECEIVED
  CALL_OUTBOUND
  CALL_INBOUND
  MEETING_SCHEDULED
  MEETING_COMPLETED
  MEETING_CANCELLED
  NOTE_ADDED
  STAGE_CHANGED
  DOCUMENT_SENT
  DOCUMENT_RECEIVED
  VDR_ACCESS_GRANTED
  VDR_ACCESS_REVOKED
  APPROVAL_REQUESTED
  APPROVAL_GRANTED
  APPROVAL_DENIED
}

enum ActivityOutcome {
  POSITIVE // Interest expressed
  NEUTRAL // No clear signal
  NEGATIVE // Declined / not interested
  NO_RESPONSE // Awaiting response
}

enum MeetingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum EmailStatus {
  DRAFT
  SCHEDULED
  SENT
  DELIVERED
  OPENED
  CLICKED
  REPLIED
  BOUNCED
  FAILED
}

// ===========================================
// Operations Diagnosis Models
// ===========================================

enum DiagnosisSubcategory {
  SCALABILITY
  TECHNOLOGY
  VENDOR
  RETENTION
}

enum WeeklyProgressStatus {
  DIAGNOSTIC
  TASKS
  REASSESSMENT
  COMPLETED
  SKIPPED
}

enum OperationsTaskStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  NOT_APPLICABLE
}

model CompanyDiagnosticQuestions {
  id          String                       @id @default(cuid())
  companyId   String                       @map("company_id")
  subcategory DiagnosisSubcategory
  questions   Json // Array of generated questions
  createdAt   DateTime                     @default(now()) @map("created_at")
  company     Company                      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  responses   CompanyDiagnosticResponses[]

  @@unique([companyId, subcategory])
  @@index([companyId])
  @@map("company_diagnostic_questions")
}

model CompanyDiagnosticResponses {
  id                String                     @id @default(cuid())
  companyId         String                     @map("company_id")
  questionSetId     String                     @map("question_set_id")
  subcategory       DiagnosisSubcategory
  responses         Json // Array of {question_id, selected_option_id, drivers[], severity}
  identifiedDrivers Json?                      @map("identified_drivers") // Aggregated drivers with severity
  scoreBefore       Int?                       @map("score_before")
  scoreAfter        Int?                       @map("score_after")
  isReassessment    Boolean                    @default(false) @map("is_reassessment")
  createdAt         DateTime                   @default(now()) @map("created_at")
  company           Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  questionSet       CompanyDiagnosticQuestions @relation(fields: [questionSetId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([questionSetId])
  @@map("company_diagnostic_responses")
}

model CompanyOperationsTask {
  id          String               @id @default(cuid())
  companyId   String               @map("company_id")
  subcategory DiagnosisSubcategory
  weekNumber  Int                  @map("week_number")

  // AI-generated content
  title           String
  description     String
  doneDefinition  String   @map("done_definition")
  benchmarkTarget String?  @map("benchmark_target")
  delegateTo      String?  @map("delegate_to")
  estimatedEffort String?  @map("estimated_effort")
  whyThisMatters  String?  @map("why_this_matters")
  improvesDrivers String[] @map("improves_drivers")

  // Status tracking
  status          OperationsTaskStatus @default(NOT_STARTED)
  completedAt     DateTime?            @map("completed_at")
  completionNotes String?              @map("completion_notes")
  hitBenchmark    Boolean?             @map("hit_benchmark")
  naReason        String?              @map("na_reason")

  // Metadata
  displayOrder Int      @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, weekNumber])
  @@index([companyId, subcategory])
  @@map("company_operations_tasks")
}

model CompanyWeeklyProgress {
  id          String               @id @default(cuid())
  companyId   String               @map("company_id")
  weekNumber  Int                  @map("week_number")
  subcategory DiagnosisSubcategory

  // Timestamps
  diagnosticStartedAt     DateTime? @map("diagnostic_started_at")
  diagnosticCompletedAt   DateTime? @map("diagnostic_completed_at")
  tasksGeneratedAt        DateTime? @map("tasks_generated_at")
  tasksCompletedAt        DateTime? @map("tasks_completed_at")
  reassessmentCompletedAt DateTime? @map("reassessment_completed_at")

  // Scores
  scoreBefore   Int?     @map("score_before")
  scoreAfter    Int?     @map("score_after")
  valueUnlocked Decimal? @map("value_unlocked") @db.Decimal(10, 2)

  // Status
  status    WeeklyProgressStatus @default(DIAGNOSTIC)
  createdAt DateTime             @default(now()) @map("created_at")
  company   Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, weekNumber])
  @@index([companyId])
  @@map("company_weekly_progress")
}

model AIGenerationLog {
  id             String   @id @default(cuid())
  companyId      String?  @map("company_id")
  generationType String   @map("generation_type") // 'clarifying_questions', 'profile', 'diagnostic_questions', 'tasks'
  inputData      Json?    @map("input_data")
  outputData     Json?    @map("output_data")
  modelUsed      String?  @map("model_used")
  inputTokens    Int?     @map("input_tokens")
  outputTokens   Int?     @map("output_tokens")
  latencyMs      Int?     @map("latency_ms")
  errorMessage   String?  @map("error_message")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([companyId])
  @@index([generationType])
  @@map("ai_generation_logs")
}

// â”€â”€â”€ Signal Architecture & Value Ledger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum SignalChannel {
  PROMPTED_DISCLOSURE
  TASK_GENERATED
  TIME_DECAY
  EXTERNAL
  ADVISOR
}

enum SignalSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SignalResolutionStatus {
  OPEN
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  DISMISSED
  EXPIRED
}

enum LedgerEventType {
  TASK_COMPLETED
  REGRESSION_DETECTED
  BENCHMARK_SHIFT
  NEW_DATA_CONNECTED
  SIGNAL_CONFIRMED
  DRIFT_DETECTED
  ASSESSMENT_COMPLETED
  SNAPSHOT_CREATED
}

model Signal {
  id                  String                 @id @default(cuid())
  companyId           String                 @map("company_id")
  channel             SignalChannel
  category            BriCategory?
  eventType           String                 @map("event_type")
  severity            SignalSeverity         @default(MEDIUM)
  confidence          ConfidenceLevel        @default(UNCERTAIN)
  title               String
  description         String?
  rawData             Json?                  @map("raw_data")
  userConfirmed       Boolean                @default(false) @map("user_confirmed")
  confirmedAt         DateTime?              @map("confirmed_at")
  confirmedByUserId   String?                @map("confirmed_by_user_id")
  resolutionStatus    SignalResolutionStatus @default(OPEN) @map("resolution_status")
  resolvedAt          DateTime?              @map("resolved_at")
  resolvedByUserId    String?                @map("resolved_by_user_id")
  resolutionNotes     String?                @map("resolution_notes")
  estimatedValueImpact Decimal?             @map("estimated_value_impact") @db.Decimal(15, 2)
  estimatedBriImpact  Decimal?              @map("estimated_bri_impact") @db.Decimal(5, 4)
  sourceType          String?                @map("source_type")
  sourceId            String?                @map("source_id")
  createdAt           DateTime               @default(now()) @map("created_at")
  updatedAt           DateTime               @updatedAt @map("updated_at")
  expiresAt           DateTime?              @map("expires_at")
  company             Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  confirmedBy         User?                  @relation("SignalConfirmer", fields: [confirmedByUserId], references: [id])
  ledgerEntries       ValueLedgerEntry[]

  @@index([companyId, createdAt])
  @@index([companyId, resolutionStatus])
  @@index([companyId, channel])
  @@index([companyId, severity])
  @@map("signals")
}

model ValueLedgerEntry {
  id                  String          @id @default(cuid())
  companyId           String          @map("company_id")
  eventType           LedgerEventType @map("event_type")
  category            BriCategory?
  deltaValueRecovered Decimal         @default(0) @map("delta_value_recovered") @db.Decimal(15, 2)
  deltaValueAtRisk    Decimal         @default(0) @map("delta_value_at_risk") @db.Decimal(15, 2)
  deltaBri            Decimal?        @map("delta_bri") @db.Decimal(5, 4)
  briScoreBefore      Decimal?        @map("bri_score_before") @db.Decimal(5, 4)
  briScoreAfter       Decimal?        @map("bri_score_after") @db.Decimal(5, 4)
  valuationBefore     Decimal?        @map("valuation_before") @db.Decimal(15, 2)
  valuationAfter      Decimal?        @map("valuation_after") @db.Decimal(15, 2)
  confidenceLevel     ConfidenceLevel @default(SOMEWHAT_CONFIDENT) @map("confidence_level")
  narrativeSummary    String          @map("narrative_summary")
  signalId            String?         @map("signal_id")
  taskId              String?         @map("task_id")
  snapshotId          String?         @map("snapshot_id")
  metadata            Json?
  occurredAt          DateTime        @default(now()) @map("occurred_at")
  createdAt           DateTime        @default(now()) @map("created_at")
  company             Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  signal              Signal?         @relation(fields: [signalId], references: [id], onDelete: SetNull)
  task                Task?           @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([companyId, occurredAt])
  @@index([companyId, eventType])
  @@index([signalId])
  @@index([taskId])
  @@map("value_ledger_entries")
}

model DisclosurePromptSet {
  id           String               @id @default(cuid())
  companyId    String               @map("company_id")
  scheduledFor DateTime             @map("scheduled_for")
  expiresAt    DateTime             @map("expires_at")
  questions    Json
  completedAt  DateTime?            @map("completed_at")
  skippedAt    DateTime?            @map("skipped_at")
  createdAt    DateTime             @default(now()) @map("created_at")
  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  responses    DisclosureResponse[]

  @@index([companyId, scheduledFor])
  @@map("disclosure_prompt_sets")
}

model DisclosureResponse {
  id              String              @id @default(cuid())
  promptSetId     String              @map("prompt_set_id")
  companyId       String              @map("company_id")
  questionKey     String              @map("question_key")
  questionText    String              @map("question_text")
  briCategory     BriCategory         @map("bri_category")
  answer          Boolean
  followUpAnswer  String?             @map("follow_up_answer")
  respondedAt     DateTime            @default(now()) @map("responded_at")
  signalCreated   Boolean             @default(false) @map("signal_created")
  promptSet       DisclosurePromptSet @relation(fields: [promptSetId], references: [id], onDelete: Cascade)

  @@index([promptSetId])
  @@index([companyId])
  @@map("disclosure_responses")
}

// â”€â”€â”€ Weekly Check-In â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model WeeklyCheckIn {
  id                  String    @id @default(cuid())
  companyId           String    @map("company_id")
  weekOf              DateTime  @map("week_of")
  expiresAt           DateTime  @map("expires_at")
  taskStatus          String?   @map("task_status")
  teamChanges         Boolean?  @map("team_changes")
  teamChangesNote     String?   @map("team_changes_note")
  customerChanges     Boolean?  @map("customer_changes")
  customerChangesNote String?   @map("customer_changes_note")
  confidenceRating    Int?      @map("confidence_rating")
  additionalNotes     String?   @map("additional_notes")
  completedAt         DateTime? @map("completed_at")
  skippedAt           DateTime? @map("skipped_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, weekOf])
  @@index([companyId, weekOf])
  @@map("weekly_check_ins")
}

// â”€â”€â”€ External Signal Sources â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model ExternalSignalSource {
  id          String    @id @default(cuid())
  name        String
  sourceType  String    @map("source_type")
  state       String?
  apiUrl      String?   @map("api_url")
  isActive    Boolean   @default(false) @map("is_active")
  lastChecked DateTime? @map("last_checked")
  metadata    Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("external_signal_sources")
}

// â”€â”€â”€ Accountability Partner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model AccountabilityPartner {
  id              String    @id @default(cuid())
  companyId       String    @unique @map("company_id")
  email           String
  name            String?
  inviteToken     String    @unique @default(cuid()) @map("invite_token")
  accessToken     String    @unique @default(cuid()) @map("access_token")
  invitedByUserId String    @map("invited_by_user_id")
  acceptedAt      DateTime? @map("accepted_at")
  lastNudgeAt     DateTime? @map("last_nudge_at")
  lastEmailSentAt DateTime? @map("last_email_sent_at")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invitedBy       User      @relation(fields: [invitedByUserId], references: [id])

  @@index([accessToken])
  @@index([inviteToken])
  @@map("accountability_partners")
}

// Company Dossier - Adaptive Intelligence Engine
model CompanyDossier {
  id            String           @id @default(cuid())
  companyId     String           @map("company_id")
  version       Int              @default(1)
  buildType     DossierBuildType @map("build_type")
  triggerEvent  String           @map("trigger_event")
  triggerSource String?          @map("trigger_source")
  content       Json
  contentHash   String           @map("content_hash")
  sections      String[]
  previousId    String?          @map("previous_id")
  isCurrent     Boolean          @default(true) @map("is_current")
  createdAt     DateTime         @default(now()) @map("created_at")
  company       Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  previous      CompanyDossier?  @relation("DossierVersions", fields: [previousId], references: [id])
  newerVersions CompanyDossier[] @relation("DossierVersions")

  @@index([companyId, isCurrent])
  @@map("company_dossiers")
}

enum DossierBuildType {
  FULL
  INCREMENTAL
}

// Email notification system
model EmailPreference {
  id                String    @id @default(cuid())
  userId            String    @unique @map("user_id")
  frequency         String    @default("WEEKLY") // REALTIME, DAILY, WEEKLY, MONTHLY, NEVER
  enabledTypes      String[]  @default([]) @map("enabled_types")
  unsubscribedAt    DateTime? @map("unsubscribed_at")
  unsubscribeToken  String?   @unique @map("unsubscribe_token")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_preferences")
}

model EmailLog {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  companyId      String?   @map("company_id")
  emailType      String    @map("email_type")
  recipientEmail String    @map("recipient_email")
  subject        String
  success        Boolean
  error          String?
  sentAt         DateTime  @default(now()) @map("sent_at")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  company        Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId, emailType, sentAt])
  @@index([companyId])
  @@map("email_logs")
}
