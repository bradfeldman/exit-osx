// Exit OSx Database Schema
// Prisma ORM with Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEAM_LEADER
  MEMBER
  VIEWER
}

// Functional categories for task assignment defaults
enum FunctionalCategory {
  OWNER // Business owner - for owner preparedness tasks
  FINANCE // CFO, accountant, finance team
  OPERATIONS // COO, operations manager
  HR // HR director, people operations
  LEGAL // Legal counsel, compliance
  SALES_MARKETING // Sales director, marketing lead
  IT // IT director, tech lead
  EXTERNAL // External advisor, consultant
}

enum RevenueSizeCategory {
  UNDER_500K
  FROM_500K_TO_1M
  FROM_1M_TO_3M
  FROM_3M_TO_10M
  FROM_10M_TO_25M
  OVER_25M
}

enum RevenueModelType {
  PROJECT_BASED
  TRANSACTIONAL
  RECURRING_CONTRACTS
  SUBSCRIPTION_SAAS
}

enum GrossMarginCategory {
  LOW
  MODERATE
  GOOD
  EXCELLENT
}

enum LaborIntensityLevel {
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

enum AssetIntensityLevel {
  ASSET_LIGHT
  MODERATE
  ASSET_HEAVY
}

enum OwnerInvolvementLevel {
  MINIMAL
  LOW
  MODERATE
  HIGH
  CRITICAL
}

enum ConfidenceLevel {
  UNCERTAIN
  SOMEWHAT_CONFIDENT
  CONFIDENT
  VERIFIED
}

enum BriCategory {
  FINANCIAL
  TRANSFERABILITY
  OPERATIONAL
  MARKET
  LEGAL_TAX
  PERSONAL
}

enum ActionItemType {
  TYPE_I_EVIDENCE
  TYPE_II_DOCUMENTATION
  TYPE_III_OPERATIONAL
  TYPE_IV_INSTITUTIONALIZE
  TYPE_V_RISK_REDUCTION
  TYPE_VI_ALIGNMENT
  TYPE_VII_READINESS
  TYPE_VIII_SIGNALING
  TYPE_IX_OPTIONS
  TYPE_X_DEFER
}

enum EffortLevel {
  MINIMAL
  LOW
  MODERATE
  HIGH
  MAJOR
}

enum ComplexityLevel {
  SIMPLE
  MODERATE
  COMPLEX
  STRATEGIC
}

// Impact level for task prioritization (25-level matrix)
enum ImpactLevel {
  NONE
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

// Difficulty level for task prioritization (25-level matrix)
enum DifficultyLevel {
  NONE
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  BLOCKED
  COMPLETED
  DEFERRED
  CANCELLED
  NOT_APPLICABLE
}

enum SprintPriority {
  BIG_ROCK
  SAND
  WATER
}

enum SprintStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum AssessmentType {
  INITIAL
  QUARTERLY_CHECK_IN
  AD_HOC
}

enum IssueTier {
  CRITICAL // Deal killers - 60% of value gap
  SIGNIFICANT // Major value impact - 30% of value gap
  OPTIMIZATION // Nice to have - 10% of value gap
}

enum PeriodType {
  ANNUAL
  QUARTERLY
  MONTHLY
}

enum Quarter {
  Q1
  Q2
  Q3
  Q4
}

// ============================================
// PROJECT ASSESSMENT ENUMS
// ============================================

enum QuestionImpact {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum BuyerSensitivity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum StrategyType {
  FULL_FIX
  PARTIAL_MITIGATION
  RISK_ACCEPTANCE
}

enum OwnerRole {
  FOUNDER
  CFO_FINANCE
  OPS_LEADER
  SALES_MKTG
  HR_PEOPLE
  LEGAL_COMPLIANCE
  IT_SECURITY
  ADVISOR
}

enum Timebox {
  IMMEDIATE_0_30
  NEAR_30_90
  LONG_90_365
}

enum ProjectAssessmentStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum DataRoomCategory {
  FINANCIAL
  LEGAL
  OPERATIONS
  CUSTOMERS
  EMPLOYEES
  IP
  CUSTOM
  TASK_PROOF // Documents uploaded as proof of task completion
  // Additional categories for enhanced data room
  TAX
  SALES_MARKETING
  TECHNOLOGY
  REAL_ESTATE
  ENVIRONMENTAL
  INSURANCE
  CORPORATE
}

// Deal stage for data room access control
enum DataRoomStage {
  PREPARATION // Internal prep, no external access
  TEASER // Limited docs for initial interest
  POST_NDA // Management presentation level
  DUE_DILIGENCE // Full DD access
  CLOSED // Deal closed, archive mode
}

// Access levels for data room users
enum DataRoomAccessLevel {
  VIEWER // View only
  DOWNLOADER // View + download
  CONTRIBUTOR // View + download + upload
  ADMIN // Full control
}

// Actions tracked in data room activity log
enum DataRoomAction {
  VIEWED_FOLDER
  VIEWED_DOCUMENT
  DOWNLOADED_DOCUMENT
  UPLOADED_DOCUMENT
  DELETED_DOCUMENT
  UPDATED_DOCUMENT
  CREATED_FOLDER
  DELETED_FOLDER
  GRANTED_ACCESS
  REVOKED_ACCESS
  ASKED_QUESTION
  ANSWERED_QUESTION
  EXPORTED_REPORT
  STAGE_CHANGED
}

enum UpdateFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
  AS_NEEDED
  ONE_TIME
}

enum DocumentStatus {
  CURRENT
  NEEDS_UPDATE
  OVERDUE
}

// ============================================
// CORE ENTITIES
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users     OrganizationUser[]
  companies Company[]
  invites   OrganizationInvite[]

  @@map("organizations")
}

model User {
  id           String   @id @default(cuid())
  authId       String   @unique @map("auth_id") // Supabase Auth UUID
  email        String   @unique
  name         String?
  avatarUrl    String?  @map("avatar_url")
  isSuperAdmin Boolean  @default(false) @map("is_super_admin") // System-wide super admin (can see Developer/Global sections)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  organizations    OrganizationUser[]
  taskAssignments  TaskAssignment[]
  primaryTasks     Task[]                @relation("TaskPrimaryAssignee")
  taskInvitesSent  TaskInvite[]          @relation("TaskInvitesSent")
  sentInvites      OrganizationInvite[]
  createdSnapshots ValuationSnapshot[]
  consents         UserConsent[]
  deletionRequests DataDeletionRequest[]
  dataExports      DataExportRequest[]
  advisorProfile   AdvisorProfile?

  // Admin dashboard relations
  auditLogs              AuditLog[]             @relation("AuditActor")
  impersonationsAsAdmin  ImpersonationSession[] @relation("ImpersonationAdmin")
  impersonationsAsTarget ImpersonationSession[] @relation("ImpersonationTarget")
  ticketsCreated         SupportTicket[]        @relation("TicketUser")
  ticketsAssigned        SupportTicket[]        @relation("TicketAssignee")
  ticketMessages         TicketMessage[]

  // Data room
  documentsUploaded        DataRoomDocument[]        @relation("DocumentUploader")
  documentVersionsUploaded DataRoomDocumentVersion[]
  dataRoomNotifications    DataRoomNotification[]    @relation("NotificationRecipient")

  // Two-factor authentication
  twoFactorAuth TwoFactorAuth?
  sessions      UserSession[]

  @@map("users")
}

// Two-Factor Authentication settings
model TwoFactorAuth {
  id                String   @id @default(cuid())
  userId            String   @unique @map("user_id")
  encryptedSecret   String   @map("encrypted_secret") // AES-256-GCM encrypted TOTP secret
  backupCodes       String[] @map("backup_codes") // Hashed backup codes
  usedBackupCodes   Int[]    @default([]) @map("used_backup_codes") // Indices of used backup codes
  enabled           Boolean  @default(false)
  verifiedAt        DateTime? @map("verified_at") // When 2FA was first verified
  lastUsedAt        DateTime? @map("last_used_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_auth")
}

// User sessions for session management
model UserSession {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  sessionToken String    @unique @map("session_token") // Supabase session ID or custom token
  userAgent    String?   @map("user_agent")
  ipAddress    String?   @map("ip_address")
  location     String?   // Approximate location from IP
  deviceType   String?   @map("device_type") // desktop, mobile, tablet
  browser      String?   // Browser name and version
  os           String?   // Operating system
  lastActiveAt DateTime  @default(now()) @map("last_active_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  expiresAt    DateTime  @map("expires_at")
  revokedAt    DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
  @@index([sessionToken])
  @@map("user_sessions")
}

model OrganizationUser {
  id                   String               @id @default(cuid())
  organizationId       String               @map("organization_id")
  userId               String               @map("user_id")
  role                 UserRole             @default(MEMBER)
  functionalCategories FunctionalCategory[] @map("functional_categories") // Functional areas for task defaults
  joinedAt             DateTime             @default(now()) @map("joined_at")
  // Role-based permissions
  roleTemplateId       String?              @map("role_template_id")
  isExternalAdvisor    Boolean              @default(false) @map("is_external_advisor")

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleTemplate      RoleTemplate?      @relation(fields: [roleTemplateId], references: [id], onDelete: SetNull)
  customPermissions MemberPermission[]

  @@unique([organizationId, userId])
  @@map("organization_users")
}

model OrganizationInvite {
  id                   String               @id @default(cuid())
  organizationId       String               @map("organization_id")
  email                String
  role                 UserRole             @default(MEMBER)
  functionalCategories FunctionalCategory[] @map("functional_categories") // Pre-assigned functional areas
  invitedBy            String               @map("invited_by")
  token                String               @unique @default(cuid())
  expiresAt            DateTime             @map("expires_at")
  acceptedAt           DateTime?            @map("accepted_at")
  createdAt            DateTime             @default(now()) @map("created_at")
  // Role-based permissions
  roleTemplateId       String?              @map("role_template_id")
  customPermissions    Json?                @map("custom_permissions") // Pre-configured permission overrides
  isExternalAdvisor    Boolean              @default(false) @map("is_external_advisor")

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter      User          @relation(fields: [invitedBy], references: [id])
  roleTemplate RoleTemplate? @relation(fields: [roleTemplateId], references: [id], onDelete: SetNull)

  @@unique([organizationId, email])
  @@map("organization_invites")
}

model Company {
  id                 String    @id @default(cuid())
  organizationId     String    @map("organization_id")
  name               String
  icbIndustry        String    @map("icb_industry")
  icbSuperSector     String    @map("icb_super_sector")
  icbSector          String    @map("icb_sector")
  icbSubSector       String    @map("icb_sub_sector")
  annualRevenue      Decimal   @map("annual_revenue") @db.Decimal(15, 2)
  annualEbitda       Decimal   @map("annual_ebitda") @db.Decimal(15, 2)
  ownerCompensation  Decimal   @default(0) @map("owner_compensation") @db.Decimal(15, 2)
  briWeights         Json?     @map("bri_weights") // Company-specific BRI category weights (null = use global defaults)
  fiscalYearEndMonth Int       @default(12) @map("fiscal_year_end_month") // 1-12, defaults to December
  fiscalYearEndDay   Int       @default(31) @map("fiscal_year_end_day") // 1-31, defaults to 31st
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at") // Soft delete - null if active, timestamp if deleted
  deleteReason       String?   @map("delete_reason") // Optional reason for deletion

  organization       Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  coreFactors        CoreFactors?
  ebitdaAdjustments  EbitdaAdjustment[]
  assessments        Assessment[]
  valuationSnapshots ValuationSnapshot[]
  tasks              Task[]
  sprints            Sprint[]
  financialPeriods   FinancialPeriod[]
  dataRoomDocuments  DataRoomDocument[]
  dataRoom           DataRoom?
  dataRoomTags       DataRoomTag[]
  integrations       Integration[]
  // Project Assessment relations
  projectAssessments ProjectAssessment[]
  questionPriorities CompanyQuestionPriority[]
  // DCF Analysis
  dcfAssumptions     DCFAssumptions?
  // Personal Financials
  personalFinancials PersonalFinancials?
  // Deal Tracker
  prospectiveBuyers  ProspectiveBuyer[]
  buyerProspects     BuyerProspect[]
  prospectImports    ProspectImportBatch[]

  @@map("companies")
}

// ============================================
// ROLE-BASED PERMISSIONS
// ============================================

// Role templates (system + custom)
model RoleTemplate {
  id                 String   @id @default(cuid())
  slug               String   @unique // 'cpa', 'attorney', 'owner', etc.
  name               String
  description        String?
  icon               String? // Icon name for UI display
  defaultPermissions Json // { "financials.statements:view": true, ... }
  isBuiltIn          Boolean  @default(true) @map("is_built_in")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  members OrganizationUser[]
  invites OrganizationInvite[]

  @@map("role_templates")
}

// Per-member permission overrides
model MemberPermission {
  id                 String  @id @default(cuid())
  organizationUserId String  @map("organization_user_id")
  permission         String // "financials.dcf:edit"
  granted            Boolean // true = allow, false = deny

  organizationUser OrganizationUser @relation(fields: [organizationUserId], references: [id], onDelete: Cascade)

  @@unique([organizationUserId, permission])
  @@map("member_permissions")
}

// Advisor profile for multi-client portal
model AdvisorProfile {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  firmName  String?  @map("firm_name")
  specialty String? // CPA, Attorney, Wealth Advisor, M&A Advisor, etc.
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("advisor_profiles")
}

// Personal financials (owner personal financial data)
model PersonalFinancials {
  id                  String   @id @default(cuid())
  companyId           String   @unique @map("company_id")
  retirementAccounts  Json?    @map("retirement_accounts") // Array of { name, type, balance, institution }
  totalRetirement     Decimal? @map("total_retirement") @db.Decimal(15, 2)
  personalAssets      Json?    @map("personal_assets") // Array of { name, type, value }
  personalLiabilities Json?    @map("personal_liabilities") // Array of { name, type, balance, rate }
  netWorth            Decimal? @map("net_worth") @db.Decimal(15, 2)
  exitGoalAmount      Decimal? @map("exit_goal_amount") @db.Decimal(15, 2)
  retirementAge       Int?     @map("retirement_age")
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("personal_financials")
}

model EbitdaAdjustment {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  periodId    String?  @map("period_id")
  description String
  amount      Decimal  @db.Decimal(15, 2)
  type        String // ADD_BACK or DEDUCTION
  frequency   String   @default("ANNUAL") // MONTHLY or ANNUAL - determines how amount is annualized
  createdAt   DateTime @default(now()) @map("created_at")

  company Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  period  FinancialPeriod? @relation(fields: [periodId], references: [id], onDelete: SetNull)

  @@index([companyId, periodId])
  @@map("ebitda_adjustments")
}

model CoreFactors {
  id                  String                @id @default(cuid())
  companyId           String                @unique @map("company_id")
  revenueSizeCategory RevenueSizeCategory   @map("revenue_size_category")
  revenueModel        RevenueModelType      @map("revenue_model")
  grossMarginProxy    GrossMarginCategory   @map("gross_margin_proxy")
  laborIntensity      LaborIntensityLevel   @map("labor_intensity")
  assetIntensity      AssetIntensityLevel   @map("asset_intensity")
  ownerInvolvement    OwnerInvolvementLevel @map("owner_involvement")
  updatedAt           DateTime              @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("core_factors")
}

// ============================================
// ASSESSMENT & QUESTIONS
// ============================================

model Question {
  id              String      @id @default(cuid())
  briCategory     BriCategory @map("bri_category")
  issueTier       IssueTier   @default(OPTIMIZATION) @map("issue_tier") // CRITICAL, SIGNIFICANT, or OPTIMIZATION
  questionText    String      @map("question_text")
  helpText        String?     @map("help_text")
  buyerLogic      String?     @map("buyer_logic") @db.VarChar(200)
  displayOrder    Int         @map("display_order")
  maxImpactPoints Decimal     @map("max_impact_points") @db.Decimal(5, 2)
  isActive        Boolean     @default(true) @map("is_active")

  options   QuestionOption[]
  responses AssessmentResponse[]

  @@index([issueTier])
  @@map("questions")
}

model QuestionOption {
  id           String  @id @default(cuid())
  questionId   String  @map("question_id")
  optionText   String  @map("option_text")
  scoreValue   Decimal @map("score_value") @db.Decimal(3, 2) // 0.00 to 1.00
  displayOrder Int     @map("display_order")

  question           Question             @relation(fields: [questionId], references: [id], onDelete: Cascade)
  responses          AssessmentResponse[] @relation("SelectedOption")
  effectiveResponses AssessmentResponse[] @relation("EffectiveOption")
  tasksUpgradingFrom Task[]               @relation("TaskUpgradeFrom")
  tasksUpgradingTo   Task[]               @relation("TaskUpgradeTo")

  @@map("question_options")
}

model Assessment {
  id             String         @id @default(cuid())
  companyId      String         @map("company_id")
  assessmentType AssessmentType @map("assessment_type")
  completedAt    DateTime?      @map("completed_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  company   Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  responses AssessmentResponse[]

  @@map("assessments")
}

model AssessmentResponse {
  id                String          @id @default(cuid())
  assessmentId      String          @map("assessment_id")
  questionId        String          @map("question_id")
  selectedOptionId  String          @map("selected_option_id")
  effectiveOptionId String?         @map("effective_option_id") // Starts as selectedOptionId, upgraded by tasks
  confidenceLevel   ConfidenceLevel @map("confidence_level")
  notes             String?
  evidenceUploaded  Boolean         @default(false) @map("evidence_uploaded")
  evidenceUrls      String[]        @map("evidence_urls")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  assessment      Assessment      @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question        Question        @relation(fields: [questionId], references: [id])
  selectedOption  QuestionOption  @relation("SelectedOption", fields: [selectedOptionId], references: [id])
  effectiveOption QuestionOption? @relation("EffectiveOption", fields: [effectiveOptionId], references: [id])

  @@unique([assessmentId, questionId])
  @@map("assessment_responses")
}

// ============================================
// VALUATION
// ============================================

model ValuationSnapshot {
  id                   String   @id @default(cuid())
  companyId            String   @map("company_id")
  createdByUserId      String?  @map("created_by_user_id")
  adjustedEbitda       Decimal  @map("adjusted_ebitda") @db.Decimal(15, 2)
  industryMultipleLow  Decimal  @map("industry_multiple_low") @db.Decimal(4, 2)
  industryMultipleHigh Decimal  @map("industry_multiple_high") @db.Decimal(4, 2)
  coreScore            Decimal  @map("core_score") @db.Decimal(5, 4) // 0.0000 to 1.0000
  briScore             Decimal  @map("bri_score") @db.Decimal(5, 4)
  briFinancial         Decimal  @map("bri_financial") @db.Decimal(5, 4)
  briTransferability   Decimal  @map("bri_transferability") @db.Decimal(5, 4)
  briOperational       Decimal  @map("bri_operational") @db.Decimal(5, 4)
  briMarket            Decimal  @map("bri_market") @db.Decimal(5, 4)
  briLegalTax          Decimal  @map("bri_legal_tax") @db.Decimal(5, 4)
  briPersonal          Decimal  @map("bri_personal") @db.Decimal(5, 4)
  baseMultiple         Decimal  @map("base_multiple") @db.Decimal(4, 2)
  discountFraction     Decimal  @map("discount_fraction") @db.Decimal(5, 4)
  finalMultiple        Decimal  @map("final_multiple") @db.Decimal(4, 2)
  currentValue         Decimal  @map("current_value") @db.Decimal(15, 2)
  potentialValue       Decimal  @map("potential_value") @db.Decimal(15, 2)
  valueGap             Decimal  @map("value_gap") @db.Decimal(15, 2)
  alphaConstant        Decimal  @default(0.40) @map("alpha_constant") @db.Decimal(3, 2)
  snapshotReason       String?  @map("snapshot_reason")
  createdAt            DateTime @default(now()) @map("created_at")

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([companyId, createdAt])
  @@map("valuation_snapshots")
}

// ============================================
// TASKS & SPRINTS
// ============================================

model Task {
  id                   String          @id @default(cuid())
  companyId            String          @map("company_id")
  title                String
  description          String
  richDescription      Json?           @map("rich_description") // Structured rich task description
  actionType           ActionItemType  @map("action_type")
  briCategory          BriCategory     @map("bri_category")
  linkedQuestionId     String?         @map("linked_question_id")
  rawImpact            Decimal         @map("raw_impact") @db.Decimal(15, 2)
  normalizedValue      Decimal         @map("normalized_value") @db.Decimal(15, 2)
  effortLevel          EffortLevel     @map("effort_level")
  complexity           ComplexityLevel
  estimatedHours       Int?            @map("estimated_hours")
  // Issue tier tracking (for value allocation)
  issueTier            IssueTier?      @map("issue_tier") // Effective tier based on question + answer
  // Priority matrix fields (25-level prioritization)
  impactLevel          ImpactLevel     @default(MEDIUM) @map("impact_level")
  difficultyLevel      DifficultyLevel @default(MEDIUM) @map("difficulty_level")
  priorityRank         Int             @default(10) @map("priority_rank") // 1-25, lower = higher priority
  inActionPlan         Boolean         @default(false) @map("in_action_plan") // Whether task is visible in action plan
  status               TaskStatus      @default(PENDING)
  deferredUntil        DateTime?       @map("deferred_until")
  deferralReason       String?         @map("deferral_reason")
  blockedAt            DateTime?       @map("blocked_at")
  blockedReason        String?         @map("blocked_reason") // Why the task is blocked
  completedAt          DateTime?       @map("completed_at")
  completionNotes      String?         @map("completion_notes") // Notes about how task was completed
  sprintId             String?         @map("sprint_id")
  sprintPriority       SprintPriority? @map("sprint_priority")
  // Assignment and due date
  dueDate              DateTime?       @map("due_date")
  primaryAssigneeId    String?         @map("primary_assignee_id")
  // Answer Upgrade System fields
  upgradesFromOptionId String?         @map("upgrades_from_option_id")
  upgradesToOptionId   String?         @map("upgrades_to_option_id")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  company            Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sprint             Sprint?            @relation(fields: [sprintId], references: [id])
  assignments        TaskAssignment[]
  invites            TaskInvite[]
  primaryAssignee    User?              @relation("TaskPrimaryAssignee", fields: [primaryAssigneeId], references: [id], onDelete: SetNull)
  upgradesFromOption QuestionOption?    @relation("TaskUpgradeFrom", fields: [upgradesFromOptionId], references: [id])
  upgradesToOption   QuestionOption?    @relation("TaskUpgradeTo", fields: [upgradesToOptionId], references: [id])
  proofDocuments     DataRoomDocument[] @relation("TaskProofDocuments") // Proof of completion documents

  @@index([companyId, status])
  @@index([sprintId])
  @@index([primaryAssigneeId])
  @@index([primaryAssigneeId, status]) // Optimize: filter assigned tasks by status
  @@map("tasks")
}

model TaskAssignment {
  id         String   @id @default(cuid())
  taskId     String   @map("task_id")
  userId     String   @map("user_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@map("task_assignments")
}

model TaskInvite {
  id          String    @id @default(cuid())
  taskId      String    @map("task_id")
  email       String
  invitedById String    @map("invited_by_id")
  token       String    @unique @default(cuid())
  isPrimary   Boolean   @default(true) @map("is_primary") // Will become primary assignee when accepted
  expiresAt   DateTime  @map("expires_at")
  acceptedAt  DateTime? @map("accepted_at")
  declinedAt  DateTime? @map("declined_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  task      Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  invitedBy User @relation("TaskInvitesSent", fields: [invitedById], references: [id])

  @@unique([taskId, email])
  @@index([token])
  @@index([email])
  @@map("task_invites")
}

model Sprint {
  id                  String       @id @default(cuid())
  companyId           String       @map("company_id")
  name                String
  startDate           DateTime     @map("start_date")
  endDate             DateTime     @map("end_date")
  targetValueIncrease Decimal      @map("target_value_increase") @db.Decimal(15, 2)
  actualValueIncrease Decimal?     @map("actual_value_increase") @db.Decimal(15, 2)
  status              SprintStatus @default(PLANNING)
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@index([companyId, status])
  @@map("sprints")
}

// ============================================
// REFERENCE DATA
// ============================================

model IndustryMultiple {
  id                  String   @id @default(cuid())
  icbIndustry         String   @map("icb_industry")
  icbSuperSector      String   @map("icb_super_sector")
  icbSector           String   @map("icb_sector")
  icbSubSector        String   @map("icb_sub_sector")
  revenueMultipleLow  Decimal  @map("revenue_multiple_low") @db.Decimal(4, 2)
  revenueMultipleHigh Decimal  @map("revenue_multiple_high") @db.Decimal(4, 2)
  ebitdaMultipleLow   Decimal  @map("ebitda_multiple_low") @db.Decimal(4, 2)
  ebitdaMultipleHigh  Decimal  @map("ebitda_multiple_high") @db.Decimal(4, 2)
  effectiveDate       DateTime @map("effective_date")
  source              String?

  @@unique([icbSubSector, effectiveDate])
  @@map("industry_multiples")
}

// ============================================
// DATA ROOM
// ============================================

// Main data room entity - one per company
model DataRoom {
  id        String        @id @default(cuid())
  companyId String        @unique @map("company_id")
  name      String        @default("Data Room")
  stage     DataRoomStage @default(PREPARATION)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  company       Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  folders       DataRoomFolder[]
  accessGrants  DataRoomAccess[]
  activities    DataRoomActivity[]
  questions     DataRoomQuestion[]
  notifications DataRoomNotification[]

  @@map("data_rooms")
}

// Hierarchical folder structure
model DataRoomFolder {
  id         String  @id @default(cuid())
  dataRoomId String  @map("data_room_id")
  parentId   String? @map("parent_id")

  name        String
  description String?
  category    DataRoomCategory
  sortOrder   Int              @default(0) @map("sort_order")

  // Access control - minimum stage to view this folder
  minStage DataRoomStage @default(PREPARATION) @map("min_stage")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  dataRoom  DataRoom           @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  parent    DataRoomFolder?    @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  DataRoomFolder[]   @relation("FolderHierarchy")
  documents DataRoomDocument[]

  @@index([dataRoomId, parentId])
  @@index([dataRoomId, category])
  @@map("data_room_folders")
}

// Document entity (enhanced from original)
model DataRoomDocument {
  id        String  @id @default(cuid())
  companyId String  @map("company_id")
  folderId  String? @map("folder_id") // New: link to folder

  // Document identity
  category     DataRoomCategory
  documentName String           @map("document_name") // Standardized name
  description  String?

  // Task proof linking (for documents uploaded as proof of task completion)
  linkedTaskId String? @map("linked_task_id")

  // File details
  fileUrl  String? @map("file_url") // Supabase Storage URL (legacy, for public files)
  filePath String? @map("file_path") // Storage path for private files (signed URLs generated on demand)
  fileName String? @map("file_name") // Original file name
  fileSize Int?    @map("file_size") // Bytes
  mimeType String? @map("mime_type")

  // Version tracking
  version           Int     @default(1)
  previousVersionId String? @map("previous_version_id")

  // Update tracking
  updateFrequency UpdateFrequency @default(AS_NEEDED) @map("update_frequency")
  lastUpdatedAt   DateTime?       @map("last_updated_at") // When document was last uploaded/updated
  nextUpdateDue   DateTime?       @map("next_update_due") // Calculated based on frequency
  status          DocumentStatus  @default(CURRENT)

  // Document type flags
  isRequired   Boolean @default(false) @map("is_required") // Part of standard checklist
  isCustom     Boolean @default(false) @map("is_custom") // User-added document
  displayOrder Int     @default(0) @map("display_order")

  // Access control
  isConfidential Boolean @default(false) @map("is_confidential")
  allowDownload  Boolean @default(true) @map("allow_download")

  // Metadata
  uploadedByUserId String? @map("uploaded_by_user_id")
  notes            String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company         Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  folder          DataRoomFolder?           @relation(fields: [folderId], references: [id], onDelete: SetNull)
  linkedTask      Task?                     @relation("TaskProofDocuments", fields: [linkedTaskId], references: [id], onDelete: SetNull)
  uploadedBy      User?                     @relation("DocumentUploader", fields: [uploadedByUserId], references: [id], onDelete: SetNull)
  previousVersion DataRoomDocument?         @relation("DocumentVersions", fields: [previousVersionId], references: [id], onDelete: SetNull)
  newerVersions   DataRoomDocument[]        @relation("DocumentVersions")
  tags            DataRoomDocumentTag[]
  views           DataRoomDocumentView[]
  versions        DataRoomDocumentVersion[]

  @@index([companyId, category])
  @@index([companyId, status])
  @@index([folderId])
  @@index([linkedTaskId])
  @@map("data_room_documents")
}

// Version history for documents (stores snapshots when files are replaced)
model DataRoomDocumentVersion {
  id         String @id @default(cuid())
  documentId String @map("document_id")

  // Version number at time of snapshot
  version Int

  // File details (snapshot of what was replaced)
  filePath String  @map("file_path")
  fileName String  @map("file_name")
  fileSize Int     @map("file_size")
  mimeType String? @map("mime_type")

  // Who uploaded this version
  uploadedByUserId String? @map("uploaded_by_user_id")
  uploadedAt       DateTime @map("uploaded_at")

  // When this version was archived (replaced by newer version)
  archivedAt DateTime @default(now()) @map("archived_at")

  document   DataRoomDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  uploadedBy User?            @relation(fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  @@index([documentId])
  @@map("data_room_document_versions")
}

// Tags for documents
model DataRoomTag {
  id        String   @id @default(cuid())
  companyId String   @map("company_id")
  name      String
  color     String   @default("#6B7280")
  createdAt DateTime @default(now()) @map("created_at")

  company   Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents DataRoomDocumentTag[]

  @@unique([companyId, name])
  @@map("data_room_tags")
}

// Many-to-many relation between documents and tags
model DataRoomDocumentTag {
  id         String   @id @default(cuid())
  documentId String   @map("document_id")
  tagId      String   @map("tag_id")
  createdAt  DateTime @default(now()) @map("created_at")

  document DataRoomDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tag      DataRoomTag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([documentId, tagId])
  @@map("data_room_document_tags")
}

// Access grants for external users
model DataRoomAccess {
  id         String @id @default(cuid())
  dataRoomId String @map("data_room_id")

  // Can be linked to user or just an email for pending invites
  userId String? @map("user_id")
  email  String

  accessLevel DataRoomAccessLevel @default(VIEWER) @map("access_level")
  maxStage    DataRoomStage       @default(POST_NDA) @map("max_stage") // Maximum stage they can see

  // Optional folder restrictions (empty = all folders at their stage level)
  folderIds String[] @map("folder_ids")

  // Expiration and NDA
  expiresAt   DateTime? @map("expires_at")
  ndaSignedAt DateTime? @map("nda_signed_at")

  // Audit
  invitedById String   @map("invited_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  dataRoom     DataRoom      @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  buyerContact BuyerContact?

  @@unique([dataRoomId, email])
  @@index([dataRoomId, userId])
  @@map("data_room_access")
}

// Activity logging for analytics
model DataRoomActivity {
  id         String @id @default(cuid())
  dataRoomId String @map("data_room_id")
  userId     String @map("user_id")
  userEmail  String @map("user_email")

  action     DataRoomAction
  documentId String?        @map("document_id")
  folderId   String?        @map("folder_id")
  metadata   Json?

  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  dataRoom DataRoom @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)

  @@index([dataRoomId, createdAt])
  @@index([dataRoomId, userId])
  @@index([documentId])
  @@index([documentId, userId]) // Optimize: user-specific document activity tracking
  @@map("data_room_activities")
}

// Document view tracking for engagement analytics
model DataRoomDocumentView {
  id         String @id @default(cuid())
  documentId String @map("document_id")
  userId     String @map("user_id")
  userEmail  String @map("user_email")

  viewCount     Int      @default(1) @map("view_count")
  totalDuration Int      @default(0) @map("total_duration") // Seconds spent viewing
  lastViewedAt  DateTime @default(now()) @map("last_viewed_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  document DataRoomDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
  @@index([documentId])
  @@map("data_room_document_views")
}

// Q&A module for buyer questions
model DataRoomQuestion {
  id         String @id @default(cuid())
  dataRoomId String @map("data_room_id")

  // Optional link to specific document or folder
  documentId String? @map("document_id")
  folderId   String? @map("folder_id")

  question      String
  askedByEmail  String  @map("asked_by_email")
  askedByUserId String? @map("asked_by_user_id")

  status    String   @default("open") // open, answered, closed
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  dataRoom DataRoom         @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  answers  DataRoomAnswer[]

  @@index([dataRoomId, status])
  @@map("data_room_questions")
}

// Answers to Q&A questions
model DataRoomAnswer {
  id         String @id @default(cuid())
  questionId String @map("question_id")

  answer           String
  answeredByEmail  String  @map("answered_by_email")
  answeredByUserId String? @map("answered_by_user_id")

  isInternal Boolean  @default(false) @map("is_internal") // Hidden from buyers if true
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  question DataRoomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("data_room_answers")
}

// Notifications for data room activity
model DataRoomNotification {
  id         String @id @default(cuid())
  dataRoomId String @map("data_room_id")

  // Who should see this notification
  recipientUserId String @map("recipient_user_id")

  // Notification type
  type String // DOCUMENT_UPLOADED, QUESTION_ASKED, QUESTION_ANSWERED, ACCESS_GRANTED

  // Related entities
  documentId String? @map("document_id")
  questionId String? @map("question_id")
  folderId   String? @map("folder_id")

  // Content
  title   String
  message String

  // Who triggered the notification
  actorEmail  String  @map("actor_email")
  actorUserId String? @map("actor_user_id")

  // Status
  isRead    Boolean  @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime @default(now()) @map("created_at")

  dataRoom  DataRoom @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  recipient User     @relation("NotificationRecipient", fields: [recipientUserId], references: [id], onDelete: Cascade)

  @@index([recipientUserId, isRead])
  @@index([dataRoomId])
  @@map("data_room_notifications")
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// ============================================
// INTEGRATIONS
// ============================================

enum IntegrationProvider {
  QUICKBOOKS_ONLINE
}

enum SyncStatus {
  IDLE
  SYNCING
  SUCCESS
  FAILED
}

model Integration {
  id        String              @id @default(cuid())
  companyId String              @map("company_id")
  provider  IntegrationProvider

  // OAuth tokens (encrypted in application layer)
  accessToken    String   @map("access_token")
  refreshToken   String   @map("refresh_token")
  tokenExpiresAt DateTime @map("token_expires_at")

  // Provider-specific identifiers
  realmId             String? @map("realm_id") // QuickBooks company ID
  providerCompanyName String? @map("provider_company_name")

  // Sync settings
  autoSyncEnabled Boolean    @default(true) @map("auto_sync_enabled")
  lastSyncAt      DateTime?  @map("last_sync_at")
  lastSyncStatus  SyncStatus @default(IDLE) @map("last_sync_status")
  lastSyncError   String?    @map("last_sync_error")

  // Metadata
  connectedAt    DateTime  @default(now()) @map("connected_at")
  disconnectedAt DateTime? @map("disconnected_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  company  Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  syncLogs IntegrationSyncLog[]

  @@unique([companyId, provider])
  @@index([companyId])
  @@map("integrations")
}

model IntegrationSyncLog {
  id             String     @id @default(cuid())
  integrationId  String     @map("integration_id")
  syncType       String     @map("sync_type") // "manual" | "auto" | "initial"
  status         SyncStatus
  startedAt      DateTime   @default(now()) @map("started_at")
  completedAt    DateTime?  @map("completed_at")
  periodsCreated Int        @default(0) @map("periods_created")
  periodsUpdated Int        @default(0) @map("periods_updated")
  errorMessage   String?    @map("error_message")
  errorDetails   Json?      @map("error_details")

  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId, startedAt])
  @@map("integration_sync_logs")
}

// ============================================
// FINANCIALS
// ============================================

model FinancialPeriod {
  id         String     @id @default(cuid())
  companyId  String     @map("company_id")
  periodType PeriodType @map("period_type")
  fiscalYear Int        @map("fiscal_year")
  quarter    Quarter?
  month      Int?
  startDate  DateTime   @map("start_date")
  endDate    DateTime   @map("end_date")
  label      String?
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  incomeStatement   IncomeStatement?
  balanceSheet      BalanceSheet?
  cashFlowStatement CashFlowStatement?
  adjustments       EbitdaAdjustment[]

  @@unique([companyId, fiscalYear, periodType, quarter, month])
  @@index([companyId, fiscalYear])
  @@map("financial_periods")
}

model IncomeStatement {
  id       String @id @default(cuid())
  periodId String @unique @map("period_id")

  // Core P&L inputs
  grossRevenue      Decimal @map("gross_revenue") @db.Decimal(15, 2)
  cogs              Decimal @db.Decimal(15, 2)
  operatingExpenses Decimal @map("operating_expenses") @db.Decimal(15, 2)

  // Calculated fields (denormalized for performance)
  grossProfit     Decimal @map("gross_profit") @db.Decimal(15, 2)
  grossMarginPct  Decimal @map("gross_margin_pct") @db.Decimal(5, 4)
  ebitda          Decimal @db.Decimal(15, 2)
  ebitdaMarginPct Decimal @map("ebitda_margin_pct") @db.Decimal(5, 4)

  // Optional below-the-line items
  depreciation    Decimal? @db.Decimal(15, 2)
  amortization    Decimal? @db.Decimal(15, 2)
  interestExpense Decimal? @map("interest_expense") @db.Decimal(15, 2)
  taxExpense      Decimal? @map("tax_expense") @db.Decimal(15, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  period FinancialPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@map("income_statements")
}

model BalanceSheet {
  id       String @id @default(cuid())
  periodId String @unique @map("period_id")

  // Current Assets
  cash               Decimal @db.Decimal(15, 2)
  accountsReceivable Decimal @map("accounts_receivable") @db.Decimal(15, 2)
  inventory          Decimal @db.Decimal(15, 2)
  prepaidExpenses    Decimal @map("prepaid_expenses") @db.Decimal(15, 2)
  otherCurrentAssets Decimal @map("other_current_assets") @db.Decimal(15, 2)

  // Long-term Assets
  ppeGross                Decimal @map("ppe_gross") @db.Decimal(15, 2)
  accumulatedDepreciation Decimal @map("accumulated_depreciation") @db.Decimal(15, 2)
  intangibleAssets        Decimal @map("intangible_assets") @db.Decimal(15, 2)
  otherLongTermAssets     Decimal @map("other_long_term_assets") @db.Decimal(15, 2)

  // Current Liabilities
  accountsPayable         Decimal @map("accounts_payable") @db.Decimal(15, 2)
  accruedExpenses         Decimal @map("accrued_expenses") @db.Decimal(15, 2)
  currentPortionLtd       Decimal @map("current_portion_ltd") @db.Decimal(15, 2)
  otherCurrentLiabilities Decimal @map("other_current_liabilities") @db.Decimal(15, 2)

  // Long-term Liabilities
  longTermDebt             Decimal @map("long_term_debt") @db.Decimal(15, 2)
  deferredTaxLiabilities   Decimal @map("deferred_tax_liabilities") @db.Decimal(15, 2)
  otherLongTermLiabilities Decimal @map("other_long_term_liabilities") @db.Decimal(15, 2)

  // Equity
  retainedEarnings Decimal @map("retained_earnings") @db.Decimal(15, 2)
  ownersEquity     Decimal @map("owners_equity") @db.Decimal(15, 2)

  // Calculated totals (denormalized)
  totalCurrentAssets       Decimal @map("total_current_assets") @db.Decimal(15, 2)
  totalLongTermAssets      Decimal @map("total_long_term_assets") @db.Decimal(15, 2)
  totalAssets              Decimal @map("total_assets") @db.Decimal(15, 2)
  totalCurrentLiabilities  Decimal @map("total_current_liabilities") @db.Decimal(15, 2)
  totalLongTermLiabilities Decimal @map("total_long_term_liabilities") @db.Decimal(15, 2)
  totalLiabilities         Decimal @map("total_liabilities") @db.Decimal(15, 2)
  totalEquity              Decimal @map("total_equity") @db.Decimal(15, 2)
  workingCapital           Decimal @map("working_capital") @db.Decimal(15, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  period FinancialPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@map("balance_sheets")
}

model CashFlowStatement {
  id            String  @id @default(cuid())
  periodId      String  @unique @map("period_id")
  priorPeriodId String? @map("prior_period_id") // Reference to prior year for calculation context

  // Operating Activities (Indirect Method)
  netIncome                       Decimal @map("net_income") @db.Decimal(15, 2)
  depreciation                    Decimal @db.Decimal(15, 2)
  amortization                    Decimal @db.Decimal(15, 2)
  changeInAccountsReceivable      Decimal @map("change_in_accounts_receivable") @db.Decimal(15, 2)
  changeInInventory               Decimal @map("change_in_inventory") @db.Decimal(15, 2)
  changeInPrepaidExpenses         Decimal @map("change_in_prepaid_expenses") @db.Decimal(15, 2)
  changeInOtherCurrentAssets      Decimal @map("change_in_other_current_assets") @db.Decimal(15, 2)
  changeInAccountsPayable         Decimal @map("change_in_accounts_payable") @db.Decimal(15, 2)
  changeInAccruedExpenses         Decimal @map("change_in_accrued_expenses") @db.Decimal(15, 2)
  changeInOtherCurrentLiabilities Decimal @map("change_in_other_current_liabilities") @db.Decimal(15, 2)
  changeInDeferredTaxLiabilities  Decimal @map("change_in_deferred_tax_liabilities") @db.Decimal(15, 2)
  otherOperatingAdjustments       Decimal @default(0) @map("other_operating_adjustments") @db.Decimal(15, 2)
  cashFromOperations              Decimal @map("cash_from_operations") @db.Decimal(15, 2)

  // Investing Activities
  capitalExpenditures         Decimal @map("capital_expenditures") @db.Decimal(15, 2) // Increase in PP&E (negative outflow)
  changeInIntangibleAssets    Decimal @map("change_in_intangible_assets") @db.Decimal(15, 2)
  changeInOtherLongTermAssets Decimal @map("change_in_other_long_term_assets") @db.Decimal(15, 2)
  otherInvestingActivities    Decimal @default(0) @map("other_investing_activities") @db.Decimal(15, 2)
  cashFromInvesting           Decimal @map("cash_from_investing") @db.Decimal(15, 2)

  // Financing Activities
  changeInCurrentPortionLtd        Decimal @map("change_in_current_portion_ltd") @db.Decimal(15, 2)
  changeInLongTermDebt             Decimal @map("change_in_long_term_debt") @db.Decimal(15, 2)
  changeInOtherLongTermLiabilities Decimal @map("change_in_other_long_term_liabilities") @db.Decimal(15, 2)
  changeInOwnersEquity             Decimal @map("change_in_owners_equity") @db.Decimal(15, 2) // Contributions/distributions
  otherFinancingActivities         Decimal @default(0) @map("other_financing_activities") @db.Decimal(15, 2)
  cashFromFinancing                Decimal @map("cash_from_financing") @db.Decimal(15, 2)

  // Summary
  netChangeInCash Decimal @map("net_change_in_cash") @db.Decimal(15, 2)
  beginningCash   Decimal @map("beginning_cash") @db.Decimal(15, 2)
  endingCash      Decimal @map("ending_cash") @db.Decimal(15, 2)

  // Free Cash Flow (highlighted metric)
  freeCashFlow Decimal @map("free_cash_flow") @db.Decimal(15, 2) // CFO - CapEx

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  period FinancialPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@map("cash_flow_statements")
}

// DCF (Discounted Cash Flow) Analysis Assumptions
model DCFAssumptions {
  id        String @id @default(cuid())
  companyId String @unique @map("company_id")

  // WACC Inputs
  riskFreeRate       Decimal  @map("risk_free_rate") @db.Decimal(5, 4)
  marketRiskPremium  Decimal  @map("market_risk_premium") @db.Decimal(5, 4)
  beta               Decimal  @db.Decimal(4, 2)
  sizeRiskPremium    Decimal  @map("size_risk_premium") @db.Decimal(5, 4)
  costOfDebtOverride Decimal? @map("cost_of_debt_override") @db.Decimal(5, 4)
  taxRateOverride    Decimal? @map("tax_rate_override") @db.Decimal(5, 4)

  // Growth Assumptions (JSON array of yearly rates)
  growthAssumptions Json @map("growth_assumptions")

  // Terminal Value
  terminalMethod      String   @map("terminal_method") // "gordon" | "exit_multiple"
  perpetualGrowthRate Decimal  @map("perpetual_growth_rate") @db.Decimal(5, 4)
  exitMultiple        Decimal? @map("exit_multiple") @db.Decimal(4, 2)

  // Cached Results
  calculatedWACC  Decimal? @map("calculated_wacc") @db.Decimal(5, 4)
  enterpriseValue Decimal? @map("enterprise_value") @db.Decimal(15, 2)
  equityValue     Decimal? @map("equity_value") @db.Decimal(15, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("dcf_assumptions")
}

// ============================================
// PROJECT ASSESSMENTS
// ============================================

// The 596 detailed questions from JSON modules (separate from Initial BRI questions)
model ProjectQuestion {
  id         String @id @default(cuid())
  moduleId   String @unique @map("module_id") // e.g., "MOD-FN-RS-001"
  questionId String @unique @map("question_id") // e.g., "Q-FN-RS-001"

  // Question content
  questionText String      @map("question_text")
  briCategory  BriCategory @map("bri_category")
  subCategory  String      @map("sub_category") // e.g., "Revenue Stability"

  // Impact scoring (for prioritization)
  questionImpact   QuestionImpact   @map("question_impact") // CRITICAL, HIGH, MEDIUM, LOW
  buyerSensitivity BuyerSensitivity @map("buyer_sensitivity")

  // Help content
  definitionNote    String? @map("definition_note")
  helpText          String? @map("help_text")
  riskDefinition    String? @map("risk_definition")
  primaryValueLever String? @map("primary_value_lever")

  // Metadata
  relatedQuestionIds String[] @map("related_question_ids")
  relatedModules     String[] @map("related_modules")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  options           ProjectQuestionOption[]
  strategies        ProjectStrategy[]
  responses         ProjectAssessmentResponse[]
  companyPriorities CompanyQuestionPriority[]
  assessmentLinks   ProjectAssessmentQuestion[]

  @@index([briCategory, questionImpact])
  @@map("project_questions")
}

// Options for Project Questions with score values
model ProjectQuestionOption {
  id                  String  @id @default(cuid())
  questionId          String  @map("question_id")
  optionId            String  @map("option_id") // A, B, C, D
  optionText          String  @map("option_text")
  scoreValue          Decimal @map("score_value") @db.Decimal(3, 2) // 0.00, 0.35, 0.70, 1.00
  buyerInterpretation String? @map("buyer_interpretation")
  displayOrder        Int     @map("display_order")

  question           ProjectQuestion             @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedResponses  ProjectAssessmentResponse[] @relation("SelectedProjectOption")
  effectiveResponses ProjectAssessmentResponse[] @relation("EffectiveProjectOption")
  tasksUpgradingFrom ProjectTaskTemplate[]       @relation("ProjectTaskUpgradeFrom")
  tasksUpgradingTo   ProjectTaskTemplate[]       @relation("ProjectTaskUpgradeTo")

  @@unique([questionId, optionId])
  @@map("project_question_options")
}

// Strategies for improving scores (from JSON modules)
model ProjectStrategy {
  id                  String       @id @default(cuid())
  questionId          String       @map("question_id")
  strategyId          String       @map("strategy_id") // STRAT-A, STRAT-B, STRAT-C
  strategyName        String       @map("strategy_name")
  strategyDescription String?      @map("strategy_description")
  strategyType        StrategyType @map("strategy_type") // FULL_FIX, PARTIAL_MITIGATION, RISK_ACCEPTANCE

  upgradeFromScore   Decimal @map("upgrade_from_score") @db.Decimal(3, 2)
  maxScoreAchievable Decimal @map("max_score_achievable") @db.Decimal(3, 2)
  estimatedEffort    String  @map("estimated_effort")
  estimatedTimeline  String? @map("estimated_timeline")
  applicableWhen     String? @map("applicable_when")

  question      ProjectQuestion       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  taskTemplates ProjectTaskTemplate[]

  @@unique([questionId, strategyId])
  @@map("project_strategies")
}

// Task templates within strategies
model ProjectTaskTemplate {
  id         String @id @default(cuid())
  strategyId String @map("strategy_id")
  taskId     String @map("task_id") // TASK-A-001, etc.
  sequence   Int

  // Task content
  title       String
  primaryVerb String  @map("primary_verb")
  verbTier    Int     @map("verb_tier")
  object      String
  outcome     String?

  // Assignment
  ownerRole OwnerRole @map("owner_role")
  timebox   Timebox

  // Effort
  effortLevel    EffortLevel     @map("effort_level")
  complexity     ComplexityLevel
  estimatedHours Int?            @map("estimated_hours")

  // Deliverables
  deliverables String[]
  evidence     String[]
  riskCategory BriCategory @map("risk_category")

  // Dependencies
  dependencies String[]
  blockedBy    String[] @map("blocked_by")

  // Answer Upgrade System
  upgradesFromScore    Decimal? @map("upgrades_from_score") @db.Decimal(3, 2)
  upgradesToScore      Decimal? @map("upgrades_to_score") @db.Decimal(3, 2)
  upgradesFromOptionId String?  @map("upgrades_from_option_id")
  upgradesToOptionId   String?  @map("upgrades_to_option_id")

  // Deferral fields (for COMMIT tasks)
  deferReasonCode   String?  @map("defer_reason_code")
  companionVerbs    String[] @map("companion_verbs")
  reEvaluationDate  String?  @map("re_evaluation_date")
  valueImpactState  String?  @map("value_impact_state")
  mitigationSummary String?  @map("mitigation_summary")

  strategy           ProjectStrategy        @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  upgradesFromOption ProjectQuestionOption? @relation("ProjectTaskUpgradeFrom", fields: [upgradesFromOptionId], references: [id])
  upgradesToOption   ProjectQuestionOption? @relation("ProjectTaskUpgradeTo", fields: [upgradesToOptionId], references: [id])

  @@unique([strategyId, taskId])
  @@map("project_task_templates")
}

// An instance of a Project Assessment (8-15 questions)
model ProjectAssessment {
  id               String @id @default(cuid())
  companyId        String @map("company_id")
  assessmentNumber Int    @map("assessment_number") // 1, 2, 3, etc.

  // Focus area (primary category for this assessment)
  primaryCategory BriCategory? @map("primary_category")
  title           String? // Optional title like "Financial Deep Dive"

  // Status
  status      ProjectAssessmentStatus @default(IN_PROGRESS)
  startedAt   DateTime                @default(now()) @map("started_at")
  completedAt DateTime?               @map("completed_at")

  // Score tracking
  briScoreBefore Decimal? @map("bri_score_before") @db.Decimal(5, 4)
  briScoreAfter  Decimal? @map("bri_score_after") @db.Decimal(5, 4)
  scoreImpact    Decimal? @map("score_impact") @db.Decimal(5, 4) // Can be positive or negative

  // Action plan generated
  actionPlanGenerated Boolean @default(false) @map("action_plan_generated")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company   Company                     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  responses ProjectAssessmentResponse[]
  questions ProjectAssessmentQuestion[] // The selected questions for this assessment

  @@unique([companyId, assessmentNumber])
  @@index([companyId, status])
  @@map("project_assessments")
}

// Links questions to a specific Project Assessment instance
model ProjectAssessmentQuestion {
  id           String @id @default(cuid())
  assessmentId String @map("assessment_id")
  questionId   String @map("question_id")
  displayOrder Int    @map("display_order")

  // Why this question was selected
  selectionReason String? @map("selection_reason") // "High impact", "Category gap", etc.
  priorityScore   Decimal @map("priority_score") @db.Decimal(5, 2)

  // Skipped questions go back to pool for future assessments
  skipped   Boolean   @default(false)
  skippedAt DateTime? @map("skipped_at")

  assessment ProjectAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question   ProjectQuestion   @relation(fields: [questionId], references: [id])

  @@unique([assessmentId, questionId])
  @@map("project_assessment_questions")
}

// User's answer to a Project Assessment question
model ProjectAssessmentResponse {
  id                String  @id @default(cuid())
  assessmentId      String  @map("assessment_id")
  questionId        String  @map("question_id")
  selectedOptionId  String  @map("selected_option_id")
  effectiveOptionId String? @map("effective_option_id") // Updated by task completion

  // Score impact tracking
  estimatedScore Decimal? @map("estimated_score") @db.Decimal(3, 2) // What system expected
  actualScore    Decimal  @map("actual_score") @db.Decimal(3, 2) // What user selected
  scoreImpact    Decimal? @map("score_impact") @db.Decimal(4, 3) // Difference (can be negative)

  // Confidence and notes
  confidenceLevel ConfidenceLevel @map("confidence_level")
  notes           String?
  evidenceUrls    String[]        @map("evidence_urls")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  assessment      ProjectAssessment      @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question        ProjectQuestion        @relation(fields: [questionId], references: [id])
  selectedOption  ProjectQuestionOption  @relation("SelectedProjectOption", fields: [selectedOptionId], references: [id])
  effectiveOption ProjectQuestionOption? @relation("EffectiveProjectOption", fields: [effectiveOptionId], references: [id])

  @@unique([assessmentId, questionId])
  @@index([assessmentId, createdAt(sort: Desc)]) // Optimize: retrieve latest responses
  @@map("project_assessment_responses")
}

// Tracks priority scores for questions per company (for the prioritization engine)
model CompanyQuestionPriority {
  id         String @id @default(cuid())
  companyId  String @map("company_id")
  questionId String @map("question_id")

  // Priority factors
  impactScore    Decimal @map("impact_score") @db.Decimal(5, 2) // Base impact from question
  relevanceScore Decimal @map("relevance_score") @db.Decimal(5, 2) // Relevance to company's weak areas
  urgencyScore   Decimal @map("urgency_score") @db.Decimal(5, 2) // Time-sensitivity

  // Combined priority
  priorityScore Decimal @map("priority_score") @db.Decimal(5, 2) // Weighted combination

  // Status
  hasBeenAsked Boolean   @default(false) @map("has_been_asked")
  askedAt      DateTime? @map("asked_at")

  updatedAt DateTime @updatedAt @map("updated_at")

  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  question ProjectQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([companyId, questionId])
  @@index([companyId, priorityScore])
  @@map("company_question_priorities")
}

// ============================================
// GDPR COMPLIANCE
// ============================================

enum ConsentType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  MARKETING_EMAILS
  ANALYTICS_COOKIES
  FUNCTIONAL_COOKIES
  MARKETING_COOKIES
}

enum ConsentAction {
  GRANTED
  WITHDRAWN
  UPDATED
}

enum DeletionRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

enum ExportRequestStatus {
  PENDING
  PROCESSING
  READY
  DOWNLOADED
  EXPIRED
  FAILED
}

// Tracks user consent history for GDPR compliance
model UserConsent {
  id          String        @id @default(cuid())
  userId      String        @map("user_id")
  consentType ConsentType   @map("consent_type")
  action      ConsentAction
  version     String? // Version of document consented to
  ipAddress   String?       @map("ip_address")
  userAgent   String?       @map("user_agent")
  createdAt   DateTime      @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, consentType])
  @@index([userId, createdAt])
  @@map("user_consents")
}

// Tracks data deletion requests (right to be forgotten)
model DataDeletionRequest {
  id                String                @id @default(cuid())
  userId            String                @map("user_id")
  status            DeletionRequestStatus @default(PENDING)
  reason            String? // Optional reason for deletion
  requestedAt       DateTime              @default(now()) @map("requested_at")
  scheduledFor      DateTime              @map("scheduled_for") // 30-day grace period
  processedAt       DateTime?             @map("processed_at")
  cancelledAt       DateTime?             @map("cancelled_at")
  confirmationToken String                @unique @map("confirmation_token")
  confirmedAt       DateTime?             @map("confirmed_at")

  // Audit trail
  dataDeleted Json?   @map("data_deleted") // Summary of what was deleted
  deletedBy   String? @map("deleted_by") // System or admin ID

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([status, scheduledFor])
  @@map("data_deletion_requests")
}

// Tracks data export requests (right to data portability)
model DataExportRequest {
  id           String              @id @default(cuid())
  userId       String              @map("user_id")
  status       ExportRequestStatus @default(PENDING)
  requestedAt  DateTime            @default(now()) @map("requested_at")
  processedAt  DateTime?           @map("processed_at")
  downloadedAt DateTime?           @map("downloaded_at")
  expiresAt    DateTime?           @map("expires_at") // Export file expiry

  // Export file details
  filePath      String? @map("file_path") // Storage path
  fileSize      Int?    @map("file_size") // Bytes
  downloadToken String? @unique @map("download_token")
  downloadCount Int     @default(0) @map("download_count")

  // What data was included
  includeProfile     Boolean @default(true) @map("include_profile")
  includeCompanies   Boolean @default(true) @map("include_companies")
  includeAssessments Boolean @default(true) @map("include_assessments")
  includeDocuments   Boolean @default(false) @map("include_documents")

  errorMessage String? @map("error_message")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([downloadToken])
  @@map("data_export_requests")
}

// ============================================
// ADMIN DASHBOARD
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String   @map("actor_id")
  actorEmail String   @map("actor_email")
  action     String // "user.update", "impersonate.start", etc.
  targetType String   @map("target_type") // "User", "Organization"
  targetId   String?  @map("target_id")
  metadata   Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  actor User @relation("AuditActor", fields: [actorId], references: [id])

  @@index([actorId])
  @@index([targetType, targetId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model ImpersonationSession {
  id           String    @id @default(cuid())
  adminId      String    @map("admin_id")
  targetUserId String    @map("target_user_id")
  reason       String
  startedAt    DateTime  @default(now()) @map("started_at")
  endedAt      DateTime? @map("ended_at")
  ipAddress    String?   @map("ip_address")

  admin      User @relation("ImpersonationAdmin", fields: [adminId], references: [id])
  targetUser User @relation("ImpersonationTarget", fields: [targetUserId], references: [id])

  @@index([adminId])
  @@index([targetUserId])
  @@map("impersonation_sessions")
}

model SupportTicket {
  id           String    @id @default(cuid())
  ticketNumber String    @unique @map("ticket_number")
  userId       String?   @map("user_id")
  userEmail    String    @map("user_email")
  subject      String
  status       String    @default("open") // open, in_progress, waiting, resolved, closed
  priority     String    @default("normal") // low, normal, high, urgent
  category     String? // billing, technical, account, feature_request
  assignedToId String?   @map("assigned_to_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  resolvedAt   DateTime? @map("resolved_at")

  user       User?           @relation("TicketUser", fields: [userId], references: [id])
  assignedTo User?           @relation("TicketAssignee", fields: [assignedToId], references: [id])
  messages   TicketMessage[]

  @@index([userId])
  @@index([status])
  @@index([assignedToId])
  @@map("support_tickets")
}

model TicketMessage {
  id          String   @id @default(cuid())
  ticketId    String   @map("ticket_id")
  authorId    String?  @map("author_id")
  authorEmail String   @map("author_email")
  content     String
  isInternal  Boolean  @default(false) @map("is_internal")
  createdAt   DateTime @default(now()) @map("created_at")

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author User?         @relation(fields: [authorId], references: [id])

  @@index([ticketId])
  @@map("ticket_messages")
}

// ============================================
// DEAL TRACKER
// ============================================

enum DealStage {
  // Identification
  IDENTIFIED
  SELLER_REVIEWING
  APPROVED
  DECLINED

  // Marketing
  TEASER_SENT
  INTERESTED
  PASSED

  // NDA
  NDA_SENT
  NDA_NEGOTIATING
  NDA_EXECUTED

  // Diligence Access
  CIM_ACCESS
  LEVEL_2_ACCESS
  LEVEL_3_ACCESS

  // Management Meeting
  MANAGEMENT_MEETING_SCHEDULED
  MANAGEMENT_MEETING_COMPLETED

  // IOI
  IOI_REQUESTED
  IOI_RECEIVED
  IOI_ACCEPTED
  IOI_DECLINED

  // LOI
  LOI_REQUESTED
  LOI_RECEIVED
  LOI_SELECTED
  LOI_BACKUP

  // Close
  DUE_DILIGENCE
  PA_DRAFTING
  PA_NEGOTIATING
  CLOSING
  CLOSED

  // Exit
  WITHDRAWN
  TERMINATED
}

enum BuyerType {
  STRATEGIC
  FINANCIAL
  INDIVIDUAL
  MANAGEMENT
  ESOP
  OTHER
}

// Prospect approval status for seller review
enum ProspectApprovalStatus {
  UNDECIDED
  APPROVED
  DENIED
}

// How the prospect was added
enum ProspectSource {
  MANUAL
  CSV_IMPORT
}

enum BuyerTier {
  A_TIER
  B_TIER
  C_TIER
  D_TIER
}

enum BuyerContactRole {
  PRIMARY
  DECISION_MAKER
  DEAL_LEAD
  DILIGENCE
  LEGAL
  FINANCE
  OPERATIONS
}

enum DealDocumentType {
  TEASER
  NDA_TEMPLATE
  NDA_SIGNED
  CIM
  PROCESS_LETTER
  IOI_RECEIVED
  LOI_RECEIVED
  PURCHASE_AGREEMENT
  OTHER
}

enum MeetingType {
  INTRO_CALL
  MANAGEMENT_PRESENTATION
  SITE_VISIT
  EXPERT_SESSION
  NEGOTIATION
  OTHER
}

// Prospective buyer company tracking (active buyers in deal pipeline)
model ProspectiveBuyer {
  id         String  @id @default(cuid())
  companyId  String  @map("company_id")
  prospectId String? @map("prospect_id") // Link to approved prospect

  // Buyer Info
  name        String
  buyerType   BuyerType @map("buyer_type")
  tier        BuyerTier @default(B_TIER)
  website     String?
  description String?
  industry    String?
  location    String?

  // Stage Tracking
  currentStage   DealStage @default(IDENTIFIED) @map("current_stage")
  stageUpdatedAt DateTime  @default(now()) @map("stage_updated_at")

  // Key Dates
  approvedAt    DateTime? @map("approved_at")
  ndaExecutedAt DateTime? @map("nda_executed_at")
  ioiReceivedAt DateTime? @map("ioi_received_at")
  loiReceivedAt DateTime? @map("loi_received_at")
  closedAt      DateTime? @map("closed_at")
  withdrawnAt   DateTime? @map("withdrawn_at")

  // Seller Approval
  approvalStatus String? @map("approval_status") // PENDING, APPROVED, DECLINED
  approvalNotes  String? @map("approval_notes")
  approvalById   String? @map("approval_by_id")

  // IOI/LOI Values
  ioiAmount Decimal? @map("ioi_amount") @db.Decimal(15, 2)
  loiAmount Decimal? @map("loi_amount") @db.Decimal(15, 2)

  // Deadlines
  ioiDeadline DateTime? @map("ioi_deadline")
  loiDeadline DateTime? @map("loi_deadline")

  // Exclusivity
  exclusivityStart DateTime? @map("exclusivity_start")
  exclusivityEnd   DateTime? @map("exclusivity_end")

  internalNotes String?  @map("internal_notes")
  tags          String[]

  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  company      Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  prospect     BuyerProspect?     @relation(fields: [prospectId], references: [id], onDelete: SetNull)
  contacts     BuyerContact[]
  stageHistory DealStageHistory[]
  activities   DealActivity[]
  documents    DealDocument[]
  meetings     DealMeeting[]

  @@unique([companyId, name])
  @@index([companyId, currentStage])
  @@index([prospectId])
  @@map("prospective_buyers")
}

// Contacts at prospective buyer companies
model BuyerContact {
  id      String @id @default(cuid())
  buyerId String @map("buyer_id")

  email     String
  firstName String @map("first_name")
  lastName  String @map("last_name")
  title     String?
  phone     String?

  role      BuyerContactRole @default(DEAL_LEAD)
  isPrimary Boolean          @default(false) @map("is_primary")

  // Link to VDR access (when granted)
  dataRoomAccessId String? @unique @map("data_room_access_id")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  buyer          ProspectiveBuyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  dataRoomAccess DataRoomAccess?  @relation(fields: [dataRoomAccessId], references: [id], onDelete: SetNull)

  @@unique([buyerId, email])
  @@index([buyerId])
  @@map("buyer_contacts")
}

// History of stage changes for audit trail
model DealStageHistory {
  id      String @id @default(cuid())
  buyerId String @map("buyer_id")

  fromStage   DealStage? @map("from_stage")
  toStage     DealStage  @map("to_stage")
  notes       String?
  changedById String     @map("changed_by_id")
  changedAt   DateTime   @default(now()) @map("changed_at")

  buyer ProspectiveBuyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, changedAt])
  @@map("deal_stage_history")
}

// Activity log for deal tracking
model DealActivity {
  id      String @id @default(cuid())
  buyerId String @map("buyer_id")

  activityType String @map("activity_type")
  description  String
  metadata     Json?

  performedById String?  @map("performed_by_id")
  performedAt   DateTime @default(now()) @map("performed_at")

  buyer ProspectiveBuyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, performedAt])
  @@map("deal_activities")
}

// Documents associated with a deal
model DealDocument {
  id      String @id @default(cuid())
  buyerId String @map("buyer_id")

  documentType DealDocumentType @map("document_type")
  name         String
  description  String?

  filePath String? @map("file_path")
  fileName String? @map("file_name")
  fileSize Int?    @map("file_size")
  mimeType String? @map("mime_type")

  receivedAt DateTime? @map("received_at")
  sentAt     DateTime? @map("sent_at")

  uploadedById String   @map("uploaded_by_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  buyer ProspectiveBuyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, documentType])
  @@map("deal_documents")
}

// Meetings with prospective buyers
model DealMeeting {
  id      String @id @default(cuid())
  buyerId String @map("buyer_id")

  meetingType MeetingType @map("meeting_type")
  title       String
  description String?

  scheduledAt DateTime @map("scheduled_at")
  duration    Int? // minutes
  location    String?
  meetingLink String?  @map("meeting_link")

  status      String    @default("scheduled") // scheduled, completed, cancelled
  completedAt DateTime? @map("completed_at")
  notes       String?
  attendees   Json? // Array of attendee info

  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  buyer ProspectiveBuyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId, scheduledAt])
  @@map("deal_meetings")
}

// ============================================
// PROSPECT BUYER LIST
// Pre-pipeline list of potential buyers for seller approval
// ============================================

// Prospect buyer for seller review before adding to deal pipeline
model BuyerProspect {
  id        String @id @default(cuid())
  companyId String @map("company_id")

  // Company Information
  name                  String
  domain                String? // Extracted/normalized for email matching
  website               String?
  headquartersLocation  String?  @map("headquarters_location")

  // Classification
  buyerType             BuyerType @map("buyer_type")
  relevanceDescription  String?   @map("relevance_description") @db.Text // Why this buyer is relevant

  // Seller Approval Workflow
  approvalStatus   ProspectApprovalStatus @default(UNDECIDED) @map("approval_status")
  statusChangedAt  DateTime?              @map("status_changed_at") // Auto-set when status changes
  statusChangedBy  String?                @map("status_changed_by") // User who changed status
  denialReason     String?                @map("denial_reason")

  // Source tracking
  source        ProspectSource @default(MANUAL)
  importBatchId String?        @map("import_batch_id")

  notes String? @db.Text

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")

  // Relations
  company     Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importBatch ProspectImportBatch? @relation(fields: [importBatchId], references: [id], onDelete: SetNull)
  buyers      ProspectiveBuyer[] // Buyers linked to this prospect

  @@unique([companyId, name]) // Prevent duplicate company names per deal
  @@index([companyId, approvalStatus])
  @@index([domain])
  @@map("buyer_prospects")
}

// CSV import batch tracking
model ProspectImportBatch {
  id        String @id @default(cuid())
  companyId String @map("company_id")

  filename       String?
  totalRows      Int     @default(0) @map("total_rows")
  successfulRows Int     @default(0) @map("successful_rows")
  failedRows     Int     @default(0) @map("failed_rows")
  errorLog       Json?   @map("error_log") // Array of row-level errors
  status         String  @default("processing") // processing, completed, failed

  createdAt   DateTime @default(now()) @map("created_at")
  createdById String   @map("created_by_id")

  company   Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  prospects BuyerProspect[]

  @@index([companyId])
  @@map("prospect_import_batches")
}
