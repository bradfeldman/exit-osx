<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IP Audit & Protection | Exit Planning Playbook #20</title>
<style>
/* ============================================================
   DESIGN TOKENS
   ============================================================ */
:root {
  --color-bg: #F5F5F7;
  --color-surface: #FFFFFF;
  --color-surface-alt: #F2F2F7;
  --color-border: #E5E7EB;
  --color-border-light: #F2F2F7;
  --color-text: #1D1D1F;
  --color-text-secondary: #6E6E73;
  --color-text-tertiary: #8E8E93;
  --color-primary: #0071E3;
  --color-primary-light: #EBF5FF;
  --color-primary-hover: #0051B3;
  --color-accent: #FF9500;
  --color-accent-light: #FFF6E8;
  --color-danger: #FF3B30;
  --color-danger-light: #FFEBEA;
  --color-warning: #C67F20;
  --color-warning-light: #FFF8EB;
  --color-success: #34C759;
  --color-success-light: #E8F8ED;
  --color-score-1: #FF3B30;
  --color-score-2: #FF9500;
  --color-score-3: #FFCC00;
  --color-score-4: #34C759;
  --color-score-5: #30D158;
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.1);
  --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', sans-serif;
  --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', sans-serif;
  --transition-fast: 150ms ease;
  --transition-normal: 250ms ease;
  --transition-slow: 400ms cubic-bezier(0.16, 1, 0.3, 1);
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
  --space-3xl: 64px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body {
  font-family: var(--font-body); font-size: 16px; line-height: 1.6;
  color: var(--color-text); background: var(--color-bg);
  -webkit-font-smoothing: antialiased; min-height: 100vh;
}
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea, select { font-family: inherit; font-size: inherit; }
a { color: var(--color-primary); text-decoration: none; }

/* Typography */
.t-display { font-family: var(--font-display); font-size: clamp(28px, 4vw, 40px); font-weight: 700; line-height: 1.2; letter-spacing: -0.02em; }
.t-h1 { font-family: var(--font-display); font-size: clamp(22px, 3vw, 30px); font-weight: 700; line-height: 1.25; letter-spacing: -0.01em; }
.t-h2 { font-size: 20px; font-weight: 600; line-height: 1.3; }
.t-h3 { font-size: 16px; font-weight: 600; line-height: 1.4; }
.t-body { font-size: 16px; line-height: 1.6; }
.t-small { font-size: 14px; line-height: 1.5; }
.t-caption { font-size: 12px; line-height: 1.4; letter-spacing: 0.02em; }
.t-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); }
.t-secondary { color: var(--color-text-secondary); }
.t-tertiary { color: var(--color-text-tertiary); }
.mb-sm { margin-bottom: var(--space-sm); }
.mb-md { margin-bottom: var(--space-md); }
.mb-lg { margin-bottom: var(--space-lg); }
.mb-xl { margin-bottom: var(--space-xl); }
.mb-2xl { margin-bottom: var(--space-2xl); }

/* Layout */
.app { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; min-width: 260px; background: var(--color-text);
  color: var(--color-text); padding: var(--space-lg); display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
  transition: transform var(--transition-slow); overflow-y: auto;
}
.main-content { flex: 1; margin-left: 260px; min-height: 100vh; transition: margin-left var(--transition-slow); }
.content-area { max-width: 800px; margin: 0 auto; padding: var(--space-2xl) var(--space-lg); }
.mobile-header {
  display: none; position: sticky; top: 0; z-index: 90;
  background: var(--color-surface); border-bottom: 1px solid var(--color-border);
  padding: var(--space-md) var(--space-lg); align-items: center; gap: var(--space-md);
}
.hamburger { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); }
.hamburger:hover { background: var(--color-surface-alt); }
.hamburger span { display: block; width: 18px; height: 2px; background: var(--color-text); position: relative; }
.hamburger span::before, .hamburger span::after { content: ''; position: absolute; width: 18px; height: 2px; background: var(--color-text); left: 0; }
.hamburger span::before { top: -6px; }
.hamburger span::after { top: 6px; }
.sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 99; }
@media (max-width: 900px) {
  .sidebar { transform: translateX(-260px); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.show { display: block; }
  .main-content { margin-left: 0 !important; }
  .mobile-header { display: flex; }
  .content-area { padding: var(--space-lg) var(--space-md); }
}

/* Sidebar Components */
.sidebar-brand { margin-bottom: var(--space-xl); }
.sidebar-brand-label { font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-xs); }
.sidebar-brand-title { font-family: var(--font-display); font-size: 18px; font-weight: 700; color: var(--color-text); line-height: 1.3; }
.sidebar-progress { margin-bottom: var(--space-xl); padding: var(--space-md); background: var(--color-surface-alt); border-radius: var(--radius-md); }
.sidebar-progress-label { font-size: 12px; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-progress-bar { height: 4px; background: var(--color-border); border-radius: 2px; overflow: hidden; }
.sidebar-progress-fill { height: 100%; background: var(--color-accent); border-radius: 2px; transition: width var(--transition-slow); }
.sidebar-progress-text { font-size: 12px; color: var(--color-text-tertiary); margin-top: var(--space-sm); text-align: right; }
.sidebar-nav { flex: 1; display: flex; flex-direction: column; gap: 2px; }
.nav-section-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-tertiary); padding: var(--space-md) var(--space-sm) var(--space-xs); }
.nav-item {
  display: flex; align-items: center; gap: var(--space-md); padding: 10px 12px;
  border-radius: var(--radius-sm); color: rgba(255,255,255,0.6);
  font-size: 14px; transition: all var(--transition-fast); cursor: pointer;
}
.nav-item:hover { background: var(--color-surface-alt); color: var(--color-text); }
.nav-item.active { background: var(--color-primary-light); color: var(--color-primary); font-weight: 500; border-left: 3px solid var(--color-primary); }
.nav-item.completed .nav-check { display: flex; }
.nav-item.locked { opacity: 0.4; cursor: default; }
.nav-item.locked:hover { background: none; color: var(--color-text-tertiary); }
.nav-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; }
.nav-check { display: none; width: 16px; height: 16px; background: var(--color-success); border-radius: 50%; align-items: center; justify-content: center; margin-left: auto; flex-shrink: 0; }
.nav-check svg { width: 10px; height: 10px; stroke: #fff; stroke-width: 2.5; fill: none; }
.sidebar-score { margin-top: auto; padding-top: var(--space-lg); border-top: 1px solid var(--color-border); }
.sidebar-score-label { font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-score-value { font-family: var(--font-display); font-size: 36px; font-weight: 700; color: #fff; line-height: 1; }
.sidebar-score-max { font-size: 18px; color: var(--color-text-tertiary); font-weight: 400; }
.sidebar-score-desc { font-size: 12px; color: var(--color-text-secondary); margin-top: var(--space-xs); }

/* Cards */
.card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--space-lg); transition: box-shadow var(--transition-normal); }
.card:hover { box-shadow: var(--shadow-sm); }
.callout { padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); border-left: 3px solid; font-size: 14px; line-height: 1.6; }
.callout-info { background: var(--color-primary-light); border-color: var(--color-primary); color: var(--color-primary); }
.callout-warning { background: var(--color-warning-light); border-color: var(--color-warning); color: #7C5500; }
.callout-danger { background: var(--color-danger-light); border-color: var(--color-danger); color: var(--color-danger); }
.callout-accent { background: var(--color-accent-light); border-color: var(--color-accent); color: #7C5500; }

/* Buttons */
.btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); padding: 10px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500; transition: all var(--transition-fast); white-space: nowrap; }
.btn-primary { background: var(--color-primary); color: #fff; }
.btn-primary:hover { background: var(--color-primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.btn-secondary { background: var(--color-surface); color: var(--color-text); border: 1px solid var(--color-border); }
.btn-secondary:hover { background: var(--color-surface-alt); border-color: var(--color-text-tertiary); }
.btn-ghost { color: var(--color-text-secondary); padding: 8px 12px; }
.btn-ghost:hover { background: var(--color-surface-alt); color: var(--color-text); }
.btn-accent { background: var(--color-accent); color: #fff; }
.btn-accent:hover { background: #E68600; }
.btn-lg { padding: 14px 28px; font-size: 16px; border-radius: var(--radius-md); }
.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
.btn-group { display: flex; gap: var(--space-sm); flex-wrap: wrap; }

/* Forms */
.form-group { margin-bottom: var(--space-lg); }
.form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: var(--space-sm); color: var(--color-text); }
.form-hint { font-size: 13px; color: var(--color-text-tertiary); margin-top: var(--space-xs); }
.form-input { width: 100%; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 15px; background: var(--color-surface); transition: all var(--transition-fast); color: var(--color-text); }
.form-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light); }
.form-input::placeholder { color: var(--color-text-tertiary); }
textarea.form-input { min-height: 80px; resize: vertical; line-height: 1.5; }
select.form-input { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%236E6E73' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }

/* Status selector */
.status-selector { display: flex; gap: var(--space-sm); flex-wrap: wrap; }
.status-option { flex: 1; min-width: 90px; padding: 12px; border: 2px solid var(--color-border); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); text-align: center; font-size: 14px; font-weight: 500; }
.status-option:hover { border-color: var(--color-text-tertiary); }
.status-option.selected.st-good { border-color: var(--color-success); background: var(--color-success-light); color: var(--color-success); }
.status-option.selected.st-partial { border-color: var(--color-warning); background: var(--color-warning-light); color: var(--color-warning); }
.status-option.selected.st-missing { border-color: var(--color-danger); background: var(--color-danger-light); color: var(--color-danger); }
.status-option.selected.st-na { border-color: var(--color-text-tertiary); background: var(--color-surface-alt); color: var(--color-text-secondary); }

/* Badges */
.badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 999px; font-size: 12px; font-weight: 500; }
.badge-success { background: var(--color-success-light); color: var(--color-success); }
.badge-warning { background: var(--color-warning-light); color: var(--color-warning); }
.badge-danger { background: var(--color-danger-light); color: var(--color-danger); }
.badge-neutral { background: var(--color-surface-alt); color: var(--color-text-secondary); }
.badge-primary { background: var(--color-primary-light); color: var(--color-primary); }

/* Checklist */
.checklist { display: flex; flex-direction: column; gap: 2px; }
.check-item { display: flex; align-items: flex-start; gap: var(--space-md); padding: var(--space-md); border-radius: var(--radius-sm); cursor: pointer; transition: background var(--transition-fast); }
.check-item:hover { background: var(--color-surface-alt); }
.check-box { width: 22px; height: 22px; border: 2px solid var(--color-border); border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all var(--transition-fast); margin-top: 1px; }
.check-item.checked .check-box { background: var(--color-primary); border-color: var(--color-primary); }
.check-item.checked .check-box svg { opacity: 1; }
.check-box svg { width: 14px; height: 14px; stroke: #fff; stroke-width: 2.5; fill: none; opacity: 0; }
.check-text { font-size: 14px; line-height: 1.5; }
.check-item.checked .check-text { color: var(--color-text-tertiary); text-decoration: line-through; }

/* Expandable card */
.expand-card { border: 1px solid var(--color-border); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: var(--space-md); background: var(--color-surface); }
.expand-card-header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-md) var(--space-lg); cursor: pointer; gap: var(--space-md); }
.expand-card-header:hover { background: var(--color-surface-alt); }
.expand-card-title { font-weight: 600; font-size: 15px; }
.expand-card-chevron { color: var(--color-text-tertiary); transition: transform var(--transition-fast); font-size: 18px; }
.expand-card.expanded .expand-card-chevron { transform: rotate(180deg); }
.expand-card-body { display: none; padding: 0 var(--space-lg) var(--space-lg); }
.expand-card.expanded .expand-card-body { display: block; }

/* Bar chart */
.bar-chart { display: flex; flex-direction: column; gap: var(--space-md); }
.bar-row { display: flex; align-items: center; gap: var(--space-md); }
.bar-label { width: 140px; flex-shrink: 0; font-size: 13px; color: var(--color-text-secondary); text-align: right; }
.bar-track { flex: 1; height: 28px; background: var(--color-surface-alt); border-radius: 4px; overflow: hidden; position: relative; }
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; min-width: 0; }
.bar-value { font-size: 12px; font-weight: 600; color: #fff; }
@media (max-width: 600px) { .bar-label { width: 90px; font-size: 11px; } }

/* Action table */
.action-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.action-table th { text-align: left; padding: var(--space-sm) var(--space-md); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-tertiary); border-bottom: 2px solid var(--color-border); }
.action-table td { padding: var(--space-md); border-bottom: 1px solid var(--color-border-light); vertical-align: top; }
.action-table tr:last-child td { border-bottom: none; }
.action-input-mini { width: 100%; padding: 6px 10px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 13px; background: var(--color-surface); }
.action-input-mini:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light); }

/* Cost table */
.cost-table { width: 100%; border-collapse: collapse; font-size: 14px; }
.cost-table th { text-align: left; padding: 10px 12px; background: var(--color-surface-alt); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-tertiary); border-bottom: 2px solid var(--color-border); }
.cost-table td { padding: 10px 12px; border-bottom: 1px solid var(--color-border-light); }
.cost-table tr:last-child td { border-bottom: none; }
.cost-total td { font-weight: 700; border-top: 2px solid var(--color-text); background: var(--color-surface-alt); }

/* Timeline */
.timeline { position: relative; padding-left: 28px; }
.timeline::before { content: ''; position: absolute; left: 9px; top: 4px; bottom: 4px; width: 2px; background: var(--color-border); }
.timeline-item { position: relative; padding-bottom: var(--space-xl); }
.timeline-item:last-child { padding-bottom: 0; }
.timeline-dot { position: absolute; left: -28px; top: 2px; width: 20px; height: 20px; border-radius: 50%; background: var(--color-surface); border: 2px solid var(--color-border); display: flex; align-items: center; justify-content: center; }
.timeline-item.tl-active .timeline-dot { border-color: var(--color-primary); background: var(--color-primary-light); }
.timeline-period { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--color-text-tertiary); margin-bottom: 2px; }
.timeline-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
.timeline-desc { font-size: 14px; color: var(--color-text-secondary); line-height: 1.5; }

/* Pages */
.page { display: none; animation: fadeIn 0.3s ease; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.page-header { margin-bottom: var(--space-2xl); }
.page-header .t-label { margin-bottom: var(--space-sm); }
.page-header .t-display { margin-bottom: var(--space-md); }
.page-header .t-body { color: var(--color-text-secondary); max-width: 600px; }
.section-divider { height: 1px; background: var(--color-border); margin: var(--space-2xl) 0; }

/* Welcome */
.welcome-hero { text-align: center; padding: var(--space-3xl) var(--space-lg); max-width: 640px; margin: 0 auto; }
.welcome-icon { width: 72px; height: 72px; background: var(--color-primary-light); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-lg); font-size: 32px; }
.welcome-hero .t-display { margin-bottom: var(--space-md); }
.welcome-hero .t-body { margin-bottom: var(--space-2xl); }
.welcome-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin: var(--space-2xl) 0; text-align: center; }
.welcome-stat { padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); }
.welcome-stat-value { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--color-primary); }
.welcome-stat-label { font-size: 13px; color: var(--color-text-secondary); margin-top: 4px; }
.welcome-phases { display: flex; flex-direction: column; gap: var(--space-md); margin: var(--space-2xl) 0; text-align: left; }
.welcome-phase { display: flex; gap: var(--space-lg); padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); }
.welcome-phase-num { width: 36px; height: 36px; background: var(--color-primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--color-primary); flex-shrink: 0; font-size: 15px; }
.welcome-phase-title { font-weight: 600; margin-bottom: 2px; }
.welcome-phase-desc { font-size: 14px; color: var(--color-text-secondary); }
@media (max-width: 600px) { .welcome-stats { grid-template-columns: 1fr; } .welcome-hero { padding: var(--space-2xl) var(--space-md); } }

/* KPI Row */
.kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-xl); }
.kpi-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-lg); text-align: center; }
.kpi-value { font-family: var(--font-display); font-size: 32px; font-weight: 700; line-height: 1; }
.kpi-label { font-size: 12px; color: var(--color-text-secondary); margin-top: 6px; }

/* IP Inventory row */
.ip-row { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-lg); margin-bottom: var(--space-md); }
.ip-fields { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-md); }
@media (max-width: 600px) { .ip-fields { grid-template-columns: 1fr; } }

/* Assignment row */
.assign-row { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-lg); margin-bottom: var(--space-md); }
.assign-fields { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-md); }
@media (max-width: 600px) { .assign-fields { grid-template-columns: 1fr; } }

/* Deficiency card */
.deficiency-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-lg); margin-bottom: var(--space-md); border-left: 4px solid var(--color-border); }
.deficiency-card.risk-critical { border-left-color: #7C5500; }
.deficiency-card.risk-high { border-left-color: var(--color-danger); }
.deficiency-card.risk-medium { border-left-color: var(--color-warning); }
.deficiency-header { display: flex; align-items: center; justify-content: space-between; gap: var(--space-sm); flex-wrap: wrap; margin-bottom: var(--space-sm); }
.deficiency-meta { font-size: 13px; color: var(--color-text-secondary); line-height: 1.5; }

/* Digital asset row */
.digital-row { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-lg); margin-bottom: var(--space-md); }
.digital-fields { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--space-md); }
@media (max-width: 600px) { .digital-fields { grid-template-columns: 1fr; } }

/* Toast */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--color-text); color: #fff; padding: 12px 20px; border-radius: var(--radius-md); font-size: 14px; box-shadow: var(--shadow-lg); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1000; max-width: 360px; }
.toast.show { transform: translateY(0); opacity: 1; }

/* Utility */
.flex { display: flex; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-sm { gap: var(--space-sm); }
.gap-md { gap: var(--space-md); }

/* Accessibility */
.skip-link { position: absolute; top: -40px; left: 0; background: var(--color-primary); color: #fff; padding: 8px 16px; z-index: 200; font-size: 14px; }
.skip-link:focus { top: 0; }
:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 2px; }
*:focus:not(:focus-visible) { outline: none; }

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } }

/* Print */
@media print { .sidebar, .mobile-header, .toast, .btn-group, .skip-link, .sidebar-overlay { display: none !important; } .main-content { margin-left: 0 !important; } .page { display: block !important; page-break-inside: avoid; } .content-area { max-width: 100%; padding: 0; } }
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to content</a>
<div class="app">
  <nav class="sidebar" id="sidebar" role="navigation" aria-label="Playbook navigation">
    <div class="sidebar-brand">
      <div class="sidebar-brand-label">Exit Planning Playbook #20</div>
      <div class="sidebar-brand-title">Intellectual Property Audit & Protection</div>
    </div>
    <div class="sidebar-progress">
      <div class="sidebar-progress-label">Your Progress</div>
      <div class="sidebar-progress-bar"><div class="sidebar-progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="sidebar-progress-text" id="progressText">0% complete</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-label">Discovery</div>
      <div class="nav-item active" data-page="welcome" onclick="goToPage('welcome')" tabindex="0" role="button">
        <div class="nav-icon">&#9733;</div> Welcome
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item" data-page="inventory" onclick="goToPage('inventory')" tabindex="0" role="button">
        <div class="nav-icon">&#128269;</div> IP Inventory
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="assignments" onclick="goToPage('assignments')" tabindex="0" role="button">
        <div class="nav-icon">&#128221;</div> Ownership & Assignments
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-section-label">Protection</div>
      <div class="nav-item locked" data-page="trademarks" onclick="goToPage('trademarks')" tabindex="0" role="button">
        <div class="nav-icon">&#174;</div> Trademarks
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="patents" onclick="goToPage('patents')" tabindex="0" role="button">
        <div class="nav-icon">&#128274;</div> Patents & Trade Secrets
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="software" onclick="goToPage('software')" tabindex="0" role="button">
        <div class="nav-icon">&#128187;</div> Software & Digital Assets
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-section-label">Remediation</div>
      <div class="nav-item locked" data-page="deficiencies" onclick="goToPage('deficiencies')" tabindex="0" role="button">
        <div class="nav-icon">&#9888;</div> Deficiency Cures
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="valuation" onclick="goToPage('valuation')" tabindex="0" role="button">
        <div class="nav-icon">&#128176;</div> IP Valuation
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="action" onclick="goToPage('action')" tabindex="0" role="button">
        <div class="nav-icon">&#10003;</div> Action Plan
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="dashboard" onclick="goToPage('dashboard')" tabindex="0" role="button">
        <div class="nav-icon">&#9632;</div> Scorecard
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
    </div>
    <div class="sidebar-score">
      <div class="sidebar-score-label">IP Protection Score</div>
      <div class="sidebar-score-value" id="sidebarScore">--<span class="sidebar-score-max">/100</span></div>
      <div class="sidebar-score-desc" id="sidebarScoreDesc">Complete assessment to see score</div>
    </div>
  </nav>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobile()"></div>
  <div class="main-content" id="main-content">
    <div class="mobile-header">
      <button class="hamburger" onclick="openMobile()" aria-label="Open menu"><span></span></button>
      <div style="font-weight:600;font-size:15px">IP Audit & Protection</div>
    </div>
    <div class="content-area">

<!-- ======================== WELCOME ======================== -->
<div class="page active" id="page-welcome">
  <div class="welcome-hero">
    <div class="welcome-icon">&#128274;</div>
    <div class="t-display">Intellectual Property Audit & Protection</div>
    <p class="t-body t-secondary">Your IP may be your most valuable asset -- or your greatest liability. Know what you own, prove you own it, and protect it before going to market. This guided assessment will inventory, evaluate, and secure your entire IP portfolio.</p>
    <div class="welcome-stats">
      <div class="welcome-stat">
        <div class="welcome-stat-value">90%</div>
        <div class="welcome-stat-label">of S&P 500 value is intangible assets</div>
      </div>
      <div class="welcome-stat">
        <div class="welcome-stat-value">0.5-1.0x</div>
        <div class="welcome-stat-label">higher EBITDA multiple with strong IP</div>
      </div>
      <div class="welcome-stat">
        <div class="welcome-stat-value">$30-75K</div>
        <div class="welcome-stat-label">typical IP protection investment</div>
      </div>
    </div>
    <div class="callout callout-accent mb-2xl">
      <strong>The Core Principle:</strong> A buyer is not paying for IP you use. A buyer is paying for IP you own -- provably, exclusively, and defensibly. If you cannot produce a signed assignment agreement from every employee and contractor who contributed to your core IP, you have an ownership gap that will be exploited in diligence.
    </div>
    <div class="welcome-phases">
      <div class="welcome-phase">
        <div class="welcome-phase-num">1</div>
        <div><div class="welcome-phase-title">Discovery: Inventory & Ownership</div><div class="welcome-phase-desc">Catalog every IP asset across 8 categories. Audit assignment agreements for all contributors.</div></div>
      </div>
      <div class="welcome-phase">
        <div class="welcome-phase-num">2</div>
        <div><div class="welcome-phase-title">Protection: Trademarks, Patents & Secrets</div><div class="welcome-phase-desc">Assess registration status, trade secret measures, and software/digital asset security.</div></div>
      </div>
      <div class="welcome-phase">
        <div class="welcome-phase-num">3</div>
        <div><div class="welcome-phase-title">Remediation: Deficiencies & Valuation</div><div class="welcome-phase-desc">Identify gaps, estimate value-enhancing actions, and build your IP protection plan.</div></div>
      </div>
    </div>
    <button class="btn btn-primary btn-lg" onclick="startAssessment()">Begin IP Audit</button>
  </div>
</div>

<!-- ======================== IP INVENTORY ======================== -->
<div class="page" id="page-inventory">
  <div class="page-header">
    <div class="t-label">Phase 1: Discovery</div>
    <div class="t-display">Comprehensive IP Inventory</div>
    <p class="t-body t-secondary">Catalog every form of intellectual property your company uses, regardless of whether it is formally registered. This master list drives all subsequent analysis.</p>
  </div>
  <div class="callout callout-warning mb-xl">
    <strong>Often Overlooked:</strong> The most commonly missed IP assets are: (1) custom software developed by contractors without written assignments, (2) domain names in founder's personal accounts, (3) social media handles that are technically personal property, and (4) proprietary processes that exist only as tribal knowledge.
  </div>
  <div id="inventoryGrid"></div>
  <button class="btn btn-secondary mb-xl" onclick="addIPAsset()">+ Add IP Asset</button>
  <div class="section-divider"></div>
  <div class="t-h2 mb-lg">IP Category Reference</div>
  <div class="card mb-xl" style="overflow-x:auto">
    <table class="cost-table">
      <thead><tr><th>Category</th><th>Examples</th><th>Where to Look</th></tr></thead>
      <tbody>
        <tr><td>Trademarks</td><td>Brand names, logos, taglines, product names</td><td>USPTO TESS; marketing materials</td></tr>
        <tr><td>Patents</td><td>Utility, design, provisionals</td><td>USPTO PAIR; R&D files</td></tr>
        <tr><td>Copyrights</td><td>Software, manuals, marketing, website</td><td>Copyright Office; repos; archives</td></tr>
        <tr><td>Trade Secrets</td><td>Customer lists, pricing models, algorithms</td><td>Internal docs; employee knowledge</td></tr>
        <tr><td>Software</td><td>Proprietary apps, SaaS, internal tools</td><td>Code repos; license records</td></tr>
        <tr><td>Domains & Digital</td><td>Domains, social accounts, app listings</td><td>Registrar; social platforms</td></tr>
        <tr><td>Licenses (In)</td><td>Third-party software/content licenses</td><td>Vendor contracts</td></tr>
        <tr><td>Licenses (Out)</td><td>Technology licensed to customers/partners</td><td>Customer agreements</td></tr>
      </tbody>
    </table>
  </div>
  <div class="btn-group">
    <button class="btn btn-secondary" onclick="goToPage('welcome')">Back</button>
    <button class="btn btn-primary" onclick="completeInventory()">Continue to Ownership</button>
  </div>
</div>

<!-- ======================== ASSIGNMENTS ======================== -->
<div class="page" id="page-assignments">
  <div class="page-header">
    <div class="t-label">Phase 1: Discovery</div>
    <div class="t-display">Ownership & Assignment Agreements</div>
    <p class="t-body t-secondary">The most critical IP diligence question: "Does the company actually own what it claims to own?" Proving ownership requires a clear chain of title from every creator to the company.</p>
  </div>
  <div class="callout callout-danger mb-xl">
    <strong>Default Rules Work Against You:</strong> Contractors own copyright in their work by default. Inventors own patent rights by default. Trade secrets require "reasonable measures" to maintain protection. Without written agreements, you may not own the IP you think you do.
  </div>
  <div class="t-h2 mb-lg">IP Assignment Tracker</div>
  <p class="t-small t-secondary mb-lg">List every person (employee or contractor) who contributed to your core IP. Cross-reference against signed assignment agreements.</p>
  <div id="assignmentGrid"></div>
  <button class="btn btn-secondary mb-xl" onclick="addAssignment()">+ Add Person</button>

  <div class="section-divider"></div>
  <div class="t-h2 mb-lg">Assignment Gap Reference</div>
  <div class="card mb-xl" style="overflow-x:auto">
    <table class="cost-table">
      <thead><tr><th>Gap Scenario</th><th>Risk</th><th>Remediation</th></tr></thead>
      <tbody>
        <tr><td>Current employee; no signed agreement</td><td><span class="badge badge-danger">High</span></td><td>Obtain signed PIIA immediately; consider retention incentive</td></tr>
        <tr><td>Former employee; no signed agreement</td><td><span class="badge badge-danger">Critical</span></td><td>Contact for retroactive assignment; may require compensation</td></tr>
        <tr><td>Contractor; no IP clause</td><td><span class="badge badge-danger">Critical</span></td><td>Obtain written assignment; assess work-for-hire arguments</td></tr>
        <tr><td>Offshore contractor; no agreement</td><td><span class="badge badge-danger">Critical</span></td><td>Engage local counsel for assignment under applicable law</td></tr>
        <tr><td>Founder; pre-formation IP</td><td><span class="badge badge-danger">High</span></td><td>Execute IP assignment from founder to entity</td></tr>
        <tr><td>University or prior employer claims</td><td><span class="badge badge-warning">Medium-High</span></td><td>Review prior agreements; obtain freedom-to-operate opinion</td></tr>
      </tbody>
    </table>
  </div>
  <div class="btn-group">
    <button class="btn btn-secondary" onclick="goToPage('inventory')">Back</button>
    <button class="btn btn-primary" onclick="completeAssignments()">Continue to Trademarks</button>
  </div>
</div>

<!-- ======================== TRADEMARKS ======================== -->
<div class="page" id="page-trademarks">
  <div class="page-header">
    <div class="t-label">Phase 2: Protection</div>
    <div class="t-display">Trademark Strategy & Registration</div>
    <p class="t-body t-secondary">Federal registration provides nationwide priority and constructive notice. Unregistered trademarks have only limited common law protection. Registration is a high-ROI investment.</p>
  </div>
  <div class="callout callout-accent mb-xl">
    <strong>Cost Reference:</strong> USPTO filing fees are $250-$350 per class per mark. Attorney fees: $1,000-$3,000 per mark. Typical company needs 3-8 registrations. Total: $5,000-$25,000 -- trivial relative to brand value being protected.
  </div>

  <div class="t-h2 mb-lg">Registration Priority Assessment</div>
  <p class="t-small t-secondary mb-lg">Assess each trademark type for your company. Register in priority order.</p>
  <div id="trademarkChecks"></div>

  <div class="section-divider"></div>
  <div class="t-h2 mb-lg">Federal vs. Common Law Protection</div>
  <div class="card mb-xl" style="overflow-x:auto">
    <table class="cost-table">
      <thead><tr><th>Factor</th><th>Federal Registration</th><th>Common Law Only</th></tr></thead>
      <tbody>
        <tr><td>Geographic scope</td><td>Nationwide priority</td><td>Limited to area of actual use</td></tr>
        <tr><td>Presumptions</td><td>Validity, ownership, exclusive right presumed</td><td>Must prove in each dispute</td></tr>
        <tr><td>Federal court access</td><td>Basis for federal jurisdiction</td><td>State court only</td></tr>
        <tr><td>Customs enforcement</td><td>Can block infringing imports</td><td>Not available</td></tr>
        <tr><td>Damages</td><td>Statutory damages and attorney fees</td><td>Actual damages only</td></tr>
        <tr><td>Incontestability</td><td>After 5 years continuous use</td><td>Never available</td></tr>
        <tr><td>International filing</td><td>Basis for Madrid Protocol application</td><td>No international priority</td></tr>
      </tbody>
    </table>
  </div>
  <div class="btn-group">
    <button class="btn btn-secondary" onclick="goToPage('assignments')">Back</button>
    <button class="btn btn-primary" onclick="completeTrademarks()">Continue to Patents & Secrets</button>
  </div>
</div>

<!-- ======================== PATENTS & TRADE SECRETS ======================== -->
<div class="page" id="page-patents">
  <div class="page-header">
    <div class="t-label">Phase 2: Protection</div>
    <div class="t-display">Patent, Trade Secret & Copyright Protection</div>
    <p class="t-body t-secondary">Patents provide monopoly protection. Trade secrets are protected indefinitely -- but only with "reasonable measures." Copyrights exist automatically but registration provides critical litigation advantages.</p>
  </div>

  <div class="t-h2 mb-lg">Patent Status Assessment</div>
  <p class="t-small t-secondary mb-md">If your company holds patents, verify maintenance and assignment status.</p>
  <div id="patentChecks"></div>

  <div class="section-divider"></div>
  <div class="t-h2 mb-lg">Trade Secret Protection Measures</div>
  <p class="t-small t-secondary mb-md">Buyers evaluate whether your trade secret program meets the "reasonable measures" standard. Assess each measure.</p>
  <div id="tradeSecretChecks"></div>

  <div class="section-divider"></div>
  <div class="t-h2 mb-lg">Copyright Registration Priorities</div>
  <div class="checklist mb-xl" id="copyrightChecklist"></div>

  <div class="btn-group">
    <button class="btn btn-secondary" onclick="goToPage('trademarks')">Back</button>
    <button class="btn btn-primary" onclick="completePatents()">Continue to Software & Digital</button>
  </div>
</div>

<!-- ======================== SOFTWARE & DIGITAL ======================== -->
<div class="page" id="page-software">
  <div class="page-header">
    <div class="t-label">Phase 2: Protection</div>
    <div class="t-display">Software, Technology & Digital Assets</div>
    <p class="t-body t-secondary">If your company develops proprietary software, a buyer's technical diligence will examine ownership, open-source compliance, and digital asset transfer readiness.</p>
  </div>

  <div class="t-h2 mb-lg">Software IP Audit</div>
  <div id="softwareChecks"></div>

  <div class="section-divider"></div>
  <div class="t-h2 mb-lg">Domain & Digital Asset Register</div>
  <p class="t-small t-secondary mb-lg">Document all digital assets and whether they are properly owned by the company entity.</p>
  <div id="digitalGrid"></div>
  <button class="btn btn-secondary mb-xl" onclick="addDigitalAsset()">+ Add Digital Asset</button>

  <div class="section-divider"></div>
  <div class="t-h2 mb-lg">Digital Asset Transfer Reference</div>
  <div class="card mb-xl" style="overflow-x:auto">
    <table class="cost-table">
      <thead><tr><th>Asset Type</th><th>Common Issue</th><th>Required Action</th></tr></thead>
      <tbody>
        <tr><td>Domain names</td><td>In founder's personal account</td><td>Transfer to company-owned registrar</td></tr>
        <tr><td>SSL certificates</td><td>Tied to individual email</td><td>Reissue under company domain</td></tr>
        <tr><td>Social media</td><td>Personal credentials</td><td>Transfer ownership to company</td></tr>
        <tr><td>App store listings</td><td>Personal developer account</td><td>Transfer to company developer account</td></tr>
        <tr><td>Cloud accounts</td><td>Root credentials held by one person</td><td>Implement IAM; document recovery</td></tr>
        <tr><td>SaaS subscriptions</td><td>Non-transferable personal licenses</td><td>Convert to enterprise accounts</td></tr>
      </tbody>
    </table>
  </div>
  <div class="btn-group">
    <button class="btn btn-secondary" onclick="goToPage('patents')">Back</button>
    <button class="btn btn-primary" onclick="completeSoftware()">Continue to Deficiency Cures</button>
  </div>
</div>

<!-- ======================== DEFICIENCIES ======================== -->
<div class="page" id="page-deficiencies">
  <div class="page-header">
    <div class="t-label">Phase 3: Remediation</div>
    <div class="t-display">IP Deficiencies & Remediation</div>
    <p class="t-body t-secondary">Review common IP deficiencies and mark which apply to your company. Track remediation progress for each.</p>
  </div>
  <div id="deficiencyCards"></div>
  <div class="section-divider"></div>
  <div class="t-h2 mb-lg">Estimated Remediation Cost</div>
  <div id="costEstimate"></div>
  <div class="section-divider"></div>
  <div class="btn-group">
    <button class="btn btn-secondary" onclick="goToPage('software')">Back</button>
    <button class="btn btn-primary" onclick="completeDeficiencies()">Continue to IP Valuation</button>
  </div>
</div>

<!-- ======================== VALUATION ======================== -->
<div class="page" id="page-valuation">
  <div class="page-header">
    <div class="t-label">Phase 3: Remediation</div>
    <div class="t-display">IP Valuation Considerations</div>
    <p class="t-body t-secondary">Understanding valuation methodologies helps you frame the value of your IP portfolio and identify value-enhancing actions you can take before a transaction.</p>
  </div>

  <div class="callout callout-accent mb-xl">
    <strong>ROI of IP Protection:</strong> A company with $5M EBITDA and strong IP protection typically commands a 0.5x-1.0x higher multiple than identical businesses with weak IP documentation. That is $2.5M-$5.0M of additional enterprise value against a $30,000-$75,000 investment.
  </div>

  <div class="t-h2 mb-lg">Valuation Method Reference</div>
  <div class="card mb-xl" style="overflow-x:auto">
    <table class="cost-table">
      <thead><tr><th>Method</th><th>Approach</th><th>Best For</th></tr></thead>
      <tbody>
        <tr><td>Cost approach</td><td>What would it cost to recreate?</td><td>Software, databases, internal tools</td></tr>
        <tr><td>Market approach</td><td>What have comparable IP assets sold for?</td><td>Patents, trademarks</td></tr>
        <tr><td>Income approach</td><td>What revenue does the IP generate?</td><td>Brands, patented products</td></tr>
        <tr><td>Relief from royalty</td><td>What royalty to license equivalent IP?</td><td>Trademarks, patents</td></tr>
        <tr><td>Multi-period excess earnings</td><td>Present value of future IP earnings</td><td>Primary IP in tech companies</td></tr>
      </tbody>
    </table>
  </div>

  <div class="t-h2 mb-lg">Value-Enhancing Actions Checklist</div>
  <div class="checklist mb-xl" id="valueActions"></div>

  <div class="section-divider"></div>
  <div class="t-h2 mb-lg">Your IP Value Estimate</div>
  <p class="t-small t-secondary mb-lg">Provide rough estimates to understand the magnitude of IP value at stake.</p>
  <div class="card mb-xl">
    <div class="ip-fields">
      <div class="form-group" style="margin-bottom:0">
        <label class="form-label">Estimated annual EBITDA</label>
        <input class="form-input" id="valEbitda" type="text" placeholder="e.g. $2,000,000" oninput="updateValuation()">
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label class="form-label">IP contribution to revenue (%)</label>
        <select class="form-input" id="valIpPct" onchange="updateValuation()">
          <option value="">Select...</option>
          <option value="10">10% -- Minimal IP dependence</option>
          <option value="25">25% -- Moderate IP contribution</option>
          <option value="40">40% -- Significant IP component</option>
          <option value="60">60% -- IP-heavy business</option>
          <option value="80">80% -- IP is the product</option>
        </select>
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label class="form-label">Expected EBITDA multiple</label>
        <select class="form-input" id="valMultiple" onchange="updateValuation()">
          <option value="">Select...</option>
          <option value="3">3x</option>
          <option value="4">4x</option>
          <option value="5">5x</option>
          <option value="6">6x</option>
          <option value="7">7x</option>
          <option value="8">8x</option>
        </select>
      </div>
    </div>
  </div>
  <div id="valuationResult"></div>

  <div class="btn-group">
    <button class="btn btn-secondary" onclick="goToPage('deficiencies')">Back</button>
    <button class="btn btn-primary" onclick="completeValuation()">Continue to Action Plan</button>
  </div>
</div>

<!-- ======================== ACTION PLAN ======================== -->
<div class="page" id="page-action">
  <div class="page-header">
    <div class="t-label">Phase 3: Remediation</div>
    <div class="t-display">IP Protection Action Plan</div>
    <p class="t-body t-secondary">Build your remediation timeline. Actions are pre-populated from identified deficiencies and gaps. Assign owners, set dates, and track progress.</p>
  </div>
  <div class="t-h2 mb-lg">Implementation Timeline</div>
  <div class="timeline mb-2xl" id="implementationTimeline"></div>
  <div class="section-divider"></div>
  <div class="t-h2 mb-lg">Action Items</div>
  <div class="card mb-lg" style="overflow-x:auto">
    <table class="action-table">
      <thead><tr><th>Action</th><th>Owner</th><th>Target Date</th><th>Status</th></tr></thead>
      <tbody id="actionTableBody"></tbody>
    </table>
  </div>
  <button class="btn btn-secondary mb-xl" onclick="addActionRow()">+ Add Action Item</button>
  <div class="btn-group">
    <button class="btn btn-secondary" onclick="goToPage('valuation')">Back</button>
    <button class="btn btn-primary" onclick="completeAction()">View Scorecard</button>
  </div>
</div>

<!-- ======================== DASHBOARD ======================== -->
<div class="page" id="page-dashboard">
  <div class="page-header">
    <div class="t-label">IP Protection Scorecard</div>
    <div class="t-display">Your IP Readiness Assessment</div>
  </div>
  <div class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-value" id="dashScore" style="color:var(--color-primary)">--</div>
      <div class="kpi-label">IP Protection Score</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value" id="dashAssets">--</div>
      <div class="kpi-label">IP Assets Cataloged</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value" id="dashAssignGaps" style="color:var(--color-danger)">--</div>
      <div class="kpi-label">Assignment Gaps</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value" id="dashDefOpen" style="color:var(--color-warning)">--</div>
      <div class="kpi-label">Open Deficiencies</div>
    </div>
  </div>
  <div class="card mb-xl">
    <div class="t-h2 mb-lg">Protection by Category</div>
    <div class="bar-chart" id="dashBarChart"></div>
  </div>
  <div class="card mb-xl">
    <div class="t-h2 mb-lg">Key Recommendations</div>
    <div id="dashRecommendations"></div>
  </div>
  <div class="card mb-xl">
    <div class="t-h2 mb-lg">Action Items Progress</div>
    <div id="dashActionProgress"></div>
  </div>
  <div class="btn-group">
    <button class="btn btn-secondary" onclick="goToPage('action')">Back to Action Plan</button>
    <button class="btn btn-accent" onclick="exportReport()">Export Report</button>
  </div>
</div>

    </div>
  </div>
</div>
<div class="toast" id="toast" aria-live="polite" role="status"></div>

<script>
/* ============================================================
   CONSTANTS
   ============================================================ */
const IP_CATEGORIES = [
  { value: 'trademark', label: 'Trademark' },
  { value: 'patent', label: 'Patent' },
  { value: 'copyright', label: 'Copyright' },
  { value: 'trade-secret', label: 'Trade Secret' },
  { value: 'software', label: 'Software' },
  { value: 'domain', label: 'Domain / Digital' },
  { value: 'license-in', label: 'License (Inbound)' },
  { value: 'license-out', label: 'License (Outbound)' }
];

const TRADEMARK_ITEMS = [
  { id: 'company_name', label: 'Primary company name/brand', desc: 'The name your customers know you by', priority: 1 },
  { id: 'product_names', label: 'Key product/service marks', desc: 'Revenue-generating product and service names', priority: 2 },
  { id: 'logos', label: 'Logo marks', desc: 'Visual brand identifiers', priority: 3 },
  { id: 'taglines', label: 'Taglines and slogans', desc: 'Distinctive phrases used in marketing', priority: 4 },
  { id: 'trade_dress', label: 'Trade dress', desc: 'Distinctive product packaging or store design, if applicable', priority: 5 }
];

const PATENT_CHECKS = [
  { id: 'has_patents', label: 'Company holds issued or pending patents', type: 'yesno' },
  { id: 'fees_current', label: 'Maintenance fees are current (due at 3.5, 7.5, 11.5 years)', type: 'status' },
  { id: 'assignments', label: 'All inventor assignments use "hereby assigns" language (not "agrees to assign")', type: 'status' },
  { id: 'filing_assess', label: 'Assessed whether unfiled patentable inventions should be filed (provisional applications)', type: 'status' },
  { id: 'grace_period', label: 'Verified no inventions past the 1-year grace period from first public use', type: 'status' }
];

const TRADE_SECRET_MEASURES = [
  { id: 'ndas', label: 'Non-disclosure agreements', desc: 'All employees, contractors, vendors, and partners sign NDAs', status: '' },
  { id: 'access', label: 'Access controls', desc: 'Trade secret info restricted to need-to-know; role-based permissions', status: '' },
  { id: 'marking', label: 'Confidentiality marking', desc: 'Documents containing trade secrets marked "Confidential"', status: '' },
  { id: 'exit_proc', label: 'Exit procedures', desc: 'Departing employees reminded of NDA; devices wiped', status: '' },
  { id: 'training', label: 'Employee training', desc: 'Annual training on confidential information handling', status: '' },
  { id: 'vendor', label: 'Vendor controls', desc: 'Vendors with access bound by NDA and use restrictions', status: '' }
];

const COPYRIGHT_ITEMS = [
  'Core software source code registered with Copyright Office',
  'Training manuals and documentation registered',
  'Key marketing materials registered',
  'Website content registered',
  'All copyright notices are current and accurate'
];

const SOFTWARE_CHECKS = [
  { id: 'oss_scan', label: 'Open-source compliance scan completed', desc: 'Used Black Duck, FOSSA, Snyk or similar to identify all OSS components' },
  { id: 'copyleft', label: 'No copyleft (GPL/AGPL) license violations', desc: 'Copyleft components categorized; no proprietary code linked to GPL' },
  { id: 'provenance', label: 'Code provenance maintained', desc: 'Version control (Git) with clear commit history showing who contributed what' },
  { id: 'dependencies', label: 'Third-party dependencies documented', desc: 'All libraries, APIs, SDKs documented with license terms and assignability' },
  { id: 'data_privacy', label: 'Data privacy compliance documented', desc: 'CCPA, GDPR, state breach notification compliance documented' }
];

const DEFICIENCIES = [
  { id: 'no_piia', label: 'No employee IP assignment agreements', risk: 'Critical', cure: 'Execute PIIAs with all current employees; pursue retroactive assignments', time: '4-12 weeks' },
  { id: 'contractor_code', label: 'Contractor code without assignments', risk: 'Critical', cure: 'Obtain retroactive assignments; document work-for-hire arguments', time: '4-16 weeks' },
  { id: 'unreg_tm', label: 'Unregistered trademarks', risk: 'Medium', cure: 'File federal trademark applications for core marks', time: '8-12 months' },
  { id: 'oss_violation', label: 'Open-source license violations', risk: 'High', cure: 'Conduct scan; remove or replace non-compliant components', time: '4-8 weeks' },
  { id: 'personal_domains', label: 'Domains in personal accounts', risk: 'High', cure: 'Transfer to corporate registrar account', time: '1-2 weeks' },
  { id: 'no_ts_program', label: 'No trade secret program', risk: 'Medium-High', cure: 'Implement NDA, access control, and marking program', time: '4-8 weeks' },
  { id: 'lapsed_patent', label: 'Lapsed patent maintenance', risk: 'Varies', cure: 'If within grace period, pay fees + surcharge', time: '1-4 weeks' },
  { id: 'no_ip_schedule', label: 'No IP schedule in corporate records', risk: 'Medium', cure: 'Create comprehensive IP inventory and attach to corporate records', time: '2-4 weeks' }
];

const VALUE_ACTIONS = [
  'Register core trademarks ($5K-$25K; adds certainty worth 5-15x the cost)',
  'Execute all missing IP assignments (eliminates ownership uncertainty)',
  'File provisional patent applications for unprotected inventions ($5K-$15K)',
  'Implement trade secret protection program (demonstrates "reasonable measures")',
  'Complete open-source audit and remediate copyleft exposure',
  'Transfer all digital assets to company-owned accounts',
  'Document IP in a formal IP schedule attached to corporate records'
];

const TIMELINE_DATA = [
  { period: 'Week 1-2', title: 'IP Inventory & Gap Identification', desc: 'Complete this assessment. Catalog all IP assets. Identify missing assignment agreements. Prioritize gaps by risk level.' },
  { period: 'Week 3-6', title: 'Critical Assignments & Agreements', desc: 'Execute PIIAs with current employees. Contact former employees/contractors for retroactive assignments. Address founder IP transfer.' },
  { period: 'Week 4-8', title: 'Trademark Registration', desc: 'File federal trademark applications for core marks. Begin with primary brand name, then product marks, then logos.' },
  { period: 'Week 4-8', title: 'Trade Secret & Software Protection', desc: 'Implement trade secret program (NDAs, access controls, marking). Complete open-source scan and remediation.' },
  { period: 'Week 6-12', title: 'Digital Asset Transfer & Documentation', desc: 'Transfer all domains, social accounts, app listings to company ownership. Create formal IP schedule. File copyright registrations for priority works.' }
];

/* ============================================================
   STATE
   ============================================================ */
const STORAGE_KEY = 'exitosx-pb20-ip-audit';
// Migrate from old key
(function() { try { const old = localStorage.getItem('playbook20-ip-audit'); if (old && !localStorage.getItem('exitosx-pb20-ip-audit')) { localStorage.setItem('exitosx-pb20-ip-audit', old); localStorage.removeItem('playbook20-ip-audit'); } } catch(e) {} })();
let state = {
  currentPage: 'welcome',
  pagesUnlocked: ['welcome', 'inventory'],
  pagesCompleted: [],
  ipAssets: [{ name: '', category: '', regNumber: '', status: '', owner: '', expiry: '', valueTier: '' }],
  assignments: [{ person: '', role: '', ipContributed: '', signed: '', date: '', gapAction: '', gapStatus: '' }],
  trademarks: {},
  patentChecks: {},
  tradeSecrets: {},
  copyrightChecks: {},
  softwareChecks: {},
  digitalAssets: [{ asset: '', type: '', registrar: '', accountOwner: '', expiry: '', transferred: '' }],
  deficiencies: {},
  valueChecks: {},
  valuation: { ebitda: '', ipPct: '', multiple: '' },
  actionItems: [],
  notes: {}
};

function saveState() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {} }
function loadState() { try { const d = localStorage.getItem(STORAGE_KEY); if (d) Object.assign(state, JSON.parse(d)); } catch(e) {} }

/* ============================================================
   NAVIGATION
   ============================================================ */
function goToPage(id) {
  const nav = document.querySelector(`.nav-item[data-page="${id}"]`);
  if (nav && nav.classList.contains('locked')) return;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const page = document.getElementById('page-' + id);
  if (page) page.classList.add('active');
  if (nav) nav.classList.add('active');
  state.currentPage = id;
  saveState();
  window.scrollTo(0, 0);
  closeMobile();
  renderPage(id);
  setTimeout(() => { const heading = page.querySelector('h1, h2, .t-display'); if (heading) { heading.setAttribute('tabindex', '-1'); heading.focus(); } }, 100);
}

function unlockPage(id) {
  if (!state.pagesUnlocked.includes(id)) state.pagesUnlocked.push(id);
  const nav = document.querySelector(`.nav-item[data-page="${id}"]`);
  if (nav) nav.classList.remove('locked');
  saveState();
}

function completePage(id) {
  if (!state.pagesCompleted.includes(id)) state.pagesCompleted.push(id);
  const nav = document.querySelector(`.nav-item[data-page="${id}"]`);
  if (nav) nav.classList.add('completed');
  saveState();
  updateProgress();
}

function updateProgress() {
  const total = 10;
  const done = state.pagesCompleted.length;
  const pct = Math.round((done / total) * 100);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = pct + '% complete';
  const score = calcScore();
  document.getElementById('sidebarScore').innerHTML = score > 0 ? score + '<span class="sidebar-score-max">/100</span>' : '--<span class="sidebar-score-max">/100</span>';
  document.getElementById('sidebarScoreDesc').textContent = score > 0 ? getLabel(score) : 'Complete assessment to see score';
}

function renderPage(id) {
  switch(id) {
    case 'inventory': renderInventory(); break;
    case 'assignments': renderAssignments(); break;
    case 'trademarks': renderTrademarks(); break;
    case 'patents': renderPatents(); break;
    case 'software': renderSoftware(); break;
    case 'deficiencies': renderDeficiencies(); break;
    case 'valuation': renderValuation(); break;
    case 'action': renderActionPage(); break;
    case 'dashboard': renderDashboard(); break;
  }
}

function openMobile() { document.getElementById('sidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.add('show'); }
function closeMobile() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); }
function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
function startAssessment() { completePage('welcome'); unlockPage('inventory'); goToPage('inventory'); showToast('Let\'s catalog your IP assets.'); }
function esc(s) { if (!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function toggleExpand(id) { document.getElementById(id).classList.toggle('expanded'); }

/* ============================================================
   IP INVENTORY
   ============================================================ */
function renderInventory() {
  document.getElementById('inventoryGrid').innerHTML = state.ipAssets.map((a, i) => `
    <div class="ip-row">
      <div class="flex items-center justify-between mb-md" style="flex-wrap:wrap;gap:8px">
        <div class="t-h3">IP Asset ${i + 1}</div>
        ${state.ipAssets.length > 1 ? `<button class="btn btn-ghost btn-sm" onclick="removeIP(${i})" style="color:var(--color-danger)">Remove</button>` : ''}
      </div>
      <div class="ip-fields">
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Asset Name</label><input class="form-input" placeholder="e.g. Company logo" value="${esc(a.name)}" oninput="updateIP(${i},'name',this.value)"></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Category</label>
          <select class="form-input" onchange="updateIP(${i},'category',this.value)"><option value="">Select...</option>${IP_CATEGORIES.map(c=>`<option value="${c.value}" ${a.category===c.value?'selected':''}>${c.label}</option>`).join('')}</select></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Registration #</label><input class="form-input" placeholder="If registered" value="${esc(a.regNumber)}" oninput="updateIP(${i},'regNumber',this.value)"></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Status</label>
          <select class="form-input" onchange="updateIP(${i},'status',this.value)"><option value="">Select...</option>
            <option value="registered" ${a.status==='registered'?'selected':''}>Registered</option>
            <option value="pending" ${a.status==='pending'?'selected':''}>Pending</option>
            <option value="unregistered" ${a.status==='unregistered'?'selected':''}>Unregistered</option>
            <option value="expired" ${a.status==='expired'?'selected':''}>Expired</option>
          </select></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Owner</label><input class="form-input" placeholder="Company or individual" value="${esc(a.owner)}" oninput="updateIP(${i},'owner',this.value)"></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Expiry / Renewal</label><input class="form-input" type="date" value="${a.expiry||''}" oninput="updateIP(${i},'expiry',this.value)"></div>
      </div>
    </div>
  `).join('');
}
function updateIP(i,f,v) { state.ipAssets[i][f]=v; saveState(); }
function addIPAsset() { state.ipAssets.push({ name:'',category:'',regNumber:'',status:'',owner:'',expiry:'',valueTier:'' }); saveState(); renderInventory(); }
function removeIP(i) { state.ipAssets.splice(i,1); saveState(); renderInventory(); }
function completeInventory() { completePage('inventory'); unlockPage('assignments'); goToPage('assignments'); showToast('IP inventory saved. Now audit ownership agreements.'); }

/* ============================================================
   ASSIGNMENTS
   ============================================================ */
function renderAssignments() {
  document.getElementById('assignmentGrid').innerHTML = state.assignments.map((a, i) => `
    <div class="assign-row">
      <div class="flex items-center justify-between mb-md" style="flex-wrap:wrap;gap:8px">
        <div class="t-h3">Person ${i + 1}</div>
        ${state.assignments.length > 1 ? `<button class="btn btn-ghost btn-sm" onclick="removeAssign(${i})" style="color:var(--color-danger)">Remove</button>` : ''}
      </div>
      <div class="assign-fields">
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Name</label><input class="form-input" placeholder="Full name" value="${esc(a.person)}" oninput="updateAssign(${i},'person',this.value)"></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Role</label>
          <select class="form-input" onchange="updateAssign(${i},'role',this.value)"><option value="">Select...</option>
            <option value="employee" ${a.role==='employee'?'selected':''}>Current Employee</option>
            <option value="former-emp" ${a.role==='former-emp'?'selected':''}>Former Employee</option>
            <option value="contractor" ${a.role==='contractor'?'selected':''}>Contractor</option>
            <option value="founder" ${a.role==='founder'?'selected':''}>Founder</option>
          </select></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">IP Contributed</label><input class="form-input" placeholder="What did they create?" value="${esc(a.ipContributed)}" oninput="updateAssign(${i},'ipContributed',this.value)"></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Assignment Signed?</label>
          <select class="form-input" onchange="updateAssign(${i},'signed',this.value)"><option value="">Select...</option>
            <option value="yes" ${a.signed==='yes'?'selected':''}>Yes</option>
            <option value="no" ${a.signed==='no'?'selected':''}>No</option>
            <option value="partial" ${a.signed==='partial'?'selected':''}>Partial / Unclear</option>
          </select></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Gap Action</label><input class="form-input" placeholder="What needs to be done?" value="${esc(a.gapAction)}" oninput="updateAssign(${i},'gapAction',this.value)"></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Status</label>
          <select class="form-input" onchange="updateAssign(${i},'gapStatus',this.value)"><option value="">Select...</option>
            <option value="resolved" ${a.gapStatus==='resolved'?'selected':''}>Resolved</option>
            <option value="in-progress" ${a.gapStatus==='in-progress'?'selected':''}>In Progress</option>
            <option value="not-started" ${a.gapStatus==='not-started'?'selected':''}>Not Started</option>
          </select></div>
      </div>
    </div>
  `).join('');
}
function updateAssign(i,f,v) { state.assignments[i][f]=v; saveState(); }
function addAssignment() { state.assignments.push({ person:'',role:'',ipContributed:'',signed:'',date:'',gapAction:'',gapStatus:'' }); saveState(); renderAssignments(); }
function removeAssign(i) { state.assignments.splice(i,1); saveState(); renderAssignments(); }
function completeAssignments() { completePage('assignments'); unlockPage('trademarks'); goToPage('trademarks'); showToast('Assignment audit saved. Now review trademark protection.'); }

/* ============================================================
   TRADEMARKS
   ============================================================ */
function renderTrademarks() {
  document.getElementById('trademarkChecks').innerHTML = TRADEMARK_ITEMS.map(item => {
    const val = state.trademarks[item.id] || '';
    return `<div class="expand-card ${val ? 'expanded' : ''}" id="tm-${item.id}">
      <div class="expand-card-header" onclick="toggleExpand('tm-${item.id}')">
        <div>
          <div class="expand-card-title"><span class="badge badge-neutral" style="margin-right:8px">Priority ${item.priority}</span>${item.label}</div>
          <div class="t-caption t-tertiary">${item.desc}</div>
        </div>
        ${val ? `<span class="badge ${val==='registered'?'badge-success':val==='filed'?'badge-primary':val==='common-law'?'badge-warning':'badge-neutral'}">${val==='registered'?'Registered':val==='filed'?'Application Filed':val==='common-law'?'Common Law Only':'N/A'}</span>` : ''}
        <span class="expand-card-chevron">&#9660;</span>
      </div>
      <div class="expand-card-body">
        <div class="status-selector mb-md" role="radiogroup" aria-label="Trademark status for ${item.name}">
          <div class="status-option st-good ${val==='registered'?'selected':''}" onclick="setTrademark('${item.id}','registered')" role="radio" aria-checked="${val==='registered'}" tabindex="0">Registered</div>
          <div class="status-option st-partial ${val==='filed'?'selected':''}" onclick="setTrademark('${item.id}','filed')" role="radio" aria-checked="${val==='filed'}" tabindex="0">App Filed</div>
          <div class="status-option st-missing ${val==='common-law'?'selected':''}" onclick="setTrademark('${item.id}','common-law')" role="radio" aria-checked="${val==='common-law'}" tabindex="0">Common Law Only</div>
          <div class="status-option st-na ${val==='na'?'selected':''}" onclick="setTrademark('${item.id}','na')" role="radio" aria-checked="${val==='na'}" tabindex="0">N/A</div>
        </div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Notes</label><textarea class="form-input" rows="2" placeholder="Mark details, registration number, classes..." oninput="state.notes['tm-${item.id}']=this.value;saveState()">${esc(state.notes['tm-'+item.id]||'')}</textarea></div>
      </div>
    </div>`;
  }).join('');
}
function setTrademark(id,val) { state.trademarks[id]=val; saveState(); renderTrademarks(); }
function completeTrademarks() { completePage('trademarks'); unlockPage('patents'); goToPage('patents'); showToast('Trademark assessment saved. Now review patents and trade secrets.'); }

/* ============================================================
   PATENTS & TRADE SECRETS
   ============================================================ */
function renderPatents() {
  renderPatentChecks();
  renderTradeSecretChecks();
  renderCopyrightChecklist();
}

function renderPatentChecks() {
  document.getElementById('patentChecks').innerHTML = PATENT_CHECKS.map(item => {
    const val = state.patentChecks[item.id] || '';
    if (item.type === 'yesno') {
      return `<div class="card mb-md">
        <div class="t-h3 mb-sm">${item.label}</div>
        <div class="status-selector" role="radiogroup" aria-label="${item.label}">
          <div class="status-option st-good ${val==='yes'?'selected':''}" onclick="setPatent('${item.id}','yes')" role="radio" aria-checked="${val==='yes'}" tabindex="0">Yes</div>
          <div class="status-option st-missing ${val==='no'?'selected':''}" onclick="setPatent('${item.id}','no')" role="radio" aria-checked="${val==='no'}" tabindex="0">No</div>
        </div>
      </div>`;
    }
    return `<div class="card mb-md">
      <div class="t-h3 mb-sm">${item.label}</div>
      <div class="status-selector" role="radiogroup" aria-label="${item.label}">
        <div class="status-option st-good ${val==='done'?'selected':''}" onclick="setPatent('${item.id}','done')" role="radio" aria-checked="${val==='done'}" tabindex="0">Complete</div>
        <div class="status-option st-partial ${val==='partial'?'selected':''}" onclick="setPatent('${item.id}','partial')" role="radio" aria-checked="${val==='partial'}" tabindex="0">In Progress</div>
        <div class="status-option st-missing ${val==='not-done'?'selected':''}" onclick="setPatent('${item.id}','not-done')" role="radio" aria-checked="${val==='not-done'}" tabindex="0">Not Done</div>
        <div class="status-option st-na ${val==='na'?'selected':''}" onclick="setPatent('${item.id}','na')" role="radio" aria-checked="${val==='na'}" tabindex="0">N/A</div>
      </div>
    </div>`;
  }).join('');
}
function setPatent(id,val) { state.patentChecks[id]=val; saveState(); renderPatentChecks(); }

function renderTradeSecretChecks() {
  document.getElementById('tradeSecretChecks').innerHTML = TRADE_SECRET_MEASURES.map(m => {
    const val = state.tradeSecrets[m.id] || '';
    return `<div class="card mb-md">
      <div class="flex items-center justify-between mb-sm" style="flex-wrap:wrap;gap:8px">
        <div><div class="t-h3">${m.label}</div><div class="t-caption t-tertiary">${m.desc}</div></div>
      </div>
      <div class="status-selector" role="radiogroup" aria-label="${m.label}">
        <div class="status-option st-good ${val==='implemented'?'selected':''}" onclick="setTradeSecret('${m.id}','implemented')" role="radio" aria-checked="${val==='implemented'}" tabindex="0">Implemented</div>
        <div class="status-option st-partial ${val==='partial'?'selected':''}" onclick="setTradeSecret('${m.id}','partial')" role="radio" aria-checked="${val==='partial'}" tabindex="0">Partial</div>
        <div class="status-option st-missing ${val==='missing'?'selected':''}" onclick="setTradeSecret('${m.id}','missing')" role="radio" aria-checked="${val==='missing'}" tabindex="0">Missing</div>
      </div>
    </div>`;
  }).join('');
}
function setTradeSecret(id,val) { state.tradeSecrets[id]=val; saveState(); renderTradeSecretChecks(); }

function renderCopyrightChecklist() {
  document.getElementById('copyrightChecklist').innerHTML = COPYRIGHT_ITEMS.map((item, i) => {
    const checked = state.copyrightChecks[i] || false;
    return `<div class="check-item ${checked?'checked':''}" onclick="toggleCopyright(${i})" role="checkbox" aria-checked="${checked}" tabindex="0">
      <div class="check-box"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      <div class="check-text">${item}</div>
    </div>`;
  }).join('');
}
function toggleCopyright(i) { state.copyrightChecks[i]=!state.copyrightChecks[i]; saveState(); renderCopyrightChecklist(); }
function completePatents() { completePage('patents'); unlockPage('software'); goToPage('software'); showToast('Patent and trade secret assessment saved.'); }

/* ============================================================
   SOFTWARE & DIGITAL
   ============================================================ */
function renderSoftware() {
  renderSoftwareChecks();
  renderDigitalGrid();
}

function renderSoftwareChecks() {
  document.getElementById('softwareChecks').innerHTML = SOFTWARE_CHECKS.map(item => {
    const val = state.softwareChecks[item.id] || '';
    return `<div class="card mb-md">
      <div class="t-h3 mb-sm">${item.label}</div>
      <div class="t-caption t-tertiary mb-md">${item.desc}</div>
      <div class="status-selector" role="radiogroup" aria-label="${item.label}">
        <div class="status-option st-good ${val==='done'?'selected':''}" onclick="setSoftware('${item.id}','done')" role="radio" aria-checked="${val==='done'}" tabindex="0">Complete</div>
        <div class="status-option st-partial ${val==='partial'?'selected':''}" onclick="setSoftware('${item.id}','partial')" role="radio" aria-checked="${val==='partial'}" tabindex="0">In Progress</div>
        <div class="status-option st-missing ${val==='not-done'?'selected':''}" onclick="setSoftware('${item.id}','not-done')" role="radio" aria-checked="${val==='not-done'}" tabindex="0">Not Done</div>
        <div class="status-option st-na ${val==='na'?'selected':''}" onclick="setSoftware('${item.id}','na')" role="radio" aria-checked="${val==='na'}" tabindex="0">N/A</div>
      </div>
    </div>`;
  }).join('');
}
function setSoftware(id,val) { state.softwareChecks[id]=val; saveState(); renderSoftwareChecks(); }

function renderDigitalGrid() {
  document.getElementById('digitalGrid').innerHTML = state.digitalAssets.map((a, i) => `
    <div class="digital-row">
      <div class="flex items-center justify-between mb-md" style="flex-wrap:wrap;gap:8px">
        <div class="t-h3">Asset ${i+1}</div>
        ${state.digitalAssets.length > 1 ? `<button class="btn btn-ghost btn-sm" onclick="removeDigital(${i})" style="color:var(--color-danger)">Remove</button>` : ''}
      </div>
      <div class="digital-fields">
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Asset Name</label><input class="form-input" placeholder="e.g. example.com" value="${esc(a.asset)}" oninput="updateDigital(${i},'asset',this.value)"></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Type</label>
          <select class="form-input" onchange="updateDigital(${i},'type',this.value)"><option value="">Select...</option>
            <option value="domain" ${a.type==='domain'?'selected':''}>Domain Name</option>
            <option value="social" ${a.type==='social'?'selected':''}>Social Media</option>
            <option value="app" ${a.type==='app'?'selected':''}>App Store Listing</option>
            <option value="cloud" ${a.type==='cloud'?'selected':''}>Cloud Account</option>
            <option value="ssl" ${a.type==='ssl'?'selected':''}>SSL Certificate</option>
            <option value="saas" ${a.type==='saas'?'selected':''}>SaaS Subscription</option>
          </select></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Registrar / Platform</label><input class="form-input" placeholder="e.g. GoDaddy" value="${esc(a.registrar)}" oninput="updateDigital(${i},'registrar',this.value)"></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Account Owner</label><input class="form-input" placeholder="Who controls it?" value="${esc(a.accountOwner)}" oninput="updateDigital(${i},'accountOwner',this.value)"></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Expiry</label><input class="form-input" type="date" value="${a.expiry||''}" oninput="updateDigital(${i},'expiry',this.value)"></div>
        <div class="form-group" style="margin-bottom:0"><label class="form-label">Transferred to Company?</label>
          <select class="form-input" onchange="updateDigital(${i},'transferred',this.value)"><option value="">Select...</option>
            <option value="yes" ${a.transferred==='yes'?'selected':''}>Yes</option>
            <option value="no" ${a.transferred==='no'?'selected':''}>No</option>
          </select></div>
      </div>
    </div>
  `).join('');
}
function updateDigital(i,f,v) { state.digitalAssets[i][f]=v; saveState(); }
function addDigitalAsset() { state.digitalAssets.push({ asset:'',type:'',registrar:'',accountOwner:'',expiry:'',transferred:'' }); saveState(); renderDigitalGrid(); }
function removeDigital(i) { state.digitalAssets.splice(i,1); saveState(); renderDigitalGrid(); }
function completeSoftware() { completePage('software'); unlockPage('deficiencies'); goToPage('deficiencies'); showToast('Software audit saved. Now review deficiencies.'); }

/* ============================================================
   DEFICIENCIES
   ============================================================ */
function renderDeficiencies() {
  document.getElementById('deficiencyCards').innerHTML = DEFICIENCIES.map(def => {
    const d = state.deficiencies[def.id] || {};
    const riskClass = def.risk==='Critical'?'risk-critical':def.risk==='High'?'risk-high':'risk-medium';
    const badgeClass = def.risk==='Critical'?'badge-danger':def.risk==='High'?'badge-danger':'badge-warning';
    return `<div class="deficiency-card ${riskClass}">
      <div class="deficiency-header">
        <div class="t-h3">${def.label}</div>
        <span class="badge ${badgeClass}">${def.risk} Risk</span>
      </div>
      <div class="deficiency-meta mb-md"><strong>Cure:</strong> ${def.cure}<br><strong>Timeline:</strong> ${def.time}</div>
      <div class="flex gap-md items-center" style="flex-wrap:wrap">
        <label class="t-small" style="font-weight:500">Applies?</label>
        <select class="form-input" style="width:auto;min-width:130px;font-size:13px;padding:6px 32px 6px 10px" onchange="setDef('${def.id}','applies',this.value)">
          <option value="">Select...</option><option value="yes" ${d.applies==='yes'?'selected':''}>Yes</option><option value="no" ${d.applies==='no'?'selected':''}>No</option><option value="unsure" ${d.applies==='unsure'?'selected':''}>Not Sure</option>
        </select>
        ${d.applies==='yes'?`<label class="t-small" style="font-weight:500">Status:</label>
        <select class="form-input" style="width:auto;min-width:130px;font-size:13px;padding:6px 32px 6px 10px" onchange="setDef('${def.id}','status',this.value)">
          <option value="">Not started</option><option value="in-progress" ${d.status==='in-progress'?'selected':''}>In Progress</option><option value="resolved" ${d.status==='resolved'?'selected':''}>Resolved</option>
        </select>`:''}
      </div>
    </div>`;
  }).join('');
  renderCostEstimate();
}
function setDef(id,f,v) { if (!state.deficiencies[id]) state.deficiencies[id]={}; state.deficiencies[id][f]=v; saveState(); renderDeficiencies(); }

function renderCostEstimate() {
  const applicable = DEFICIENCIES.filter(d => (state.deficiencies[d.id]||{}).applies==='yes');
  if (applicable.length===0) { document.getElementById('costEstimate').innerHTML='<p class="t-small t-tertiary">Mark applicable deficiencies to see estimates.</p>'; return; }
  const rows = applicable.map(d => {
    const st = (state.deficiencies[d.id]||{}).status||'not-started';
    return `<tr><td>${d.label}</td><td>${d.time}</td><td><span class="badge ${st==='resolved'?'badge-success':st==='in-progress'?'badge-warning':'badge-neutral'}">${st==='resolved'?'Resolved':st==='in-progress'?'In Progress':'Not Started'}</span></td></tr>`;
  });
  document.getElementById('costEstimate').innerHTML = `<div class="card" style="overflow-x:auto"><table class="cost-table"><thead><tr><th>Deficiency</th><th>Timeline</th><th>Status</th></tr></thead><tbody>${rows.join('')}</tbody></table></div>`;
}
function completeDeficiencies() { completePage('deficiencies'); unlockPage('valuation'); goToPage('valuation'); showToast('Deficiency review saved. Now consider IP valuation.'); }

/* ============================================================
   VALUATION
   ============================================================ */
function renderValuation() {
  renderValueChecklist();
  document.getElementById('valEbitda').value = state.valuation.ebitda || '';
  document.getElementById('valIpPct').value = state.valuation.ipPct || '';
  document.getElementById('valMultiple').value = state.valuation.multiple || '';
  updateValuation();
}

function renderValueChecklist() {
  document.getElementById('valueActions').innerHTML = VALUE_ACTIONS.map((item, i) => {
    const checked = state.valueChecks[i] || false;
    return `<div class="check-item ${checked?'checked':''}" onclick="toggleValueCheck(${i})" role="checkbox" aria-checked="${checked}" tabindex="0">
      <div class="check-box"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      <div class="check-text">${item}</div>
    </div>`;
  }).join('');
}
function toggleValueCheck(i) { state.valueChecks[i]=!state.valueChecks[i]; saveState(); renderValueChecklist(); }

function updateValuation() {
  const ebitdaRaw = document.getElementById('valEbitda').value.replace(/[^0-9]/g,'');
  const ipPct = parseInt(document.getElementById('valIpPct').value) || 0;
  const mult = parseInt(document.getElementById('valMultiple').value) || 0;
  state.valuation.ebitda = document.getElementById('valEbitda').value;
  state.valuation.ipPct = document.getElementById('valIpPct').value;
  state.valuation.multiple = document.getElementById('valMultiple').value;
  saveState();

  if (!ebitdaRaw || !ipPct || !mult) {
    document.getElementById('valuationResult').innerHTML = '<p class="t-small t-tertiary">Enter all values above to see IP value estimates.</p>';
    return;
  }
  const ebitda = parseInt(ebitdaRaw);
  const ev = ebitda * mult;
  const ipValue = ev * (ipPct / 100);
  const uplift05 = ebitda * 0.5;
  const uplift10 = ebitda * 1.0;

  document.getElementById('valuationResult').innerHTML = `
    <div class="kpi-row">
      <div class="kpi-card"><div class="kpi-value" style="font-size:24px;color:var(--color-primary)">$${formatNum(ev)}</div><div class="kpi-label">Estimated Enterprise Value</div></div>
      <div class="kpi-card"><div class="kpi-value" style="font-size:24px;color:var(--color-accent)">$${formatNum(ipValue)}</div><div class="kpi-label">IP-Attributable Value (${ipPct}%)</div></div>
    </div>
    <div class="callout callout-info mb-md">
      <strong>Multiple Uplift from Strong IP:</strong> With well-documented IP protection, you could command a 0.5x-1.0x higher EBITDA multiple, adding <strong>$${formatNum(uplift05)}-$${formatNum(uplift10)}</strong> to your enterprise value.
    </div>`;
}

function formatNum(n) { if (n >= 1000000) return (n/1000000).toFixed(1)+'M'; if (n >= 1000) return (n/1000).toFixed(0)+'K'; return n.toString(); }
function completeValuation() { completePage('valuation'); unlockPage('action'); goToPage('action'); showToast('Valuation analysis saved. Build your action plan.'); }

/* ============================================================
   ACTION PLAN
   ============================================================ */
function renderActionPage() {
  renderTimeline();
  renderActionTable();
}

function renderTimeline() {
  document.getElementById('implementationTimeline').innerHTML = TIMELINE_DATA.map((item, i) => `
    <div class="timeline-item ${i===0?'tl-active':''}">
      <div class="timeline-dot"></div>
      <div class="timeline-period">${item.period}</div>
      <div class="timeline-title">${item.title}</div>
      <div class="timeline-desc">${item.desc}</div>
    </div>
  `).join('');
}

function renderActionTable() {
  if (state.actionItems.length === 0) {
    state.actionItems = generateActions();
    if (state.actionItems.length === 0) state.actionItems = [{ action:'',owner:'',date:'',status:'not-started' },{ action:'',owner:'',date:'',status:'not-started' },{ action:'',owner:'',date:'',status:'not-started' }];
  }
  document.getElementById('actionTableBody').innerHTML = state.actionItems.map((item, i) => `
    <tr>
      <td><input class="action-input-mini" value="${esc(item.action)}" placeholder="Specific action..." oninput="updateAction(${i},'action',this.value)" style="width:100%"></td>
      <td><input class="action-input-mini" value="${esc(item.owner)}" placeholder="Owner" oninput="updateAction(${i},'owner',this.value)" style="width:100%"></td>
      <td><input class="action-input-mini" type="date" value="${item.date}" oninput="updateAction(${i},'date',this.value)" style="width:100%"></td>
      <td><select class="action-input-mini" onchange="updateAction(${i},'status',this.value)" style="width:100%">
        <option value="not-started" ${item.status==='not-started'?'selected':''}>Not Started</option>
        <option value="in-progress" ${item.status==='in-progress'?'selected':''}>In Progress</option>
        <option value="done" ${item.status==='done'?'selected':''}>Done</option>
      </select></td>
    </tr>
  `).join('');
}

function generateActions() {
  const actions = [];
  const gaps = state.assignments.filter(a => a.person && a.signed === 'no');
  if (gaps.length > 0) actions.push({ action: `Obtain IP assignments from ${gaps.length} contributor(s) without signed agreements`, owner:'', date:'', status:'not-started' });
  const unreg = Object.entries(state.trademarks).filter(([,v]) => v==='common-law');
  if (unreg.length > 0) actions.push({ action: `File federal trademark applications for ${unreg.length} unregistered mark(s)`, owner:'', date:'', status:'not-started' });
  const missingTS = Object.entries(state.tradeSecrets).filter(([,v]) => v==='missing');
  if (missingTS.length > 0) actions.push({ action: `Implement ${missingTS.length} missing trade secret protection measure(s)`, owner:'', date:'', status:'not-started' });
  const swIssues = Object.entries(state.softwareChecks).filter(([,v]) => v==='not-done');
  if (swIssues.length > 0) actions.push({ action: `Complete ${swIssues.length} software audit item(s)`, owner:'', date:'', status:'not-started' });
  const untransferred = state.digitalAssets.filter(a => a.asset && a.transferred==='no');
  if (untransferred.length > 0) actions.push({ action: `Transfer ${untransferred.length} digital asset(s) to company ownership`, owner:'', date:'', status:'not-started' });
  DEFICIENCIES.forEach(d => {
    if ((state.deficiencies[d.id]||{}).applies==='yes' && (state.deficiencies[d.id]||{}).status!=='resolved') {
      actions.push({ action: `Cure: ${d.label}`, owner:'', date:'', status:'not-started' });
    }
  });
  return actions.slice(0, 12);
}

function updateAction(i,f,v) { state.actionItems[i][f]=v; saveState(); }
function addActionRow() { state.actionItems.push({ action:'',owner:'',date:'',status:'not-started' }); saveState(); renderActionTable(); }
function completeAction() { completePage('action'); unlockPage('dashboard'); goToPage('dashboard'); showToast('Action plan saved. Here is your IP scorecard.'); }

/* ============================================================
   SCORING
   ============================================================ */
function calcScore() {
  let s = 0;
  // Inventory (15 pts)
  const assets = state.ipAssets.filter(a => a.name);
  s += Math.min(15, assets.length * 3);
  // Assignments (25 pts)
  const ppl = state.assignments.filter(a => a.person);
  const signed = ppl.filter(a => a.signed === 'yes').length;
  if (ppl.length > 0) s += Math.round((signed / ppl.length) * 25);
  else s += 0;
  // Trademarks (15 pts)
  const tmReg = Object.values(state.trademarks).filter(v => v==='registered').length;
  const tmTotal = Object.values(state.trademarks).filter(v => v && v!=='na').length;
  if (tmTotal > 0) s += Math.round((tmReg / tmTotal) * 15);
  // Trade secrets (15 pts)
  const tsImpl = Object.values(state.tradeSecrets).filter(v => v==='implemented').length;
  s += Math.round((tsImpl / TRADE_SECRET_MEASURES.length) * 15);
  // Software (10 pts)
  const swDone = Object.values(state.softwareChecks).filter(v => v==='done' || v==='na').length;
  s += Math.round((swDone / SOFTWARE_CHECKS.length) * 10);
  // Deficiencies (10 pts)
  const applicable = DEFICIENCIES.filter(d => (state.deficiencies[d.id]||{}).applies==='yes');
  const resolved = applicable.filter(d => (state.deficiencies[d.id]||{}).status==='resolved').length;
  if (applicable.length > 0) s += Math.round((resolved / applicable.length) * 10);
  else s += 10;
  // Digital assets (10 pts)
  const dAssets = state.digitalAssets.filter(a => a.asset);
  const dTransferred = dAssets.filter(a => a.transferred === 'yes').length;
  if (dAssets.length > 0) s += Math.round((dTransferred / dAssets.length) * 10);
  else s += 5;

  return Math.min(100, Math.max(0, s));
}

function getLabel(s) { if (s>=85) return 'Well Protected'; if (s>=65) return 'Approaching Protected'; if (s>=40) return 'Gaps Present'; return 'Critical Exposure'; }
function getColor(s) { if (s>=85) return 'var(--color-success)'; if (s>=65) return 'var(--color-score-4)'; if (s>=40) return 'var(--color-warning)'; return 'var(--color-danger)'; }

/* ============================================================
   DASHBOARD
   ============================================================ */
function renderDashboard() {
  const score = calcScore();
  document.getElementById('dashScore').textContent = score;
  document.getElementById('dashScore').style.color = getColor(score);
  document.getElementById('dashAssets').textContent = state.ipAssets.filter(a => a.name).length;
  const gaps = state.assignments.filter(a => a.person && a.signed !== 'yes').length;
  document.getElementById('dashAssignGaps').textContent = gaps;
  const openDef = DEFICIENCIES.filter(d => (state.deficiencies[d.id]||{}).applies==='yes' && (state.deficiencies[d.id]||{}).status!=='resolved').length;
  document.getElementById('dashDefOpen').textContent = openDef;

  // Bar chart
  const ppl = state.assignments.filter(a => a.person);
  const signedPct = ppl.length > 0 ? Math.round(ppl.filter(a=>a.signed==='yes').length/ppl.length*100) : 0;
  const tmVals = Object.values(state.trademarks).filter(v=>v&&v!=='na');
  const tmPct = tmVals.length > 0 ? Math.round(tmVals.filter(v=>v==='registered').length/tmVals.length*100) : 0;
  const tsPct = Math.round(Object.values(state.tradeSecrets).filter(v=>v==='implemented').length/TRADE_SECRET_MEASURES.length*100);
  const swPct = Math.round(Object.values(state.softwareChecks).filter(v=>v==='done'||v==='na').length/SOFTWARE_CHECKS.length*100);
  const dA = state.digitalAssets.filter(a=>a.asset);
  const dPct = dA.length > 0 ? Math.round(dA.filter(a=>a.transferred==='yes').length/dA.length*100) : 0;

  const cats = [
    { label: 'IP Assignments', pct: signedPct },
    { label: 'Trademarks', pct: tmPct },
    { label: 'Trade Secrets', pct: tsPct },
    { label: 'Software Audit', pct: swPct },
    { label: 'Digital Assets', pct: dPct }
  ];
  document.getElementById('dashBarChart').innerHTML = cats.map((c,idx) => `
    <div class="bar-row">
      <div class="bar-label">${c.label}</div>
      <div class="bar-track">
        <div class="bar-fill" data-width="${c.pct}" data-delay="${idx*100}" style="width:0%;background:${c.pct>=80?'var(--color-success)':c.pct>=50?'var(--color-warning)':'var(--color-danger)'}">
          <span class="bar-value">${c.pct}%</span>
        </div>
      </div>
    </div>
  `).join('');
  setTimeout(()=>{document.querySelectorAll('#dashBarChart .bar-fill').forEach(el=>{const w=el.dataset.width;const d=parseInt(el.dataset.delay)||0;setTimeout(()=>{el.style.width=w+'%';},d);});},100);

  // Recommendations
  const recs = [];
  if (gaps > 0) recs.push({ type:'danger', text:`${gaps} IP contributor(s) lack signed assignment agreements. This is the highest-priority IP risk. Obtain assignments immediately -- every day of delay increases exposure.` });
  const clTm = Object.values(state.trademarks).filter(v=>v==='common-law').length;
  if (clTm > 0) recs.push({ type:'warning', text:`${clTm} trademark(s) have only common law protection. Federal registration costs $1,000-$3,000 per mark and adds nationwide priority.` });
  const missingTS = Object.values(state.tradeSecrets).filter(v=>v==='missing').length;
  if (missingTS > 0) recs.push({ type:'warning', text:`${missingTS} trade secret protection measure(s) are missing. Without "reasonable measures," trade secret protection under the DTSA evaporates.` });
  const untrans = state.digitalAssets.filter(a=>a.asset&&a.transferred==='no').length;
  if (untrans > 0) recs.push({ type:'warning', text:`${untrans} digital asset(s) not yet transferred to company ownership. Transfer before going to market.` });
  if (openDef > 0) recs.push({ type:'danger', text:`${openDef} IP deficienc${openDef>1?'ies':'y'} remain unresolved. Address systematically using the action plan.` });
  if (score >= 85) recs.push({ type:'success', text:'Your IP portfolio is well-documented and protected. This is a significant value driver -- highlight it in your CIM and management presentations.' });
  if (recs.length===0) recs.push({ type:'info', text:'Complete all assessment phases to receive personalized recommendations.' });

  const typeMap = { danger:'callout-danger', warning:'callout-warning', success:'callout-info', info:'callout-accent' };
  document.getElementById('dashRecommendations').innerHTML = recs.map(r=>`<div class="callout ${typeMap[r.type]} mb-md">${r.text}</div>`).join('');

  // Action progress
  const total = state.actionItems.length;
  const done = state.actionItems.filter(a=>a.status==='done').length;
  const inProg = state.actionItems.filter(a=>a.status==='in-progress').length;
  document.getElementById('dashActionProgress').innerHTML = total > 0 ? `
    <div class="flex gap-md items-center mb-md" style="flex-wrap:wrap">
      <span class="badge badge-success">${done} Done</span>
      <span class="badge badge-warning">${inProg} In Progress</span>
      <span class="badge badge-neutral">${total-done-inProg} Not Started</span>
    </div>
    <div class="bar-track" style="height:12px;margin-bottom:var(--space-sm)">
      <div style="height:100%;border-radius:4px;background:var(--color-success);width:${total>0?Math.round(done/total*100):0}%;transition:width 0.8s ease"></div>
    </div>
    <div class="t-small t-secondary">${total>0?Math.round(done/total*100):0}% of action items complete</div>
  ` : '<p class="t-small t-tertiary">No action items created.</p>';
}

/* ============================================================
   UTILITIES
   ============================================================ */
function exportReport() {
  let text = 'IP AUDIT & PROTECTION - Summary Report\n';
  text += '='.repeat(50) + '\n';
  text += 'Generated: ' + new Date().toLocaleDateString() + '\n\n';
  text += 'PROGRESS\n';
  text += 'Pages Completed: ' + state.pagesCompleted.length + '/' + state.pagesUnlocked.length + '\n\n';
  text += 'IP INVENTORY\n';
  state.ipAssets.forEach((a, i) => { if (a.name) text += (i+1) + '. ' + a.name + ' (' + (a.category||'uncategorized') + ') - Status: ' + (a.status||'N/A') + '\n'; });
  text += '\nASSIGNMENT AUDIT\n';
  state.assignments.forEach((a, i) => { if (a.person) text += (i+1) + '. ' + a.person + ' - ' + (a.role||'N/A') + ' - Signed: ' + (a.signed||'N/A') + '\n'; });
  text += '\nTRADEMARK STATUS\n';
  Object.entries(state.trademarks).forEach(([k,v]) => { if (v) text += '  ' + k + ': ' + v + '\n'; });
  text += '\nACTION ITEMS\n';
  state.actionItems.forEach((a, i) => { if (a.action) text += (i+1) + '. ' + a.action + ' - ' + (a.status||'not-started') + ' - Owner: ' + (a.owner||'N/A') + '\n'; });
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ip-audit-report.txt';
  a.click(); URL.revokeObjectURL(url);
  showToast('Report exported successfully.');
}

/* ============================================================
   INIT
   ============================================================ */
function init() {
  loadState();
  state.pagesUnlocked.forEach(p => unlockPage(p));
  state.pagesCompleted.forEach(p => {
    const nav = document.querySelector(`.nav-item[data-page="${p}"]`);
    if (nav) nav.classList.add('completed');
  });
  if (state.currentPage && state.pagesUnlocked.includes(state.currentPage)) goToPage(state.currentPage);
  updateProgress();
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') { e.preventDefault(); item.click(); } });
  });
  document.addEventListener('keydown', e => {
    if ((e.key==='Enter'||e.key===' ') && e.target.classList.contains('check-item')) { e.preventDefault(); e.target.click(); }
  });
}
document.addEventListener('DOMContentLoaded', init);
</script>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('embedded') === 'true') {
    // Hide playbook's own chrome
    var sidebar = document.querySelector('.sidebar');
    var overlay = document.querySelector('.sidebar-overlay');
    var mobileHeader = document.querySelector('.mobile-header');
    var mainContent = document.querySelector('.main-content');
    if (sidebar) sidebar.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    if (mobileHeader) mobileHeader.style.display = 'none';
    if (mainContent) {
      mainContent.style.marginLeft = '0';
      mainContent.style.minHeight = 'auto';
    }

    // Navigate to specific section if requested
    var section = params.get('section');
    if (section !== null) {
      var sectionIndex = parseInt(section, 10);
      if (typeof navigateToSection === 'function') {
        setTimeout(function() { navigateToSection(sectionIndex); }, 100);
      }
    }

    // Forward score updates to parent
    var origDispatch = window.dispatchEvent.bind(window);
    window.addEventListener('playbook:score-update', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:score-update',
          detail: e.detail
        }, '*');
      }
    });

    // Forward section changes to parent
    window.addEventListener('playbook:section-change', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:section-change',
          detail: e.detail
        }, '*');
      }
    });

    // Listen for commands from parent
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'navigate-section') {
        if (typeof navigateToSection === 'function') {
          navigateToSection(e.data.sectionIndex);
        }
      }
    });
  }
})();
</script>
</body>
</html>
