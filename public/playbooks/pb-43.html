<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exit Timeline & Milestone Tracker | Exit Planning Playbook #43</title>
<style>
:root {
  --color-bg: #F5F5F7;
  --color-surface: #FFFFFF;
  --color-surface-alt: #F2F2F7;
  --color-border: #E5E7EB;
  --color-border-light: #F2F2F7;
  --color-text: #1D1D1F;
  --color-text-secondary: #6E6E73;
  --color-text-tertiary: #8E8E93;
  --color-primary: #0071E3;
  --color-primary-light: #EBF5FF;
  --color-primary-hover: #0051B3;
  --color-accent: #FF9500;
  --color-accent-light: #FFF6E8;
  --color-danger: #FF3B30;
  --color-danger-light: #FFEBEA;
  --color-warning: #C67F20;
  --color-warning-light: #FFF8EB;
  --color-success: #34C759;
  --color-success-light: #E8F8ED;
  --color-score-1: #FF3B30;
  --color-score-2: #FF9500;
  --color-score-3: #FFCC00;
  --color-score-4: #34C759;
  --color-score-5: #30D158;
  --color-phase-1: #6366F1;
  --color-phase-2: #8B5CF6;
  --color-phase-3: #B87333;
  --color-phase-4: #2D8A4E;
  --color-phase-5: #1A6B35;
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.1);
  --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', sans-serif;
  --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', sans-serif;
  --transition-fast: 150ms ease;
  --transition-normal: 250ms ease;
  --transition-slow: 400ms cubic-bezier(0.16, 1, 0.3, 1);
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
  --space-3xl: 64px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body {
  font-family: var(--font-body); font-size: 16px; line-height: 1.6;
  color: var(--color-text); background: var(--color-bg);
  -webkit-font-smoothing: antialiased; min-height: 100vh;
}
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea, select { font-family: inherit; font-size: inherit; }
a { color: var(--color-primary); text-decoration: none; }

.t-display { font-family: var(--font-display); font-size: clamp(28px, 4vw, 40px); font-weight: 700; line-height: 1.2; letter-spacing: -0.02em; }
.t-h1 { font-family: var(--font-display); font-size: clamp(22px, 3vw, 30px); font-weight: 700; line-height: 1.25; letter-spacing: -0.01em; }
.t-h2 { font-size: 20px; font-weight: 600; line-height: 1.3; }
.t-h3 { font-size: 16px; font-weight: 600; line-height: 1.4; }
.t-body { font-size: 16px; line-height: 1.6; }
.t-small { font-size: 14px; line-height: 1.5; }
.t-caption { font-size: 12px; line-height: 1.4; letter-spacing: 0.02em; }
.t-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); }
.t-secondary { color: var(--color-text-secondary); }
.t-tertiary { color: var(--color-text-tertiary); }
.mb-xs { margin-bottom: var(--space-xs); }
.mb-sm { margin-bottom: var(--space-sm); }
.mb-md { margin-bottom: var(--space-md); }
.mb-lg { margin-bottom: var(--space-lg); }
.mb-xl { margin-bottom: var(--space-xl); }
.mb-2xl { margin-bottom: var(--space-2xl); }

.app { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; min-width: 260px; background: var(--color-text);
  color: var(--color-text); padding: var(--space-lg); display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
  transition: transform var(--transition-slow); overflow-y: auto;
}
.sidebar.collapsed { transform: translateX(-260px); }
.main-content { flex: 1; margin-left: 260px; min-height: 100vh; transition: margin-left var(--transition-slow); }
.sidebar.collapsed + .main-content { margin-left: 0; }
.content-area { max-width: 860px; margin: 0 auto; padding: var(--space-2xl) var(--space-lg); }

.mobile-header {
  display: none; position: sticky; top: 0; z-index: 90;
  background: var(--color-surface); border-bottom: 1px solid var(--color-border);
  padding: var(--space-md) var(--space-lg); align-items: center; gap: var(--space-md);
}
.hamburger { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); }
.hamburger:hover { background: var(--color-surface-alt); }
.hamburger span { display: block; width: 18px; height: 2px; background: var(--color-text); position: relative; }
.hamburger span::before, .hamburger span::after { content: ''; position: absolute; width: 18px; height: 2px; background: var(--color-text); left: 0; }
.hamburger span::before { top: -6px; }
.hamburger span::after { top: 6px; }
.sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 99; }

@media (max-width: 900px) {
  .sidebar { transform: translateX(-260px); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.show { display: block; }
  .main-content { margin-left: 0 !important; }
  .mobile-header { display: flex; }
  .content-area { padding: var(--space-lg) var(--space-md); }
}

.sidebar-brand { margin-bottom: var(--space-xl); }
.sidebar-brand-label { font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-xs); }
.sidebar-brand-title { font-family: var(--font-display); font-size: 18px; font-weight: 700; color: var(--color-text); line-height: 1.3; }
.sidebar-progress { margin-bottom: var(--space-xl); padding: var(--space-md); background: var(--color-surface-alt); border-radius: var(--radius-md); }
.sidebar-progress-label { font-size: 12px; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-progress-bar { height: 4px; background: var(--color-border); border-radius: 2px; overflow: hidden; }
.sidebar-progress-fill { height: 100%; background: var(--color-accent); border-radius: 2px; transition: width var(--transition-slow); }
.sidebar-progress-text { font-size: 12px; color: var(--color-text-tertiary); margin-top: var(--space-sm); text-align: right; }
.sidebar-nav { flex: 1; display: flex; flex-direction: column; gap: 2px; }
.nav-section-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-tertiary); padding: var(--space-md) var(--space-sm) var(--space-xs); }
.nav-item {
  display: flex; align-items: center; gap: var(--space-md); padding: 10px 12px;
  border-radius: var(--radius-sm); color: rgba(255,255,255,0.6);
  font-size: 14px; transition: all var(--transition-fast); cursor: pointer; position: relative;
}
.nav-item:hover { background: var(--color-surface-alt); color: var(--color-text); }
.nav-item.active { background: var(--color-primary-light); color: var(--color-primary); font-weight: 500; border-left: 3px solid var(--color-primary); }
.nav-item.completed .nav-check { display: flex; }
.nav-item.locked { opacity: 0.4; cursor: default; }
.nav-item.locked:hover { background: none; color: var(--color-text-tertiary); }
.nav-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; }
.nav-check { display: none; width: 16px; height: 16px; background: var(--color-success); border-radius: 50%; align-items: center; justify-content: center; margin-left: auto; flex-shrink: 0; }
.nav-check svg { width: 10px; height: 10px; stroke: #fff; stroke-width: 2.5; fill: none; }

.sidebar-score { margin-top: auto; padding-top: var(--space-lg); border-top: 1px solid var(--color-border); }
.sidebar-score-label { font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-score-value { font-family: var(--font-display); font-size: 36px; font-weight: 700; color: #fff; line-height: 1; }
.sidebar-score-max { font-size: 18px; color: var(--color-text-tertiary); font-weight: 400; }
.sidebar-score-desc { font-size: 12px; color: var(--color-text-secondary); margin-top: var(--space-xs); }

.card {
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: var(--radius-lg); padding: var(--space-lg);
  transition: box-shadow var(--transition-normal);
}
.card:hover { box-shadow: var(--shadow-sm); }
.card-elevated { box-shadow: var(--shadow-md); border-color: transparent; }
.callout {
  padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md);
  border-left: 3px solid; font-size: 14px; line-height: 1.6;
}
.callout-info { background: var(--color-primary-light); border-color: var(--color-primary); color: var(--color-primary); }
.callout-warning { background: var(--color-warning-light); border-color: var(--color-warning); color: #7C5500; }
.callout-danger { background: var(--color-danger-light); border-color: var(--color-danger); color: var(--color-danger); }
.callout-accent { background: var(--color-accent-light); border-color: var(--color-accent); color: #7C5500; }

.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm);
  padding: 10px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500;
  transition: all var(--transition-fast); white-space: nowrap;
}
.btn-primary { background: var(--color-primary); color: #fff; }
.btn-primary:hover { background: var(--color-primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.btn-secondary { background: var(--color-surface); color: var(--color-text); border: 1px solid var(--color-border); }
.btn-secondary:hover { background: var(--color-surface-alt); border-color: var(--color-text-tertiary); }
.btn-ghost { color: var(--color-text-secondary); padding: 8px 12px; }
.btn-ghost:hover { background: var(--color-surface-alt); color: var(--color-text); }
.btn-accent { background: var(--color-accent); color: #fff; }
.btn-accent:hover { background: #E68600; }
.btn-lg { padding: 14px 28px; font-size: 16px; border-radius: var(--radius-md); }
.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
.btn-group { display: flex; gap: var(--space-sm); flex-wrap: wrap; }

.form-group { margin-bottom: var(--space-lg); }
.form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: var(--space-sm); color: var(--color-text); }
.form-hint { font-size: 13px; color: var(--color-text-tertiary); margin-top: var(--space-xs); }
.form-input {
  width: 100%; padding: 10px 14px; border: 1px solid var(--color-border);
  border-radius: var(--radius-sm); font-size: 15px; background: var(--color-surface);
  transition: all var(--transition-fast); color: var(--color-text);
}
.form-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light); }
.form-input::placeholder { color: var(--color-text-tertiary); }
textarea.form-input { min-height: 80px; resize: vertical; line-height: 1.5; }
select.form-input { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%236E6E73' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }

.badge {
  display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px;
  border-radius: 999px; font-size: 12px; font-weight: 500;
}
.badge-success { background: var(--color-success-light); color: var(--color-success); }
.badge-warning { background: var(--color-warning-light); color: var(--color-warning); }
.badge-danger { background: var(--color-danger-light); color: var(--color-danger); }
.badge-neutral { background: var(--color-surface-alt); color: var(--color-text-secondary); }
.badge-primary { background: var(--color-primary-light); color: var(--color-primary); }
.badge-accent { background: var(--color-accent-light); color: var(--color-accent); }

.page { display: none; animation: fadeIn 0.3s ease; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.page-header { margin-bottom: var(--space-2xl); }
.page-header .t-label { margin-bottom: var(--space-sm); }
.page-header .t-display { margin-bottom: var(--space-md); }
.page-header .t-body { color: var(--color-text-secondary); max-width: 600px; }
.section-divider { height: 1px; background: var(--color-border); margin: var(--space-2xl) 0; }

.welcome-hero { text-align: center; padding: var(--space-3xl) var(--space-lg); max-width: 640px; margin: 0 auto; }
.welcome-icon {
  width: 72px; height: 72px; background: var(--color-primary-light);
  border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center;
  margin: 0 auto var(--space-lg); font-size: 32px;
}
.welcome-hero .t-display { margin-bottom: var(--space-md); }
.welcome-hero .t-body { margin-bottom: var(--space-2xl); }
.welcome-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin: var(--space-2xl) 0; text-align: center; }
.welcome-stat { padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); }
.welcome-stat-value { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--color-primary); }
.welcome-stat-label { font-size: 13px; color: var(--color-text-secondary); margin-top: 4px; }
.welcome-phases { display: flex; flex-direction: column; gap: var(--space-md); margin: var(--space-2xl) 0; text-align: left; }
.welcome-phase {
  display: flex; gap: var(--space-lg); padding: var(--space-lg);
  background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md);
}
.welcome-phase-num {
  width: 36px; height: 36px; background: var(--color-primary-light); border-radius: 50%;
  display: flex; align-items: center; justify-content: center; font-weight: 700;
  color: var(--color-primary); flex-shrink: 0; font-size: 15px;
}
.welcome-phase-title { font-weight: 600; margin-bottom: 2px; }
.welcome-phase-desc { font-size: 14px; color: var(--color-text-secondary); }
@media (max-width: 600px) { .welcome-stats { grid-template-columns: 1fr; } .welcome-hero { padding: var(--space-2xl) var(--space-md); } }

/* Timeline Visual */
.timeline-viz { position: relative; padding-left: 32px; }
.timeline-viz::before { content: ''; position: absolute; left: 11px; top: 8px; bottom: 8px; width: 2px; background: var(--color-border); }
.tl-item { position: relative; padding-bottom: var(--space-xl); }
.tl-item:last-child { padding-bottom: 0; }
.tl-dot { position: absolute; left: -32px; top: 4px; width: 22px; height: 22px; border-radius: 50%; border: 3px solid var(--color-border); background: var(--color-surface); z-index: 1; display: flex; align-items: center; justify-content: center; }
.tl-dot.done { background: var(--color-success); border-color: var(--color-success); }
.tl-dot.done svg { display: block; }
.tl-dot.active { border-color: var(--color-primary); background: var(--color-primary-light); }
.tl-dot svg { display: none; width: 12px; height: 12px; stroke: #fff; stroke-width: 2.5; fill: none; }
.tl-phase-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 4px; }
.tl-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
.tl-desc { font-size: 13px; color: var(--color-text-secondary); }

/* Gantt-style chart */
.gantt-container { overflow-x: auto; padding-bottom: var(--space-md); }
.gantt { min-width: 700px; }
.gantt-header { display: flex; border-bottom: 2px solid var(--color-border); padding-bottom: var(--space-sm); margin-bottom: var(--space-sm); }
.gantt-label-col { width: 180px; flex-shrink: 0; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--color-text-tertiary); }
.gantt-bars-col { flex: 1; display: flex; }
.gantt-q { flex: 1; text-align: center; font-size: 11px; font-weight: 600; color: var(--color-text-tertiary); letter-spacing: 0.03em; }
.gantt-row { display: flex; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--color-border-light); }
.gantt-row-label { width: 180px; flex-shrink: 0; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: var(--space-sm); }
.gantt-row-bars { flex: 1; display: flex; position: relative; height: 24px; }
.gantt-bar { position: absolute; height: 20px; top: 2px; border-radius: 4px; opacity: 0.85; transition: opacity var(--transition-fast); cursor: default; }
.gantt-bar:hover { opacity: 1; }
.gantt-row.done .gantt-row-label { color: var(--color-success); text-decoration: line-through; }

/* Playbook tracker table */
.tracker-table { width: 100%; border-collapse: collapse; font-size: 14px; }
.tracker-table th { text-align: left; padding: 8px 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--color-text-tertiary); border-bottom: 2px solid var(--color-border); }
.tracker-table td { padding: 8px 12px; border-bottom: 1px solid var(--color-border-light); vertical-align: middle; }
.tracker-table tr:hover td { background: var(--color-surface-alt); }
.status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
.status-select { padding: 4px 8px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 13px; background: var(--color-surface); cursor: pointer; }
.status-select:focus { outline: none; border-color: var(--color-primary); }

/* Phase pills */
.phase-pill { display: inline-flex; align-items: center; gap: 4px; padding: 2px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; letter-spacing: 0.02em; }
.phase-1 { background: #EEF2FF; color: #4338CA; }
.phase-2 { background: #F5F3FF; color: #7C3AED; }
.phase-3 { background: var(--color-accent-light); color: var(--color-accent); }
.phase-4 { background: var(--color-success-light); color: var(--color-success); }
.phase-5 { background: var(--color-primary-light); color: var(--color-primary); }

/* Progress ring */
.progress-ring-wrap { position: relative; display: inline-flex; align-items: center; justify-content: center; }
.progress-ring-text { position: absolute; text-align: center; }
.progress-ring-value { font-family: var(--font-display); font-weight: 700; line-height: 1; }
.progress-ring-label { font-size: 10px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }

/* KPI row */
.kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md); margin-bottom: var(--space-xl); }
.kpi-card { padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); text-align: center; }
.kpi-value { font-family: var(--font-display); font-size: 32px; font-weight: 700; line-height: 1.1; }
.kpi-label { font-size: 12px; color: var(--color-text-secondary); margin-top: 4px; }
@media (max-width: 700px) { .kpi-row { grid-template-columns: repeat(2, 1fr); } }

/* Dependency chain visualization */
.dep-chain { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; padding: var(--space-sm) 0; }
.dep-node { padding: 4px 10px; border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; background: var(--color-surface-alt); border: 1px solid var(--color-border); white-space: nowrap; }
.dep-node.critical { background: var(--color-danger-light); border-color: var(--color-danger); color: var(--color-danger); }
.dep-node.done { background: var(--color-success-light); border-color: var(--color-success); color: var(--color-success); text-decoration: line-through; }
.dep-arrow { color: var(--color-text-tertiary); font-size: 14px; }

/* Bottleneck cards */
.bottleneck-card { border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-md); background: var(--color-surface); }
.bottleneck-card.is-bottleneck { border-color: var(--color-danger); border-left: 4px solid var(--color-danger); }

/* Check items */
.check-item {
  display: flex; align-items: flex-start; gap: var(--space-md); padding: var(--space-md);
  border: 1px solid var(--color-border-light); border-radius: var(--radius-sm);
  cursor: pointer; transition: all var(--transition-fast); margin-bottom: var(--space-sm);
}
.check-item:hover { background: var(--color-surface-alt); }
.check-item.checked { background: var(--color-success-light); border-color: var(--color-success); }
.check-box {
  width: 22px; height: 22px; border: 2px solid var(--color-border); border-radius: 4px;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all var(--transition-fast);
}
.check-item.checked .check-box { background: var(--color-success); border-color: var(--color-success); }
.check-box svg { width: 14px; height: 14px; stroke: #fff; stroke-width: 2.5; fill: none; opacity: 0; transition: opacity var(--transition-fast); }
.check-item.checked .check-box svg { opacity: 1; }
.check-text { font-size: 14px; padding-top: 1px; }

/* Bar chart */
.bar-chart { display: flex; flex-direction: column; gap: var(--space-md); }
.bar-row { display: flex; align-items: center; gap: var(--space-md); }
.bar-label { width: 140px; flex-shrink: 0; font-size: 13px; color: var(--color-text-secondary); text-align: right; }
.bar-track { flex: 1; height: 24px; background: var(--color-surface-alt); border-radius: 4px; overflow: hidden; position: relative; }
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; }
.bar-value { font-size: 12px; font-weight: 600; color: #fff; }
@media (max-width: 600px) { .bar-label { width: 90px; font-size: 11px; } }

/* Toast */
.toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast {
  padding: 12px 20px; border-radius: var(--radius-md); background: var(--color-text);
  color: #fff; font-size: 14px; font-weight: 500; box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s ease; max-width: 360px;
}
.toast.out { animation: toastOut 0.3s ease forwards; }
@keyframes toastIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-8px); } }

/* Scorecard */
.score-selector { display: flex; gap: var(--space-sm); }
.score-option {
  flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;
  padding: 12px 8px; border: 2px solid var(--color-border); border-radius: var(--radius-md);
  cursor: pointer; transition: all var(--transition-fast); text-align: center; min-width: 0;
}
.score-option:hover { border-color: var(--color-text-tertiary); background: var(--color-surface-alt); }
.score-option.selected { border-color: var(--color-primary); background: var(--color-primary-light); }
.score-option input { position: absolute; opacity: 0; width: 0; height: 0; }
.score-number { font-size: 22px; font-weight: 700; line-height: 1; }
.score-label-text { font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.04em; color: var(--color-text-secondary); line-height: 1.2; }
.score-option.s1 .score-number { color: var(--color-score-1); }
.score-option.s2 .score-number { color: var(--color-score-2); }
.score-option.s3 .score-number { color: var(--color-score-3); }
.score-option.s4 .score-number { color: var(--color-score-4); }
.score-option.s5 .score-number { color: var(--color-score-5); }
.score-option.selected.s1 { border-color: var(--color-score-1); background: #FFF5F5; }
.score-option.selected.s2 { border-color: var(--color-score-2); background: #FFFBEB; }
.score-option.selected.s3 { border-color: var(--color-score-3); background: #FFF8EB; }
.score-option.selected.s4 { border-color: var(--color-score-4); background: #E8F8EE; }
.score-option.selected.s5 { border-color: var(--color-score-5); background: #E0F5E8; }
@media (max-width: 600px) { .score-selector { gap: 4px; } .score-option { padding: 10px 4px; } .score-number { font-size: 18px; } .score-label-text { font-size: 9px; } }

/* Action table */
.action-input-mini { padding: 6px 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 13px; background: var(--color-surface); width: 100%; }
.action-input-mini:focus { outline: none; border-color: var(--color-primary); }
.action-table { width: 100%; border-collapse: collapse; }
.action-table th { text-align: left; padding: 8px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--color-text-tertiary); border-bottom: 2px solid var(--color-border); }
.action-table td { padding: 6px 8px; border-bottom: 1px solid var(--color-border-light); }

/* Quarterly review */
.quarter-card { border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: var(--space-md); overflow: hidden; }
.quarter-header { padding: var(--space-md) var(--space-lg); background: var(--color-surface-alt); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
.quarter-header:hover { background: var(--color-border-light); }
.quarter-body { padding: var(--space-lg); display: none; }
.quarter-card.open .quarter-body { display: block; }

/* PRINT */
@media print {
  .sidebar, .mobile-header, .sidebar-overlay, .toast-container, .btn-group, .skip-link { display: none !important; }
  .main-content { margin-left: 0 !important; }
  .page { display: block !important; page-break-inside: avoid; }
  .content-area { max-width: 100%; padding: 0; }
}

/* ACCESSIBILITY */
.skip-link { position: absolute; top: -40px; left: 0; background: var(--color-primary); color: #fff; padding: 8px 16px; z-index: 200; font-size: 14px; text-decoration: none; }
.skip-link:focus { top: 0; }
:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 2px; }
*:focus:not(:focus-visible) { outline: none; }
@media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } }
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to content</a>
<div class="toast-container" id="toastContainer" aria-live="polite" role="status"></div>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div class="app">
  <nav class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
    <div class="sidebar-brand">
      <div class="sidebar-brand-label">Exit Planning Playbook #43</div>
      <div class="sidebar-brand-title">Exit Timeline &amp; Milestone Tracker</div>
    </div>
    <div class="sidebar-progress">
      <div class="sidebar-progress-label">Your progress</div>
      <div class="sidebar-progress-bar"><div class="sidebar-progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="sidebar-progress-text" id="progressText">0% complete</div>
    </div>
    <div class="sidebar-nav" id="sidebarNav">
      <div class="nav-section-label">Journey</div>
      <div class="nav-item active" data-page="welcome" onclick="goToPage('welcome')" tabindex="0" role="button">
        <div class="nav-icon">1</div><span>Welcome</span>
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="setup" onclick="goToPage('setup')" tabindex="0" role="button">
        <div class="nav-icon">2</div><span>Exit Date Setup</span>
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="readiness" onclick="goToPage('readiness')" tabindex="0" role="button">
        <div class="nav-icon">3</div><span>Readiness Factors</span>
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="phases" onclick="goToPage('phases')" tabindex="0" role="button">
        <div class="nav-icon">4</div><span>Phase Overview</span>
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="tracker" onclick="goToPage('tracker')" tabindex="0" role="button">
        <div class="nav-icon">5</div><span>Playbook Tracker</span>
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="dependencies" onclick="goToPage('dependencies')" tabindex="0" role="button">
        <div class="nav-icon">6</div><span>Dependencies</span>
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="checklist" onclick="goToPage('checklist')" tabindex="0" role="button">
        <div class="nav-icon">7</div><span>Deal Readiness</span>
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="quarterly" onclick="goToPage('quarterly')" tabindex="0" role="button">
        <div class="nav-icon">8</div><span>Quarterly Review</span>
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
      <div class="nav-item locked" data-page="dashboard" onclick="goToPage('dashboard')" tabindex="0" role="button">
        <div class="nav-icon">9</div><span>Dashboard</span>
        <div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      </div>
    </div>
    <div class="sidebar-score">
      <div class="sidebar-score-label">Playbooks Completed</div>
      <div class="sidebar-score-value" id="sidebarCompleted">0<span class="sidebar-score-max">/44</span></div>
      <div class="sidebar-score-desc" id="sidebarPhase">Set your exit date to begin</div>
    </div>
  </nav>

  <div class="main-content" id="main-content">
    <div class="mobile-header">
      <button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle navigation"><span></span></button>
      <div style="font-weight:600;font-size:15px">Exit Timeline Tracker</div>
    </div>
    <div class="content-area">

      <!-- PAGE: WELCOME -->
      <div class="page active" id="page-welcome">
        <div class="welcome-hero">
          <div class="welcome-icon">&#128197;</div>
          <div class="t-display">Your Exit Is a Journey,<br>Not an Event</div>
          <p class="t-body t-secondary">A successful exit is a multi-year process with hundreds of interconnected tasks. This tool reverse-engineers your timeline from your target close date, telling you exactly what to work on, when, and in what order.</p>
          <div class="welcome-stats">
            <div class="welcome-stat">
              <div class="welcome-stat-value">44</div>
              <div class="welcome-stat-label">Playbooks mapped</div>
            </div>
            <div class="welcome-stat">
              <div class="welcome-stat-value">5</div>
              <div class="welcome-stat-label">Time horizons</div>
            </div>
            <div class="welcome-stat">
              <div class="welcome-stat-value">12</div>
              <div class="welcome-stat-label">Quarters of planning</div>
            </div>
          </div>
          <div class="welcome-phases">
            <div class="welcome-phase">
              <div class="welcome-phase-num">1</div>
              <div><div class="welcome-phase-title">Set your target exit date</div><div class="welcome-phase-desc">Establish your timeline based on business, personal, and market readiness factors.</div></div>
            </div>
            <div class="welcome-phase">
              <div class="welcome-phase-num">2</div>
              <div><div class="welcome-phase-title">Assess your readiness</div><div class="welcome-phase-desc">Evaluate the five factors that determine when you can enter the market.</div></div>
            </div>
            <div class="welcome-phase">
              <div class="welcome-phase-num">3</div>
              <div><div class="welcome-phase-title">Map your milestones</div><div class="welcome-phase-desc">Track all 44 playbooks across their ideal quarters with dependency chains.</div></div>
            </div>
            <div class="welcome-phase">
              <div class="welcome-phase-num">4</div>
              <div><div class="welcome-phase-title">Monitor and adjust</div><div class="welcome-phase-desc">Quarterly reviews to keep your exit plan on track and identify bottlenecks early.</div></div>
            </div>
          </div>
          <button class="btn btn-primary btn-lg" onclick="startJourney()">Set My Exit Date &rarr;</button>
        </div>
      </div>

      <!-- PAGE: SETUP -->
      <div class="page" id="page-setup">
        <div class="page-header">
          <div class="t-label">Step 1 of 8</div>
          <div class="t-display">Set Your Target Exit Date</div>
          <p class="t-body t-secondary">Your timeline works backward from this date. It should reflect the intersection of business readiness, personal readiness, and market conditions.</p>
        </div>
        <div class="card mb-xl" style="padding:var(--space-xl)">
          <div class="form-group">
            <label class="form-label">Target Close Date</label>
            <input type="month" class="form-input" id="exitDate" onchange="updateExitDate()" style="max-width:280px">
            <div class="form-hint">Choose the month and year you aim to close the transaction.</div>
          </div>
          <div id="timelineCalc" style="display:none">
            <div class="section-divider"></div>
            <div class="t-h2 mb-md">Your Time Horizons</div>
            <p class="t-small t-secondary mb-lg">Based on your target date, here are your five planning phases.</p>
            <div id="horizonCards"></div>
          </div>
        </div>
        <div class="callout callout-accent mb-xl">
          <strong>The Acceleration Principle:</strong> If you are already inside a shorter time horizon than ideal, you can still succeed. Activities can be compressed or run in parallel -- though this increases cost, complexity, and stress. The timeline is ideal sequencing, not a rigid requirement.
        </div>
        <div class="callout callout-warning mb-xl">
          <strong>Time Is the Most Expensive Variable:</strong> Every year of preparation you skip typically costs 0.5x to 1.0x on your EBITDA multiple. On $2M EBITDA, that is a $3M difference. Preparation is not overhead -- it is the highest-returning investment you will ever make.
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToPage('welcome')">&larr; Back</button>
          <button class="btn btn-primary" id="setupNext" onclick="completeSetup()" disabled>Continue to Readiness Factors &rarr;</button>
        </div>
      </div>

      <!-- PAGE: READINESS -->
      <div class="page" id="page-readiness">
        <div class="page-header">
          <div class="t-label">Step 2 of 8</div>
          <div class="t-display">Readiness Factor Assessment</div>
          <p class="t-body t-secondary">Rate each factor that should influence your target exit date. These determine whether your timeline is realistic or needs adjustment.</p>
        </div>
        <div id="readinessFactors"></div>
        <div class="section-divider"></div>
        <div id="readinessSummary" style="display:none"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToPage('setup')">&larr; Back</button>
          <button class="btn btn-primary" onclick="completeReadiness()">Continue to Phase Overview &rarr;</button>
        </div>
      </div>

      <!-- PAGE: PHASES -->
      <div class="page" id="page-phases">
        <div class="page-header">
          <div class="t-label">Step 3 of 8</div>
          <div class="t-display">Your Five-Phase Roadmap</div>
          <p class="t-body t-secondary">Each phase has specific objectives, key activities, and playbooks mapped to it. This visual shows your entire journey.</p>
        </div>
        <div class="card mb-xl" style="padding:var(--space-xl)">
          <div class="t-h3 mb-lg">Timeline Overview</div>
          <div class="gantt-container" id="ganttChart"></div>
        </div>
        <div id="phaseDetails"></div>
        <div class="section-divider"></div>
        <div class="callout callout-info mb-xl">
          <strong>The Critical Path:</strong> Financial cleanup (6-12 months) &#8594; Normalized EBITDA / QoE (2-4 months) &#8594; Valuation (1-2 months) &#8594; CIM (1-2 months) &#8594; Go to market (3-4 months) &#8594; LOI to close (6-9 months). Total: approximately 19-33 months. This is why starting 3+ years out is recommended.
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToPage('readiness')">&larr; Back</button>
          <button class="btn btn-primary" onclick="completePhases()">Continue to Playbook Tracker &rarr;</button>
        </div>
      </div>

      <!-- PAGE: TRACKER -->
      <div class="page" id="page-tracker">
        <div class="page-header">
          <div class="t-label">Step 4 of 8</div>
          <div class="t-display">44-Playbook Tracker</div>
          <p class="t-body t-secondary">Track your progress across all 44 playbooks. Each is mapped to its ideal implementation quarter relative to your target close date.</p>
        </div>
        <div class="card mb-lg" style="padding:var(--space-sm) var(--space-md)">
          <div style="display:flex;gap:var(--space-sm);align-items:center;padding:var(--space-sm) 0;flex-wrap:wrap">
            <span class="t-small t-secondary" style="margin-right:var(--space-sm)">Filter:</span>
            <button class="btn btn-sm filter-btn active" data-filter="all" onclick="filterTracker('all')">All</button>
            <button class="btn btn-sm filter-btn" data-filter="foundation" onclick="filterTracker('foundation')">Foundation</button>
            <button class="btn btn-sm filter-btn" data-filter="value" onclick="filterTracker('value')">Value Creation</button>
            <button class="btn btn-sm filter-btn" data-filter="readiness" onclick="filterTracker('readiness')">Deal Readiness</button>
            <button class="btn btn-sm filter-btn" data-filter="market" onclick="filterTracker('market')">Go-to-Market</button>
          </div>
        </div>
        <div class="card" style="padding:0;overflow-x:auto">
          <table class="tracker-table" id="trackerTable">
            <thead><tr><th style="width:40px">#</th><th>Playbook</th><th>Phase</th><th>Quarter</th><th>Priority</th><th style="width:140px">Status</th></tr></thead>
            <tbody id="trackerBody"></tbody>
          </table>
        </div>
        <div class="section-divider"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToPage('phases')">&larr; Back</button>
          <button class="btn btn-primary" onclick="completeTracker()">Continue to Dependencies &rarr;</button>
        </div>
      </div>

      <!-- PAGE: DEPENDENCIES -->
      <div class="page" id="page-dependencies">
        <div class="page-header">
          <div class="t-label">Step 5 of 8</div>
          <div class="t-display">Critical Path &amp; Dependencies</div>
          <p class="t-body t-secondary">Not all activities are independent. Understanding these dependencies is critical for realistic planning and avoiding bottlenecks.</p>
        </div>
        <div class="callout callout-danger mb-xl">
          <strong>The Bottleneck Principle:</strong> The entire exit timeline moves at the speed of its slowest critical path item. If your financials are a mess, nothing downstream can start. Identify your bottleneck and attack it first.
        </div>
        <div class="t-h2 mb-lg">Major Dependency Chains</div>
        <div id="depChains" class="mb-2xl"></div>
        <div class="t-h2 mb-lg">Your Bottleneck Identifier</div>
        <p class="t-small t-secondary mb-lg">Based on your playbook statuses, these are your current bottlenecks -- items that are blocking downstream progress.</p>
        <div id="bottleneckList" class="mb-xl"></div>
        <div class="section-divider"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToPage('tracker')">&larr; Back</button>
          <button class="btn btn-primary" onclick="completeDependencies()">Continue to Deal Readiness &rarr;</button>
        </div>
      </div>

      <!-- PAGE: CHECKLIST -->
      <div class="page" id="page-checklist">
        <div class="page-header">
          <div class="t-label">Step 6 of 8</div>
          <div class="t-display">Deal Readiness Checklist</div>
          <p class="t-body t-secondary">Before going to market, every item on this checklist should be complete or in progress. This is your go/no-go gate.</p>
        </div>
        <div class="card mb-xl" style="padding:var(--space-xl)">
          <div id="dealChecklist"></div>
          <div class="section-divider"></div>
          <div id="checklistSummary"></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToPage('dependencies')">&larr; Back</button>
          <button class="btn btn-primary" onclick="completeChecklist()">Continue to Quarterly Review &rarr;</button>
        </div>
      </div>

      <!-- PAGE: QUARTERLY -->
      <div class="page" id="page-quarterly">
        <div class="page-header">
          <div class="t-label">Step 7 of 8</div>
          <div class="t-display">Quarterly Review Scorecard</div>
          <p class="t-body t-secondary">Track your progress each quarter. Record what was planned, what was completed, and adjust your plan based on reality.</p>
        </div>
        <div id="quarterlyReviews"></div>
        <div class="section-divider"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToPage('checklist')">&larr; Back</button>
          <button class="btn btn-primary" onclick="completeQuarterly()">View Your Dashboard &rarr;</button>
        </div>
      </div>

      <!-- PAGE: DASHBOARD -->
      <div class="page" id="page-dashboard">
        <div class="page-header">
          <div class="t-label">Your Exit Roadmap</div>
          <div class="t-display">Timeline Dashboard</div>
          <p class="t-body t-secondary">Your complete exit preparation status at a glance.</p>
        </div>
        <div class="kpi-row" id="dashKpis"></div>
        <div class="card mb-xl" style="padding:var(--space-xl)">
          <div class="t-h2 mb-lg">Phase Completion</div>
          <div class="bar-chart" id="dashPhaseBars"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-lg);margin-bottom:var(--space-xl)">
          <div class="card" style="padding:var(--space-xl)">
            <div class="t-h3 mb-md">Readiness Score</div>
            <div style="text-align:center;padding:var(--space-lg) 0" id="dashRing"></div>
          </div>
          <div class="card" style="padding:var(--space-xl)">
            <div class="t-h3 mb-md">Time Remaining</div>
            <div id="dashCountdown" style="text-align:center;padding:var(--space-lg) 0"></div>
          </div>
        </div>
        <div class="card mb-xl" style="padding:var(--space-xl)">
          <div class="t-h2 mb-lg">Recommendations</div>
          <div id="dashRecs"></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToPage('quarterly')">&larr; Back to Review</button>
          <button class="btn btn-accent" onclick="exportReport()">Export Report</button>
          <button class="btn btn-secondary" onclick="exportData()">Export Raw Data</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ============================================================
   DATA MODEL
   ============================================================ */
const STORAGE_KEY = 'exitosx-pb43-exit-timeline';

const READINESS_FACTORS = [
  { id: 'business', label: 'Business Readiness', question: 'When will the business be at peak performance relative to its current trajectory?', labels: ['Far off','2-3 years','1-2 years','6-12 mo','Ready now'] },
  { id: 'personal', label: 'Personal Readiness', question: 'When does your personal situation (age, energy, family, health, financial need) make exit optimal?', labels: ['Not ready','Uncertain','Open to it','Eager','Must exit'] },
  { id: 'market', label: 'Market Conditions', question: 'Are M&A market conditions likely to be favorable for your industry and deal size?', labels: ['Very weak','Weak','Neutral','Favorable','Excellent'] },
  { id: 'external', label: 'External Factors', question: 'Do tax law changes, interest rate shifts, or regulatory changes create urgency or opportunity?', labels: ['Threat','Concern','Neutral','Tailwind','Urgent opp.'] },
  { id: 'stakeholder', label: 'Stakeholder Alignment', question: 'If you have partners, board members, or investors, when do their timelines align?', labels: ['Misaligned','Somewhat','Neutral','Aligned','Fully aligned'] }
];

const DEAL_CHECKLIST = [
  'Three years of audited or reviewed financial statements available',
  'Adjusted EBITDA calculated and defensible for each year',
  'Sell-side Quality of Earnings report completed',
  'Business valuation obtained (formal or advisor-provided range)',
  'Data room built and populated with all key documents',
  'CIM drafted and reviewed by M&A advisor',
  'Target buyer list developed (minimum 50-100 names)',
  'M&A advisor engaged with clear fee agreement',
  'Transaction attorney identified (M&A specialist)',
  'Tax advisor engaged on deal structure planning',
  'Internal Deal Team Lead identified and incentivized',
  'Management team briefed (to extent appropriate)',
  'Personal financial plan updated with post-exit projections',
  'Spouse / partner aligned on timing, terms, and post-exit plan',
  'Walk-away number defined (minimum acceptable net proceeds)'
];

const PHASES = [
  { id: 'foundation', name: 'Foundation & Structure', horizon: '3+ Years Out', color: 'var(--color-phase-1)', pill: 'phase-1', qStart: -12, qEnd: -8, objective: 'Build the structural foundation that makes the business saleable', outcome: 'Entity structure optimized, estate plan current, owner dependency reduced, financials cleaned up' },
  { id: 'value', name: 'Value Creation & Team', horizon: '2-3 Years Out', color: 'var(--color-phase-2)', pill: 'phase-2', qStart: -8, qEnd: -4, objective: 'Drive value and build the team that runs the business without you', outcome: 'Value drivers accelerated, management team in place, SOPs documented, growth trajectory established' },
  { id: 'readiness', name: 'Deal Readiness', horizon: '1-2 Years Out', color: 'var(--color-phase-3)', pill: 'phase-3', qStart: -4, qEnd: -2, objective: 'Prepare all the materials and infrastructure needed to go to market', outcome: 'Valuation complete, deal team assembled, data room built, CIM drafted' },
  { id: 'market', name: 'Go to Market', horizon: '6-12 Months', color: 'var(--color-phase-4)', pill: 'phase-4', qStart: -2, qEnd: -1, objective: 'Execute the sale process: outreach, meetings, offers, negotiations', outcome: 'LOI signed with qualified buyer on acceptable terms' },
  { id: 'close', name: 'Diligence & Close', horizon: '0-6 Months', color: 'var(--color-phase-5)', pill: 'phase-5', qStart: -1, qEnd: 0, objective: 'Survive diligence, negotiate the definitive agreement, and close', outcome: 'Funds wired, transition plan activated, next chapter begins' }
];

const PLAYBOOKS = [
  { num: 1, title: 'Exit Readiness Assessment', phase: 'foundation', quarter: -12, priority: 'Critical', deps: [] },
  { num: 2, title: 'Entity Structure Optimization', phase: 'foundation', quarter: -12, priority: 'Critical', deps: [1] },
  { num: 3, title: 'Estate Planning for Exit', phase: 'foundation', quarter: -12, priority: 'Critical', deps: [1,2] },
  { num: 4, title: 'Succession Planning', phase: 'foundation', quarter: -11, priority: 'High', deps: [1] },
  { num: 5, title: 'Owner Dependency Reduction', phase: 'foundation', quarter: -11, priority: 'Critical', deps: [4] },
  { num: 6, title: 'Financial Cleanup & Normalization', phase: 'foundation', quarter: -10, priority: 'Critical', deps: [1] },
  { num: 7, title: 'Adjusted EBITDA Calculation', phase: 'foundation', quarter: -9, priority: 'Critical', deps: [6] },
  { num: 8, title: 'Tax Planning & Structuring', phase: 'foundation', quarter: -11, priority: 'Critical', deps: [2] },
  { num: 9, title: 'Business Valuation', phase: 'readiness', quarter: -4, priority: 'Critical', deps: [6,7] },
  { num: 10, title: 'Valuation Methods Deep Dive', phase: 'readiness', quarter: -4, priority: 'High', deps: [9] },
  { num: 11, title: 'Legal & Compliance Audit', phase: 'foundation', quarter: -9, priority: 'High', deps: [1] },
  { num: 12, title: 'Workforce & HR Readiness', phase: 'foundation', quarter: -8, priority: 'Medium', deps: [5] },
  { num: 13, title: 'Customer Contract Review', phase: 'foundation', quarter: -8, priority: 'High', deps: [6] },
  { num: 14, title: 'Intellectual Property Protection', phase: 'foundation', quarter: -10, priority: 'High', deps: [1] },
  { num: 15, title: 'Technology & Systems', phase: 'value', quarter: -7, priority: 'High', deps: [1] },
  { num: 16, title: 'Data Room Construction', phase: 'readiness', quarter: -3, priority: 'Critical', deps: [6,11,13,14] },
  { num: 17, title: 'Insurance Review', phase: 'value', quarter: -6, priority: 'Medium', deps: [11] },
  { num: 18, title: 'Environmental & Regulatory', phase: 'value', quarter: -5, priority: 'Medium', deps: [11] },
  { num: 19, title: 'Real Estate & Lease Strategy', phase: 'value', quarter: -5, priority: 'Medium', deps: [16] },
  { num: 20, title: 'Working Capital Optimization', phase: 'readiness', quarter: -4, priority: 'High', deps: [6,7] },
  { num: 21, title: 'Personal Financial Planning', phase: 'readiness', quarter: -4, priority: 'High', deps: [9] },
  { num: 22, title: 'Emotional Readiness', phase: 'readiness', quarter: -4, priority: 'Medium', deps: [] },
  { num: 23, title: 'Post-Exit Identity & Purpose', phase: 'close', quarter: 0, priority: 'Medium', deps: [22] },
  { num: 24, title: 'Wealth Management Post-Exit', phase: 'close', quarter: 0, priority: 'High', deps: [21] },
  { num: 25, title: 'Legacy & Philanthropy Planning', phase: 'close', quarter: 0, priority: 'Medium', deps: [24] },
  { num: 26, title: 'Value Driver Acceleration', phase: 'value', quarter: -8, priority: 'Critical', deps: [7] },
  { num: 27, title: 'Management Team Development', phase: 'value', quarter: -8, priority: 'Critical', deps: [4,5] },
  { num: 28, title: 'SOP Documentation', phase: 'value', quarter: -7, priority: 'High', deps: [5] },
  { num: 29, title: 'Growth Strategy for Exit', phase: 'value', quarter: -7, priority: 'High', deps: [26] },
  { num: 30, title: 'Customer Diversification Strategy', phase: 'value', quarter: -6, priority: 'High', deps: [26] },
  { num: 31, title: 'Choosing Your Advisory Team', phase: 'readiness', quarter: -3, priority: 'Critical', deps: [9] },
  { num: 32, title: 'Confidential Info Memorandum', phase: 'readiness', quarter: -2, priority: 'Critical', deps: [9,16] },
  { num: 33, title: 'Buyer Universe Mapping', phase: 'readiness', quarter: -3, priority: 'High', deps: [9,31] },
  { num: 34, title: 'Quality of Earnings (Sell-Side)', phase: 'readiness', quarter: -4, priority: 'Critical', deps: [6,7] },
  { num: 35, title: 'Management Presentation Prep', phase: 'readiness', quarter: -2, priority: 'High', deps: [27] },
  { num: 36, title: 'Buyer Outreach & NDAs', phase: 'market', quarter: -2, priority: 'Critical', deps: [32,33] },
  { num: 37, title: 'Evaluating and Comparing Offers', phase: 'market', quarter: -1, priority: 'Critical', deps: [36] },
  { num: 38, title: 'LOI Negotiation', phase: 'market', quarter: -1, priority: 'Critical', deps: [37] },
  { num: 39, title: 'Due Diligence Survival Guide', phase: 'close', quarter: -1, priority: 'Critical', deps: [16] },
  { num: 40, title: 'Purchase Agreement Negotiation', phase: 'close', quarter: 0, priority: 'Critical', deps: [38] },
  { num: 41, title: 'Closing Process & Transition', phase: 'close', quarter: 0, priority: 'Critical', deps: [40] },
  { num: 42, title: 'Deal Fatigue Management', phase: 'readiness', quarter: -2, priority: 'High', deps: [] },
  { num: 43, title: 'Exit Timeline & Milestone Tracker', phase: 'readiness', quarter: -2, priority: 'High', deps: [] },
  { num: 44, title: 'Market Timing Assessment', phase: 'readiness', quarter: -2, priority: 'High', deps: [9] }
];

const DEP_CHAINS = [
  { name: 'Financial to Market', nodes: [6,7,9,32,36,38,40,41], desc: 'The longest chain: from financial cleanup through close. This IS your critical path.' },
  { name: 'Owner to Management', nodes: [4,5,27,35], desc: 'From succession planning through management presentation readiness.' },
  { name: 'Legal to Data Room', nodes: [11,13,14,16], desc: 'Legal cleanup feeds directly into a credible data room.' },
  { name: 'Valuation to Deal Team', nodes: [9,31,33,36], desc: 'You need a valuation before you can effectively choose advisors and map buyers.' },
  { name: 'Personal Readiness', nodes: [22,21,24,25], desc: 'Emotional readiness enables financial planning which enables wealth management.' }
];

let state = {
  currentPage: 'welcome',
  pagesUnlocked: ['welcome'],
  pagesCompleted: [],
  exitDate: '',
  readinessScores: {},
  playbookStatus: {},
  dealChecklist: {},
  quarterlyNotes: {},
  bottleneckNotes: {}
};

/* ============================================================
   PERSISTENCE
   ============================================================ */
function saveData() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {}
}
function loadData() {
  try {
    const d = localStorage.getItem(STORAGE_KEY);
    if (d) { const parsed = JSON.parse(d); Object.assign(state, parsed); }
  } catch(e) {}
}

/* ============================================================
   NAVIGATION
   ============================================================ */
function goToPage(pageId) {
  const item = document.querySelector(`.nav-item[data-page="${pageId}"]`);
  if (item && item.classList.contains('locked')) return;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const page = document.getElementById('page-' + pageId);
  if (page) page.classList.add('active');
  if (item) item.classList.add('active');
  state.currentPage = pageId;
  saveData();
  window.scrollTo({ top: 0, behavior: 'smooth' });
  closeSidebar();

  setTimeout(() => {
    const heading = page ? page.querySelector('.t-display, h1, h2, .t-h2') : null;
    if (heading) { heading.setAttribute('tabindex', '-1'); heading.focus(); }
  }, 100);

  if (pageId === 'readiness') renderReadiness();
  if (pageId === 'phases') renderPhases();
  if (pageId === 'tracker') renderTracker();
  if (pageId === 'dependencies') renderDependencies();
  if (pageId === 'checklist') renderChecklist();
  if (pageId === 'quarterly') renderQuarterly();
  if (pageId === 'dashboard') renderDashboard();
}

function unlockPage(pageId) {
  if (!state.pagesUnlocked.includes(pageId)) state.pagesUnlocked.push(pageId);
  const item = document.querySelector(`.nav-item[data-page="${pageId}"]`);
  if (item) item.classList.remove('locked');
  saveData();
}

function completePage(pageId) {
  if (!state.pagesCompleted.includes(pageId)) state.pagesCompleted.push(pageId);
  const item = document.querySelector(`.nav-item[data-page="${pageId}"]`);
  if (item) item.classList.add('completed');
  saveData();
  updateProgress();
}

function updateProgress() {
  const total = 9;
  const done = state.pagesCompleted.length;
  const pct = Math.round((done / total) * 100);
  const fill = document.getElementById('progressFill');
  const text = document.getElementById('progressText');
  if (fill) fill.style.width = pct + '%';
  if (text) text.textContent = pct + '% complete';

  const completed = Object.values(state.playbookStatus).filter(s => s === 'complete').length;
  document.getElementById('sidebarCompleted').innerHTML = completed + '<span class="sidebar-score-max">/44</span>';

  const currentPhase = getCurrentPhase();
  document.getElementById('sidebarPhase').textContent = currentPhase ? 'Current: ' + currentPhase : 'Set your exit date to begin';
}

function getCurrentPhase() {
  if (!state.exitDate) return '';
  const months = getMonthsRemaining();
  if (months > 36) return 'Foundation';
  if (months > 24) return 'Value Creation';
  if (months > 12) return 'Deal Readiness';
  if (months > 6) return 'Go to Market';
  return 'Close';
}

function getMonthsRemaining() {
  if (!state.exitDate) return 0;
  const target = new Date(state.exitDate + '-01');
  const now = new Date();
  return Math.max(0, (target.getFullYear() - now.getFullYear()) * 12 + target.getMonth() - now.getMonth());
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show');
}

function showToast(msg) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.classList.add('out'); setTimeout(() => t.remove(), 300); }, 3000);
}

/* ============================================================
   WELCOME
   ============================================================ */
function startJourney() {
  completePage('welcome');
  unlockPage('setup');
  goToPage('setup');
  if (state.exitDate) document.getElementById('exitDate').value = state.exitDate;
}

/* ============================================================
   SETUP
   ============================================================ */
function updateExitDate() {
  const val = document.getElementById('exitDate').value;
  state.exitDate = val;
  saveData();
  if (val) {
    document.getElementById('setupNext').disabled = false;
    document.getElementById('timelineCalc').style.display = 'block';
    renderHorizons();
  }
}

function renderHorizons() {
  const months = getMonthsRemaining();
  const target = new Date(state.exitDate + '-01');
  const fmt = (d) => d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

  const horizons = [
    { label: '3+ Years Out', desc: 'Foundation and Structure', months: 36, color: 'var(--color-phase-1)' },
    { label: '2-3 Years Out', desc: 'Value Creation and Team', months: 24, color: 'var(--color-phase-2)' },
    { label: '1-2 Years Out', desc: 'Deal Readiness', months: 12, color: 'var(--color-phase-3)' },
    { label: '6-12 Months Out', desc: 'Go to Market', months: 6, color: 'var(--color-phase-4)' },
    { label: '0-6 Months', desc: 'Diligence and Close', months: 0, color: 'var(--color-phase-5)' }
  ];

  let html = '';
  horizons.forEach((h, i) => {
    const startDate = new Date(target);
    startDate.setMonth(startDate.getMonth() - h.months);
    const isActive = months >= h.months && (i === horizons.length - 1 || months < horizons[i > 0 ? i - 1 : 0].months);
    const isPast = months < h.months && i > 0;
    html += `<div class="card mb-md" style="padding:var(--space-md) var(--space-lg);border-left:4px solid ${h.color};${isActive ? 'background:var(--color-surface-alt)' : ''}">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:var(--space-sm)">
        <div>
          <div class="t-h3">${h.label}</div>
          <div class="t-small t-secondary">${h.desc}</div>
        </div>
        <div style="text-align:right">
          <div class="t-small">${fmt(startDate)} &mdash; ${i > 0 ? fmt(new Date(new Date(target).setMonth(target.getMonth() - horizons[i-1].months))) : fmt(target)}</div>
          ${isActive ? '<span class="badge badge-accent">You are here</span>' : ''}
          ${isPast ? '<span class="badge badge-warning">Compressed</span>' : ''}
        </div>
      </div>
    </div>`;
  });

  if (months < 24) {
    html += '<div class="callout callout-warning" style="margin-top:var(--space-md)"><strong>Accelerated Timeline:</strong> With ' + months + ' months remaining, some foundation activities will need to be compressed or run in parallel. This is achievable but requires more resources and coordination.</div>';
  }
  document.getElementById('horizonCards').innerHTML = html;
}

function completeSetup() {
  if (!state.exitDate) return;
  completePage('setup');
  unlockPage('readiness');
  goToPage('readiness');
  showToast('Target date set. Now assess your readiness factors.');
}

/* ============================================================
   READINESS FACTORS
   ============================================================ */
function renderReadiness() {
  let html = '';
  READINESS_FACTORS.forEach(f => {
    const score = state.readinessScores[f.id] || 0;
    html += `<div class="card mb-lg" style="padding:var(--space-xl)">
      <div class="t-h3 mb-sm">${f.label}</div>
      <p class="t-small t-secondary mb-lg">${f.question}</p>
      <div class="score-selector">
        ${[1,2,3,4,5].map(s => `
          <div class="score-option s${s} ${score===s?'selected':''}" onclick="setReadiness('${f.id}',${s})" role="radio" aria-checked="${score===s}" tabindex="0">
            <input type="radio" name="r_${f.id}" value="${s}">
            <div class="score-number">${s}</div>
            <div class="score-label-text">${f.labels[s-1]}</div>
          </div>
        `).join('')}
      </div>
    </div>`;
  });
  document.getElementById('readinessFactors').innerHTML = html;
  renderReadinessSummary();
}

function setReadiness(id, val) {
  state.readinessScores[id] = val;
  saveData();
  renderReadiness();
}

function renderReadinessSummary() {
  const scores = Object.values(state.readinessScores);
  if (scores.length < 3) { document.getElementById('readinessSummary').style.display = 'none'; return; }
  document.getElementById('readinessSummary').style.display = 'block';
  const avg = scores.reduce((a,b) => a+b, 0) / scores.length;
  let interpretation = '';
  if (avg >= 4) interpretation = 'Your readiness factors strongly support moving forward. Your timeline is realistic.';
  else if (avg >= 3) interpretation = 'Most factors are aligned. Address the weaker areas to strengthen your position before going to market.';
  else if (avg >= 2) interpretation = 'Several factors need improvement. Consider extending your timeline by 6-12 months to address gaps.';
  else interpretation = 'Significant preparation is needed. Focus on foundation activities before setting an aggressive timeline.';

  document.getElementById('readinessSummary').innerHTML = `
    <div class="t-h2 mb-md">Readiness Summary</div>
    <div style="display:flex;align-items:center;gap:var(--space-xl);margin-bottom:var(--space-lg)">
      <div style="text-align:center">
        <div style="font-family:var(--font-display);font-size:48px;font-weight:700;color:${getScoreColor(avg)}">${avg.toFixed(1)}</div>
        <div class="t-small t-secondary">out of 5.0</div>
      </div>
      <div class="t-body" style="flex:1">${interpretation}</div>
    </div>
    <div class="bar-chart">
      ${READINESS_FACTORS.map((f, i) => {
        const s = state.readinessScores[f.id] || 0;
        return `<div class="bar-row">
          <div class="bar-label">${f.label}</div>
          <div class="bar-track">
            <div class="bar-fill" data-width="${(s/5)*100}" data-delay="${i*80}" style="width:0%;background:${getScoreColor(s)}">
              <span class="bar-value">${s || '-'}</span>
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>
  `;
  setTimeout(() => {
    document.querySelectorAll('#readinessSummary .bar-fill').forEach(el => {
      setTimeout(() => { el.style.width = el.dataset.width + '%'; }, parseInt(el.dataset.delay) || 0);
    });
  }, 100);
}

function completeReadiness() {
  completePage('readiness');
  unlockPage('phases');
  goToPage('phases');
  showToast('Readiness assessed. Review your phase roadmap.');
}

/* ============================================================
   PHASES
   ============================================================ */
function renderPhases() {
  renderGantt();
  renderPhaseDetails();
}

function renderGantt() {
  const quarters = [];
  for (let q = -12; q <= 0; q++) quarters.push('T' + (q >= 0 ? '' : '') + q);

  let html = '<div class="gantt"><div class="gantt-header"><div class="gantt-label-col">Activity</div><div class="gantt-bars-col">';
  quarters.forEach(q => { html += `<div class="gantt-q">${q}</div>`; });
  html += '</div></div>';

  PHASES.forEach(phase => {
    const startIdx = phase.qStart + 12;
    const endIdx = phase.qEnd + 12;
    const widthPct = ((endIdx - startIdx) / 13) * 100;
    const leftPct = (startIdx / 13) * 100;
    html += `<div class="gantt-row">
      <div class="gantt-row-label" style="font-weight:600">${phase.name}</div>
      <div class="gantt-row-bars">
        <div class="gantt-bar" style="left:${leftPct}%;width:${widthPct}%;background:${phase.color}" title="${phase.horizon}: ${phase.objective}"></div>
      </div>
    </div>`;
  });
  html += '</div>';
  document.getElementById('ganttChart').innerHTML = html;
}

function renderPhaseDetails() {
  let html = '';
  PHASES.forEach(phase => {
    const playbooks = PLAYBOOKS.filter(p => p.phase === phase.id);
    const completed = playbooks.filter(p => state.playbookStatus[p.num] === 'complete').length;
    const pct = playbooks.length > 0 ? Math.round((completed / playbooks.length) * 100) : 0;
    html += `<div class="card mb-lg" style="padding:var(--space-xl);border-left:4px solid ${phase.color}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:var(--space-md);margin-bottom:var(--space-md)">
        <div>
          <span class="phase-pill ${phase.pill}">${phase.horizon}</span>
          <div class="t-h2" style="margin-top:var(--space-sm)">${phase.name}</div>
        </div>
        <div style="text-align:right">
          <div class="t-caption t-tertiary">${completed}/${playbooks.length} playbooks</div>
          <div style="width:100px;height:6px;background:var(--color-surface-alt);border-radius:3px;overflow:hidden;margin-top:4px">
            <div style="width:${pct}%;height:100%;background:${phase.color};border-radius:3px;transition:width 0.5s ease"></div>
          </div>
        </div>
      </div>
      <p class="t-small t-secondary mb-md"><strong>Objective:</strong> ${phase.objective}</p>
      <p class="t-small t-secondary mb-md"><strong>Key Outcome:</strong> ${phase.outcome}</p>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:var(--space-md)">
        ${playbooks.map(p => {
          const st = state.playbookStatus[p.num] || 'not-started';
          const bg = st === 'complete' ? 'var(--color-success-light)' : st === 'in-progress' ? 'var(--color-warning-light)' : 'var(--color-surface-alt)';
          const tc = st === 'complete' ? 'var(--color-success)' : st === 'in-progress' ? 'var(--color-warning)' : 'var(--color-text-secondary)';
          return `<span style="padding:2px 8px;border-radius:999px;font-size:11px;font-weight:500;background:${bg};color:${tc}">#${p.num} ${p.title.split(' ').slice(0,3).join(' ')}</span>`;
        }).join('')}
      </div>
    </div>`;
  });
  document.getElementById('phaseDetails').innerHTML = html;
}

function completePhases() {
  completePage('phases');
  unlockPage('tracker');
  goToPage('tracker');
  showToast('Phases reviewed. Track your 44 playbooks.');
}

/* ============================================================
   TRACKER
   ============================================================ */
function renderTracker(filter) {
  filter = filter || 'all';
  const filtered = filter === 'all' ? PLAYBOOKS : PLAYBOOKS.filter(p => p.phase === filter);
  let html = '';
  filtered.forEach(p => {
    const st = state.playbookStatus[p.num] || 'not-started';
    const phase = PHASES.find(ph => ph.id === p.phase);
    const qLabel = p.quarter >= 0 ? 'T' : 'T' + p.quarter;
    const prColor = p.priority === 'Critical' ? 'badge-danger' : p.priority === 'High' ? 'badge-warning' : 'badge-neutral';
    html += `<tr data-phase="${p.phase}">
      <td style="font-weight:600;color:var(--color-text-tertiary)">${p.num}</td>
      <td style="font-weight:500">${p.title}</td>
      <td><span class="phase-pill ${phase.pill}">${phase.name.split(' ')[0]}</span></td>
      <td><span class="t-small">${qLabel}</span></td>
      <td><span class="badge ${prColor}">${p.priority}</span></td>
      <td><select class="status-select" onchange="setPlaybookStatus(${p.num},this.value)" aria-label="Status for playbook ${p.num}">
        <option value="not-started" ${st==='not-started'?'selected':''}>Not Started</option>
        <option value="in-progress" ${st==='in-progress'?'selected':''}>In Progress</option>
        <option value="complete" ${st==='complete'?'selected':''}>Complete</option>
      </select></td>
    </tr>`;
  });
  document.getElementById('trackerBody').innerHTML = html;
}

function filterTracker(filter) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === filter));
  renderTracker(filter);
}

function setPlaybookStatus(num, val) {
  state.playbookStatus[num] = val;
  saveData();
  updateProgress();
}

function completeTracker() {
  completePage('tracker');
  unlockPage('dependencies');
  goToPage('dependencies');
  showToast('Tracker updated. Review your dependencies.');
}

/* ============================================================
   DEPENDENCIES
   ============================================================ */
function renderDependencies() {
  let html = '';
  DEP_CHAINS.forEach(chain => {
    html += `<div class="card mb-lg" style="padding:var(--space-lg)">
      <div class="t-h3 mb-sm">${chain.name}</div>
      <p class="t-small t-secondary mb-md">${chain.desc}</p>
      <div class="dep-chain">
        ${chain.nodes.map((num, i) => {
          const pb = PLAYBOOKS.find(p => p.num === num);
          const st = state.playbookStatus[num] || 'not-started';
          const cls = st === 'complete' ? 'done' : (isBottleneck(num) ? 'critical' : '');
          return (i > 0 ? '<span class="dep-arrow">&rarr;</span>' : '') +
            `<span class="dep-node ${cls}" title="#${num}: ${pb.title}">#${num}</span>`;
        }).join('')}
      </div>
    </div>`;
  });
  document.getElementById('depChains').innerHTML = html;

  const bottlenecks = findBottlenecks();
  if (bottlenecks.length === 0) {
    document.getElementById('bottleneckList').innerHTML = '<div class="callout callout-info">No bottlenecks detected. Either all dependencies are satisfied or no playbooks have been started yet.</div>';
  } else {
    document.getElementById('bottleneckList').innerHTML = bottlenecks.map(b => `
      <div class="bottleneck-card is-bottleneck">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-sm)">
          <div class="t-h3">#${b.num}: ${b.title}</div>
          <span class="badge badge-danger">Blocking ${b.blocking.length} playbook${b.blocking.length > 1 ? 's' : ''}</span>
        </div>
        <p class="t-small t-secondary mb-sm">Status: ${(state.playbookStatus[b.num] || 'not-started').replace('-', ' ')}</p>
        <p class="t-small">Blocks: ${b.blocking.map(n => '#' + n).join(', ')}</p>
        <div class="form-group" style="margin-top:var(--space-md);margin-bottom:0">
          <input class="form-input" placeholder="Action to resolve this bottleneck..." value="${esc(state.bottleneckNotes[b.num] || '')}" oninput="state.bottleneckNotes[${b.num}]=this.value;saveData()">
        </div>
      </div>
    `).join('');
  }
}

function isBottleneck(num) {
  const st = state.playbookStatus[num] || 'not-started';
  if (st === 'complete') return false;
  const downstream = PLAYBOOKS.filter(p => p.deps.includes(num) && state.playbookStatus[p.num] !== 'complete');
  return downstream.length > 0;
}

function findBottlenecks() {
  const results = [];
  PLAYBOOKS.forEach(pb => {
    const st = state.playbookStatus[pb.num] || 'not-started';
    if (st === 'complete') return;
    const blocking = PLAYBOOKS.filter(p => p.deps.includes(pb.num) && (state.playbookStatus[p.num] || 'not-started') !== 'complete');
    if (blocking.length > 0) {
      results.push({ num: pb.num, title: pb.title, blocking: blocking.map(b => b.num) });
    }
  });
  results.sort((a, b) => b.blocking.length - a.blocking.length);
  return results.slice(0, 8);
}

function completeDependencies() {
  completePage('dependencies');
  unlockPage('checklist');
  goToPage('checklist');
  showToast('Dependencies mapped. Check your deal readiness.');
}

/* ============================================================
   DEAL READINESS CHECKLIST
   ============================================================ */
function renderChecklist() {
  document.getElementById('dealChecklist').innerHTML = DEAL_CHECKLIST.map((item, i) => {
    const checked = state.dealChecklist[i] || false;
    return `<div class="check-item ${checked ? 'checked' : ''}" onclick="toggleDealCheck(${i})" role="checkbox" aria-checked="${checked}" tabindex="0">
      <div class="check-box"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div>
      <div class="check-text">${item}</div>
    </div>`;
  }).join('');

  const checked = Object.values(state.dealChecklist).filter(Boolean).length;
  const total = DEAL_CHECKLIST.length;
  const pct = Math.round((checked / total) * 100);

  let signal = '', color = '';
  if (checked >= 12) { signal = 'Strong go signal. Engage your advisor and begin the process.'; color = 'var(--color-success)'; }
  else if (checked >= 8) { signal = 'Conditional go. Address the missing items within 3-6 months.'; color = 'var(--color-warning)'; }
  else { signal = 'Hold. Focus on the unchecked items before going to market.'; color = 'var(--color-danger)'; }

  document.getElementById('checklistSummary').innerHTML = `
    <div style="display:flex;align-items:center;gap:var(--space-xl)">
      <div style="text-align:center">
        <div style="font-family:var(--font-display);font-size:48px;font-weight:700;color:${color}">${checked}<span style="font-size:24px;color:var(--color-text-tertiary)">/${total}</span></div>
        <div class="t-small t-secondary">${pct}% ready</div>
      </div>
      <div>
        <div class="t-h3 mb-sm">Go/No-Go Signal</div>
        <p class="t-body" style="color:${color};font-weight:500">${signal}</p>
      </div>
    </div>
  `;
}

function toggleDealCheck(i) {
  state.dealChecklist[i] = !state.dealChecklist[i];
  saveData();
  renderChecklist();
}

function completeChecklist() {
  completePage('checklist');
  unlockPage('quarterly');
  goToPage('quarterly');
  showToast('Checklist saved. Set up your quarterly reviews.');
}

/* ============================================================
   QUARTERLY REVIEW
   ============================================================ */
function renderQuarterly() {
  const months = getMonthsRemaining();
  const numQuarters = Math.min(Math.ceil(months / 3), 12);
  if (numQuarters < 1) {
    document.getElementById('quarterlyReviews').innerHTML = '<div class="callout callout-warning">Set your exit date to generate quarterly review periods.</div>';
    return;
  }

  const now = new Date();
  let html = '';
  for (let i = 0; i < numQuarters; i++) {
    const qStart = new Date(now.getFullYear(), now.getMonth() + (i * 3), 1);
    const qEnd = new Date(now.getFullYear(), now.getMonth() + ((i + 1) * 3) - 1, 1);
    const qLabel = 'Q' + (i + 1);
    const qRange = qStart.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) + ' - ' + qEnd.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    const notes = state.quarterlyNotes[i] || {};
    const isOpen = i === 0;

    html += `<div class="quarter-card ${isOpen ? 'open' : ''}" id="qcard-${i}">
      <div class="quarter-header" onclick="toggleQuarter(${i})">
        <div>
          <div class="t-h3">${qLabel}: ${qRange}</div>
        </div>
        <span style="font-size:18px;color:var(--color-text-tertiary);transition:transform 0.2s">${isOpen ? '&#9660;' : '&#9654;'}</span>
      </div>
      <div class="quarter-body">
        <div class="form-group">
          <label class="form-label">Planned Milestones</label>
          <textarea class="form-input" rows="3" placeholder="What do you plan to accomplish this quarter?" oninput="setQuarterlyNote(${i},'planned',this.value)">${esc(notes.planned || '')}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Completed</label>
          <textarea class="form-input" rows="3" placeholder="What actually got done?" oninput="setQuarterlyNote(${i},'completed',this.value)">${esc(notes.completed || '')}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Delayed / Blocked</label>
          <textarea class="form-input" rows="2" placeholder="What fell behind and why?" oninput="setQuarterlyNote(${i},'delayed',this.value)">${esc(notes.delayed || '')}</textarea>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Adjustments for Next Quarter</label>
          <textarea class="form-input" rows="2" placeholder="What changes will you make based on this review?" oninput="setQuarterlyNote(${i},'adjustments',this.value)">${esc(notes.adjustments || '')}</textarea>
        </div>
      </div>
    </div>`;
  }
  document.getElementById('quarterlyReviews').innerHTML = html;
}

function toggleQuarter(i) {
  const card = document.getElementById('qcard-' + i);
  card.classList.toggle('open');
}

function setQuarterlyNote(q, field, val) {
  if (!state.quarterlyNotes[q]) state.quarterlyNotes[q] = {};
  state.quarterlyNotes[q][field] = val;
  saveData();
}

function completeQuarterly() {
  completePage('quarterly');
  unlockPage('dashboard');
  goToPage('dashboard');
  showToast('Reviews saved. Here is your dashboard.');
}

/* ============================================================
   DASHBOARD
   ============================================================ */
function renderDashboard() {
  const completed = Object.values(state.playbookStatus).filter(s => s === 'complete').length;
  const inProgress = Object.values(state.playbookStatus).filter(s => s === 'in-progress').length;
  const months = getMonthsRemaining();
  const checkedItems = Object.values(state.dealChecklist).filter(Boolean).length;

  document.getElementById('dashKpis').innerHTML = `
    <div class="kpi-card"><div class="kpi-value" style="color:var(--color-primary)">${completed}</div><div class="kpi-label">Playbooks Complete</div></div>
    <div class="kpi-card"><div class="kpi-value" style="color:var(--color-warning)">${inProgress}</div><div class="kpi-label">In Progress</div></div>
    <div class="kpi-card"><div class="kpi-value" style="color:var(--color-accent)">${months}</div><div class="kpi-label">Months Remaining</div></div>
    <div class="kpi-card"><div class="kpi-value" style="color:${checkedItems >= 12 ? 'var(--color-success)' : 'var(--color-danger)'}">${checkedItems}/15</div><div class="kpi-label">Deal Ready Items</div></div>
  `;

  // Phase bars
  let barsHtml = '';
  PHASES.forEach((phase, idx) => {
    const pbs = PLAYBOOKS.filter(p => p.phase === phase.id);
    const done = pbs.filter(p => state.playbookStatus[p.num] === 'complete').length;
    const pct = pbs.length > 0 ? Math.round((done / pbs.length) * 100) : 0;
    barsHtml += `<div class="bar-row">
      <div class="bar-label">${phase.name.split('&')[0].trim()}</div>
      <div class="bar-track">
        <div class="bar-fill" data-width="${pct}" data-delay="${idx * 100}" style="width:0%;background:${phase.color}">
          <span class="bar-value">${done}/${pbs.length}</span>
        </div>
      </div>
    </div>`;
  });
  document.getElementById('dashPhaseBars').innerHTML = barsHtml;
  setTimeout(() => {
    document.querySelectorAll('#dashPhaseBars .bar-fill').forEach(el => {
      setTimeout(() => { el.style.width = el.dataset.width + '%'; }, parseInt(el.dataset.delay) || 0);
    });
  }, 100);

  // Progress ring
  const pct = Math.round((completed / 44) * 100);
  const radius = 60, circ = 2 * Math.PI * radius;
  const offset = circ - (pct / 100) * circ;
  document.getElementById('dashRing').innerHTML = `
    <div class="progress-ring-wrap" style="width:150px;height:150px">
      <svg width="150" height="150" viewBox="0 0 150 150">
        <circle cx="75" cy="75" r="${radius}" fill="none" stroke="var(--color-surface-alt)" stroke-width="10"/>
        <circle cx="75" cy="75" r="${radius}" fill="none" stroke="var(--color-primary)" stroke-width="10"
          stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round"
          transform="rotate(-90 75 75)" style="transition:stroke-dashoffset 1s ease"/>
      </svg>
      <div class="progress-ring-text">
        <div class="progress-ring-value" style="font-size:32px;color:var(--color-primary)">${pct}%</div>
        <div class="progress-ring-label">Complete</div>
      </div>
    </div>
  `;

  // Countdown
  if (months > 0) {
    const years = Math.floor(months / 12);
    const mo = months % 12;
    document.getElementById('dashCountdown').innerHTML = `
      <div style="font-family:var(--font-display);font-size:48px;font-weight:700;color:${months < 12 ? 'var(--color-danger)' : 'var(--color-primary)'}">${years > 0 ? years + 'y ' : ''}${mo}m</div>
      <div class="t-small t-secondary" style="margin-top:4px">until target close: ${new Date(state.exitDate + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</div>
      <div class="t-caption t-tertiary" style="margin-top:var(--space-md)">${months < 18 ? 'Accelerated timeline -- prioritize critical path items' : months < 30 ? 'Good timeline -- stay on schedule' : 'Ample time -- build a strong foundation'}</div>
    `;
  } else {
    document.getElementById('dashCountdown').innerHTML = '<div class="t-h2" style="color:var(--color-success)">Target date reached</div>';
  }

  // Recommendations
  const recs = [];
  const bottlenecks = findBottlenecks();
  if (bottlenecks.length > 0) {
    recs.push({ type: 'danger', text: `Your top bottleneck is #${bottlenecks[0].num} (${bottlenecks[0].title}), blocking ${bottlenecks[0].blocking.length} downstream playbooks. Resolve this first.` });
  }
  if (completed === 0 && inProgress === 0) {
    recs.push({ type: 'accent', text: 'You have not started any playbooks yet. Begin with #1 (Exit Readiness Assessment) -- it is the foundation for everything else.' });
  }
  const criticalNotStarted = PLAYBOOKS.filter(p => p.priority === 'Critical' && !state.playbookStatus[p.num]);
  if (criticalNotStarted.length > 0 && completed > 0) {
    recs.push({ type: 'warning', text: `${criticalNotStarted.length} critical playbooks have not been started. Next priority: #${criticalNotStarted[0].num} (${criticalNotStarted[0].title}).` });
  }
  if (checkedItems < 8 && months < 18) {
    recs.push({ type: 'danger', text: `Only ${checkedItems} of 15 deal readiness items are checked, with ${months} months remaining. You may not be ready for go-to-market on schedule.` });
  }
  if (completed >= 30) {
    recs.push({ type: 'info', text: 'Excellent progress. You are in the top tier of exit preparedness. Focus on the remaining items and maintain momentum through close.' });
  }
  if (recs.length === 0) {
    recs.push({ type: 'info', text: 'Complete more sections to receive personalized recommendations.' });
  }

  const typeMap = { danger: 'callout-danger', warning: 'callout-warning', info: 'callout-info', accent: 'callout-accent' };
  document.getElementById('dashRecs').innerHTML = recs.map(r => `<div class="callout ${typeMap[r.type]} mb-md">${r.text}</div>`).join('');
}

/* ============================================================
   UTILITIES
   ============================================================ */
function getScoreColor(val) {
  if (val >= 4.5) return 'var(--color-score-5)';
  if (val >= 3.5) return 'var(--color-score-4)';
  if (val >= 2.5) return 'var(--color-score-3)';
  if (val >= 1.5) return 'var(--color-score-2)';
  return 'var(--color-score-1)';
}

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'exit-timeline-' + new Date().toISOString().split('T')[0] + '.json';
  a.click(); URL.revokeObjectURL(url);
  showToast('Data exported successfully.');
}

/* ============================================================
   STATE MIGRATION
   ============================================================ */
(function migrateStorageKey() {
  const OLD_KEY = 'playbook43_exit_timeline_v2';
  const NEW_KEY = 'exitosx-pb43-exit-timeline';
  if (OLD_KEY === STORAGE_KEY) return;
  try {
    const old = localStorage.getItem(OLD_KEY);
    if (old && !localStorage.getItem(NEW_KEY)) {
      localStorage.setItem(NEW_KEY, old);
      localStorage.removeItem(OLD_KEY);
    }
  } catch(e) {}
})();

/* ============================================================
   TEXT EXPORT
   ============================================================ */
function exportReport() {
  const lines = ['EXIT TIMELINE & MILESTONE TRACKER', '='.repeat(40), ''];
  lines.push('Exit Date: ' + (state.exitDate || 'Not set'));
  lines.push('');

  if (state.readinessScores && Object.keys(state.readinessScores).length) {
    lines.push('READINESS SCORES', '-'.repeat(30));
    Object.entries(state.readinessScores).forEach(([k, v]) => {
      lines.push('  ' + k + ': ' + v + '/5');
    });
    lines.push('');
  }

  if (state.phases && Object.keys(state.phases).length) {
    lines.push('PHASE STATUS', '-'.repeat(30));
    Object.entries(state.phases).forEach(([k, v]) => {
      lines.push('  ' + k + ': ' + v);
    });
    lines.push('');
  }

  if (state.milestones && Object.keys(state.milestones).length) {
    lines.push('MILESTONES', '-'.repeat(30));
    Object.entries(state.milestones).forEach(([k, v]) => {
      lines.push('  ' + k + ': ' + (v ? 'Complete' : 'Incomplete'));
    });
    lines.push('');
  }

  if (state.playbookStatus && Object.keys(state.playbookStatus).length) {
    lines.push('PLAYBOOK STATUS', '-'.repeat(30));
    Object.entries(state.playbookStatus).forEach(([k, v]) => {
      lines.push('  ' + k + ': ' + v);
    });
    lines.push('');
  }

  if (state.dealChecklist && Object.keys(state.dealChecklist).length) {
    lines.push('DEAL CHECKLIST', '-'.repeat(30));
    Object.entries(state.dealChecklist).forEach(([k, v]) => {
      lines.push('  ' + k + ': ' + (v ? 'Done' : 'Pending'));
    });
    lines.push('');
  }

  if (state.quarterlyNotes && Object.keys(state.quarterlyNotes).length) {
    lines.push('QUARTERLY NOTES', '-'.repeat(30));
    Object.entries(state.quarterlyNotes).forEach(([k, v]) => {
      if (v) lines.push('  ' + k + ': ' + v);
    });
    lines.push('');
  }

  if (state.bottleneckNotes && Object.keys(state.bottleneckNotes).length) {
    lines.push('BOTTLENECK NOTES', '-'.repeat(30));
    Object.entries(state.bottleneckNotes).forEach(([k, v]) => {
      if (v) lines.push('  ' + k + ': ' + v);
    });
    lines.push('');
  }

  lines.push('', 'Generated: ' + new Date().toLocaleString());
  const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'exit-timeline-report-' + new Date().toISOString().split('T')[0] + '.txt';
  a.click(); URL.revokeObjectURL(url);
  showToast('Report exported successfully.');
}

/* ============================================================
   INITIALIZATION
   ============================================================ */
function init() {
  loadData();
  state.pagesUnlocked.forEach(p => unlockPage(p));
  state.pagesCompleted.forEach(p => {
    const item = document.querySelector(`.nav-item[data-page="${p}"]`);
    if (item) item.classList.add('completed');
  });

  if (state.exitDate) {
    const input = document.getElementById('exitDate');
    if (input) input.value = state.exitDate;
    renderHorizons();
    document.getElementById('timelineCalc').style.display = 'block';
    document.getElementById('setupNext').disabled = false;
  }

  if (state.currentPage && state.pagesUnlocked.includes(state.currentPage)) {
    goToPage(state.currentPage);
  }
  updateProgress();

  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); item.click(); }
    });
  });
  document.addEventListener('keydown', e => {
    if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('check-item')) {
      e.preventDefault(); e.target.click();
    }
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('embedded') === 'true') {
    // Hide playbook's own chrome
    var sidebar = document.querySelector('.sidebar');
    var overlay = document.querySelector('.sidebar-overlay');
    var mobileHeader = document.querySelector('.mobile-header');
    var mainContent = document.querySelector('.main-content');
    if (sidebar) sidebar.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    if (mobileHeader) mobileHeader.style.display = 'none';
    if (mainContent) {
      mainContent.style.marginLeft = '0';
      mainContent.style.minHeight = 'auto';
    }

    // Navigate to specific section if requested
    var section = params.get('section');
    if (section !== null) {
      var sectionIndex = parseInt(section, 10);
      if (typeof navigateToSection === 'function') {
        setTimeout(function() { navigateToSection(sectionIndex); }, 100);
      }
    }

    // Forward score updates to parent
    var origDispatch = window.dispatchEvent.bind(window);
    window.addEventListener('playbook:score-update', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:score-update',
          detail: e.detail
        }, '*');
      }
    });

    // Forward section changes to parent
    window.addEventListener('playbook:section-change', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:section-change',
          detail: e.detail
        }, '*');
      }
    });

    // Listen for commands from parent
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'navigate-section') {
        if (typeof navigateToSection === 'function') {
          navigateToSection(e.data.sectionIndex);
        }
      }
    });
  }
})();
</script>
</body>
</html>
