<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Environmental & Insurance Review | Exit Planning Playbook #24</title>
<style>
:root {
  --color-bg: #F5F5F7;
  --color-surface: #FFFFFF;
  --color-surface-alt: #F2F2F7;
  --color-border: #E5E7EB;
  --color-border-light: #F2F2F7;
  --color-text: #1D1D1F;
  --color-text-secondary: #6E6E73;
  --color-text-tertiary: #8E8E93;
  --color-primary: #0071E3;
  --color-primary-light: #E8F4EC;
  --color-primary-hover: #0051B3;
  --color-accent: #FF9500;
  --color-accent-light: #FFF6E8;
  --color-danger: #FF3B30;
  --color-danger-light: #FFEBEA;
  --color-warning: #C67F20;
  --color-warning-light: #FFF8EB;
  --color-success: #34C759;
  --color-success-light: #E8F8ED;
  --color-score-1: #FF3B30;
  --color-score-2: #FF9500;
  --color-score-3: #FFCC00;
  --color-score-4: #34C759;
  --color-score-5: #30D158;
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.1);
  --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', sans-serif;
  --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', sans-serif;
  --transition-fast: 150ms ease;
  --transition-normal: 250ms ease;
  --transition-slow: 400ms cubic-bezier(0.16, 1, 0.3, 1);
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
  --space-3xl: 64px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body { font-family: var(--font-body); font-size: 16px; line-height: 1.6; color: var(--color-text); background: var(--color-bg); -webkit-font-smoothing: antialiased; min-height: 100vh; }
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea, select { font-family: inherit; font-size: inherit; }
a.skip-link { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; z-index: 1000; }
a.skip-link:focus { position: fixed; top: 10px; left: 10px; width: auto; height: auto; padding: 12px 20px; background: var(--color-primary); color: #fff; border-radius: var(--radius-sm); font-weight: 600; z-index: 1000; }
.t-display { font-family: var(--font-display); font-size: clamp(26px, 4vw, 38px); font-weight: 700; line-height: 1.2; letter-spacing: -0.02em; }
.t-h1 { font-family: var(--font-display); font-size: clamp(22px, 3vw, 30px); font-weight: 700; line-height: 1.25; }
.t-h2 { font-size: 20px; font-weight: 600; line-height: 1.3; }
.t-h3 { font-size: 16px; font-weight: 600; line-height: 1.4; }
.t-body { font-size: 16px; line-height: 1.6; }
.t-small { font-size: 14px; line-height: 1.5; }
.t-caption { font-size: 12px; line-height: 1.4; letter-spacing: 0.02em; }
.t-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); }
.t-secondary { color: var(--color-text-secondary); }
.app { display: flex; min-height: 100vh; }
.sidebar { width: 260px; min-width: 260px; background: #FFFFFF; border-right: 1px solid var(--color-border); color: var(--color-text); padding: var(--space-lg); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; transition: transform var(--transition-slow); overflow-y: auto; }
.main-content { flex: 1; margin-left: 260px; min-height: 100vh; }
.content-area { max-width: 800px; margin: 0 auto; padding: var(--space-2xl) var(--space-lg); }
.mobile-header { display: none; position: sticky; top: 0; z-index: 90; background: var(--color-surface); border-bottom: 1px solid var(--color-border); padding: var(--space-md) var(--space-lg); align-items: center; gap: var(--space-md); }
.hamburger { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); }
.hamburger:hover { background: var(--color-surface-alt); }
.hamburger span { display: block; width: 18px; height: 2px; background: var(--color-text); position: relative; }
.hamburger span::before, .hamburger span::after { content: ''; position: absolute; width: 18px; height: 2px; background: var(--color-text); left: 0; }
.hamburger span::before { top: -6px; }
.hamburger span::after { top: 6px; }
.sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 99; }
@media (max-width: 900px) {
  .sidebar { transform: translateX(-260px); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.show { display: block; }
  .main-content { margin-left: 0 !important; }
  .mobile-header { display: flex; }
  .content-area { padding: var(--space-lg) var(--space-md); }
}
.sidebar-brand { margin-bottom: var(--space-xl); }
.sidebar-brand-label { font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-xs); }
.sidebar-brand-title { font-family: var(--font-display); font-size: 18px; font-weight: 700; color: var(--color-text); line-height: 1.3; }
.sidebar-progress { margin-bottom: var(--space-xl); padding: var(--space-md); background: var(--color-surface-alt); border-radius: var(--radius-md); }
.sidebar-progress-label { font-size: 12px; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-progress-bar { height: 4px; background: var(--color-border); border-radius: 2px; overflow: hidden; }
.sidebar-progress-fill { height: 100%; background: var(--color-accent); border-radius: 2px; transition: width var(--transition-slow); }
.sidebar-progress-text { font-size: 12px; color: var(--color-text-tertiary); margin-top: var(--space-sm); text-align: right; }
.sidebar-nav { flex: 1; display: flex; flex-direction: column; gap: 2px; }
.nav-section-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-tertiary); padding: var(--space-md) var(--space-sm) var(--space-xs); }
.nav-item { display: flex; align-items: center; gap: var(--space-md); padding: 10px 12px; border-radius: var(--radius-sm); color: var(--color-text-secondary); font-size: 14px; transition: all var(--transition-fast); cursor: pointer; position: relative; }
.nav-item:hover { background: var(--color-surface-alt); color: var(--color-text); }
.nav-item.active { background: var(--color-primary-light); color: var(--color-primary); font-weight: 500; border-left: 3px solid var(--color-primary); }
.nav-item.completed .nav-check { display: flex; }
.nav-item.locked { opacity: 0.4; cursor: default; }
.nav-item.locked:hover { background: none; color: var(--color-text-tertiary); }
.nav-icon { width: 20px; text-align: center; flex-shrink: 0; font-size: 14px; }
.nav-check { display: none; width: 16px; height: 16px; background: var(--color-success); border-radius: 50%; align-items: center; justify-content: center; margin-left: auto; flex-shrink: 0; }
.nav-check svg { width: 10px; height: 10px; stroke: #fff; stroke-width: 2.5; fill: none; }
.sidebar-score { margin-top: auto; padding-top: var(--space-lg); border-top: 1px solid var(--color-border); }
.sidebar-score-label { font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-score-value { font-family: var(--font-display); font-size: 36px; font-weight: 700; color: #fff; line-height: 1; }
.sidebar-score-max { font-size: 18px; color: var(--color-text-tertiary); font-weight: 400; }
.sidebar-score-desc { font-size: 12px; color: var(--color-text-secondary); margin-top: var(--space-xs); }
.sidebar-footer { margin-top: var(--space-lg); padding-top: var(--space-md); border-top: 1px solid var(--color-border); font-size: 12px; color: rgba(255,255,255,0.3); display: flex; align-items: center; gap: 6px; }
.sidebar-footer-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--color-success); }
.card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--space-lg); transition: box-shadow var(--transition-normal); margin-bottom: var(--space-md); }
.card:hover { box-shadow: var(--shadow-sm); }
.callout { padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); border-left: 3px solid; font-size: 14px; line-height: 1.6; margin-bottom: var(--space-md); }
.callout-info { background: var(--color-primary-light); border-color: var(--color-primary); color: var(--color-primary); }
.callout-warning { background: var(--color-warning-light); border-color: var(--color-warning); color: #7C5500; }
.callout-danger { background: var(--color-danger-light); border-color: var(--color-danger); color: var(--color-danger); }
.callout-accent { background: var(--color-accent-light); border-color: var(--color-accent); color: #7C5500; }
.btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); padding: 10px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500; transition: all var(--transition-fast); white-space: nowrap; }
.btn-primary { background: var(--color-primary); color: #fff; }
.btn-primary:hover { background: var(--color-primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.btn-secondary { background: var(--color-surface); color: var(--color-text); border: 1px solid var(--color-border); }
.btn-secondary:hover { background: var(--color-surface-alt); }
.btn-ghost { color: var(--color-text-secondary); padding: 8px 12px; }
.btn-ghost:hover { background: var(--color-surface-alt); color: var(--color-text); }
.btn-accent { background: var(--color-accent); color: #fff; }
.btn-accent:hover { background: #E68600; }
.btn-lg { padding: 14px 28px; font-size: 16px; border-radius: var(--radius-md); }
.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
.badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 999px; font-size: 12px; font-weight: 500; }
.badge-success { background: var(--color-success-light); color: var(--color-success); }
.badge-warning { background: var(--color-warning-light); color: var(--color-warning); }
.badge-danger { background: var(--color-danger-light); color: var(--color-danger); }
.badge-neutral { background: var(--color-surface-alt); color: var(--color-text-secondary); }
.badge-primary { background: var(--color-primary-light); color: var(--color-primary); }
.form-group { margin-bottom: var(--space-lg); }
.form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: var(--space-sm); }
.form-hint { font-size: 13px; color: var(--color-text-tertiary); margin-top: var(--space-xs); }
.form-input { width: 100%; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 15px; background: var(--color-surface); transition: all var(--transition-fast); color: var(--color-text); }
.form-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light); }
textarea.form-input { min-height: 80px; resize: vertical; line-height: 1.5; }
select.form-input { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%236E6E73' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }
.score-selector { display: flex; gap: var(--space-sm); }
.score-option { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 12px 8px; border: 2px solid var(--color-border); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); text-align: center; }
.score-option:hover { border-color: var(--color-text-tertiary); background: var(--color-surface-alt); }
.score-option.selected { border-color: var(--color-primary); background: var(--color-primary-light); }
.score-option input[type="radio"] { position: absolute; opacity: 0; width: 0; height: 0; }
.score-number { font-size: 22px; font-weight: 700; line-height: 1; }
.score-label-text { font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.04em; color: var(--color-text-secondary); line-height: 1.2; }
.score-option.s1 .score-number { color: var(--color-score-1); }
.score-option.s2 .score-number { color: var(--color-score-2); }
.score-option.s3 .score-number { color: var(--color-score-3); }
.score-option.s4 .score-number { color: var(--color-score-4); }
.score-option.s5 .score-number { color: var(--color-score-5); }
.score-option.selected.s1 { border-color: var(--color-score-1); background: #FFF5F5; }
.score-option.selected.s2 { border-color: var(--color-score-2); background: #FFFBEB; }
.score-option.selected.s3 { border-color: var(--color-score-3); background: #FFF8EB; }
.score-option.selected.s4 { border-color: var(--color-score-4); background: #E8F8EE; }
.score-option.selected.s5 { border-color: var(--color-score-5); background: #E0F5E8; }
@media (max-width: 600px) { .score-selector { gap: 4px; } .score-option { padding: 10px 4px; } .score-number { font-size: 18px; } .score-label-text { font-size: 9px; } }
.checklist { display: flex; flex-direction: column; gap: 2px; }
.check-item { display: flex; align-items: flex-start; gap: var(--space-md); padding: var(--space-md); border-radius: var(--radius-sm); cursor: pointer; transition: background var(--transition-fast); }
.check-item:hover { background: var(--color-surface-alt); }
.check-box { width: 22px; height: 22px; border: 2px solid var(--color-border); border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all var(--transition-fast); margin-top: 1px; }
.check-item.checked .check-box { background: var(--color-primary); border-color: var(--color-primary); }
.check-item.checked .check-box svg { opacity: 1; }
.check-box svg { width: 14px; height: 14px; stroke: #fff; stroke-width: 2.5; fill: none; opacity: 0; }
.check-text { font-size: 14px; line-height: 1.5; }
.check-item.checked .check-text { color: var(--color-text-tertiary); text-decoration: line-through; }
.page { display: none; animation: fadeIn 0.3s ease; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.page-header { margin-bottom: var(--space-2xl); }
.page-header .t-label { margin-bottom: var(--space-sm); }
.page-header .t-display { margin-bottom: var(--space-md); }
.page-header .t-body { color: var(--color-text-secondary); max-width: 600px; }
.page-nav { display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-2xl); padding-top: var(--space-xl); border-top: 1px solid var(--color-border); }
.welcome-hero { text-align: center; padding: var(--space-3xl) var(--space-lg); max-width: 640px; margin: 0 auto; }
.welcome-icon { width: 72px; height: 72px; background: var(--color-primary-light); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-lg); font-size: 32px; }
.welcome-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin: var(--space-2xl) 0; text-align: center; }
.welcome-stat { padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); }
.welcome-stat-value { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--color-primary); }
.welcome-stat-label { font-size: 13px; color: var(--color-text-secondary); margin-top: 4px; }
@media (max-width: 600px) { .welcome-stats { grid-template-columns: 1fr; } .welcome-hero { padding: var(--space-2xl) var(--space-md); } }
.summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg); }
.summary-item { padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); text-align: center; }
.summary-item-value { font-family: var(--font-display); font-size: 28px; font-weight: 700; }
.summary-item-label { font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.04em; margin-top: var(--space-xs); }
.bar-chart { display: flex; flex-direction: column; gap: var(--space-md); }
.bar-row { display: flex; align-items: center; gap: var(--space-md); }
.bar-label { width: 140px; flex-shrink: 0; font-size: 13px; color: var(--color-text-secondary); text-align: right; }
.bar-track { flex: 1; height: 24px; background: var(--color-surface-alt); border-radius: 4px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; }
.bar-value { font-size: 12px; font-weight: 600; color: #fff; }
@media (max-width: 600px) { .bar-label { width: 90px; font-size: 11px; } }
.data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; margin-bottom: var(--space-md); }
.data-table th { text-align: left; padding: var(--space-sm) var(--space-md); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-tertiary); border-bottom: 2px solid var(--color-border); }
.data-table td { padding: var(--space-sm) var(--space-md); border-bottom: 1px solid var(--color-border-light); vertical-align: top; }
.data-table tr:last-child td { border-bottom: none; }
.data-table input, .data-table select { width: 100%; padding: 6px 10px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 13px; font-family: inherit; background: var(--color-surface); }
.data-table input:focus, .data-table select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px var(--color-primary-light); }
.gauge-wrap { display: flex; justify-content: center; margin: var(--space-lg) 0; }
.gauge-ring { position: relative; width: 160px; height: 160px; }
.gauge-ring svg { width: 160px; height: 160px; transform: rotate(-90deg); }
.gauge-ring circle { fill: none; stroke-width: 8; stroke-linecap: round; }
.gauge-bg { stroke: var(--color-border); }
.gauge-fill { transition: stroke-dashoffset 1s ease; }
.gauge-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.gauge-center-value { font-family: var(--font-display); font-size: 36px; font-weight: 700; line-height: 1; }
.gauge-center-label { font-size: 12px; color: var(--color-text-tertiary); margin-top: 4px; }
.add-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 14px; border: 2px dashed var(--color-border); border-radius: var(--radius-md); background: transparent; cursor: pointer; font-size: 14px; color: var(--color-text-tertiary); font-weight: 500; transition: all var(--transition-fast); font-family: inherit; margin-bottom: var(--space-md); }
.add-btn:hover { border-color: var(--color-primary); color: var(--color-primary); background: var(--color-primary-light); }
.risk-badge { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; }
.risk-low { background: var(--color-success-light); color: var(--color-success); }
.risk-moderate { background: #FEF3C7; color: #92400E; }
.risk-high { background: #FEE2E2; color: #991B1B; }
.risk-very-high { background: #C53030; color: #fff; }
@media print {
  .sidebar, .mobile-header, .page-nav, .sidebar-overlay { display: none !important; }
  .main-content { margin-left: 0 !important; }
  .page { display: block !important; page-break-inside: avoid; margin-bottom: 24px; }
}
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
}
:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 2px; }
</style>
</head>
<body>
<a href="#contentArea" class="skip-link">Skip to content</a>
<div class="app">
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Playbook navigation">
    <div class="sidebar-brand">
      <div class="sidebar-brand-label">Exit Planning Playbook #24</div>
      <div class="sidebar-brand-title">Environmental & Insurance Review</div>
    </div>
    <div class="sidebar-progress">
      <div class="sidebar-progress-label">Your Progress</div>
      <div class="sidebar-progress-bar"><div class="sidebar-progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="sidebar-progress-text" id="progressText">0% complete</div>
    </div>
    <nav class="sidebar-nav" id="sidebarNav"></nav>
    <div class="sidebar-score">
      <div class="sidebar-score-label">Readiness Score</div>
      <div class="sidebar-score-value" id="sidebarScore">--<span class="sidebar-score-max">/100</span></div>
      <div class="sidebar-score-desc" id="sidebarScoreDesc">Complete sections to build your score</div>
    </div>
    <div class="sidebar-footer"><div class="sidebar-footer-dot"></div>Auto-saved locally</div>
  </aside>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <div class="main-content">
    <div class="mobile-header">
      <button class="hamburger" id="hamburgerBtn" aria-label="Toggle navigation"><span></span></button>
      <div style="flex:1"><strong style="font-size:15px;">Env & Insurance</strong></div>
      <div class="badge badge-primary" id="mobileScore">--/100</div>
    </div>
    <main class="content-area" id="contentArea" role="main"></main>
  </div>
</div>

<script>
(function() {
'use strict';

var STORAGE_KEY = 'exitosx-pb24-environmental-insurance';

var PAGES = [
  { id: 'welcome', title: 'Welcome', phase: 'START', icon: '1' },
  { id: 'why-it-matters', title: 'Why It Matters', phase: 'UNDERSTAND', icon: '2' },
  { id: 'env-assessment', title: 'Environmental Assessment', phase: 'ASSESS', icon: '3' },
  { id: 'phase-assessments', title: 'Phase I & Phase II ESAs', phase: 'ASSESS', icon: '4' },
  { id: 'insurance-review', title: 'Insurance Coverage Review', phase: 'ASSESS', icon: '5' },
  { id: 'specialty-insurance', title: 'Specialty Insurance', phase: 'STRATEGY', icon: '6' },
  { id: 'claims-resolution', title: 'Claims Resolution', phase: 'STRATEGY', icon: '7' },
  { id: 'tail-coverage', title: 'Tail Coverage Planning', phase: 'STRATEGY', icon: '8' },
  { id: 'mistakes', title: 'Common Mistakes', phase: 'PLAN', icon: '9' },
  { id: 'dashboard', title: 'Dashboard', phase: 'RESULTS', icon: '10' }
];

function defaultState() {
  return {
    currentPage: 'welcome',
    completed: {},
    // Environmental screening checklist (12 items)
    envChecklist: {},
    envRiskLevel: 0, // 1-5 overall risk
    businessType: '',
    // Phase assessment status
    phaseIStatus: '', // none, ordered, completed, clean, recs-found
    phaseIINeeded: '', // yes, no, unsure
    phaseIIStatus: '', // none, ordered, completed
    remediationNeeded: '', // yes, no, unsure
    remediationEstimate: '',
    // Insurance policies (add/remove)
    policies: [
      { type: 'General Liability', carrier: '', limits: '', expiration: '', claimsMade: '', tailNeeded: '' }
    ],
    // Insurance scores (1-5)
    insuranceScores: { coverage: 0, limits: 0, claims: 0, carrier: 0, cyber: 0 },
    // Specialty insurance awareness
    rwiAware: '', // yes, no
    rwiPursuing: '', // yes, no, na
    envInsurance: '', // yes, no, na
    // Claims register (add/remove)
    claims: [],
    // Tail coverage planning
    tailPlans: [
      { policy: 'D&O', premium: '', period: '', cost: '', whoPays: '', status: '' },
      { policy: 'E&O', premium: '', period: '', cost: '', whoPays: '', status: '' },
      { policy: 'EPLI', premium: '', period: '', cost: '', whoPays: '', status: '' },
      { policy: 'Cyber', premium: '', period: '', cost: '', whoPays: '', status: '' }
    ],
    // Mistakes
    mistakeFlags: {},
    notes: {}
  };
}

var state = loadState();

function loadState() {
  try { var s = localStorage.getItem(STORAGE_KEY); return s ? Object.assign(defaultState(), JSON.parse(s)) : defaultState(); }
  catch(e) { return defaultState(); }
}

function saveState() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {}
  updateProgress();
  updateScore();
}

function calcScore() {
  var score = 0;
  // Environmental checklist completion (0-15)
  var checkCount = Object.keys(state.envChecklist).filter(function(k) { return state.envChecklist[k]; }).length;
  score += Math.round((checkCount / 12) * 15);
  // Environmental risk assessed (0-10)
  if (state.envRiskLevel > 0) score += 10;
  // Phase I status (0-15)
  if (state.phaseIStatus === 'clean') score += 15;
  else if (state.phaseIStatus === 'completed' || state.phaseIStatus === 'recs-found') score += 10;
  else if (state.phaseIStatus === 'ordered') score += 5;
  // Insurance scores (0-25, 5 dims at 5 each)
  var insVals = Object.values(state.insuranceScores);
  insVals.forEach(function(v) { score += v; });
  // Tail coverage planning (0-20)
  var tailDone = state.tailPlans.filter(function(t) { return t.status === 'secured' || t.status === 'ordered'; }).length;
  score += tailDone * 5;
  // Claims resolved or no claims (0-10)
  if (state.claims.length === 0) score += 10;
  else {
    var resolved = state.claims.filter(function(c) { return c.status === 'Closed'; }).length;
    score += Math.round((resolved / state.claims.length) * 10);
  }
  // Mistake awareness (0-5)
  var flagCount = Object.keys(state.mistakeFlags).filter(function(k) { return state.mistakeFlags[k]; }).length;
  score += Math.min(flagCount, 5);
  return Math.min(Math.round(score), 100);
}

function getScoreColor(s) {
  if (s >= 81) return 'var(--color-score-5)';
  if (s >= 61) return 'var(--color-score-4)';
  if (s >= 41) return 'var(--color-score-3)';
  if (s >= 21) return 'var(--color-score-2)';
  return 'var(--color-score-1)';
}

function getScoreLabel(s) {
  if (s >= 81) return 'Strong readiness -- well protected';
  if (s >= 61) return 'Good foundation, gaps to address';
  if (s >= 41) return 'Moderate -- several areas need attention';
  if (s >= 21) return 'Significant gaps in coverage';
  return 'Complete sections to build your score';
}

function updateScore() {
  var score = calcScore();
  document.getElementById('sidebarScore').innerHTML = score + '<span class="sidebar-score-max">/100</span>';
  document.getElementById('mobileScore').textContent = score + '/100';
  document.getElementById('sidebarScoreDesc').textContent = getScoreLabel(score);
}

function updateProgress() {
  var total = PAGES.length - 2;
  var done = Object.keys(state.completed).length;
  var pct = Math.round((done / total) * 100);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = pct + '% complete';
}

function isUnlocked(pageId) {
  var idx = PAGES.findIndex(function(p) { return p.id === pageId; });
  if (idx <= 0) return true;
  return state.completed[PAGES[idx - 1].id] === true;
}

function renderNav() {
  var nav = document.getElementById('sidebarNav');
  var html = '';
  var lastPhase = '';
  PAGES.forEach(function(p) {
    if (p.phase !== lastPhase) {
      html += '<div class="nav-section-label">' + p.phase + '</div>';
      lastPhase = p.phase;
    }
    var isActive = state.currentPage === p.id;
    var isDone = state.completed[p.id];
    var locked = !isUnlocked(p.id);
    html += '<div class="nav-item' + (isActive ? ' active' : '') + (isDone ? ' completed' : '') + (locked ? ' locked' : '') + '" data-page="' + p.id + '" role="button" tabindex="' + (locked ? '-1' : '0') + '" aria-current="' + (isActive ? 'step' : 'false') + '">';
    html += '<span class="nav-icon">' + p.icon + '</span>';
    html += '<span>' + p.title + '</span>';
    if (isDone) html += '<span class="nav-check"><svg viewBox="0 0 10 10"><polyline points="1.5 5 4 7.5 8.5 2.5"/></svg></span>';
    html += '</div>';
  });
  nav.innerHTML = html;
  nav.querySelectorAll('.nav-item:not(.locked)').forEach(function(el) {
    el.addEventListener('click', function() { goToPage(el.dataset.page); });
    el.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); goToPage(el.dataset.page); } });
  });
}

function goToPage(pageId) {
  if (!isUnlocked(pageId)) return;
  state.currentPage = pageId;
  saveState();
  renderPage();
  renderNav();
  window.scrollTo({ top: 0, behavior: 'smooth' });
  closeSidebar();
}

function completePage(pageId) {
  state.completed[pageId] = true;
  var idx = PAGES.findIndex(function(p) { return p.id === pageId; });
  if (idx < PAGES.length - 1) state.currentPage = PAGES[idx + 1].id;
  saveState();
  renderPage();
  renderNav();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function prevPage() {
  var idx = PAGES.findIndex(function(p) { return p.id === state.currentPage; });
  if (idx > 0) goToPage(PAGES[idx - 1].id);
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show');
}

document.getElementById('hamburgerBtn').addEventListener('click', toggleSidebar);
document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

function esc(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function pageNav(showPrev, nextLabel, currentId) {
  var html = '<div class="page-nav">';
  html += showPrev ? '<button class="btn btn-secondary" onclick="PB.prevPage()">&larr; Back</button>' : '<div></div>';
  if (nextLabel !== false) {
    html += '<button class="btn btn-primary" onclick="PB.completePage(\'' + currentId + '\')">' + (nextLabel || 'Continue') + ' &rarr;</button>';
  }
  html += '</div>';
  return html;
}

function scoreSelector(key, stateObj, stateKey, labels) {
  var current = stateObj[stateKey] || 0;
  var html = '<div class="score-selector" role="radiogroup" aria-label="Score for ' + key + '">';
  for (var i = 1; i <= 5; i++) {
    var sel = current === i ? ' selected' : '';
    html += '<label class="score-option s' + i + sel + '" onclick="PB.setScore(\'' + stateKey + '\',\'' + key + '\',' + i + ')" tabindex="0" role="radio" aria-checked="' + (current === i) + '"';
    html += ' onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();PB.setScore(\'' + stateKey + '\',\'' + key + '\',' + i + ');}">';
    html += '<input type="radio" name="score-' + key + '" value="' + i + '"' + (current === i ? ' checked' : '') + '>';
    html += '<span class="score-number">' + i + '</span>';
    html += '<span class="score-label-text">' + (labels ? labels[i-1] : ['Poor','Below Avg','Average','Good','Excellent'][i-1]) + '</span>';
    html += '</label>';
  }
  html += '</div>';
  return html;
}

function renderPage() {
  var area = document.getElementById('contentArea');
  var renderers = {
    'welcome': renderWelcome,
    'why-it-matters': renderWhyItMatters,
    'env-assessment': renderEnvAssessment,
    'phase-assessments': renderPhaseAssessments,
    'insurance-review': renderInsuranceReview,
    'specialty-insurance': renderSpecialtyInsurance,
    'claims-resolution': renderClaimsResolution,
    'tail-coverage': renderTailCoverage,
    'mistakes': renderMistakes,
    'dashboard': renderDashboard
  };
  var fn = renderers[state.currentPage];
  area.innerHTML = '<div class="page active">' + (fn ? fn() : '') + '</div>';
  bindInputs();
}

function bindInputs() {
  document.querySelectorAll('[data-bind]').forEach(function(el) {
    var keys = el.dataset.bind.split('.');
    var handler = function() {
      var obj = state;
      for (var i = 0; i < keys.length - 1; i++) {
        if (keys[i].match(/^\d+$/)) obj = obj[parseInt(keys[i])];
        else obj = obj[keys[i]];
      }
      obj[keys[keys.length - 1]] = el.value;
      saveState();
    };
    el.addEventListener('input', handler);
    el.addEventListener('change', handler);
  });
  document.querySelectorAll('.check-item[data-check]').forEach(function(el) {
    var handler = function() {
      var key = el.dataset.check;
      if (key.startsWith('env_')) {
        state.envChecklist[key] = !state.envChecklist[key];
      } else {
        state.mistakeFlags[key] = !state.mistakeFlags[key];
      }
      saveState();
      renderPage();
    };
    el.addEventListener('click', handler);
    el.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); } });
  });
}

// PAGE RENDERERS

function renderWelcome() {
  return '<div class="welcome-hero">' +
    '<div class="welcome-icon">&#9888;</div>' +
    '<div class="t-display">Environmental & Insurance Review</div>' +
    '<p class="t-body t-secondary" style="margin-top:var(--space-md)">Environmental liabilities can exceed your enterprise value. Insurance gaps can leave you exposed for years after closing. This playbook systematically identifies and addresses both.</p>' +
    '<div class="welcome-stats">' +
    '<div class="welcome-stat"><div class="welcome-stat-value">$2M+</div><div class="welcome-stat-label">Potential cleanup liability on contaminated property</div></div>' +
    '<div class="welcome-stat"><div class="welcome-stat-value">6yr</div><div class="welcome-stat-label">Recommended D&O tail coverage period</div></div>' +
    '<div class="welcome-stat"><div class="welcome-stat-value">10</div><div class="welcome-stat-label">Key insurance policies reviewed</div></div>' +
    '</div>' +
    '<div class="callout callout-danger" style="text-align:left"><strong>The Core Principle:</strong> Under CERCLA (the federal Superfund law), environmental liability follows the property and the polluter -- not the corporate structure. A buyer who acquires contaminated property can be held strictly liable for cleanup costs. This makes environmental issues a deal-structure, risk-allocation, and indemnification problem.</div>' +
    '</div>' +
    pageNav(false, 'Begin Review', 'welcome');
}

function renderWhyItMatters() {
  var riskTable = [
    { type: 'Manufacturing (heavy)', exposures: 'Soil/groundwater contamination, hazardous waste, air emissions', risk: 'Very High' },
    { type: 'Manufacturing (light)', exposures: 'Chemical storage, waste disposal, stormwater runoff', risk: 'High' },
    { type: 'Auto/fleet services', exposures: 'Underground storage tanks, used oil, solvents', risk: 'High' },
    { type: 'Real estate (commercial)', exposures: 'Asbestos, lead paint, mold, prior tenant contamination', risk: 'Moderate' },
    { type: 'Healthcare', exposures: 'Medical waste, pharmaceutical disposal, radiation safety', risk: 'Moderate' },
    { type: 'Professional services', exposures: 'Tenant liability for pre-existing building conditions', risk: 'Low' },
    { type: 'Technology / SaaS', exposures: 'E-waste disposal, data center cooling', risk: 'Low' },
    { type: 'Agriculture', exposures: 'Pesticide application, nutrient runoff, confined animal operations', risk: 'High' },
    { type: 'Dry cleaning', exposures: 'Perchloroethylene contamination; groundwater plumes', risk: 'Very High' }
  ];
  var html = '<div class="page-header"><div class="t-label">Understanding</div><div class="t-display">Why Environmental & Insurance Reviews Matter</div><p class="t-body t-secondary">Environmental and insurance issues impact transactions through direct liability, indirect liability, and deal mechanics.</p></div>';
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Environmental Risk by Business Type</div>';
  html += '<div class="form-group"><label class="form-label">Select your business type</label><select class="form-input" data-bind="businessType"><option value="">-- Select --</option>';
  riskTable.forEach(function(r) { html += '<option value="' + r.type + '"' + (state.businessType === r.type ? ' selected' : '') + '>' + r.type + '</option>'; });
  html += '</select></div>';
  html += '<table class="data-table"><thead><tr><th>Business Type</th><th>Typical Exposures</th><th>Risk Level</th></tr></thead><tbody>';
  riskTable.forEach(function(r) {
    var active = state.businessType === r.type;
    var riskClass = r.risk === 'Very High' ? 'risk-very-high' : r.risk === 'High' ? 'risk-high' : r.risk === 'Moderate' ? 'risk-moderate' : 'risk-low';
    html += '<tr style="' + (active ? 'background:var(--color-primary-light);font-weight:500' : '') + '"><td>' + r.type + '</td><td class="t-small">' + r.exposures + '</td><td><span class="risk-badge ' + riskClass + '">' + r.risk + '</span></td></tr>';
  });
  html += '</tbody></table></div>';
  html += '<div class="callout callout-info"><strong>Insurance as a deal enabler:</strong> Insurance protects the business through closing AND can be structured to allocate risk between buyer and seller post-close. Key M&A insurance products include RWI, D&O tail, environmental liability insurance, and transaction-specific policies.</div>';
  html += pageNav(true, 'Continue', 'why-it-matters');
  return html;
}

function renderEnvAssessment() {
  var items = [
    'Does the business own or lease real property?',
    'Has the property ever been used for manufacturing, chemical storage, or industrial purposes?',
    'Are there underground storage tanks (USTs) on the property -- active or abandoned?',
    'Does the business generate, store, transport, or dispose of hazardous waste?',
    'Does the business hold any environmental permits (air, water, waste)?',
    'Has the business ever received a notice of violation or enforcement action?',
    'Has the business ever been involved in an environmental cleanup or remediation?',
    'Are there known or suspected areas of soil or groundwater contamination?',
    'Does the business use or store chemicals listed on the EPA Toxics Release Inventory?',
    'Are there adjacent properties with known environmental contamination?',
    'Has a Phase I ESA ever been conducted on the property?',
    'Are there asbestos-containing materials, lead-based paint, or PCBs in the facility?'
  ];
  var html = '<div class="page-header"><div class="t-label">Assessment</div><div class="t-display">Environmental Liability Assessment</div><p class="t-body t-secondary">Before engaging environmental consultants, conduct this internal screening to identify potential areas of concern.</p></div>';
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Internal Environmental Screening Checklist</div><p class="t-small t-secondary" style="margin-bottom:var(--space-md)">Check each item that applies to your business. More checked items = higher environmental risk.</p>';
  html += '<div class="checklist">';
  items.forEach(function(item, i) {
    var key = 'env_' + i;
    var checked = state.envChecklist[key];
    html += '<div class="check-item' + (checked ? ' checked' : '') + '" data-check="' + key + '" role="checkbox" aria-checked="' + !!checked + '" tabindex="0">' +
      '<div class="check-box"><svg viewBox="0 0 14 14"><polyline points="2.5 7 5.5 10 11.5 4"/></svg></div>' +
      '<div class="check-text">' + item + '</div></div>';
  });
  html += '</div></div>';
  var yesCount = Object.keys(state.envChecklist).filter(function(k) { return state.envChecklist[k]; }).length;
  if (yesCount > 0) {
    var riskMsg = yesCount >= 6 ? 'High environmental risk exposure. A Phase I ESA is strongly recommended before going to market.' :
                  yesCount >= 3 ? 'Moderate risk. Review each flagged item with your attorney and consider a Phase I ESA.' :
                  'Lower risk profile. Still review flagged items with your deal team.';
    var riskCallout = yesCount >= 6 ? 'callout-danger' : yesCount >= 3 ? 'callout-warning' : 'callout-info';
    html += '<div class="callout ' + riskCallout + '"><strong>' + yesCount + ' of 12 risk indicators flagged.</strong> ' + riskMsg + '</div>';
  }
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Overall Environmental Risk Assessment</div>' +
    scoreSelector('envRisk', state, 'envRiskLevel', ['Minimal','Low','Moderate','High','Severe']) + '</div>';
  html += pageNav(true, 'Continue', 'env-assessment');
  return html;
}

function renderPhaseAssessments() {
  var html = '<div class="page-header"><div class="t-label">Assessment</div><div class="t-display">Phase I & Phase II Environmental Site Assessments</div><p class="t-body t-secondary">ESAs are the standard tool for evaluating environmental risk. Understanding scope, cost, and implications is essential.</p></div>';
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Phase I ESA (ASTM E1527-21)</div>' +
    '<p class="t-small t-secondary" style="margin-bottom:var(--space-md)">A non-invasive investigation: historical use analysis, regulatory records review, site inspection, and interviews. No sampling.</p>' +
    '<table class="data-table"><thead><tr><th>Metric</th><th>Typical Range</th></tr></thead><tbody>' +
    '<tr><td><strong>Cost</strong></td><td>$2,500 - $6,000 per property</td></tr>' +
    '<tr><td><strong>Timeline</strong></td><td>3-5 weeks</td></tr>' +
    '<tr><td><strong>Shelf Life</strong></td><td>180 days (ASTM standard)</td></tr>' +
    '<tr><td><strong>Who Orders</strong></td><td>Typically buyer; proactive seller may commission pre-market</td></tr>' +
    '</tbody></table>' +
    '<div class="form-group" style="margin-top:var(--space-md)"><label class="form-label">Your Phase I Status</label>' +
    '<select class="form-input" data-bind="phaseIStatus"><option value="">-- Select --</option>' +
    '<option value="none"' + (state.phaseIStatus === 'none' ? ' selected' : '') + '>Not yet ordered</option>' +
    '<option value="ordered"' + (state.phaseIStatus === 'ordered' ? ' selected' : '') + '>Ordered / In progress</option>' +
    '<option value="clean"' + (state.phaseIStatus === 'clean' ? ' selected' : '') + '>Completed -- Clean (no RECs found)</option>' +
    '<option value="recs-found"' + (state.phaseIStatus === 'recs-found' ? ' selected' : '') + '>Completed -- RECs identified</option>' +
    '</select></div></div>';

  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Phase II ESA (ASTM E1903-19)</div>' +
    '<p class="t-small t-secondary" style="margin-bottom:var(--space-md)">Invasive investigation triggered by Phase I findings: soil, groundwater, soil vapor sampling, asbestos/lead survey.</p>' +
    '<table class="data-table"><thead><tr><th>Component</th><th>Cost Range</th></tr></thead><tbody>' +
    '<tr><td>Soil Sampling</td><td>$5,000 - $25,000</td></tr>' +
    '<tr><td>Groundwater Sampling</td><td>$8,000 - $30,000</td></tr>' +
    '<tr><td>Soil Vapor Sampling</td><td>$5,000 - $15,000</td></tr>' +
    '<tr><td>Asbestos/Lead Survey</td><td>$2,000 - $10,000</td></tr>' +
    '<tr><td>UST Assessment</td><td>$5,000 - $25,000</td></tr>' +
    '<tr><td><strong>Full Phase II Report</strong></td><td><strong>$15,000 - $100,000+</strong></td></tr>' +
    '</tbody></table>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-md);margin-top:var(--space-md)">' +
    '<div class="form-group"><label class="form-label">Phase II Needed?</label>' +
    '<select class="form-input" data-bind="phaseIINeeded"><option value="">-- Select --</option><option value="yes"' + (state.phaseIINeeded === 'yes' ? ' selected' : '') + '>Yes</option><option value="no"' + (state.phaseIINeeded === 'no' ? ' selected' : '') + '>No</option><option value="unsure"' + (state.phaseIINeeded === 'unsure' ? ' selected' : '') + '>Unsure</option></select></div>' +
    '<div class="form-group"><label class="form-label">Remediation Estimate ($)</label>' +
    '<input class="form-input" type="text" placeholder="e.g., $50,000" value="' + esc(state.remediationEstimate) + '" data-bind="remediationEstimate"></div>' +
    '</div></div>';

  html += '<div class="callout callout-accent"><strong>Innocent Landowner Defense:</strong> Under CERCLA, a buyer can qualify for the "bona fide prospective purchaser" defense if they conducted "all appropriate inquiries" (Phase I ESA per ASTM E1527-21) before acquisition. This is why buyers almost always insist on a Phase I.</div>';
  html += pageNav(true, 'Continue', 'phase-assessments');
  return html;
}

function renderInsuranceReview() {
  var dims = [
    { key: 'coverage', label: 'Coverage Breadth', hint: 'Do you have all core policies? GL, property, E&O, D&O, EPLI, cyber, WC, umbrella?' },
    { key: 'limits', label: 'Limits Adequacy', hint: 'Are your limits at or above industry norms? ($1M/$2M GL minimum)' },
    { key: 'claims', label: 'Claims History', hint: 'Is your claims frequency low? EMR below 1.0?' },
    { key: 'carrier', label: 'Carrier Quality', hint: 'Are your carriers rated A- or better by AM Best?' },
    { key: 'cyber', label: 'Cyber Insurance', hint: 'Do you have cyber coverage adequate for your data exposure?' }
  ];
  var html = '<div class="page-header"><div class="t-label">Assessment</div><div class="t-display">Insurance Coverage Review</div><p class="t-body t-secondary">A comprehensive insurance review ensures you are protected through closing and demonstrates professional risk management to buyers.</p></div>';
  dims.forEach(function(d) {
    html += '<div class="card"><div class="form-label">' + d.label + '</div>' +
      '<div class="form-hint" style="margin-bottom:var(--space-sm)">' + d.hint + '</div>' +
      scoreSelector(d.key, state.insuranceScores, d.key, ['Critical Gaps','Below Standard','Adequate','Good','Best-in-Class']) +
      '</div>';
  });
  // Policy inventory
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Policy Inventory</div>';
  html += '<div style="overflow-x:auto"><table class="data-table"><thead><tr><th>Policy Type</th><th>Carrier</th><th>Limits</th><th>Expiration</th><th>Claims-Made?</th><th>Tail Needed?</th><th></th></tr></thead><tbody>';
  state.policies.forEach(function(p, i) {
    html += '<tr>';
    html += '<td><input class="form-input" type="text" value="' + esc(p.type) + '" data-bind="policies.' + i + '.type" placeholder="Policy type"></td>';
    html += '<td><input class="form-input" type="text" value="' + esc(p.carrier) + '" data-bind="policies.' + i + '.carrier" placeholder="Carrier"></td>';
    html += '<td><input class="form-input" type="text" value="' + esc(p.limits) + '" data-bind="policies.' + i + '.limits" placeholder="$1M/$2M"></td>';
    html += '<td><input class="form-input" type="date" value="' + esc(p.expiration) + '" data-bind="policies.' + i + '.expiration"></td>';
    html += '<td><select class="form-input" data-bind="policies.' + i + '.claimsMade"><option value="">--</option><option value="yes"' + (p.claimsMade === 'yes' ? ' selected' : '') + '>Yes</option><option value="no"' + (p.claimsMade === 'no' ? ' selected' : '') + '>No</option></select></td>';
    html += '<td><select class="form-input" data-bind="policies.' + i + '.tailNeeded"><option value="">--</option><option value="yes"' + (p.tailNeeded === 'yes' ? ' selected' : '') + '>Yes</option><option value="no"' + (p.tailNeeded === 'no' ? ' selected' : '') + '>No</option></select></td>';
    html += '<td>' + (state.policies.length > 1 ? '<button class="btn btn-ghost btn-sm" onclick="PB.removePolicy(' + i + ')" style="color:var(--color-danger)">Remove</button>' : '') + '</td>';
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  html += '<button class="add-btn" onclick="PB.addPolicy()">+ Add Policy</button></div>';
  html += pageNav(true, 'Continue', 'insurance-review');
  return html;
}

function renderSpecialtyInsurance() {
  var html = '<div class="page-header"><div class="t-label">Strategy</div><div class="t-display">Specialty Insurance for Transactions</div><p class="t-body t-secondary">Beyond standard business insurance, several specialty products are commonly used in M&A to allocate risk and facilitate closing.</p></div>';
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Representations & Warranties Insurance (RWI)</div>' +
    '<p class="t-small t-secondary" style="margin-bottom:var(--space-md)">RWI covers losses from breaches of seller reps and warranties. Standard in PE deals, increasingly common in lower middle market.</p>' +
    '<table class="data-table"><thead><tr><th>Feature</th><th>Buyer-Side Policy</th><th>Seller-Side Policy</th></tr></thead><tbody>' +
    '<tr><td><strong>Typical Premium</strong></td><td>2-4% of policy limit</td><td>2-3% of policy limit</td></tr>' +
    '<tr><td><strong>Typical Retention</strong></td><td>0.75-1.5% of enterprise value</td><td>Varies; often matches escrow</td></tr>' +
    '<tr><td><strong>Policy Period</strong></td><td>3 years general; 6 years fundamental</td><td>Matches survival period</td></tr>' +
    '<tr><td><strong>Min Deal Size</strong></td><td>$10M-$20M+</td><td>$20M+</td></tr>' +
    '<tr><td><strong>Common Exclusions</strong></td><td colspan="2">Known issues, environmental (unless endorsed), pension underfunding, transfer pricing</td></tr>' +
    '</tbody></table>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-md);margin-top:var(--space-md)">' +
    '<div class="form-group"><label class="form-label">Aware of RWI?</label><select class="form-input" data-bind="rwiAware"><option value="">--</option><option value="yes"' + (state.rwiAware === 'yes' ? ' selected' : '') + '>Yes</option><option value="no"' + (state.rwiAware === 'no' ? ' selected' : '') + '>No</option></select></div>' +
    '<div class="form-group"><label class="form-label">Plan to pursue RWI?</label><select class="form-input" data-bind="rwiPursuing"><option value="">--</option><option value="yes"' + (state.rwiPursuing === 'yes' ? ' selected' : '') + '>Yes</option><option value="no"' + (state.rwiPursuing === 'no' ? ' selected' : '') + '>No</option><option value="na"' + (state.rwiPursuing === 'na' ? ' selected' : '') + '>N/A (deal size too small)</option></select></div>' +
    '</div></div>';

  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Other Transaction Liability Policies</div>' +
    '<table class="data-table"><thead><tr><th>Policy Type</th><th>Use Case</th><th>Typical Cost</th></tr></thead><tbody>' +
    '<tr><td><strong>Environmental Liability</strong></td><td>Covers known and unknown environmental conditions</td><td>$15K-$100K+ (10-year policy)</td></tr>' +
    '<tr><td><strong>Tax Liability</strong></td><td>Covers adverse tax treatment risk</td><td>$25K-$100K+</td></tr>' +
    '<tr><td><strong>Litigation Buyout</strong></td><td>Covers pending or threatened litigation outcome</td><td>10-30% of coverage limit</td></tr>' +
    '<tr><td><strong>Successor Liability</strong></td><td>Covers unknown predecessor liabilities in asset sale</td><td>Case-by-case</td></tr>' +
    '</tbody></table>' +
    '<div class="form-group" style="margin-top:var(--space-md)"><label class="form-label">Environmental liability insurance relevant?</label>' +
    '<select class="form-input" data-bind="envInsurance"><option value="">--</option><option value="yes"' + (state.envInsurance === 'yes' ? ' selected' : '') + '>Yes -- pursuing</option><option value="no"' + (state.envInsurance === 'no' ? ' selected' : '') + '>No -- not needed</option><option value="na"' + (state.envInsurance === 'na' ? ' selected' : '') + '>Not sure yet</option></select></div></div>';
  html += pageNav(true, 'Continue', 'specialty-insurance');
  return html;
}

function renderClaimsResolution() {
  var html = '<div class="page-header"><div class="t-label">Strategy</div><div class="t-display">Pending Claims Resolution</div><p class="t-body t-secondary">Open claims create complexity in negotiations. Buyers want clarity on status, exposure, and coverage for every open claim.</p></div>';
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Claims Register</div>';
  if (state.claims.length === 0) {
    html += '<div style="text-align:center;padding:var(--space-xl);color:var(--color-text-tertiary)"><p>No open claims recorded. If you have none, that is excellent for your deal.</p></div>';
  } else {
    html += '<div style="overflow-x:auto"><table class="data-table"><thead><tr><th>Description</th><th>Policy</th><th>Reserve ($)</th><th>Status</th><th></th></tr></thead><tbody>';
    state.claims.forEach(function(c, i) {
      html += '<tr>';
      html += '<td><input class="form-input" type="text" value="' + esc(c.description) + '" data-bind="claims.' + i + '.description" placeholder="Claim description"></td>';
      html += '<td><input class="form-input" type="text" value="' + esc(c.policy) + '" data-bind="claims.' + i + '.policy" placeholder="GL, WC, etc."></td>';
      html += '<td><input class="form-input" type="text" value="' + esc(c.reserve) + '" data-bind="claims.' + i + '.reserve" placeholder="$0"></td>';
      html += '<td><select class="form-input" data-bind="claims.' + i + '.status"><option value="">--</option><option value="Active"' + (c.status === 'Active' ? ' selected' : '') + '>Active</option><option value="Investigation"' + (c.status === 'Investigation' ? ' selected' : '') + '>Under Investigation</option><option value="Reserved"' + (c.status === 'Reserved' ? ' selected' : '') + '>Reserved</option><option value="Denied"' + (c.status === 'Denied' ? ' selected' : '') + '>Denied/Appeal</option><option value="Closed"' + (c.status === 'Closed' ? ' selected' : '') + '>Closed</option></select></td>';
      html += '<td><button class="btn btn-ghost btn-sm" onclick="PB.removeClaim(' + i + ')" style="color:var(--color-danger)">Remove</button></td>';
      html += '</tr>';
    });
    html += '</tbody></table></div>';
  }
  html += '<button class="add-btn" onclick="PB.addClaim()">+ Add Open Claim</button></div>';

  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Claims Resolution Best Practices</div>' +
    '<ul style="margin-left:var(--space-lg);color:var(--color-text-secondary);font-size:14px;display:flex;flex-direction:column;gap:8px">' +
    '<li>Prepare a complete claims history for the past 5 years across all policy types</li>' +
    '<li>For each open claim, obtain defense counsel\'s written assessment of probable outcome</li>' +
    '<li>Identify claims that could give rise to future claims (e.g., workplace injury leading to EEOC complaint)</li>' +
    '<li>Review all policies for claims-made reporting deadlines -- missing a deadline can void coverage</li>' +
    '<li>Accelerate resolution of active litigation if possible before going to market</li>' +
    '</ul></div>';
  html += pageNav(true, 'Continue', 'claims-resolution');
  return html;
}

function renderTailCoverage() {
  var html = '<div class="page-header"><div class="t-label">Strategy</div><div class="t-display">Tail Coverage Planning</div><p class="t-body t-secondary">For claims-made policies, tail coverage is one of the most critical insurance decisions in any transaction. Without it, you have zero coverage for post-close claims.</p></div>';
  html += '<div class="callout callout-danger"><strong>D&O Tail -- Non-Negotiable for Sellers.</strong> If you served as a director or officer, a D&O tail is non-negotiable. Without it, you have zero coverage for any claim made after closing. A 6-year tail is standard. Make it a closing condition.</div>';
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Tail Coverage Planning Worksheet</div>';
  html += '<div style="overflow-x:auto"><table class="data-table"><thead><tr><th>Policy</th><th>Annual Premium ($)</th><th>Tail Period</th><th>Est. Tail Cost ($)</th><th>Who Pays</th><th>Status</th></tr></thead><tbody>';
  state.tailPlans.forEach(function(t, i) {
    html += '<tr>';
    html += '<td><strong>' + esc(t.policy) + '</strong></td>';
    html += '<td><input class="form-input" type="text" value="' + esc(t.premium) + '" data-bind="tailPlans.' + i + '.premium" placeholder="$0"></td>';
    html += '<td><select class="form-input" data-bind="tailPlans.' + i + '.period"><option value="">--</option><option value="3yr"' + (t.period === '3yr' ? ' selected' : '') + '>3 years</option><option value="6yr"' + (t.period === '6yr' ? ' selected' : '') + '>6 years</option><option value="na"' + (t.period === 'na' ? ' selected' : '') + '>N/A</option></select></td>';
    html += '<td><input class="form-input" type="text" value="' + esc(t.cost) + '" data-bind="tailPlans.' + i + '.cost" placeholder="150-250% of premium"></td>';
    html += '<td><select class="form-input" data-bind="tailPlans.' + i + '.whoPays"><option value="">--</option><option value="seller"' + (t.whoPays === 'seller' ? ' selected' : '') + '>Seller</option><option value="buyer"' + (t.whoPays === 'buyer' ? ' selected' : '') + '>Buyer</option><option value="split"' + (t.whoPays === 'split' ? ' selected' : '') + '>Split</option><option value="tbd"' + (t.whoPays === 'tbd' ? ' selected' : '') + '>TBD</option></select></td>';
    html += '<td><select class="form-input" data-bind="tailPlans.' + i + '.status"><option value="">--</option><option value="not-started"' + (t.status === 'not-started' ? ' selected' : '') + '>Not started</option><option value="quoted"' + (t.status === 'quoted' ? ' selected' : '') + '>Quoted</option><option value="ordered"' + (t.status === 'ordered' ? ' selected' : '') + '>Ordered</option><option value="secured"' + (t.status === 'secured' ? ' selected' : '') + '>Secured</option></select></td>';
    html += '</tr>';
  });
  html += '</tbody></table></div></div>';
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Purchase Agreement Negotiation Points</div>' +
    '<ul style="margin-left:var(--space-lg);color:var(--color-text-secondary);font-size:14px;display:flex;flex-direction:column;gap:8px">' +
    '<li><strong>Responsibility:</strong> Who purchases the tail (buyer or seller)?</li>' +
    '<li><strong>Duration:</strong> Minimum tail period (3 years? 6 years? matching statute of limitations)</li>' +
    '<li><strong>Cost allocation:</strong> Factored into purchase price or closing adjustment?</li>' +
    '<li><strong>Alternative:</strong> Does buyer commit to maintaining run-off coverage if no standalone tail?</li>' +
    '<li><strong>Contingency:</strong> What happens if tail becomes unavailable or prohibitively expensive?</li>' +
    '</ul></div>';
  html += pageNav(true, 'Continue', 'tail-coverage');
  return html;
}

function renderMistakes() {
  var mistakes = [
    { key: 'm1', title: 'No Phase I ESA Before Going to Market', desc: 'Buyer discovers contamination during diligence; deal stalls or dies.', fix: 'Commission Phase I 12+ months pre-market; remediate before listing.' },
    { key: 'm2', title: 'Ignoring Underground Storage Tanks', desc: 'UST leak creates $100K-$1M+ cleanup liability.', fix: 'Conduct UST survey; remove or close abandoned tanks properly.' },
    { key: 'm3', title: 'Not Purchasing D&O Tail', desc: 'Former director/officer has no coverage for post-close claims.', fix: 'Require D&O tail as closing condition; budget 150-250% of annual premium.' },
    { key: 'm4', title: 'Letting Policies Lapse During Extended Diligence', desc: 'Coverage gap creates exposure for both parties.', fix: 'Maintain all policies through closing; do not cancel prematurely.' },
    { key: 'm5', title: 'Not Disclosing Known Environmental Conditions', desc: 'Fraud claim; rescission of sale; personal liability.', fix: 'Disclose all known conditions; let Phase I/II findings speak for themselves.' },
    { key: 'm6', title: 'Assuming Buyer Insurance Covers Seller Post-Close', desc: 'Buyer policies only cover the buyer; seller has no standing.', fix: 'Secure tail coverage for all claims-made policies before closing.' },
    { key: 'm7', title: 'Underestimating Remediation Costs', desc: 'Purchase price adjustment exceeds expectations.', fix: 'Get remediation cost estimates from qualified environmental consultants.' },
    { key: 'm8', title: 'No EPLI Tail for Pre-Close Employment Actions', desc: 'Former employee files discrimination claim 6 months post-close; no coverage.', fix: 'Purchase EPLI tail; review all pending HR matters pre-close.' }
  ];
  var html = '<div class="page-header"><div class="t-label">Plan</div><div class="t-display">Common Mistakes & Deal Killers</div><p class="t-body t-secondary">Flag each mistake you have addressed or are actively working on.</p></div>';
  mistakes.forEach(function(m) {
    var checked = state.mistakeFlags[m.key];
    html += '<div class="card"><div class="check-item' + (checked ? ' checked' : '') + '" data-check="' + m.key + '" role="checkbox" aria-checked="' + !!checked + '" tabindex="0" style="padding:0">' +
      '<div class="check-box"><svg viewBox="0 0 14 14"><polyline points="2.5 7 5.5 10 11.5 4"/></svg></div>' +
      '<div style="flex:1"><div class="t-h3">' + m.title + '</div>' +
      '<p class="t-small t-secondary" style="margin:var(--space-sm) 0">' + m.desc + '</p>' +
      '<div style="padding:var(--space-sm) var(--space-md);background:var(--color-success-light);border-radius:var(--radius-sm);font-size:13px;color:var(--color-success)"><strong>Prevention:</strong> ' + m.fix + '</div></div></div></div>';
  });
  html += pageNav(true, 'View Dashboard', 'mistakes');
  return html;
}

function renderDashboard() {
  var score = calcScore();
  var sc = getScoreColor(score);
  var r = 60, circ = 2 * Math.PI * r;
  var offset = circ - (score / 100) * circ;

  var html = '<div class="page-header"><div class="t-label">Results</div><div class="t-display">Environmental & Insurance Readiness</div></div>';
  html += '<div class="gauge-wrap"><div class="gauge-ring"><svg viewBox="0 0 160 160"><circle class="gauge-bg" cx="80" cy="80" r="' + r + '"/><circle class="gauge-fill" cx="80" cy="80" r="' + r + '" stroke="' + sc + '" stroke-dasharray="' + circ + '" stroke-dashoffset="' + offset + '"/></svg><div class="gauge-center"><div class="gauge-center-value" style="color:' + sc + '">' + score + '</div><div class="gauge-center-label">of 100</div></div></div></div>';

  // KPIs
  var envCount = Object.keys(state.envChecklist).filter(function(k) { return state.envChecklist[k]; }).length;
  var insTotal = Object.values(state.insuranceScores).reduce(function(a,v) { return a+v; }, 0);
  var tailSecured = state.tailPlans.filter(function(t) { return t.status === 'secured' || t.status === 'ordered'; }).length;
  var openClaims = state.claims.filter(function(c) { return c.status !== 'Closed'; }).length;

  html += '<div class="summary-grid">' +
    '<div class="summary-item"><div class="summary-item-value">' + envCount + '/12</div><div class="summary-item-label">Env Risk Flags</div></div>' +
    '<div class="summary-item"><div class="summary-item-value" style="color:' + getScoreColor(insTotal * 4) + '">' + insTotal + '/25</div><div class="summary-item-label">Insurance Score</div></div>' +
    '<div class="summary-item"><div class="summary-item-value">' + tailSecured + '/4</div><div class="summary-item-label">Tails Secured</div></div>' +
    '<div class="summary-item"><div class="summary-item-value" style="color:' + (openClaims > 0 ? 'var(--color-danger)' : 'var(--color-success)') + '">' + openClaims + '</div><div class="summary-item-label">Open Claims</div></div>' +
    '</div>';

  // Bar chart
  var cats = [
    { label: 'Env Screening', score: Math.round((envCount / 12) * 100), max: 100 },
    { label: 'Phase I Status', score: state.phaseIStatus === 'clean' ? 100 : state.phaseIStatus === 'recs-found' ? 70 : state.phaseIStatus === 'ordered' ? 40 : 0, max: 100 },
    { label: 'Insurance Coverage', score: insTotal * 4, max: 100 },
    { label: 'Tail Coverage', score: tailSecured * 25, max: 100 },
    { label: 'Claims Resolved', score: state.claims.length === 0 ? 100 : Math.round((state.claims.filter(function(c){return c.status==='Closed';}).length / state.claims.length) * 100), max: 100 }
  ];
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Readiness Breakdown</div><div class="bar-chart">';
  cats.forEach(function(cat) {
    var color = cat.score >= 70 ? 'var(--color-success)' : cat.score >= 40 ? 'var(--color-warning)' : 'var(--color-danger)';
    html += '<div class="bar-row"><div class="bar-label">' + cat.label + '</div><div class="bar-track"><div class="bar-fill" style="width:' + cat.score + '%;background:' + color + '"><span class="bar-value">' + cat.score + '%</span></div></div></div>';
  });
  html += '</div></div>';

  // Recommendations
  html += '<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Recommendations</div>';
  if (!state.phaseIStatus || state.phaseIStatus === 'none') html += '<div class="callout callout-danger" style="margin-bottom:var(--space-sm)">Phase I ESA not yet ordered. Commission one 12+ months before going to market.</div>';
  if (state.phaseIStatus === 'recs-found') html += '<div class="callout callout-warning" style="margin-bottom:var(--space-sm)">Phase I identified RECs. Evaluate Phase II need and remediation options before listing.</div>';
  if (insTotal < 15) html += '<div class="callout callout-warning" style="margin-bottom:var(--space-sm)">Insurance coverage below standard. Review gaps with your broker before entering the market.</div>';
  if (tailSecured < 2) html += '<div class="callout callout-warning" style="margin-bottom:var(--space-sm)">Tail coverage not yet secured on critical policies. Prioritize D&O and E&O tails.</div>';
  if (openClaims > 0) html += '<div class="callout callout-danger" style="margin-bottom:var(--space-sm)">You have ' + openClaims + ' open claim(s). Accelerate resolution before going to market.</div>';
  if (score >= 70) html += '<div class="callout callout-info" style="background:var(--color-success-light);border-color:var(--color-success);color:var(--color-success)"><strong>Strong readiness.</strong> Your environmental and insurance preparation positions you well for a smooth diligence process.</div>';
  html += '</div>';

  html += '<div style="display:flex;gap:var(--space-sm);flex-wrap:wrap;margin-top:var(--space-lg)">' +
    '<button class="btn btn-primary" onclick="PB.exportResults()">Export Summary</button>' +
    '<button class="btn btn-secondary" onclick="window.print()">Print</button>' +
    '<button class="btn btn-ghost" onclick="PB.resetAll()" style="color:var(--color-danger)">Reset All Data</button>' +
    '</div>';
  html += '<div class="page-nav"><button class="btn btn-secondary" onclick="PB.prevPage()">&larr; Back</button><div></div></div>';
  return html;
}

function exportResults() {
  var score = calcScore();
  var text = 'PLAYBOOK #24: ENVIRONMENTAL & INSURANCE REVIEW\n';
  text += 'Generated: ' + new Date().toLocaleDateString() + '\n';
  text += '='.repeat(50) + '\n\n';
  text += 'READINESS SCORE: ' + score + '/100\n\n';
  text += 'ENVIRONMENTAL SCREENING:\n';
  text += '  Risk flags: ' + Object.keys(state.envChecklist).filter(function(k){return state.envChecklist[k];}).length + '/12\n';
  text += '  Overall risk level: ' + (state.envRiskLevel || '--') + '/5\n';
  text += '  Business type: ' + (state.businessType || '--') + '\n';
  text += '  Phase I status: ' + (state.phaseIStatus || 'Not started') + '\n\n';
  text += 'INSURANCE COVERAGE: ' + Object.values(state.insuranceScores).reduce(function(a,v){return a+v;},0) + '/25\n';
  text += 'POLICIES: ' + state.policies.length + '\n';
  text += 'OPEN CLAIMS: ' + state.claims.filter(function(c){return c.status!=='Closed';}).length + '\n\n';
  text += 'TAIL COVERAGE:\n';
  state.tailPlans.forEach(function(t) {
    text += '  ' + t.policy + ': ' + (t.status || 'Not started') + (t.cost ? ' (Est. ' + t.cost + ')' : '') + '\n';
  });

  var blob = new Blob([text], { type: 'text/plain' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = 'playbook-24-environmental-insurance.txt'; a.click();
  URL.revokeObjectURL(url);
}

function resetAll() {
  if (confirm('This will erase all your data in this playbook. Are you sure?')) {
    localStorage.removeItem(STORAGE_KEY);
    state = defaultState();
    saveState();
    goToPage('welcome');
  }
}

window.PB = {
  prevPage: prevPage,
  completePage: completePage,
  exportResults: exportResults,
  resetAll: resetAll,
  setScore: function(stateKey, dimKey, val) {
    if (stateKey === 'insuranceScores') {
      state.insuranceScores[dimKey] = val;
    } else if (stateKey === 'envRiskLevel') {
      state.envRiskLevel = val;
    } else {
      state[stateKey] = val;
    }
    saveState();
    renderPage();
  },
  addPolicy: function() {
    state.policies.push({ type: '', carrier: '', limits: '', expiration: '', claimsMade: '', tailNeeded: '' });
    saveState();
    renderPage();
  },
  removePolicy: function(i) {
    state.policies.splice(i, 1);
    saveState();
    renderPage();
  },
  addClaim: function() {
    state.claims.push({ description: '', policy: '', reserve: '', status: '' });
    saveState();
    renderPage();
  },
  removeClaim: function(i) {
    state.claims.splice(i, 1);
    saveState();
    renderPage();
  }
};

renderNav();
renderPage();
updateProgress();
updateScore();

})();
</script>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('embedded') === 'true') {
    // Hide playbook's own chrome
    var sidebar = document.querySelector('.sidebar');
    var overlay = document.querySelector('.sidebar-overlay');
    var mobileHeader = document.querySelector('.mobile-header');
    var mainContent = document.querySelector('.main-content');
    if (sidebar) sidebar.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    if (mobileHeader) mobileHeader.style.display = 'none';
    if (mainContent) {
      mainContent.style.marginLeft = '0';
      mainContent.style.minHeight = 'auto';
    }

    // Navigate to specific section if requested
    var section = params.get('section');
    if (section !== null) {
      var sectionIndex = parseInt(section, 10);
      if (typeof navigateToSection === 'function') {
        setTimeout(function() { navigateToSection(sectionIndex); }, 100);
      }
    }

    // Forward score updates to parent
    var origDispatch = window.dispatchEvent.bind(window);
    window.addEventListener('playbook:score-update', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:score-update',
          detail: e.detail
        }, '*');
      }
    });

    // Forward section changes to parent
    window.addEventListener('playbook:section-change', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:section-change',
          detail: e.detail
        }, '*');
      }
    });

    // Listen for commands from parent
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'navigate-section') {
        if (typeof navigateToSection === 'function') {
          navigateToSection(e.data.sectionIndex);
        }
      }
    });
  }
})();
</script>
</body>
</html>