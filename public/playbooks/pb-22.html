<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Employment & HR Compliance | Exit Planning Playbook #22</title>
<style>
/* ============================================================
   DESIGN TOKENS
   ============================================================ */
:root {
  --color-bg: #F5F5F7;
  --color-surface: #FFFFFF;
  --color-surface-alt: #F2F2F7;
  --color-border: #E5E7EB;
  --color-border-light: #F2F2F7;
  --color-text: #1D1D1F;
  --color-text-secondary: #6E6E73;
  --color-text-tertiary: #8E8E93;
  --color-primary: #0071E3;
  --color-primary-light: #EBF5FF;
  --color-primary-hover: #0051B3;
  --color-accent: #FF9500;
  --color-accent-light: #FFF6E8;
  --color-danger: #FF3B30;
  --color-danger-light: #FFEBEA;
  --color-warning: #C67F20;
  --color-warning-light: #FFF8EB;
  --color-success: #34C759;
  --color-success-light: #E8F8ED;
  --color-score-1: #FF3B30;
  --color-score-2: #FF9500;
  --color-score-3: #FFCC00;
  --color-score-4: #34C759;
  --color-score-5: #30D158;
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.1);
  --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', sans-serif;
  --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', sans-serif;
  --transition-fast: 150ms ease;
  --transition-normal: 250ms ease;
  --transition-slow: 400ms cubic-bezier(0.16, 1, 0.3, 1);
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
  --space-3xl: 64px;
}

/* RESET */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body {
  font-family: var(--font-body); font-size: 16px; line-height: 1.6;
  color: var(--color-text); background: var(--color-bg);
  -webkit-font-smoothing: antialiased; min-height: 100vh;
}
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea, select { font-family: inherit; font-size: inherit; }
a { color: var(--color-primary); text-decoration: none; }

/* TYPOGRAPHY */
.t-display { font-family: var(--font-display); font-size: clamp(26px, 4vw, 38px); font-weight: 700; line-height: 1.2; letter-spacing: -0.02em; }
.t-h1 { font-family: var(--font-display); font-size: clamp(22px, 3vw, 30px); font-weight: 700; line-height: 1.25; }
.t-h2 { font-size: 20px; font-weight: 600; line-height: 1.3; }
.t-h3 { font-size: 16px; font-weight: 600; line-height: 1.4; }
.t-body { font-size: 16px; line-height: 1.6; }
.t-small { font-size: 14px; line-height: 1.5; }
.t-caption { font-size: 12px; line-height: 1.4; letter-spacing: 0.02em; }
.t-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); }
.t-secondary { color: var(--color-text-secondary); }

/* LAYOUT */
.app { display: flex; min-height: 100vh; }
.sidebar {
  width: 272px; min-width: 272px; background: var(--color-text);
  color: var(--color-text); padding: var(--space-lg); display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
  transition: transform var(--transition-slow); overflow-y: auto;
}
.sidebar.collapsed { transform: translateX(-272px); }
.main-content { flex: 1; margin-left: 272px; min-height: 100vh; transition: margin-left var(--transition-slow); }
.sidebar.collapsed + .main-content { margin-left: 0; }
.content-area { max-width: 820px; margin: 0 auto; padding: var(--space-2xl) var(--space-lg); }

.mobile-header {
  display: none; position: sticky; top: 0; z-index: 90;
  background: var(--color-surface); border-bottom: 1px solid var(--color-border);
  padding: var(--space-md) var(--space-lg); align-items: center; gap: var(--space-md);
}
.hamburger { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); }
.hamburger:hover { background: var(--color-surface-alt); }
.hamburger span { display: block; width: 18px; height: 2px; background: var(--color-text); position: relative; }
.hamburger span::before, .hamburger span::after { content:''; position: absolute; width: 18px; height: 2px; background: var(--color-text); left: 0; }
.hamburger span::before { top: -6px; }
.hamburger span::after { top: 6px; }
.sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 99; }

@media (max-width: 900px) {
  .sidebar { transform: translateX(-272px); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.show { display: block; }
  .main-content { margin-left: 0 !important; }
  .mobile-header { display: flex; }
  .content-area { padding: var(--space-lg) var(--space-md); }
}

/* SIDEBAR */
.sidebar-brand { margin-bottom: var(--space-xl); }
.sidebar-brand-label { font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-xs); }
.sidebar-brand-title { font-family: var(--font-display); font-size: 17px; font-weight: 700; color: #fff; line-height: 1.3; }

.sidebar-progress { margin-bottom: var(--space-xl); padding: var(--space-md); background: var(--color-surface-alt); border-radius: var(--radius-md); }
.sidebar-progress-label { font-size: 12px; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-progress-bar { height: 4px; background: var(--color-border); border-radius: 2px; overflow: hidden; }
.sidebar-progress-fill { height: 100%; background: var(--color-accent); border-radius: 2px; transition: width var(--transition-slow); }
.sidebar-progress-text { font-size: 12px; color: var(--color-text-tertiary); margin-top: var(--space-sm); text-align: right; }

.sidebar-nav { flex: 1; display: flex; flex-direction: column; gap: 2px; }
.nav-section-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-tertiary); padding: var(--space-md) var(--space-sm) var(--space-xs); }
.nav-item {
  display: flex; align-items: center; gap: var(--space-md); padding: 10px 12px;
  border-radius: var(--radius-sm); color: rgba(255,255,255,0.6);
  font-size: 13px; transition: all var(--transition-fast); cursor: pointer;
}
.nav-item:hover { background: var(--color-surface-alt); color: var(--color-text); }
.nav-item.active { background: var(--color-primary-light); color: var(--color-primary); font-weight: 500; border-left: 3px solid var(--color-primary); }
.nav-item.completed .nav-check { display: flex; }
.nav-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 13px; }
.nav-check { display: none; width: 16px; height: 16px; background: var(--color-success); border-radius: 50%; align-items: center; justify-content: center; margin-left: auto; flex-shrink: 0; }
.nav-check svg { width: 10px; height: 10px; stroke: #fff; stroke-width: 2.5; fill: none; }

.sidebar-score { margin-top: auto; padding-top: var(--space-lg); border-top: 1px solid var(--color-border); }
.sidebar-score-label { font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-score-value { font-family: var(--font-display); font-size: 36px; font-weight: 700; color: #fff; line-height: 1; }
.sidebar-score-max { font-size: 18px; color: var(--color-text-tertiary); font-weight: 400; }
.sidebar-score-desc { font-size: 12px; color: var(--color-text-secondary); margin-top: var(--space-xs); }

/* CARDS */
.card {
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: var(--radius-lg); padding: var(--space-lg);
  transition: box-shadow var(--transition-normal); margin-bottom: var(--space-md);
}
.card:hover { box-shadow: var(--shadow-sm); }

.callout {
  padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md);
  border-left: 3px solid; font-size: 14px; line-height: 1.6; margin-bottom: var(--space-lg);
}
.callout-info { background: var(--color-primary-light); border-color: var(--color-primary); color: var(--color-primary); }
.callout-warning { background: var(--color-warning-light); border-color: var(--color-warning); color: #7C5500; }
.callout-danger { background: var(--color-danger-light); border-color: var(--color-danger); color: var(--color-danger); }
.callout-accent { background: var(--color-accent-light); border-color: var(--color-accent); color: #7C5500; }

/* BUTTONS */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm);
  padding: 10px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500;
  transition: all var(--transition-fast); white-space: nowrap;
}
.btn-primary { background: var(--color-primary); color: #fff; }
.btn-primary:hover { background: var(--color-primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.btn-secondary { background: var(--color-surface); color: var(--color-text); border: 1px solid var(--color-border); }
.btn-secondary:hover { background: var(--color-surface-alt); border-color: var(--color-text-tertiary); }
.btn-accent { background: var(--color-accent); color: #fff; }
.btn-accent:hover { background: #E68600; }
.btn-lg { padding: 14px 28px; font-size: 16px; border-radius: var(--radius-md); }
.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
.btn-group { display: flex; gap: var(--space-sm); flex-wrap: wrap; }

/* FORMS */
.form-group { margin-bottom: var(--space-lg); }
.form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: var(--space-sm); }
.form-hint { font-size: 13px; color: var(--color-text-tertiary); margin-top: var(--space-xs); }
.form-input {
  width: 100%; padding: 10px 14px; border: 1px solid var(--color-border);
  border-radius: var(--radius-sm); font-size: 15px; background: var(--color-surface);
  transition: all var(--transition-fast); color: var(--color-text);
}
.form-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light); }
textarea.form-input { min-height: 80px; resize: vertical; line-height: 1.5; }
select.form-input { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%236E6E73' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }

/* SCORE SELECTOR */
.score-selector { display: flex; gap: var(--space-sm); margin-bottom: var(--space-md); }
.score-option {
  flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;
  padding: 12px 8px; border: 2px solid var(--color-border); border-radius: var(--radius-md);
  cursor: pointer; transition: all var(--transition-fast); text-align: center;
}
.score-option:hover { border-color: var(--color-text-tertiary); background: var(--color-surface-alt); }
.score-option.selected { border-color: var(--color-primary); background: var(--color-primary-light); }
.score-option input { position: absolute; opacity: 0; width: 0; height: 0; }
.score-number { font-size: 22px; font-weight: 700; line-height: 1; }
.score-label-text { font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.04em; color: var(--color-text-secondary); line-height: 1.2; }
.score-option.s1 .score-number { color: var(--color-score-1); }
.score-option.s2 .score-number { color: var(--color-score-2); }
.score-option.s3 .score-number { color: var(--color-score-3); }
.score-option.s4 .score-number { color: var(--color-score-4); }
.score-option.s5 .score-number { color: var(--color-score-5); }
.score-option.selected.s1 { border-color: var(--color-score-1); background: #FFF5F5; }
.score-option.selected.s2 { border-color: var(--color-score-2); background: #FFFBEB; }
.score-option.selected.s3 { border-color: var(--color-score-3); background: #FFF8EB; }
.score-option.selected.s4 { border-color: var(--color-score-4); background: #E8F8EE; }
.score-option.selected.s5 { border-color: var(--color-score-5); background: #E0F5E8; }

@media (max-width: 600px) {
  .score-selector { gap: 4px; }
  .score-option { padding: 10px 4px; }
  .score-number { font-size: 18px; }
  .score-label-text { font-size: 9px; }
}

/* RISK SELECTOR */
.risk-selector { display: flex; gap: var(--space-sm); margin-bottom: var(--space-sm); }
.risk-option {
  flex: 1; padding: 12px; border: 2px solid var(--color-border); border-radius: var(--radius-md);
  cursor: pointer; transition: all var(--transition-fast); text-align: center; font-size: 14px; font-weight: 500;
}
.risk-option:hover { border-color: var(--color-text-tertiary); }
.risk-option.selected.risk-low { border-color: var(--color-success); background: var(--color-success-light); color: var(--color-success); }
.risk-option.selected.risk-med { border-color: var(--color-warning); background: var(--color-warning-light); color: var(--color-warning); }
.risk-option.selected.risk-high { border-color: var(--color-danger); background: var(--color-danger-light); color: var(--color-danger); }

/* BADGES */
.badge {
  display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px;
  border-radius: 999px; font-size: 12px; font-weight: 500;
}
.badge-success { background: var(--color-success-light); color: var(--color-success); }
.badge-warning { background: var(--color-warning-light); color: var(--color-warning); }
.badge-danger { background: var(--color-danger-light); color: var(--color-danger); }
.badge-neutral { background: var(--color-surface-alt); color: var(--color-text-secondary); }
.badge-primary { background: var(--color-primary-light); color: var(--color-primary); }

/* PROGRESS RING */
.progress-ring-wrap { position: relative; display: inline-flex; align-items: center; justify-content: center; }
.progress-ring-text { position: absolute; text-align: center; }
.progress-ring-value { font-family: var(--font-display); font-weight: 700; line-height: 1; }

/* BAR CHART */
.bar-chart { display: flex; flex-direction: column; gap: var(--space-md); }
.bar-row { display: flex; align-items: center; gap: var(--space-md); }
.bar-label { width: 140px; flex-shrink: 0; font-size: 13px; color: var(--color-text-secondary); text-align: right; }
.bar-track { flex: 1; height: 28px; background: var(--color-surface-alt); border-radius: 4px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; }
.bar-value { font-size: 12px; font-weight: 600; color: #fff; white-space: nowrap; }
@media (max-width: 600px) { .bar-label { width: 90px; font-size: 11px; } }

/* HEATMAP */
.heatmap-container { overflow-x: auto; }
.heatmap { display: grid; gap: 3px; min-width: 400px; }
.heatmap-cell {
  aspect-ratio: 1.4; border-radius: var(--radius-sm); display: flex; align-items: center;
  justify-content: center; font-size: 13px; font-weight: 600; color: #fff;
  transition: transform var(--transition-fast); cursor: default;
}
.heatmap-cell:hover { transform: scale(1.05); z-index: 1; }
.heatmap-cell.hs0 { background: var(--color-border); color: var(--color-text-tertiary); }
.heatmap-cell.hs1 { background: var(--color-score-5); }
.heatmap-cell.hs2 { background: var(--color-score-4); }
.heatmap-cell.hs3 { background: var(--color-score-3); }
.heatmap-cell.hs4 { background: var(--color-score-2); }
.heatmap-cell.hs5 { background: var(--color-score-1); }
.heatmap-row-label { font-size: 12px; color: var(--color-text-secondary); display: flex; align-items: center; padding-right: var(--space-sm); }
.heatmap-col-label { font-size: 10px; color: var(--color-text-tertiary); text-align: center; text-transform: uppercase; letter-spacing: 0.03em; padding-bottom: 4px; }

/* PAGES */
.page { display: none; animation: fadeIn 0.3s ease; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.page-header { margin-bottom: var(--space-2xl); }
.page-header .t-label { margin-bottom: var(--space-sm); }
.page-header .t-display { margin-bottom: var(--space-md); }
.page-header .t-body { color: var(--color-text-secondary); max-width: 620px; }

.section-divider { height: 1px; background: var(--color-border); margin: var(--space-2xl) 0; }

/* WELCOME */
.welcome-hero { text-align: center; padding: var(--space-3xl) var(--space-lg); max-width: 640px; margin: 0 auto; }
.welcome-icon {
  width: 72px; height: 72px; background: var(--color-primary-light);
  border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center;
  margin: 0 auto var(--space-lg); font-size: 32px;
}
.welcome-hero .t-display { margin-bottom: var(--space-md); }
.welcome-hero .t-body { margin-bottom: var(--space-2xl); }
.welcome-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin: var(--space-2xl) 0; text-align: center; }
.welcome-stat { padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); }
.welcome-stat-value { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--color-primary); }
.welcome-stat-label { font-size: 13px; color: var(--color-text-secondary); margin-top: 4px; }
.welcome-phases { display: flex; flex-direction: column; gap: var(--space-md); margin: var(--space-2xl) 0; text-align: left; }
.welcome-phase { display: flex; gap: var(--space-lg); padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); }
.welcome-phase-num { width: 36px; height: 36px; background: var(--color-primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--color-primary); flex-shrink: 0; }
.welcome-phase-title { font-weight: 600; margin-bottom: 2px; }
.welcome-phase-desc { font-size: 14px; color: var(--color-text-secondary); }
@media (max-width: 600px) { .welcome-stats { grid-template-columns: 1fr; } .welcome-hero { padding: var(--space-2xl) var(--space-md); } }

/* DATA TABLE */
.data-table-wrap { overflow-x: auto; margin-bottom: var(--space-lg); }
.data-table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 600px; }
.data-table th { background: var(--color-surface-alt); padding: 10px 12px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.04em; color: var(--color-text-secondary); border-bottom: 2px solid var(--color-border); white-space: nowrap; }
.data-table td { padding: 10px 12px; border-bottom: 1px solid var(--color-border-light); vertical-align: top; }
.data-table tr:hover td { background: var(--color-surface-alt); }
.data-table input, .data-table select { font-size: 13px; padding: 6px 8px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: var(--color-surface); width: 100%; min-width: 80px; }
.data-table input:focus, .data-table select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px var(--color-primary-light); }

/* CHECKLIST */
.checklist { display: flex; flex-direction: column; gap: var(--space-sm); }
.checklist-item {
  display: flex; align-items: flex-start; gap: var(--space-md); padding: var(--space-md);
  background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md);
  cursor: pointer; transition: all var(--transition-fast);
}
.checklist-item:hover { border-color: var(--color-primary); }
.checklist-item.checked { background: var(--color-primary-light); border-color: var(--color-primary); }
.checklist-box {
  width: 22px; height: 22px; border: 2px solid var(--color-border); border-radius: 4px;
  flex-shrink: 0; display: flex; align-items: center; justify-content: center;
  transition: all var(--transition-fast); margin-top: 1px;
}
.checklist-item.checked .checklist-box { background: var(--color-primary); border-color: var(--color-primary); }
.checklist-box svg { width: 14px; height: 14px; stroke: #fff; stroke-width: 2.5; fill: none; opacity: 0; transition: opacity var(--transition-fast); }
.checklist-item.checked .checklist-box svg { opacity: 1; }
.checklist-text { font-size: 14px; line-height: 1.5; }
.checklist-detail { font-size: 12px; color: var(--color-text-tertiary); margin-top: 2px; }

/* EXPANDABLE */
.expandable { border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: var(--space-sm); overflow: hidden; }
.expandable-header {
  display: flex; align-items: center; justify-content: space-between; padding: var(--space-md) var(--space-lg);
  cursor: pointer; background: var(--color-surface); font-weight: 500; font-size: 15px;
  transition: background var(--transition-fast);
}
.expandable-header:hover { background: var(--color-surface-alt); }
.expandable-chevron { transition: transform var(--transition-fast); font-size: 12px; color: var(--color-text-tertiary); }
.expandable.open .expandable-chevron { transform: rotate(180deg); }
.expandable-body { display: none; padding: 0 var(--space-lg) var(--space-lg); background: var(--color-surface); }
.expandable.open .expandable-body { display: block; }

/* EXPOSURE CALCULATOR */
.calc-card {
  background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg);
  padding: var(--space-xl); margin-bottom: var(--space-lg);
}
.calc-result {
  background: var(--color-danger-light); border: 1px solid var(--color-danger); border-radius: var(--radius-md);
  padding: var(--space-lg); text-align: center; margin-top: var(--space-lg);
}
.calc-result-value { font-family: var(--font-display); font-size: 36px; font-weight: 700; color: var(--color-danger); }
.calc-result-label { font-size: 13px; color: var(--color-text-secondary); margin-top: 4px; }

/* DASH GRID */
.dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg); }
.dash-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--space-lg); text-align: center; }
.dash-card-value { font-family: var(--font-display); font-size: 32px; font-weight: 700; line-height: 1.2; }
.dash-card-label { font-size: 13px; color: var(--color-text-secondary); margin-top: 4px; }

/* GAUGE */
.gauge-wrap { display: flex; flex-direction: column; align-items: center; gap: var(--space-sm); }
.gauge-label { font-size: 13px; font-weight: 600; color: var(--color-text-secondary); }
.gauge-value { font-family: var(--font-display); font-size: 32px; font-weight: 700; }

/* PAGE NAV */
.page-nav { display: flex; justify-content: space-between; align-items: center; padding-top: var(--space-2xl); border-top: 1px solid var(--color-border); margin-top: var(--space-2xl); }

/* TOAST */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--color-text); color: #fff; padding: 12px 20px; border-radius: var(--radius-md); font-size: 14px; z-index: 200; transform: translateY(100px); opacity: 0; transition: all var(--transition-slow); }
.toast.show { transform: translateY(0); opacity: 1; }

/* PRINT */
/* Accessibility */
.skip-link { position: absolute; top: -40px; left: 0; background: var(--color-primary); color: #fff; padding: 8px 16px; z-index: 200; font-size: 14px; }
.skip-link:focus { top: 0; }
:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 2px; }
*:focus:not(:focus-visible) { outline: none; }

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } }

/* Print */
@media print { .sidebar, .mobile-header, .page-nav, .sidebar-overlay, .toast, .btn-group, .skip-link { display: none !important; } .main-content { margin-left: 0 !important; } .page { display: block !important; page-break-inside: avoid; } .content-area { max-width: 100%; padding: 0; } }
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to content</a>
<div class="app">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <nav class="sidebar" id="sidebar" role="navigation" aria-label="Playbook navigation">
    <div class="sidebar-brand">
      <div class="sidebar-brand-label">Exit Planning Playbook #22</div>
      <div class="sidebar-brand-title">Employment & HR Compliance</div>
    </div>
    <div class="sidebar-progress">
      <div class="sidebar-progress-label">Your Progress</div>
      <div class="sidebar-progress-bar"><div class="sidebar-progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="sidebar-progress-text" id="progressText">0% complete</div>
    </div>
    <div class="sidebar-nav" id="sidebarNav"></div>
    <div class="sidebar-score">
      <div class="sidebar-score-label">HR Compliance Score</div>
      <div class="sidebar-score-value" id="sidebarScore">--<span class="sidebar-score-max">/100</span></div>
      <div class="sidebar-score-desc" id="sidebarScoreDesc">Complete assessments to see your score</div>
    </div>
  </nav>

  <div class="main-content" id="main-content">
    <div class="mobile-header">
      <button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle navigation"><span></span></button>
      <span style="font-weight:600;font-size:15px;">HR Compliance</span>
    </div>

    <div class="content-area" id="contentArea">

      <!-- PAGE 0: Welcome -->
      <div class="page active" id="page-0">
        <div class="welcome-hero">
          <div class="welcome-icon">&#128188;</div>
          <div class="t-display">Employment & HR Compliance</div>
          <p class="t-body t-secondary">Employment law violations are the hidden landmines of M&A transactions. A clean HR house protects your deal -- and your purchase price.</p>
          <div class="welcome-stats">
            <div class="welcome-stat">
              <div class="welcome-stat-value">$1M-$10M+</div>
              <div class="welcome-stat-label">Potential class action exposure (50-200 employees)</div>
            </div>
            <div class="welcome-stat">
              <div class="welcome-stat-value">$252-$2,507</div>
              <div class="welcome-stat-label">Per-employee I-9 violation fine</div>
            </div>
            <div class="welcome-stat">
              <div class="welcome-stat-value">$200M+</div>
              <div class="welcome-stat-label">DOL annual back-wage recoveries</div>
            </div>
          </div>
          <div class="welcome-phases">
            <div class="welcome-phase"><div class="welcome-phase-num">1</div><div><div class="welcome-phase-title">Understand the Risk</div><div class="welcome-phase-desc">Learn why employment compliance matters in a transaction and what buyers scrutinize.</div></div></div>
            <div class="welcome-phase"><div class="welcome-phase-num">2</div><div><div class="welcome-phase-title">Classify & Audit</div><div class="welcome-phase-desc">Review worker classifications, handbook policies, benefit plans, and wage practices.</div></div></div>
            <div class="welcome-phase"><div class="welcome-phase-num">3</div><div><div class="welcome-phase-title">Calculate Exposure</div><div class="welcome-phase-desc">Quantify potential liabilities so you can prioritize remediation.</div></div></div>
            <div class="welcome-phase"><div class="welcome-phase-num">4</div><div><div class="welcome-phase-title">Remediate & Track</div><div class="welcome-phase-desc">Build a compliance action plan with tracking worksheets for every area.</div></div></div>
          </div>
          <button class="btn btn-primary btn-lg" onclick="goToPage(1)">Begin HR Compliance Review &rarr;</button>
        </div>
      </div>

      <!-- PAGE 1: Why It Matters -->
      <div class="page" id="page-1">
        <div class="page-header">
          <div class="t-label">Section 1 of 9</div>
          <div class="t-display">Why Employment Compliance Matters</div>
          <p class="t-body t-secondary">Employment-related liabilities are disproportionately expensive relative to their root cause. Buyers model these exposures and adjust their offer accordingly -- or walk away.</p>
        </div>

        <div class="callout callout-accent" style="margin-bottom:var(--space-2xl);">
          <strong>The Core Principle:</strong> Employment liabilities can follow the business through any deal structure. In an asset sale, successor liability doctrines can make the buyer responsible for pre-closing violations. Buyers will require comprehensive employment representations, indemnities, and escrows.
        </div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Compliance Risk Assessment</div>
        <p class="t-small t-secondary" style="margin-bottom:var(--space-md);">Rate your current compliance posture in each area. This creates your risk profile for the transaction.</p>

        <div id="complianceRiskCards"></div>

        <div class="page-nav">
          <button class="btn btn-secondary" onclick="goToPage(0)">&larr; Back</button>
          <button class="btn btn-primary" onclick="goToPage(2)">Worker Classification &rarr;</button>
        </div>
      </div>

      <!-- PAGE 2: Worker Classification -->
      <div class="page" id="page-2">
        <div class="page-header">
          <div class="t-label">Section 2 of 9</div>
          <div class="t-display">Employee Classification: W-2 vs. 1099</div>
          <p class="t-body t-secondary">Worker misclassification is the single most common employment compliance issue in lower middle market companies. A buyer who inherits misclassification liability faces back taxes, penalties, and class action exposure.</p>
        </div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Classification Tests Reference</div>
        <div id="classificationTests"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Misclassification Risk Assessment</div>
        <p class="t-small t-secondary" style="margin-bottom:var(--space-md);">For each current independent contractor, evaluate these factors. Three or more checked items means the classification should be reviewed by employment counsel.</p>
        <div class="checklist" id="misclassChecklist"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Contractor Classification Audit</div>
        <p class="t-small t-secondary" style="margin-bottom:var(--space-md);">Document each contractor and their classification risk level.</p>
        <div class="data-table-wrap">
          <table class="data-table" id="classAuditTable">
            <thead>
              <tr><th>Worker Name</th><th>Current Class.</th><th>IRS Factors</th><th>ABC Test</th><th>Risk Level</th><th>Action Needed</th></tr>
            </thead>
            <tbody id="classAuditBody"></tbody>
          </table>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="addClassRow()">+ Add Worker</button>

        <div class="page-nav">
          <button class="btn btn-secondary" onclick="goToPage(1)">&larr; Back</button>
          <button class="btn btn-primary" onclick="goToPage(3)">Handbook & Policies &rarr;</button>
        </div>
      </div>

      <!-- PAGE 3: Handbook & Policy -->
      <div class="page" id="page-3">
        <div class="page-header">
          <div class="t-label">Section 3 of 9</div>
          <div class="t-display">Employee Handbook & Policy Compliance</div>
          <p class="t-body t-secondary">A current, legally compliant employee handbook is a foundational document that buyers expect to see during diligence. It establishes the policies that govern the employment relationship and provides critical legal protections.</p>
        </div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Required Handbook Policies</div>
        <p class="t-small t-secondary" style="margin-bottom:var(--space-md);">Review each required policy area. Score your compliance level.</p>
        <div id="handbookPolicies"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Handbook Compliance Checklist</div>
        <div class="checklist" id="handbookChecklist"></div>

        <div class="page-nav">
          <button class="btn btn-secondary" onclick="goToPage(2)">&larr; Back</button>
          <button class="btn btn-primary" onclick="goToPage(4)">Benefits & ERISA &rarr;</button>
        </div>
      </div>

      <!-- PAGE 4: Benefits & ERISA -->
      <div class="page" id="page-4">
        <div class="page-header">
          <div class="t-label">Section 4 of 9</div>
          <div class="t-display">Benefit Plan Documentation & ERISA</div>
          <p class="t-body t-secondary">ERISA governs most employer-sponsored benefit plans. Plan defects can result in IRS disqualification, DOL penalties, and excise taxes. Buyers review every plan document, Form 5500, and non-discrimination test.</p>
        </div>

        <div class="callout callout-warning" style="margin-bottom:var(--space-2xl);">
          <strong>Transaction Impact:</strong> In a stock deal, the buyer inherits all benefit plan liabilities. In an asset deal, the buyer may be a "successor employer" for COBRA and WARN Act obligations. Uncorrected plan defects will be addressed through indemnification or price adjustments.
        </div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Retirement Plan Compliance</div>
        <div id="retirementScoring"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Health & Welfare Plan Compliance</div>
        <div class="checklist" id="healthChecklist"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Benefit Plan Tracker</div>
        <div class="data-table-wrap">
          <table class="data-table" id="benefitTable">
            <thead>
              <tr><th>Plan Name</th><th>Type</th><th>5500 Current?</th><th>SPD Distributed?</th><th>NDT Passed?</th><th>Deficiency</th><th>Status</th></tr>
            </thead>
            <tbody id="benefitBody"></tbody>
          </table>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="addBenefitRow()">+ Add Plan</button>

        <div class="page-nav">
          <button class="btn btn-secondary" onclick="goToPage(3)">&larr; Back</button>
          <button class="btn btn-primary" onclick="goToPage(5)">Wage & Hour &rarr;</button>
        </div>
      </div>

      <!-- PAGE 5: Wage & Hour -->
      <div class="page" id="page-5">
        <div class="page-header">
          <div class="t-label">Section 5 of 9</div>
          <div class="t-display">Wage & Hour Compliance</div>
          <p class="t-body t-secondary">Wage and hour compliance has the highest litigation volume and greatest class action exposure of any employment area. The DOL recovers over $200 million annually in back wages.</p>
        </div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Exempt vs. Non-Exempt Classification</div>
        <p class="t-small t-secondary" style="margin-bottom:var(--space-md);">The most common violation is misclassifying non-exempt employees as exempt. Review each exemption category.</p>
        <div id="exemptionCards"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Wage & Hour Audit Checklist</div>
        <div class="checklist" id="wageChecklist"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Exposure Calculator</div>
        <div class="callout callout-danger" style="margin-bottom:var(--space-md);">
          <strong>Liability Math:</strong> FLSA allows 2 years of back wages (3 years for willful violations) plus equal liquidated damages plus attorney fees. State laws often provide longer lookback periods (California: 4 years).
        </div>
        <div class="calc-card">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-md);">
            <div class="form-group">
              <label class="form-label">Number of affected employees</label>
              <input type="number" class="form-input" id="calcEmployees" value="" min="0" placeholder="e.g. 50" oninput="calculateExposure()">
            </div>
            <div class="form-group">
              <label class="form-label">Average underpayment per hour ($)</label>
              <input type="number" class="form-input" id="calcHourly" value="" min="0" step="0.01" placeholder="e.g. 10" oninput="calculateExposure()">
            </div>
            <div class="form-group">
              <label class="form-label">Overtime hours per week</label>
              <input type="number" class="form-input" id="calcHours" value="" min="0" placeholder="e.g. 10" oninput="calculateExposure()">
            </div>
            <div class="form-group">
              <label class="form-label">Lookback period (weeks)</label>
              <input type="number" class="form-input" id="calcWeeks" value="156" min="0" placeholder="156 (3 years)" oninput="calculateExposure()">
            </div>
          </div>
          <div class="calc-result" id="calcResult" style="display:none;">
            <div style="font-size:13px;color:var(--color-text-secondary);margin-bottom:var(--space-sm);">Estimated Total Exposure (with liquidated damages)</div>
            <div class="calc-result-value" id="calcValue">$0</div>
            <div class="calc-result-label" id="calcBreakdown"></div>
          </div>
        </div>

        <div class="page-nav">
          <button class="btn btn-secondary" onclick="goToPage(4)">&larr; Back</button>
          <button class="btn btn-primary" onclick="goToPage(6)">I-9 Compliance &rarr;</button>
        </div>
      </div>

      <!-- PAGE 6: I-9 -->
      <div class="page" id="page-6">
        <div class="page-header">
          <div class="t-label">Section 6 of 9</div>
          <div class="t-display">I-9 Verification & Immigration</div>
          <p class="t-body t-secondary">Every employer must verify identity and employment authorization for every employee. I-9 compliance is one of the most commonly deficient areas, and penalties have increased significantly.</p>
        </div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">I-9 Penalty Structure (2024 Rates)</div>
        <div id="i9PenaltyCards"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">I-9 Self-Audit Process</div>
        <div class="checklist" id="i9AuditChecklist"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">I-9 Audit Tracker</div>
        <div class="data-table-wrap">
          <table class="data-table" id="i9Table">
            <thead>
              <tr><th>Employee</th><th>Hire Date</th><th>I-9 on File?</th><th>Sec 1 Complete?</th><th>Sec 2 Complete?</th><th>Reverify?</th><th>Deficiency</th><th>Corrected?</th></tr>
            </thead>
            <tbody id="i9Body"></tbody>
          </table>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="addI9Row()">+ Add Employee</button>

        <div class="page-nav">
          <button class="btn btn-secondary" onclick="goToPage(5)">&larr; Back</button>
          <button class="btn btn-primary" onclick="goToPage(7)">EEOC & Anti-Discrimination &rarr;</button>
        </div>
      </div>

      <!-- PAGE 7: EEOC -->
      <div class="page" id="page-7">
        <div class="page-header">
          <div class="t-label">Section 7 of 9</div>
          <div class="t-display">EEOC, Anti-Discrimination & Harassment</div>
          <p class="t-body t-secondary">Title VII, ADA, ADEA, and state equivalents prohibit employment discrimination. Pending claims, complaint patterns, or absent policies are significant red flags for buyers.</p>
        </div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Buyer Diligence Focus Areas</div>
        <p class="t-small t-secondary" style="margin-bottom:var(--space-md);">Score your readiness in each area buyers will scrutinize.</p>
        <div id="eeocScoring"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Pre-Transaction Compliance Actions</div>
        <div class="checklist" id="eeocChecklist"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Pending Claims Log</div>
        <div class="data-table-wrap">
          <table class="data-table" id="claimsTable">
            <thead>
              <tr><th>Claimant</th><th>Claim Type</th><th>Agency/Court</th><th>Date Filed</th><th>Status</th><th>Est. Exposure</th><th>Counsel</th></tr>
            </thead>
            <tbody id="claimsBody"></tbody>
          </table>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="addClaimRow()">+ Add Claim</button>

        <div class="page-nav">
          <button class="btn btn-secondary" onclick="goToPage(6)">&larr; Back</button>
          <button class="btn btn-primary" onclick="goToPage(8)">COBRA & WARN Act &rarr;</button>
        </div>
      </div>

      <!-- PAGE 8: COBRA & WARN -->
      <div class="page" id="page-8">
        <div class="page-header">
          <div class="t-label">Section 8 of 9</div>
          <div class="t-display">COBRA, WARN Act & Transaction Obligations</div>
          <p class="t-body t-secondary">Transaction-specific employment obligations can create significant liability if not properly planned. COBRA violations cost $100/day per person; WARN Act violations cost 60 days of back pay per employee.</p>
        </div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">COBRA Compliance Assessment</div>
        <div id="cobraScoring"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">WARN Act Thresholds</div>
        <div id="warnCards"></div>

        <div class="section-divider"></div>

        <div class="t-h2" style="margin-bottom:var(--space-lg);">Transaction Employment Checklist</div>
        <p class="t-small t-secondary" style="margin-bottom:var(--space-md);">These items must be addressed for any deal structure.</p>
        <div class="checklist" id="transChecklist"></div>

        <div class="section-divider"></div>

        <div class="callout callout-info">
          <strong>Day 1 Readiness:</strong> Create a "Day 1" employment checklist covering offer letters, benefit enrollment, payroll setup, I-9 completion (new I-9 required if asset sale), handbook distribution, and policy acknowledgments. This signals operational maturity and reduces post-close integration risk.
        </div>

        <div class="form-group">
          <label class="form-label">Transaction Employment Notes</label>
          <textarea class="form-input" id="transNotes" rows="4" placeholder="Document your plans for COBRA, WARN, offer letters, service continuity..." oninput="saveState()"></textarea>
        </div>

        <div class="page-nav">
          <button class="btn btn-secondary" onclick="goToPage(7)">&larr; Back</button>
          <button class="btn btn-primary" onclick="goToPage(9)">View Results &rarr;</button>
        </div>
      </div>

      <!-- PAGE 9: Dashboard -->
      <div class="page" id="page-9">
        <div class="page-header">
          <div class="t-label">Your Results</div>
          <div class="t-display">HR Compliance Dashboard</div>
          <p class="t-body t-secondary">A comprehensive view of your employment compliance readiness for a transaction.</p>
        </div>

        <div class="dash-grid" id="dashKPIs"></div>

        <div class="card" style="margin-bottom:var(--space-lg);padding:var(--space-xl);">
          <div class="t-h2" style="margin-bottom:var(--space-lg);">Compliance by Category</div>
          <div class="bar-chart" id="categoryBarChart"></div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-md);margin-bottom:var(--space-lg);">
          <div class="card" style="padding:var(--space-xl);">
            <div class="t-h2" style="margin-bottom:var(--space-lg);">Risk Heat Map</div>
            <div class="heatmap-container"><div class="heatmap" id="riskHeatmap" style="grid-template-columns:120px repeat(7,1fr);"></div></div>
          </div>
          <div class="card" style="padding:var(--space-xl);">
            <div class="t-h2" style="margin-bottom:var(--space-lg);">Priority Actions</div>
            <div id="priorityActions"></div>
          </div>
        </div>

        <div class="card" style="padding:var(--space-xl);">
          <div class="t-h2" style="margin-bottom:var(--space-md);">HR Compliance Score</div>
          <div style="display:flex;align-items:center;gap:var(--space-2xl);">
            <div class="gauge-wrap">
              <svg width="160" height="100" viewBox="0 0 160 100">
                <path d="M 20 90 A 60 60 0 0 1 140 90" fill="none" stroke="#E5E7EB" stroke-width="12" stroke-linecap="round"/>
                <path id="gaugeArc" d="M 20 90 A 60 60 0 0 1 140 90" fill="none" stroke="var(--color-primary)" stroke-width="12" stroke-linecap="round" stroke-dasharray="0 188.5"/>
              </svg>
              <div class="gauge-value" id="gaugeValue" style="margin-top:-20px;">--</div>
              <div class="gauge-label" style="font-size:13px;font-weight:600;color:var(--color-text-secondary);">out of 100</div>
            </div>
            <div style="flex:1;">
              <div id="scoreInterpretation" class="t-body t-secondary" style="margin-bottom:var(--space-md);"></div>
              <div id="scoreRecommendation"></div>
            </div>
          </div>
        </div>

        <div class="callout callout-accent" style="margin-top:var(--space-lg);">
          <strong>Final Thought:</strong> "Employment compliance is not a cost center -- it is deal insurance. Every dollar spent on compliance before a transaction saves ten dollars in price adjustments after."
        </div>

        <div class="page-nav">
          <button class="btn btn-secondary" onclick="goToPage(8)">&larr; Back</button>
          <button class="btn btn-accent" onclick="exportResults()">Export Summary</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast" aria-live="polite" role="status"></div>

<script>
/* ============================================================
   STATE
   ============================================================ */
const STORAGE_KEY = 'exitosx-pb22-hr-compliance';
// Migrate from old key
(function() { try { const old = localStorage.getItem('playbook22_hr_compliance'); if (old && !localStorage.getItem('exitosx-pb22-hr-compliance')) { localStorage.setItem('exitosx-pb22-hr-compliance', old); localStorage.removeItem('playbook22_hr_compliance'); } } catch(e) {} })();
let state = loadState();

function defaultState() {
  return {
    currentPage: 0,
    complianceRisk: {},
    misclassChecklist: {},
    classRows: [],
    handbookScores: {},
    handbookChecklist: {},
    retirementScores: {},
    healthChecklist: {},
    benefitRows: [],
    wageChecklist: {},
    calcEmployees: '', calcHourly: '', calcHours: '', calcWeeks: '156',
    i9Checklist: {},
    i9Rows: [],
    eeocScores: {},
    eeocChecklist: {},
    claimRows: [],
    cobraScores: {},
    transChecklist: {},
    transNotes: '',
    completedPages: [],
  };
}

function loadState() {
  try { const s = localStorage.getItem(STORAGE_KEY); return s ? {...defaultState(), ...JSON.parse(s)} : defaultState(); }
  catch(e) { return defaultState(); }
}

function saveState() {
  state.transNotes = document.getElementById('transNotes')?.value || state.transNotes;
  const ce = document.getElementById('calcEmployees');
  if (ce) { state.calcEmployees = ce.value; state.calcHourly = document.getElementById('calcHourly').value; state.calcHours = document.getElementById('calcHours').value; state.calcWeeks = document.getElementById('calcWeeks').value; }
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {}
  updateProgress();
  updateSidebarScore();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

/* ============================================================
   NAVIGATION
   ============================================================ */
const PAGES = [
  { id: 'welcome', label: 'Welcome', icon: '&#9679;' },
  { id: 'why', label: 'Why It Matters', icon: '&#9670;' },
  { id: 'classification', label: 'Worker Classification', icon: '&#9670;' },
  { id: 'handbook', label: 'Handbook & Policies', icon: '&#9670;' },
  { id: 'benefits', label: 'Benefits & ERISA', icon: '&#9670;' },
  { id: 'wage', label: 'Wage & Hour', icon: '&#9670;' },
  { id: 'i9', label: 'I-9 Compliance', icon: '&#9670;' },
  { id: 'eeoc', label: 'EEOC & Discrimination', icon: '&#9670;' },
  { id: 'cobra-warn', label: 'COBRA & WARN Act', icon: '&#9670;' },
  { id: 'dashboard', label: 'Dashboard', icon: '&#9632;' },
];

function buildSidebar() {
  const nav = document.getElementById('sidebarNav');
  nav.innerHTML = '<div class="nav-section-label">Assessment</div>';
  PAGES.forEach((p, i) => {
    const item = document.createElement('div');
    item.className = 'nav-item' + (i === state.currentPage ? ' active' : '') + (state.completedPages.includes(i) ? ' completed' : '');
    item.setAttribute('role', 'button'); item.setAttribute('tabindex', '0');
    item.innerHTML = `<span class="nav-icon">${p.icon}</span><span>${p.label}</span><span class="nav-check"><svg viewBox="0 0 12 12"><polyline points="2,6 5,9 10,3"/></svg></span>`;
    item.onclick = () => goToPage(i);
    item.onkeydown = (e) => { if(e.key==='Enter'||e.key===' ') { e.preventDefault(); goToPage(i); }};
    nav.appendChild(item);
  });
}

function goToPage(idx) {
  if (state.currentPage > 0 && state.currentPage < 9 && !state.completedPages.includes(state.currentPage)) {
    state.completedPages.push(state.currentPage);
  }
  state.currentPage = idx;
  document.querySelectorAll('.page').forEach((p, i) => p.classList.toggle('active', i === idx));
  buildSidebar(); saveState(); window.scrollTo(0, 0);
  if (idx === 9) renderDashboard();
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show');
  // Focus management
  setTimeout(() => { const page = document.querySelectorAll('.page')[idx]; if (page) { const heading = page.querySelector('h1, h2, .t-display'); if (heading) { heading.setAttribute('tabindex', '-1'); heading.focus(); } } }, 100);
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
}

function updateProgress() {
  const total = 8;
  const done = state.completedPages.filter(p => p >= 1 && p <= 8).length;
  const pct = Math.round((done / total) * 100);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = pct + '% complete';
}

/* ============================================================
   SCORING
   ============================================================ */
function calculateOverallScore() {
  let scores = [];
  const addAvg = (obj, max) => { const v = Object.values(obj).filter(x => typeof x === 'number'); if (v.length) scores.push((v.reduce((s,x)=>s+x,0) / (v.length * max)) * 100); };
  addAvg(state.complianceRisk, 5);
  addAvg(state.handbookScores, 5);
  addAvg(state.retirementScores, 5);
  addAvg(state.eeocScores, 5);
  addAvg(state.cobraScores, 5);
  // Checklists
  const clTotal = [state.misclassChecklist, state.handbookChecklist, state.healthChecklist, state.wageChecklist, state.i9Checklist, state.eeocChecklist, state.transChecklist];
  const checked = clTotal.reduce((s, c) => s + Object.values(c).filter(Boolean).length, 0);
  const maxCl = 45; // approximate
  if (checked > 0) scores.push((checked / maxCl) * 100);
  if (scores.length === 0) return null;
  return Math.round(scores.reduce((s,v) => s+v, 0) / scores.length);
}

function updateSidebarScore() {
  const score = calculateOverallScore();
  const el = document.getElementById('sidebarScore');
  const desc = document.getElementById('sidebarScoreDesc');
  if (score === null) {
    el.innerHTML = '--<span class="sidebar-score-max">/100</span>';
    desc.textContent = 'Complete assessments to see your score';
  } else {
    el.innerHTML = score + '<span class="sidebar-score-max">/100</span>';
    if (score >= 80) desc.textContent = 'Strong -- minimal risk';
    else if (score >= 60) desc.textContent = 'Moderate -- some remediation needed';
    else if (score >= 40) desc.textContent = 'Below average -- significant gaps';
    else desc.textContent = 'Critical -- urgent attention needed';
  }
}

/* ============================================================
   GENERIC HELPERS
   ============================================================ */
function selectScore(selector, option) {
  const key = selector.dataset.key;
  const store = selector.dataset.store;
  const val = parseInt(option.querySelector('input').value);
  state[store][key] = val;
  selector.querySelectorAll('.score-option').forEach(o => { o.classList.remove('selected'); o.setAttribute('aria-checked', 'false'); });
  option.classList.add('selected'); option.setAttribute('aria-checked', 'true');
  const badge = selector.closest('.card')?.querySelector('.badge');
  if (badge) { badge.className = 'badge ' + (val >= 4 ? 'badge-success' : val >= 3 ? 'badge-warning' : 'badge-danger'); badge.textContent = val + '/5'; }
  saveState();
}

function buildScoreCards(container, dims, store) {
  container.innerHTML = '';
  dims.forEach(dim => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-sm);">
        <div class="t-h3">${dim.label}</div>
        <span class="badge ${state[store][dim.key] ? (state[store][dim.key] >= 4 ? 'badge-success' : state[store][dim.key] >= 3 ? 'badge-warning' : 'badge-danger') : 'badge-neutral'}">${state[store][dim.key] ? state[store][dim.key] + '/5' : 'Not scored'}</span>
      </div>
      ${dim.desc ? `<p class="t-small t-secondary" style="margin-bottom:var(--space-sm);">${dim.desc}</p>` : ''}
      <div class="score-selector" data-key="${dim.key}" data-store="${store}" role="radiogroup" aria-label="${dim.label}">
        ${[1,2,3,4,5].map(n => `<label class="score-option s${n} ${state[store][dim.key] === n ? 'selected' : ''}" tabindex="0" role="radio" aria-checked="${state[store][dim.key] === n}"><input type="radio" name="${store}_${dim.key}" value="${n}" ${state[store][dim.key] === n ? 'checked' : ''}><span class="score-number">${n}</span><span class="score-label-text">${['Critical','Poor','Fair','Good','Strong'][n-1]}</span></label>`).join('')}
      </div>`;
    container.appendChild(card);
  });
  container.querySelectorAll('.score-selector').forEach(sel => {
    sel.querySelectorAll('.score-option').forEach(opt => {
      opt.onclick = () => selectScore(sel, opt);
      opt.onkeydown = (e) => { if(e.key==='Enter'||e.key===' ') { e.preventDefault(); selectScore(sel, opt); }};
    });
  });
}

function buildChecklist(containerId, items, storeKey) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'checklist-item' + (state[storeKey][item.key] ? ' checked' : '');
    div.onclick = () => { state[storeKey][item.key] = !state[storeKey][item.key]; saveState(); buildChecklist(containerId, items, storeKey); };
    div.innerHTML = `<div class="checklist-box"><svg viewBox="0 0 12 12"><polyline points="2,6 5,9 10,3"/></svg></div><div><div class="checklist-text">${item.text}</div>${item.detail ? `<div class="checklist-detail">${item.detail}</div>` : ''}</div>`;
    container.appendChild(div);
  });
}

/* ============================================================
   PAGE 1: Compliance Risk
   ============================================================ */
const COMPLIANCE_DIMS = [
  { key: 'misclass', label: 'Worker Misclassification (W-2 vs 1099)', desc: 'Back taxes + penalties + potential class action' },
  { key: 'wage_hour', label: 'Wage & Hour Violations', desc: '2-3 years back pay + liquidated damages + attorney fees' },
  { key: 'i9', label: 'I-9 Deficiencies', desc: '$252-$2,507 per employee; pattern violations higher' },
  { key: 'erisa', label: 'ERISA Plan Violations', desc: 'IRS/DOL penalties; plan disqualification; excise taxes' },
  { key: 'warn', label: 'WARN Act Compliance', desc: '60 days back pay + benefits for each affected employee' },
  { key: 'discrimination', label: 'Discrimination / Harassment Claims', desc: 'Statutory damages, punitive damages, reputation risk' },
  { key: 'files', label: 'Incomplete Employee Files', desc: 'Inference of non-compliance; inability to defend claims' },
  { key: 'noncompete', label: 'Non-Compete Enforceability', desc: 'Key employees may be free to compete post-close' },
];

/* ============================================================
   PAGE 2: Classification
   ============================================================ */
function buildClassificationTests() {
  const tests = [
    { name: 'IRS 20-Factor Test / Common Law', by: 'IRS (SS-8 determinations)', factors: 'Behavioral control, financial control, relationship type', standard: 'Totality of circumstances' },
    { name: 'Economic Reality Test', by: 'DOL (FLSA enforcement)', factors: 'Economic dependence; opportunity for profit/loss; permanence', standard: 'Is the worker economically dependent?' },
    { name: 'ABC Test', by: 'California (AB 5), NJ, MA, IL, others', factors: '(A) Free from control, (B) Outside usual course of business, (C) Independent trade', standard: 'All three prongs must be met' },
    { name: 'Right-to-Control Test', by: 'Most states (common law)', factors: 'Degree of control over manner and means', standard: 'Greater control = more likely employee' },
    { name: 'IRS Section 530 Safe Harbor', by: 'IRS', factors: 'Reasonable basis; consistent treatment; timely filing', standard: 'Retroactive relief from reclassification' },
  ];
  const container = document.getElementById('classificationTests');
  container.innerHTML = '';
  tests.forEach(t => {
    const div = document.createElement('div');
    div.className = 'expandable';
    div.innerHTML = `
      <div class="expandable-header" onclick="this.parentElement.classList.toggle('open')">
        <span>${t.name}</span>
        <span class="expandable-chevron">&#9660;</span>
      </div>
      <div class="expandable-body">
        <div style="margin-bottom:var(--space-sm);"><span class="t-label">Applied By</span><p class="t-small" style="margin-top:4px;">${t.by}</p></div>
        <div style="margin-bottom:var(--space-sm);"><span class="t-label">Key Factors</span><p class="t-small" style="margin-top:4px;">${t.factors}</p></div>
        <div><span class="t-label">Standard</span><p class="t-small" style="margin-top:4px;">${t.standard}</p></div>
      </div>`;
    container.appendChild(div);
  });
}

const MISCLASS_ITEMS = [
  { key: 'exclusive', text: 'Worker performs services exclusively or primarily for your company' },
  { key: 'control', text: 'Company controls when, where, and how the work is performed' },
  { key: 'tools', text: 'Company provides tools, equipment, or workspace' },
  { key: 'schedule', text: 'Worker is paid on a regular schedule rather than by project' },
  { key: 'no_entity', text: 'Worker does not have their own business entity, insurance, or other clients' },
  { key: 'duration', text: 'Relationship has lasted more than 12 months continuously' },
  { key: 'same_work', text: 'Worker performs the same type of work as W-2 employees' },
  { key: 'no_agreement', text: 'Worker does not have a written independent contractor agreement' },
];

function buildMisclassChecklist() {
  buildChecklist('misclassChecklist', MISCLASS_ITEMS, 'misclassChecklist');
  const checked = Object.values(state.misclassChecklist).filter(Boolean).length;
  if (checked >= 3) {
    const warn = document.createElement('div');
    warn.className = 'callout callout-danger'; warn.style.marginTop = 'var(--space-md)';
    warn.innerHTML = `<strong>${checked} of 8 risk factors identified.</strong> This level of risk strongly suggests misclassification. Consult employment counsel immediately. Consider the IRS Voluntary Classification Settlement Program (VCSP) for reduced penalties.`;
    document.getElementById('misclassChecklist').appendChild(warn);
  }
}

function renderClassTable() {
  const body = document.getElementById('classAuditBody');
  body.innerHTML = '';
  state.classRows.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${row.name||''}" oninput="state.classRows[${i}].name=this.value;saveState();" placeholder="Name"></td>
      <td><select onchange="state.classRows[${i}].classification=this.value;saveState();"><option value="">--</option><option ${row.classification==='W-2'?'selected':''}>W-2</option><option ${row.classification==='1099'?'selected':''}>1099</option></select></td>
      <td><select onchange="state.classRows[${i}].irsFactors=this.value;saveState();"><option value="">--</option><option ${row.irsFactors==='Pass'?'selected':''}>Pass</option><option ${row.irsFactors==='Fail'?'selected':''}>Fail</option><option ${row.irsFactors==='Unclear'?'selected':''}>Unclear</option></select></td>
      <td><select onchange="state.classRows[${i}].abcTest=this.value;saveState();"><option value="">--</option><option ${row.abcTest==='Pass'?'selected':''}>Pass</option><option ${row.abcTest==='Fail'?'selected':''}>Fail</option><option ${row.abcTest==='N/A'?'selected':''}>N/A</option></select></td>
      <td><select onchange="state.classRows[${i}].risk=this.value;saveState();"><option value="">--</option><option ${row.risk==='Low'?'selected':''}>Low</option><option ${row.risk==='Medium'?'selected':''}>Medium</option><option ${row.risk==='High'?'selected':''}>High</option></select></td>
      <td><input value="${row.action||''}" oninput="state.classRows[${i}].action=this.value;saveState();" placeholder="Reclassify / Restructure"></td>`;
    body.appendChild(tr);
  });
}

function addClassRow() { state.classRows.push({}); saveState(); renderClassTable(); }

/* ============================================================
   PAGE 3: Handbook
   ============================================================ */
const HANDBOOK_DIMS = [
  { key: 'eeo', label: 'Equal Employment Opportunity', desc: 'Non-discrimination statement covering all protected classes (Title VII; ADA; ADEA)' },
  { key: 'harassment', label: 'Anti-Harassment / Anti-Retaliation', desc: 'Reporting procedures; investigation process; no-retaliation commitment' },
  { key: 'fmla', label: 'Family & Medical Leave', desc: 'Eligibility; notice requirements; job restoration rights (50+ employees)' },
  { key: 'ada', label: 'Americans with Disabilities Act', desc: 'Reasonable accommodation process; interactive dialogue (15+ employees)' },
  { key: 'at_will', label: 'At-Will Employment', desc: 'Clear statement; no implied contract language elsewhere in handbook' },
  { key: 'wage_policies', label: 'Wage & Hour Policies', desc: 'Pay periods; overtime rules; timekeeping; meal and rest breaks' },
  { key: 'leave', label: 'Leave Policies', desc: 'Sick leave, vacation, PTO accrual and payout (vary by state)' },
  { key: 'social_media', label: 'Social Media / Electronic Communications', desc: 'Cannot restrict protected concerted activity (NLRA 7); balance with confidentiality' },
  { key: 'drug', label: 'Drug & Alcohol Policy', desc: 'Testing procedures; accommodation for medical marijuana (state-dependent)' },
  { key: 'safety', label: 'Workplace Safety', desc: 'OSHA reporting obligations; safety procedures; anti-retaliation' },
];

const HANDBOOK_CL_ITEMS = [
  { key: 'reviewed', text: 'Handbook reviewed by employment counsel within past 12 months' },
  { key: 'signed', text: 'All employees have signed an acknowledgment of receipt' },
  { key: 'multistate', text: 'Handbook complies with laws of every state where employees are located' },
  { key: 'at_will', text: 'At-will disclaimer is prominent and not contradicted by other language' },
  { key: 'harassment_channels', text: 'Anti-harassment policy includes multiple reporting channels' },
  { key: 'fmla_current', text: 'FMLA and state leave policies are accurate and current' },
  { key: 'meal_break', text: 'Meal and rest break policies comply with state requirements' },
  { key: 'noncompete', text: 'Handbook does not contain unenforceable non-compete language' },
  { key: 'remote', text: 'Handbook addresses remote work policies' },
];

/* ============================================================
   PAGE 4: Benefits
   ============================================================ */
const RETIREMENT_DIMS = [
  { key: 'plan_doc', label: 'Plan Document & Amendments', desc: 'Plan restated for recent law changes (EPCRS correction program available)' },
  { key: 'form_5500', label: 'Annual Reporting (Form 5500)', desc: 'Filed timely; DOL DFVCP available for delinquent filers' },
  { key: 'ndt', label: 'Non-Discrimination Testing', desc: 'ADP/ACP tests passed; corrective distributions if needed' },
  { key: 'contributions', label: 'Timely Deposit of Contributions', desc: 'Most common violation; DOL VFCP available for correction' },
  { key: 'spd', label: 'Summary Plan Description', desc: 'Distributed to all participants; current version on file' },
  { key: 'fiduciary', label: 'Fiduciary Compliance', desc: 'Investment policy adopted; fees benchmarked and reasonable' },
  { key: 'loans', label: 'Participant Loan Compliance', desc: 'Loans within limits; terms properly documented' },
];

const HEALTH_CL_ITEMS = [
  { key: 'aca', text: 'ACA Employer Mandate compliance confirmed (50+ FTE)', detail: 'Must offer minimum essential coverage or face $2,970/employee/year penalty (2024)' },
  { key: 'cobra', text: 'COBRA continuation coverage offered for qualifying events', detail: '20+ employees; 18-36 months coverage; $100/day excise tax for missed notices' },
  { key: 'hipaa', text: 'HIPAA privacy notice distributed; privacy officer designated', detail: 'Business associate agreements in place with all PHI-handling vendors' },
  { key: 'sec125', text: 'Section 125 plans compliant (FSA, HSA, HRA)', detail: 'Plan documents current; non-discrimination testing completed annually' },
];

function renderBenefitTable() {
  const body = document.getElementById('benefitBody');
  body.innerHTML = '';
  state.benefitRows.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${row.name||''}" oninput="state.benefitRows[${i}].name=this.value;saveState();" placeholder="Plan name"></td>
      <td><select onchange="state.benefitRows[${i}].type=this.value;saveState();"><option value="">--</option>${['401(k)','Pension','Profit-Sharing','Health','Dental','Life','Disability','FSA','HSA'].map(t=>`<option ${row.type===t?'selected':''}>${t}</option>`).join('')}</select></td>
      <td><select onchange="state.benefitRows[${i}].f5500=this.value;saveState();"><option value="">--</option><option ${row.f5500==='Yes'?'selected':''}>Yes</option><option ${row.f5500==='No'?'selected':''}>No</option></select></td>
      <td><select onchange="state.benefitRows[${i}].spd=this.value;saveState();"><option value="">--</option><option ${row.spd==='Yes'?'selected':''}>Yes</option><option ${row.spd==='No'?'selected':''}>No</option></select></td>
      <td><select onchange="state.benefitRows[${i}].ndt=this.value;saveState();"><option value="">--</option><option ${row.ndt==='Pass'?'selected':''}>Pass</option><option ${row.ndt==='Fail'?'selected':''}>Fail</option><option ${row.ndt==='N/A'?'selected':''}>N/A</option></select></td>
      <td><input value="${row.deficiency||''}" oninput="state.benefitRows[${i}].deficiency=this.value;saveState();" placeholder="Describe"></td>
      <td><select onchange="state.benefitRows[${i}].status=this.value;saveState();"><option value="">--</option><option ${row.status==='Compliant'?'selected':''}>Compliant</option><option ${row.status==='Needs Correction'?'selected':''}>Needs Correction</option><option ${row.status==='In Progress'?'selected':''}>In Progress</option></select></td>`;
    body.appendChild(tr);
  });
}

function addBenefitRow() { state.benefitRows.push({}); saveState(); renderBenefitTable(); }

/* ============================================================
   PAGE 5: Wage & Hour
   ============================================================ */
function buildExemptionCards() {
  const exemptions = [
    { name: 'Executive', salary: '$684/week ($35,568/year)', duties: 'Manages enterprise/department; directs 2+ employees; hiring/firing authority', misclass: 'Assistant managers who do not actually direct others' },
    { name: 'Administrative', salary: '$684/week ($35,568/year)', duties: 'Office/non-manual work; exercises discretion and independent judgment', misclass: 'Administrative assistants; bookkeepers who follow procedures' },
    { name: 'Professional (Learned)', salary: '$684/week ($35,568/year)', duties: 'Advanced knowledge in science or learning; prolonged specialized instruction', misclass: 'IT workers without advanced degree; paralegals' },
    { name: 'Professional (Creative)', salary: '$684/week ($35,568/year)', duties: 'Invention, imagination, originality in recognized creative field', misclass: 'Marketing coordinators; junior designers' },
    { name: 'Computer Employee', salary: '$684/week or $27.63/hour', duties: 'Systems analyst, programmer, software engineer; specific computer duties', misclass: 'Help desk; hardware technicians' },
    { name: 'Outside Sales', salary: 'No salary requirement', duties: 'Customarily engaged away from employer premises; primary duty is sales', misclass: 'Inside sales reps called "outside sales"' },
    { name: 'Highly Compensated', salary: '$107,432/year', duties: 'Performs at least one exempt duty; total comp exceeds threshold', misclass: 'High-earning production workers' },
  ];
  const container = document.getElementById('exemptionCards');
  container.innerHTML = '';
  exemptions.forEach(e => {
    const div = document.createElement('div');
    div.className = 'expandable';
    div.innerHTML = `
      <div class="expandable-header" onclick="this.parentElement.classList.toggle('open')">
        <div style="display:flex;align-items:center;gap:var(--space-md);"><span>${e.name}</span><span class="badge badge-neutral">${e.salary}</span></div>
        <span class="expandable-chevron">&#9660;</span>
      </div>
      <div class="expandable-body">
        <div style="margin-bottom:var(--space-sm);"><span class="t-label">Duties Test</span><p class="t-small" style="margin-top:4px;">${e.duties}</p></div>
        <div><span class="t-label" style="color:var(--color-danger);">Common Misclassification</span><p class="t-small" style="margin-top:4px;color:var(--color-danger);">${e.misclass}</p></div>
      </div>`;
    container.appendChild(div);
  });
}

const WAGE_CL_ITEMS = [
  { key: 'exempt_test', text: 'All exempt employees meet both salary AND duties tests' },
  { key: 'overtime', text: 'Overtime calculated correctly (1.5x regular rate, including bonuses/commissions)' },
  { key: 'timekeeping', text: 'Non-exempt employees accurately record all hours (no off-the-clock work)' },
  { key: 'meal_break', text: 'Meal and rest break policies comply with state law' },
  { key: 'final_pay', text: 'Final paycheck timing complies with state law' },
  { key: 'min_wage', text: 'Minimum wage compliance verified for all states and localities' },
  { key: 'pay_stub', text: 'Pay stub requirements met (vary by state)' },
  { key: 'tip_credit', text: 'Tip credit and tip pooling comply with FLSA and state law (if applicable)' },
  { key: 'commission', text: 'Commission agreements are in writing (required in CA, NY, MA)' },
  { key: 'deductions', text: 'No unauthorized deductions from wages' },
];

function calculateExposure() {
  const emp = parseFloat(document.getElementById('calcEmployees').value) || 0;
  const hourly = parseFloat(document.getElementById('calcHourly').value) || 0;
  const hours = parseFloat(document.getElementById('calcHours').value) || 0;
  const weeks = parseFloat(document.getElementById('calcWeeks').value) || 0;
  const result = document.getElementById('calcResult');
  if (emp > 0 && hourly > 0 && hours > 0 && weeks > 0) {
    const backWages = emp * hourly * hours * weeks;
    const total = backWages * 2; // liquidated damages
    result.style.display = 'block';
    document.getElementById('calcValue').textContent = '$' + total.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    document.getElementById('calcBreakdown').textContent = `Back wages: $${backWages.toLocaleString()} x 2 (liquidated damages) = $${total.toLocaleString()} (plus attorney fees)`;
  } else {
    result.style.display = 'none';
  }
  saveState();
}

/* ============================================================
   PAGE 6: I-9
   ============================================================ */
function buildI9PenaltyCards() {
  const penalties = [
    { type: 'Paperwork Violations (technical errors)', first: '$252 - $2,507/I-9', second: '$252 - $2,507/I-9', third: '$252 - $2,507/I-9' },
    { type: 'Substantive Violations (failure to complete)', first: '$252 - $2,507/I-9', second: '$252 - $2,507/I-9', third: '$252 - $2,507/I-9' },
    { type: 'Knowingly Hiring Unauthorized Worker', first: '$627 - $5,016/worker', second: '$5,016 - $12,537', third: '$7,523 - $25,076' },
    { type: 'Document Fraud', first: '$529 - $4,228/doc', second: '$4,228 - $10,570', third: '$6,341 - $21,137' },
    { type: 'Pattern and Practice', first: 'Criminal: up to $3,000/worker + 6 months', second: '', third: '' },
  ];
  const container = document.getElementById('i9PenaltyCards');
  container.innerHTML = '';
  penalties.forEach(p => {
    const card = document.createElement('div');
    card.className = 'card';
    const isPattern = p.type === 'Pattern and Practice';
    card.innerHTML = `
      <div class="t-h3" style="margin-bottom:var(--space-sm);">${p.type}</div>
      <div style="display:grid;grid-template-columns:${isPattern ? '1fr' : 'repeat(3,1fr)'};gap:var(--space-sm);">
        <div style="text-align:center;padding:var(--space-sm);background:var(--color-surface-alt);border-radius:var(--radius-sm);">
          <div class="t-caption" style="margin-bottom:2px;">1st Offense</div>
          <div class="t-small" style="font-weight:600;color:var(--color-danger);">${p.first}</div>
        </div>
        ${!isPattern ? `<div style="text-align:center;padding:var(--space-sm);background:var(--color-surface-alt);border-radius:var(--radius-sm);">
          <div class="t-caption" style="margin-bottom:2px;">2nd Offense</div>
          <div class="t-small" style="font-weight:600;color:var(--color-danger);">${p.second}</div>
        </div>
        <div style="text-align:center;padding:var(--space-sm);background:var(--color-surface-alt);border-radius:var(--radius-sm);">
          <div class="t-caption" style="margin-bottom:2px;">3rd+ Offense</div>
          <div class="t-small" style="font-weight:600;color:var(--color-danger);">${p.third}</div>
        </div>` : ''}
      </div>`;
    container.appendChild(card);
  });
}

const I9_CL_ITEMS = [
  { key: 'inventory', text: 'Step 1: Pull I-9 for every current employee', detail: 'Verify Section 1 (employee) and Section 2 (employer) are complete.' },
  { key: 'errors', text: 'Step 2: Identify errors', detail: 'Missing I-9s, incomplete sections, expired documents, technical errors.' },
  { key: 'correct', text: 'Step 3: Correct errors', detail: 'New entry dated today (never backdate). Attach explanation note.' },
  { key: 'legal', text: 'Step 4: Legal review', detail: 'Consult immigration counsel before any termination based on I-9 deficiencies.' },
  { key: 'on_file', text: 'All current employees have completed I-9 forms on file' },
  { key: 'separate', text: 'I-9 forms stored separately from personnel files' },
  { key: 'reverify', text: 'Reverification current for temporary work authorization' },
  { key: 'retention', text: 'I-9 retention schedule followed (3 years from hire or 1 year from termination)' },
  { key: 'everify', text: 'E-Verify compliance confirmed (if required)' },
];

function renderI9Table() {
  const body = document.getElementById('i9Body');
  body.innerHTML = '';
  state.i9Rows.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${row.name||''}" oninput="state.i9Rows[${i}].name=this.value;saveState();" placeholder="Name"></td>
      <td><input type="date" value="${row.hireDate||''}" oninput="state.i9Rows[${i}].hireDate=this.value;saveState();"></td>
      <td><select onchange="state.i9Rows[${i}].onFile=this.value;saveState();"><option value="">--</option><option ${row.onFile==='Yes'?'selected':''}>Yes</option><option ${row.onFile==='No'?'selected':''}>No</option></select></td>
      <td><select onchange="state.i9Rows[${i}].sec1=this.value;saveState();"><option value="">--</option><option ${row.sec1==='Yes'?'selected':''}>Yes</option><option ${row.sec1==='No'?'selected':''}>No</option></select></td>
      <td><select onchange="state.i9Rows[${i}].sec2=this.value;saveState();"><option value="">--</option><option ${row.sec2==='Yes'?'selected':''}>Yes</option><option ${row.sec2==='No'?'selected':''}>No</option></select></td>
      <td><select onchange="state.i9Rows[${i}].reverify=this.value;saveState();"><option value="">--</option><option ${row.reverify==='Yes'?'selected':''}>Yes</option><option ${row.reverify==='No'?'selected':''}>No</option><option ${row.reverify==='N/A'?'selected':''}>N/A</option></select></td>
      <td><input value="${row.deficiency||''}" oninput="state.i9Rows[${i}].deficiency=this.value;saveState();" placeholder="Describe"></td>
      <td><select onchange="state.i9Rows[${i}].corrected=this.value;saveState();"><option value="">--</option><option ${row.corrected==='Yes'?'selected':''}>Yes</option><option ${row.corrected==='No'?'selected':''}>No</option></select></td>`;
    body.appendChild(tr);
  });
}

function addI9Row() { state.i9Rows.push({}); saveState(); renderI9Table(); }

/* ============================================================
   PAGE 7: EEOC
   ============================================================ */
const EEOC_DIMS = [
  { key: 'pending', label: 'Pending Claims History', desc: 'EEOC charges, state complaints, and lawsuits (past 5 years)' },
  { key: 'settlements', label: 'Settlement History', desc: 'Employment-related settlements and severance agreements' },
  { key: 'training', label: 'Training Records', desc: 'Anti-harassment and anti-discrimination training logs' },
  { key: 'investigations', label: 'Complaint Investigations', desc: 'Internal complaint files; investigation reports; written findings' },
  { key: 'eeo1', label: 'EEO-1 Reports', desc: 'Filed for 100+ employees or federal contractors' },
  { key: 'accommodation', label: 'ADA Accommodation Records', desc: 'Interactive process documentation; no blanket denials' },
  { key: 'pay_equity', label: 'Pay Equity Analysis', desc: 'Compensation analysis by gender, race, age for comparable roles' },
];

const EEOC_CL_ITEMS = [
  { key: 'training_current', text: 'Anti-harassment training current for all employees and managers', detail: 'CA: 2hr supervisors, 1hr all, every 2 years. NY: annual. IL, CT, DE, ME have requirements.' },
  { key: 'pay_audit', text: 'Pay equity audit conducted by outside counsel (privileged)', detail: 'Several states now require pay transparency and/or equity audits.' },
  { key: 'resolve_pending', text: 'All pending EEOC charges and complaints resolved', detail: 'Unresolved claims create uncertainty buyers price into the deal.' },
  { key: 'policy_review', text: 'Written anti-harassment policy with complaint procedure', detail: 'Multiple reporting channels; no-retaliation policy; documented investigation process.' },
];

function renderClaimsTable() {
  const body = document.getElementById('claimsBody');
  body.innerHTML = '';
  state.claimRows.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${row.claimant||''}" oninput="state.claimRows[${i}].claimant=this.value;saveState();" placeholder="Name"></td>
      <td><select onchange="state.claimRows[${i}].type=this.value;saveState();"><option value="">--</option>${['Discrimination','Harassment','Wage/Hour','Retaliation','ADA','ADEA','Other'].map(t=>`<option ${row.type===t?'selected':''}>${t}</option>`).join('')}</select></td>
      <td><input value="${row.agency||''}" oninput="state.claimRows[${i}].agency=this.value;saveState();" placeholder="EEOC / State / Court"></td>
      <td><input type="date" value="${row.date||''}" oninput="state.claimRows[${i}].date=this.value;saveState();"></td>
      <td><select onchange="state.claimRows[${i}].status=this.value;saveState();"><option value="">--</option>${['Open','Settled','Dismissed','In Litigation'].map(t=>`<option ${row.status===t?'selected':''}>${t}</option>`).join('')}</select></td>
      <td><input value="${row.exposure||''}" oninput="state.claimRows[${i}].exposure=this.value;saveState();" placeholder="$"></td>
      <td><input value="${row.counsel||''}" oninput="state.claimRows[${i}].counsel=this.value;saveState();" placeholder="Firm / Attorney"></td>`;
    body.appendChild(tr);
  });
}

function addClaimRow() { state.claimRows.push({}); saveState(); renderClaimsTable(); }

/* ============================================================
   PAGE 8: COBRA & WARN
   ============================================================ */
const COBRA_DIMS = [
  { key: 'notice_process', label: 'COBRA Notice Process', desc: 'Initial, qualifying event, and election notices sent timely' },
  { key: 'admin', label: 'COBRA Administration', desc: 'Qualified beneficiaries tracked; premiums collected; coverage maintained' },
  { key: 'transaction', label: 'Transaction COBRA Planning', desc: 'Stock vs. asset sale obligations mapped; coverage continuity planned' },
];

function buildWarnCards() {
  const triggers = [
    { type: 'Plant Closing', threshold: '50+ employees at single site', notice: '60 days written', penalty: 'Back pay + benefits for up to 60 days per employee' },
    { type: 'Mass Layoff (33% Rule)', threshold: '50+ employees AND 33%+ of workforce', notice: '60 days written', penalty: 'Back pay + benefits for up to 60 days per employee' },
    { type: 'Mass Layoff (500 Rule)', threshold: '500+ employees at single site', notice: '60 days written', penalty: 'Back pay + benefits for up to 60 days per employee' },
    { type: 'State Mini-WARN Laws', threshold: 'Varies (CA: 75; NY: 25; NJ: 100)', notice: 'Varies (CA: 60 days; NY: 90 days)', penalty: 'Varies; often more severe than federal' },
  ];
  const container = document.getElementById('warnCards');
  container.innerHTML = '';
  triggers.forEach(t => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="t-h3" style="margin-bottom:var(--space-sm);">${t.type}</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-sm);">
        <div><span class="t-label">Threshold</span><p class="t-small" style="margin-top:4px;">${t.threshold}</p></div>
        <div><span class="t-label">Notice Required</span><p class="t-small" style="margin-top:4px;">${t.notice}</p></div>
        <div><span class="t-label">Penalty</span><p class="t-small" style="margin-top:4px;color:var(--color-danger);">${t.penalty}</p></div>
      </div>`;
    container.appendChild(card);
  });
}

const TRANS_CL_ITEMS = [
  { key: 'offer_letters', text: 'Offer letters prepared for asset sale (employment continuity for stock sale)', detail: 'Asset sale requires buyer to make new offers; WARN may trigger if not hiring substantially all.' },
  { key: 'accrued', text: 'Accrued benefits treatment determined (vacation, sick, PTO)', detail: 'California requires payout of accrued vacation upon termination.' },
  { key: 'service', text: 'Service continuity credit plan established', detail: 'For FMLA eligibility, benefit vesting, vacation accrual, seniority.' },
  { key: 'severance', text: 'Severance agreements with adequate release language prepared', detail: 'ADEA: 21-day consideration + 7-day revocation for individuals; 45 days for groups.' },
  { key: 'day1', text: 'Day 1 Readiness checklist created', detail: 'Offer letters, benefit enrollment, payroll, I-9, handbook distribution, policy acknowledgments.' },
  { key: 'cobra_plan', text: 'COBRA transition plan documented', detail: 'Stock sale: buyer assumes. Asset sale: seller generally retains pre-close obligations.' },
  { key: 'warn_analysis', text: 'WARN Act analysis completed for anticipated headcount changes' },
];

/* ============================================================
   PAGE 9: Dashboard
   ============================================================ */
function renderDashboard() {
  const score = calculateOverallScore() || 0;

  // KPIs
  const kpis = document.getElementById('dashKPIs');
  const misclassRisk = Object.values(state.misclassChecklist).filter(Boolean).length;
  const totalChecked = [state.handbookChecklist, state.healthChecklist, state.wageChecklist, state.i9Checklist, state.eeocChecklist, state.transChecklist]
    .reduce((s, c) => s + Object.values(c).filter(Boolean).length, 0);
  const openClaims = state.claimRows.filter(r => r.status === 'Open' || r.status === 'In Litigation').length;
  const i9Deficient = state.i9Rows.filter(r => r.onFile === 'No' || r.sec1 === 'No' || r.sec2 === 'No').length;
  const highRiskWorkers = state.classRows.filter(r => r.risk === 'High').length;

  kpis.innerHTML = `
    <div class="dash-card"><div class="dash-card-value" style="color:var(--color-primary);">${score}</div><div class="dash-card-label">Compliance Score</div></div>
    <div class="dash-card"><div class="dash-card-value">${totalChecked}</div><div class="dash-card-label">Checklist Items Done</div></div>
    <div class="dash-card"><div class="dash-card-value" style="color:${misclassRisk >= 3 ? 'var(--color-danger)' : 'var(--color-success)'};">${misclassRisk}/8</div><div class="dash-card-label">Misclass. Risk Factors</div></div>
    <div class="dash-card"><div class="dash-card-value" style="color:${openClaims > 0 ? 'var(--color-danger)' : 'var(--color-success)'};">${openClaims}</div><div class="dash-card-label">Open Claims</div></div>
    <div class="dash-card"><div class="dash-card-value" style="color:${i9Deficient > 0 ? 'var(--color-warning)' : 'var(--color-success)'};">${i9Deficient}</div><div class="dash-card-label">I-9 Deficiencies</div></div>
    <div class="dash-card"><div class="dash-card-value" style="color:${highRiskWorkers > 0 ? 'var(--color-danger)' : 'var(--color-success)'};">${highRiskWorkers}</div><div class="dash-card-label">High-Risk Workers</div></div>`;

  // Bar Chart
  const barChart = document.getElementById('categoryBarChart');
  const categories = [
    { label: 'Compliance Risk', vals: Object.values(state.complianceRisk) },
    { label: 'Handbook Policies', vals: Object.values(state.handbookScores) },
    { label: 'Retirement Plans', vals: Object.values(state.retirementScores) },
    { label: 'EEOC Readiness', vals: Object.values(state.eeocScores) },
    { label: 'COBRA/WARN', vals: Object.values(state.cobraScores) },
  ];
  barChart.innerHTML = '';
  categories.forEach(cat => {
    const avg = cat.vals.length > 0 ? (cat.vals.reduce((s,v) => s+v, 0) / cat.vals.length) : 0;
    const pct = (avg / 5) * 100;
    const color = pct >= 80 ? 'var(--color-score-5)' : pct >= 60 ? 'var(--color-score-4)' : pct >= 40 ? 'var(--color-score-3)' : pct >= 20 ? 'var(--color-score-2)' : 'var(--color-score-1)';
    barChart.innerHTML += `<div class="bar-row"><div class="bar-label">${cat.label}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color};min-width:${pct>0?'30px':'0'};"><span class="bar-value">${Math.round(pct)}%</span></div></div></div>`;
  });

  // Heatmap
  const heatmap = document.getElementById('riskHeatmap');
  const hmAreas = ['Classification', 'Handbook', 'Benefits', 'Wage/Hour', 'I-9', 'EEOC', 'COBRA/WARN'];
  const hmStores = [state.complianceRisk, state.handbookScores, state.retirementScores, state.complianceRisk, state.complianceRisk, state.eeocScores, state.cobraScores];
  const hmKeys = [
    ['misclass'], ['eeo','harassment','fmla','ada','at_will'], ['plan_doc','form_5500','ndt'],
    ['wage_hour'], ['i9'], ['pending','training','pay_equity'], ['notice_process','admin','transaction']
  ];
  heatmap.innerHTML = '<div class="heatmap-col-label"></div>' + hmAreas.map(a => `<div class="heatmap-col-label">${a}</div>`).join('');
  ['Readiness'].forEach(lbl => {
    heatmap.innerHTML += `<div class="heatmap-row-label">${lbl}</div>`;
    hmAreas.forEach((area, ai) => {
      const store = hmStores[ai];
      const keys = hmKeys[ai];
      const vals = keys.map(k => store[k] || 0).filter(v => v > 0);
      const avg = vals.length > 0 ? Math.round(vals.reduce((s,v)=>s+v,0)/vals.length) : 0;
      const cls = avg === 0 ? 'hs0' : avg <= 1 ? 'hs5' : avg <= 2 ? 'hs4' : avg <= 3 ? 'hs3' : avg <= 4 ? 'hs2' : 'hs1';
      heatmap.innerHTML += `<div class="heatmap-cell ${cls}" title="${area}: ${avg || 'N/A'}/5">${avg || '-'}</div>`;
    });
  });

  // Priority Actions
  const actions = document.getElementById('priorityActions');
  let actionItems = [];
  if (misclassRisk >= 3) actionItems.push({ text: `${misclassRisk} misclassification risk factors -- consult counsel`, level: 'danger' });
  if (openClaims > 0) actionItems.push({ text: `${openClaims} open claims need resolution before market`, level: 'danger' });
  if (i9Deficient > 0) actionItems.push({ text: `${i9Deficient} I-9 deficiencies to correct`, level: 'warning' });
  if (highRiskWorkers > 0) actionItems.push({ text: `${highRiskWorkers} high-risk worker classifications`, level: 'danger' });
  const weakScores = [...Object.values(state.complianceRisk), ...Object.values(state.handbookScores), ...Object.values(state.retirementScores)].filter(v => v <= 2).length;
  if (weakScores > 0) actionItems.push({ text: `${weakScores} weak compliance areas need attention`, level: 'warning' });
  if (actionItems.length === 0) actionItems.push({ text: 'No critical actions identified', level: 'success' });
  actions.innerHTML = actionItems.map(a => `<div style="display:flex;align-items:center;gap:var(--space-sm);margin-bottom:var(--space-sm);"><span class="badge badge-${a.level}">${a.level === 'danger' ? 'Urgent' : a.level === 'warning' ? 'Important' : 'Good'}</span><span class="t-small">${a.text}</span></div>`).join('');

  // Gauge
  const gaugeArc = document.getElementById('gaugeArc');
  const gaugeValue = document.getElementById('gaugeValue');
  const arcLen = 188.5;
  gaugeArc.style.strokeDasharray = `${(score / 100) * arcLen} ${arcLen}`;
  gaugeArc.style.stroke = score >= 80 ? 'var(--color-score-5)' : score >= 60 ? 'var(--color-score-4)' : score >= 40 ? 'var(--color-score-3)' : score >= 20 ? 'var(--color-score-2)' : 'var(--color-score-1)';
  gaugeValue.textContent = score;

  const interp = document.getElementById('scoreInterpretation');
  const rec = document.getElementById('scoreRecommendation');
  if (score >= 80) {
    interp.textContent = 'Your HR compliance posture is strong. Most areas show low risk and good documentation practices.';
    rec.innerHTML = '<div class="callout callout-info">Continue maintaining current practices. Ensure annual training, I-9 audits, and pay equity reviews stay on schedule.</div>';
  } else if (score >= 60) {
    interp.textContent = 'Moderate compliance readiness. Some areas need remediation but the foundation is solid.';
    rec.innerHTML = '<div class="callout callout-warning">Prioritize: worker classification review, handbook update by counsel, and any outstanding I-9 corrections. Address before going to market.</div>';
  } else if (score >= 40) {
    interp.textContent = 'Below-average readiness. Significant compliance gaps could impact deal pricing or create buyer concerns.';
    rec.innerHTML = '<div class="callout callout-danger">Engage employment counsel immediately. Budget 3-6 months for remediation. Key areas: classification audit, handbook rewrite, benefit plan corrections, and I-9 self-audit.</div>';
  } else {
    interp.textContent = 'Critical compliance gaps detected. These issues could materially impact your transaction.';
    rec.innerHTML = '<div class="callout callout-danger">Do not go to market. Engage specialized employment counsel for a comprehensive compliance audit. Expect 6-12 months of remediation work and potential voluntary disclosure filings (IRS VCSP, DOL correction programs).</div>';
  }
}

function exportResults() {
  const score = calculateOverallScore() || 0;
  let text = `EMPLOYMENT & HR COMPLIANCE - SUMMARY REPORT\n${'='.repeat(50)}\n\n`;
  text += `Overall Compliance Score: ${score}/100\n`;
  text += `Misclassification Risk Factors: ${Object.values(state.misclassChecklist).filter(Boolean).length}/8\n`;
  text += `Open Claims: ${state.claimRows.filter(r => r.status === 'Open' || r.status === 'In Litigation').length}\n`;
  text += `I-9 Deficiencies: ${state.i9Rows.filter(r => r.onFile === 'No').length}\n\n`;

  text += `COMPLIANCE RISK SCORES\n${'-'.repeat(30)}\n`;
  COMPLIANCE_DIMS.forEach(d => { text += `${d.label}: ${state.complianceRisk[d.key] || 'Not scored'}/5\n`; });

  text += `\nWORKER CLASSIFICATION AUDIT\n${'-'.repeat(30)}\n`;
  state.classRows.filter(r => r.name).forEach(r => { text += `${r.name} | ${r.classification} | Risk: ${r.risk} | Action: ${r.action}\n`; });

  text += `\nPENDING CLAIMS\n${'-'.repeat(30)}\n`;
  state.claimRows.filter(r => r.claimant).forEach(r => { text += `${r.claimant} | ${r.type} | ${r.status} | Exposure: ${r.exposure}\n`; });

  text += `\nBENEFIT PLANS\n${'-'.repeat(30)}\n`;
  state.benefitRows.filter(r => r.name).forEach(r => { text += `${r.name} | ${r.type} | Status: ${r.status}\n`; });

  const blob = new Blob([text], { type: 'text/plain' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'HR-Compliance-Summary.txt'; a.click();
  showToast('Report exported successfully');
}

/* ============================================================
   INIT
   ============================================================ */
function init() {
  buildSidebar();

  // Page 1
  buildScoreCards(document.getElementById('complianceRiskCards'), COMPLIANCE_DIMS, 'complianceRisk');

  // Page 2
  buildClassificationTests();
  buildMisclassChecklist();
  renderClassTable();

  // Page 3
  buildScoreCards(document.getElementById('handbookPolicies'), HANDBOOK_DIMS, 'handbookScores');
  buildChecklist('handbookChecklist', HANDBOOK_CL_ITEMS, 'handbookChecklist');

  // Page 4
  buildScoreCards(document.getElementById('retirementScoring'), RETIREMENT_DIMS, 'retirementScores');
  buildChecklist('healthChecklist', HEALTH_CL_ITEMS, 'healthChecklist');
  renderBenefitTable();

  // Page 5
  buildExemptionCards();
  buildChecklist('wageChecklist', WAGE_CL_ITEMS, 'wageChecklist');
  // Restore calc values
  if (state.calcEmployees) document.getElementById('calcEmployees').value = state.calcEmployees;
  if (state.calcHourly) document.getElementById('calcHourly').value = state.calcHourly;
  if (state.calcHours) document.getElementById('calcHours').value = state.calcHours;
  if (state.calcWeeks) document.getElementById('calcWeeks').value = state.calcWeeks;
  calculateExposure();

  // Page 6
  buildI9PenaltyCards();
  buildChecklist('i9AuditChecklist', I9_CL_ITEMS, 'i9Checklist');
  renderI9Table();

  // Page 7
  buildScoreCards(document.getElementById('eeocScoring'), EEOC_DIMS, 'eeocScores');
  buildChecklist('eeocChecklist', EEOC_CL_ITEMS, 'eeocChecklist');
  renderClaimsTable();

  // Page 8
  buildScoreCards(document.getElementById('cobraScoring'), COBRA_DIMS, 'cobraScores');
  buildWarnCards();
  buildChecklist('transChecklist', TRANS_CL_ITEMS, 'transChecklist');
  document.getElementById('transNotes').value = state.transNotes || '';

  updateProgress();
  updateSidebarScore();
  goToPage(state.currentPage);
}

init();
</script>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('embedded') === 'true') {
    // Hide playbook's own chrome
    var sidebar = document.querySelector('.sidebar');
    var overlay = document.querySelector('.sidebar-overlay');
    var mobileHeader = document.querySelector('.mobile-header');
    var mainContent = document.querySelector('.main-content');
    if (sidebar) sidebar.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    if (mobileHeader) mobileHeader.style.display = 'none';
    if (mainContent) {
      mainContent.style.marginLeft = '0';
      mainContent.style.minHeight = 'auto';
    }

    // Navigate to specific section if requested
    var section = params.get('section');
    if (section !== null) {
      var sectionIndex = parseInt(section, 10);
      if (typeof navigateToSection === 'function') {
        setTimeout(function() { navigateToSection(sectionIndex); }, 100);
      }
    }

    // Forward score updates to parent
    var origDispatch = window.dispatchEvent.bind(window);
    window.addEventListener('playbook:score-update', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:score-update',
          detail: e.detail
        }, '*');
      }
    });

    // Forward section changes to parent
    window.addEventListener('playbook:section-change', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:section-change',
          detail: e.detail
        }, '*');
      }
    });

    // Listen for commands from parent
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'navigate-section') {
        if (typeof navigateToSection === 'function') {
          navigateToSection(e.data.sectionIndex);
        }
      }
    });
  }
})();
</script>
</body>
</html>
