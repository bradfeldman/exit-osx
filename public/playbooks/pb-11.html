<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Three-Year Financial Projection | Exit Planning Playbook #11</title>
<style>
/* ============================================================
   DESIGN TOKENS
   ============================================================ */
:root {
  --color-bg: #F5F5F7;
  --color-surface: #FFFFFF;
  --color-surface-alt: #F2F2F7;
  --color-border: #E5E7EB;
  --color-border-light: #F2F2F7;
  --color-text: #1D1D1F;
  --color-text-secondary: #6E6E73;
  --color-text-tertiary: #8E8E93;
  --color-primary: #0071E3;
  --color-primary-light: #EBF5FF;
  --color-primary-hover: #0051B3;
  --color-accent: #FF9500;
  --color-accent-light: #FFF6E8;
  --color-danger: #FF3B30;
  --color-danger-light: #FFEBEA;
  --color-warning: #C67F20;
  --color-warning-light: #FFF8EB;
  --color-success: #34C759;
  --color-success-light: #E8F8ED;
  --color-score-1: #FF3B30;
  --color-score-2: #FF9500;
  --color-score-3: #FFCC00;
  --color-score-4: #34C759;
  --color-score-5: #30D158;
  --color-chart-1: #0071E3;
  --color-chart-2: #B87333;
  --color-chart-3: #5B8BA0;
  --color-chart-4: #9C6B8A;
  --color-chart-5: #7A8B5A;
  --color-negative: #C53030;
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.1);
  --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', sans-serif;
  --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', sans-serif;
  --font-mono: 'SF Mono', 'Fira Code', monospace;
  --transition-fast: 150ms ease;
  --transition-normal: 250ms ease;
  --transition-slow: 400ms cubic-bezier(0.16, 1, 0.3, 1);
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
  --space-3xl: 64px;
}

/* ============================================================
   RESET & BASE
   ============================================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body {
  font-family: var(--font-body);
  font-size: 16px;
  line-height: 1.6;
  color: var(--color-text);
  background: var(--color-bg);
  -webkit-font-smoothing: antialiased;
  min-height: 100vh;
}
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea, select { font-family: inherit; font-size: inherit; }
a { color: var(--color-primary); text-decoration: none; }

/* ============================================================
   TYPOGRAPHY
   ============================================================ */
.t-display { font-family: var(--font-display); font-size: clamp(28px, 4vw, 40px); font-weight: 700; line-height: 1.2; letter-spacing: -0.02em; color: var(--color-text); }
.t-h1 { font-family: var(--font-display); font-size: clamp(22px, 3vw, 30px); font-weight: 700; line-height: 1.25; letter-spacing: -0.01em; }
.t-h2 { font-size: 20px; font-weight: 600; line-height: 1.3; }
.t-h3 { font-size: 16px; font-weight: 600; line-height: 1.4; }
.t-body { font-size: 16px; line-height: 1.6; }
.t-small { font-size: 14px; line-height: 1.5; }
.t-caption { font-size: 12px; line-height: 1.4; letter-spacing: 0.02em; }
.t-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); }
.t-secondary { color: var(--color-text-secondary); }
.t-tertiary { color: var(--color-text-tertiary); }
.t-mono { font-family: var(--font-mono); }

/* ============================================================
   LAYOUT
   ============================================================ */
.app { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; min-width: 260px; background: var(--color-text);
  color: var(--color-text); padding: var(--space-lg); display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
  transition: transform var(--transition-slow);
  overflow-y: auto;
}
.main-content {
  flex: 1; margin-left: 260px; min-height: 100vh;
  transition: margin-left var(--transition-slow);
}
.content-area { max-width: 860px; margin: 0 auto; padding: var(--space-2xl) var(--space-lg); }

.mobile-header {
  display: none; position: sticky; top: 0; z-index: 90;
  background: var(--color-surface); border-bottom: 1px solid var(--color-border);
  padding: var(--space-md) var(--space-lg); align-items: center; gap: var(--space-md);
}
.hamburger { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); }
.hamburger:hover { background: var(--color-surface-alt); }
.hamburger span { display: block; width: 18px; height: 2px; background: var(--color-text); position: relative; }
.hamburger span::before, .hamburger span::after { content: ''; position: absolute; width: 18px; height: 2px; background: var(--color-text); left: 0; }
.hamburger span::before { top: -6px; }
.hamburger span::after { top: 6px; }
.sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 99; }

@media (max-width: 900px) {
  .sidebar { transform: translateX(-260px); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.show { display: block; }
  .main-content { margin-left: 0 !important; }
  .mobile-header { display: flex; }
  .content-area { padding: var(--space-lg) var(--space-md); }
}

/* ============================================================
   SIDEBAR COMPONENTS
   ============================================================ */
.sidebar-brand { margin-bottom: var(--space-xl); }
.sidebar-brand-label { font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-xs); }
.sidebar-brand-title { font-family: var(--font-display); font-size: 18px; font-weight: 700; color: var(--color-text); line-height: 1.3; }

.sidebar-progress { margin-bottom: var(--space-xl); padding: var(--space-md); background: var(--color-surface-alt); border-radius: var(--radius-md); }
.sidebar-progress-label { font-size: 12px; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-progress-bar { height: 4px; background: var(--color-border); border-radius: 2px; overflow: hidden; }
.sidebar-progress-fill { height: 100%; background: var(--color-accent); border-radius: 2px; transition: width var(--transition-slow); }
.sidebar-progress-text { font-size: 12px; color: var(--color-text-tertiary); margin-top: var(--space-sm); text-align: right; }

.sidebar-nav { flex: 1; display: flex; flex-direction: column; gap: 2px; }
.nav-section-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-tertiary); padding: var(--space-md) var(--space-sm) var(--space-xs); }
.nav-item {
  display: flex; align-items: center; gap: var(--space-md); padding: 10px 12px;
  border-radius: var(--radius-sm); color: rgba(255,255,255,0.6);
  font-size: 14px; transition: all var(--transition-fast); cursor: pointer; position: relative;
}
.nav-item:hover { background: var(--color-surface-alt); color: var(--color-text); }
.nav-item.active { background: var(--color-primary-light); color: var(--color-primary); font-weight: 500; border-left: 3px solid var(--color-primary); }
.nav-item.completed .nav-check { display: flex; }
.nav-item.locked { opacity: 0.4; cursor: default; }
.nav-item.locked:hover { background: none; color: var(--color-text-tertiary); }
.nav-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; }
.nav-check { display: none; width: 16px; height: 16px; background: var(--color-success); border-radius: 50%; align-items: center; justify-content: center; margin-left: auto; flex-shrink: 0; }
.nav-check svg { width: 10px; height: 10px; stroke: #fff; stroke-width: 2.5; fill: none; }

.sidebar-metric { margin-top: auto; padding-top: var(--space-lg); border-top: 1px solid var(--color-border); }
.sidebar-metric-label { font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-metric-value { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: #fff; line-height: 1; }
.sidebar-metric-sub { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: var(--space-xs); }

/* ============================================================
   CARDS & SURFACES
   ============================================================ */
.card {
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: var(--radius-lg); padding: var(--space-lg);
  transition: box-shadow var(--transition-normal);
}
.card:hover { box-shadow: var(--shadow-sm); }

.callout {
  padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md);
  border-left: 3px solid; font-size: 14px; line-height: 1.6;
}
.callout-info { background: var(--color-primary-light); border-color: var(--color-primary); color: var(--color-primary); }
.callout-warning { background: var(--color-warning-light); border-color: var(--color-warning); color: #7C5500; }
.callout-danger { background: var(--color-danger-light); border-color: var(--color-danger); color: var(--color-danger); }
.callout-accent { background: var(--color-accent-light); border-color: var(--color-accent); color: #7C5500; }

/* ============================================================
   BUTTONS
   ============================================================ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm);
  padding: 10px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500;
  transition: all var(--transition-fast); white-space: nowrap;
}
.btn-primary { background: var(--color-primary); color: #fff; }
.btn-primary:hover { background: var(--color-primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.btn-secondary { background: var(--color-surface); color: var(--color-text); border: 1px solid var(--color-border); }
.btn-secondary:hover { background: var(--color-surface-alt); border-color: var(--color-text-tertiary); }
.btn-ghost { color: var(--color-text-secondary); padding: 8px 12px; }
.btn-ghost:hover { background: var(--color-surface-alt); color: var(--color-text); }
.btn-accent { background: var(--color-accent); color: #fff; }
.btn-accent:hover { background: #E68600; }
.btn-lg { padding: 14px 28px; font-size: 16px; border-radius: var(--radius-md); }
.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

/* ============================================================
   FORM ELEMENTS
   ============================================================ */
.form-group { margin-bottom: var(--space-lg); }
.form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: var(--space-sm); color: var(--color-text); }
.form-hint { font-size: 13px; color: var(--color-text-tertiary); margin-top: var(--space-xs); }
.form-input {
  width: 100%; padding: 10px 14px; border: 1px solid var(--color-border);
  border-radius: var(--radius-sm); font-size: 15px; background: var(--color-surface);
  transition: all var(--transition-fast); color: var(--color-text);
}
.form-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light); }
.form-input::placeholder { color: var(--color-text-tertiary); }
textarea.form-input { min-height: 80px; resize: vertical; line-height: 1.5; }
select.form-input { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%236E6E73' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }

/* ============================================================
   FINANCIAL TABLE
   ============================================================ */
.fin-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; }
.fin-table th {
  text-align: right; padding: 8px 12px; font-size: 11px;
  font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
  color: var(--color-text-tertiary); border-bottom: 2px solid var(--color-border);
}
.fin-table th:first-child { text-align: left; }
.fin-table td { padding: 8px 12px; border-bottom: 1px solid var(--color-border-light); text-align: right; }
.fin-table td:first-child { text-align: left; font-weight: 500; }
.fin-table tr.total-row td { font-weight: 700; border-top: 2px solid var(--color-border); border-bottom: 2px solid var(--color-border); background: var(--color-surface-alt); }
.fin-table tr.subtotal-row td { font-weight: 600; border-top: 1px solid var(--color-border); }
.fin-table .negative { color: var(--color-negative); }
.fin-table input {
  width: 100%; padding: 6px 8px; border: 1px solid var(--color-border);
  border-radius: var(--radius-sm); text-align: right; font-size: 14px;
  font-family: var(--font-mono); background: var(--color-surface);
  transition: border-color var(--transition-fast);
}
.fin-table input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px var(--color-primary-light); }
.fin-table input::placeholder { color: var(--color-text-tertiary); text-align: right; }
.fin-table .row-label { font-size: 13px; color: var(--color-text-secondary); }
.fin-table .indent { padding-left: 28px; }
.fin-table textarea {
  width: 100%; padding: 6px 8px; border: 1px solid var(--color-border);
  border-radius: var(--radius-sm); font-size: 13px; resize: vertical;
  min-height: 36px; background: var(--color-surface);
}

/* ============================================================
   BADGES
   ============================================================ */
.badge {
  display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px;
  border-radius: 999px; font-size: 12px; font-weight: 500;
}
.badge-success { background: var(--color-success-light); color: var(--color-success); }
.badge-warning { background: var(--color-warning-light); color: var(--color-warning); }
.badge-danger { background: var(--color-danger-light); color: var(--color-danger); }
.badge-neutral { background: var(--color-surface-alt); color: var(--color-text-secondary); }
.badge-primary { background: var(--color-primary-light); color: var(--color-primary); }
.badge-accent { background: var(--color-accent-light); color: var(--color-accent); }

/* ============================================================
   CHART CANVAS
   ============================================================ */
.chart-wrap { position: relative; padding: var(--space-md) 0; }
.chart-svg { width: 100%; overflow: visible; }
.chart-legend { display: flex; gap: var(--space-lg); flex-wrap: wrap; margin-top: var(--space-md); justify-content: center; }
.chart-legend-item { display: flex; align-items: center; gap: var(--space-sm); font-size: 13px; color: var(--color-text-secondary); }
.chart-legend-dot { width: 10px; height: 10px; border-radius: 3px; }

/* ============================================================
   SENSITIVITY GRID
   ============================================================ */
.sensitivity-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md); }
.sensitivity-card {
  padding: var(--space-lg); border-radius: var(--radius-md);
  border: 2px solid var(--color-border); text-align: center; transition: all var(--transition-fast);
  cursor: pointer;
}
.sensitivity-card.active { border-color: var(--color-primary); background: var(--color-primary-light); }
.sensitivity-card:hover { border-color: var(--color-text-tertiary); }
.sensitivity-card-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.sensitivity-card-val { font-family: var(--font-display); font-size: 24px; font-weight: 700; line-height: 1.2; }
.sensitivity-card-sub { font-size: 12px; color: var(--color-text-secondary); margin-top: 4px; }

@media (max-width: 700px) {
  .sensitivity-grid { grid-template-columns: 1fr 1fr; }
}

/* ============================================================
   ASSUMPTION ROW
   ============================================================ */
.assumption-card {
  border: 1px solid var(--color-border); border-radius: var(--radius-md);
  padding: var(--space-lg); margin-bottom: var(--space-md); background: var(--color-surface);
}
.assumption-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-md); }
.assumption-remove { color: var(--color-text-tertiary); font-size: 18px; padding: 4px 8px; border-radius: var(--radius-sm); }
.assumption-remove:hover { background: var(--color-danger-light); color: var(--color-danger); }

/* ============================================================
   PROGRESS RING (SVG)
   ============================================================ */
.progress-ring-wrap { position: relative; display: inline-flex; align-items: center; justify-content: center; }
.progress-ring-text { position: absolute; text-align: center; }
.progress-ring-value { font-family: var(--font-display); font-weight: 700; line-height: 1; }
.progress-ring-label { font-size: 10px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }

/* ============================================================
   SECTION PAGES
   ============================================================ */
.page { display: none; animation: fadeIn 0.3s ease; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.page-header { margin-bottom: var(--space-2xl); }
.page-header .t-label { margin-bottom: var(--space-sm); }
.page-header .t-display { margin-bottom: var(--space-md); }
.page-header .t-body { color: var(--color-text-secondary); max-width: 640px; }

.section-divider { height: 1px; background: var(--color-border); margin: var(--space-2xl) 0; }

/* ============================================================
   WELCOME PAGE
   ============================================================ */
.welcome-hero { text-align: center; padding: var(--space-3xl) var(--space-lg); max-width: 640px; margin: 0 auto; }
.welcome-icon { width: 72px; height: 72px; background: var(--color-primary-light); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-lg); font-size: 32px; }
.welcome-hero .t-display { margin-bottom: var(--space-md); }
.welcome-hero .t-body { margin-bottom: var(--space-2xl); }

.welcome-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin: var(--space-2xl) 0; text-align: center; }
.welcome-stat { padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); }
.welcome-stat-value { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--color-primary); }
.welcome-stat-label { font-size: 13px; color: var(--color-text-secondary); margin-top: 4px; }

.welcome-phases { display: flex; flex-direction: column; gap: var(--space-md); margin: var(--space-2xl) 0; text-align: left; }
.welcome-phase { display: flex; gap: var(--space-lg); padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); }
.welcome-phase-num { width: 36px; height: 36px; background: var(--color-primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--color-primary); flex-shrink: 0; font-size: 15px; }
.welcome-phase-title { font-weight: 600; margin-bottom: 2px; }
.welcome-phase-desc { font-size: 14px; color: var(--color-text-secondary); }

@media (max-width: 600px) {
  .welcome-stats { grid-template-columns: 1fr; }
  .welcome-hero { padding: var(--space-2xl) var(--space-md); }
}

/* ============================================================
   DASHBOARD METRICS
   ============================================================ */
.dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); }
@media (max-width: 700px) { .dashboard-grid { grid-template-columns: 1fr; } }
.metric-card { padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); }
.metric-card-label { font-size: 12px; font-weight: 500; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: var(--space-sm); }
.metric-card-value { font-family: var(--font-display); font-size: 32px; font-weight: 700; line-height: 1; }
.metric-card-sub { font-size: 13px; color: var(--color-text-secondary); margin-top: var(--space-xs); }

/* ============================================================
   BAR CHART
   ============================================================ */
.bar-chart { display: flex; flex-direction: column; gap: var(--space-md); }
.bar-row { display: flex; align-items: center; gap: var(--space-md); }
.bar-label { width: 100px; flex-shrink: 0; font-size: 13px; color: var(--color-text-secondary); text-align: right; }
.bar-track { flex: 1; height: 28px; background: var(--color-surface-alt); border-radius: 4px; overflow: hidden; position: relative; }
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; min-width: 0; }
.bar-fill.animated { min-width: 30px; }
.bar-value { font-size: 12px; font-weight: 600; color: #fff; white-space: nowrap; }

/* ============================================================
   PAGE FOOTER
   ============================================================ */
.page-footer {
  display: flex; align-items: center; justify-content: space-between;
  padding-top: var(--space-2xl); margin-top: var(--space-2xl);
  border-top: 1px solid var(--color-border);
}

/* ============================================================
   TOAST
   ============================================================ */
.toast-container { position: fixed; bottom: var(--space-lg); right: var(--space-lg); z-index: 1000; display: flex; flex-direction: column; gap: var(--space-sm); }
.toast {
  padding: var(--space-md) var(--space-lg); background: var(--color-text);
  color: #fff; border-radius: var(--radius-md); font-size: 14px; box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
  display: flex; align-items: center; gap: var(--space-sm); max-width: 360px;
}
@keyframes toastIn { from { opacity: 0; transform: translateY(16px); } }
@keyframes toastOut { to { opacity: 0; transform: translateY(-8px); } }

/* ============================================================
   UTILITY
   ============================================================ */
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-sm { gap: var(--space-sm); }
.gap-md { gap: var(--space-md); }
.gap-lg { gap: var(--space-lg); }
.mb-sm { margin-bottom: var(--space-sm); }
.mb-md { margin-bottom: var(--space-md); }
.mb-lg { margin-bottom: var(--space-lg); }
.mb-xl { margin-bottom: var(--space-xl); }
.mt-md { margin-top: var(--space-md); }
.mt-lg { margin-top: var(--space-lg); }
.w-full { width: 100%; }
.text-center { text-align: center; }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

/* Print styles */
@media print {
  .sidebar, .mobile-header, .sidebar-overlay, .toast-container, .btn-group, .skip-link { display: none !important; }
  .main-content { margin-left: 0 !important; }
  .page { display: block !important; page-break-inside: avoid; }
  .content-area { max-width: 100%; padding: 0; }
  .btn { display: none; }
}

/* Accessibility */
.skip-link { position: absolute; top: -40px; left: 0; background: var(--color-primary); color: #fff; padding: 8px 16px; z-index: 200; font-size: 14px; border-radius: 0 0 var(--radius-sm) 0; }
.skip-link:focus { top: 0; }
:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 2px; }
*:focus:not(:focus-visible) { outline: none; }

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; }
}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to content</a>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>

<div class="app">
<nav class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
  <div class="sidebar-brand">
    <div class="sidebar-brand-label">Exit Planning Playbook #11</div>
    <div class="sidebar-brand-title">Three-Year Financial<br>Projection Model</div>
  </div>

  <div class="sidebar-progress">
    <div class="sidebar-progress-label">Overall Progress</div>
    <div class="sidebar-progress-bar"><div class="sidebar-progress-fill" id="globalProgressBar" style="width: 0%"></div></div>
    <div class="sidebar-progress-text" id="globalProgressText">0% complete</div>
  </div>

  <div class="sidebar-nav" id="sidebarNav">
    <div class="nav-section-label">Build Your Model</div>
    <div class="nav-item active" data-page="welcome" onclick="goToPage('welcome')" role="button" tabindex="0" aria-current="page">
      <span class="nav-icon">&#9673;</span> Welcome
      <span class="nav-check"><svg viewBox="0 0 12 12"><polyline points="2 6 5 9 10 3"/></svg></span>
    </div>
    <div class="nav-item locked" data-page="assumptions" onclick="goToPage('assumptions')" role="button" tabindex="0">
      <span class="nav-icon">&#9881;</span> Assumptions
      <span class="nav-check"><svg viewBox="0 0 12 12"><polyline points="2 6 5 9 10 3"/></svg></span>
    </div>
    <div class="nav-item locked" data-page="revenue" onclick="goToPage('revenue')" role="button" tabindex="0">
      <span class="nav-icon">&#9650;</span> Revenue
      <span class="nav-check"><svg viewBox="0 0 12 12"><polyline points="2 6 5 9 10 3"/></svg></span>
    </div>
    <div class="nav-item locked" data-page="expenses" onclick="goToPage('expenses')" role="button" tabindex="0">
      <span class="nav-icon">&#9660;</span> Expenses
      <span class="nav-check"><svg viewBox="0 0 12 12"><polyline points="2 6 5 9 10 3"/></svg></span>
    </div>
    <div class="nav-item locked" data-page="capex" onclick="goToPage('capex')" role="button" tabindex="0">
      <span class="nav-icon">&#9830;</span> CapEx &amp; Cash Flow
      <span class="nav-check"><svg viewBox="0 0 12 12"><polyline points="2 6 5 9 10 3"/></svg></span>
    </div>
    <div class="nav-item locked" data-page="sensitivity" onclick="goToPage('sensitivity')" role="button" tabindex="0">
      <span class="nav-icon">&#9733;</span> Sensitivity Analysis
      <span class="nav-check"><svg viewBox="0 0 12 12"><polyline points="2 6 5 9 10 3"/></svg></span>
    </div>

    <div class="nav-section-label" style="margin-top:var(--space-md)">Results</div>
    <div class="nav-item locked" data-page="dashboard" onclick="goToPage('dashboard')" role="button" tabindex="0">
      <span class="nav-icon">&#9632;</span> Projection Summary
      <span class="nav-check"><svg viewBox="0 0 12 12"><polyline points="2 6 5 9 10 3"/></svg></span>
    </div>
  </div>

  <div class="sidebar-metric" id="sidebarMetric" style="display:none">
    <div class="sidebar-metric-label">Year 3 EBITDA</div>
    <div class="sidebar-metric-value" id="sidebarEbitda">--</div>
    <div class="sidebar-metric-sub" id="sidebarMargin"></div>
  </div>
  <div id="sidebarSaved" style="margin-top:var(--space-md);font-size:11px;color:rgba(255,255,255,0.3);display:none">
    Auto-saved <span id="savedTime"></span>
  </div>
</nav>

<main class="main-content" id="main-content">
  <div class="mobile-header">
    <button class="hamburger" onclick="toggleSidebar(true)" aria-label="Open navigation"><span></span></button>
    <div style="font-weight:600;font-size:15px;">Financial Projection Model</div>
  </div>

  <div class="content-area">

    <!-- ===================== PAGE: WELCOME ===================== -->
    <div class="page active" id="page-welcome">
      <div class="welcome-hero">
        <div class="welcome-icon">&#9650;</div>
        <div class="t-display">Build a Projection That Buyers Will Believe</div>
        <p class="t-body t-secondary">
          Buyers value businesses on future cash flows, not past performance. Your three-year projection tells the buyer what they are buying into. It must be credible, well-structured, and tied to identifiable growth levers.
        </p>

        <div class="welcome-stats">
          <div class="welcome-stat">
            <div class="welcome-stat-value">3-7x</div>
            <div class="welcome-stat-label">EBITDA multiple buyers typically pay</div>
          </div>
          <div class="welcome-stat">
            <div class="welcome-stat-value">#1</div>
            <div class="welcome-stat-label">Factor PE firms use: the projection model</div>
          </div>
          <div class="welcome-stat">
            <div class="welcome-stat-value">3 yr</div>
            <div class="welcome-stat-label">Standard projection horizon for exits</div>
          </div>
        </div>

        <div class="callout callout-accent mb-xl" style="text-align:left">
          <strong>The core principle:</strong> The projection is a promise. If the buyer believes your projection, they will pay a multiple of it. If they do not, they will discount it -- or pay a multiple of trailing EBITDA instead. Your job is to make it believable by grounding every assumption in evidence.
        </div>

        <div class="welcome-phases">
          <div class="welcome-phase">
            <div class="welcome-phase-num">1</div>
            <div><div class="welcome-phase-title">Document Assumptions</div><div class="welcome-phase-desc">Ground every assumption in evidence: contracts, pipeline, historical data</div></div>
          </div>
          <div class="welcome-phase">
            <div class="welcome-phase-num">2</div>
            <div><div class="welcome-phase-title">Revenue Projections</div><div class="welcome-phase-desc">Build bottoms-up revenue with existing, new, churn, and pricing drivers</div></div>
          </div>
          <div class="welcome-phase">
            <div class="welcome-phase-num">3</div>
            <div><div class="welcome-phase-title">Expense Projections</div><div class="welcome-phase-desc">Model costs with headcount, variable costs, and investment spending</div></div>
          </div>
          <div class="welcome-phase">
            <div class="welcome-phase-num">4</div>
            <div><div class="welcome-phase-title">CapEx &amp; Cash Flow</div><div class="welcome-phase-desc">Calculate free cash flow from EBITDA minus CapEx and working capital</div></div>
          </div>
          <div class="welcome-phase">
            <div class="welcome-phase-num">5</div>
            <div><div class="welcome-phase-title">Sensitivity Analysis</div><div class="welcome-phase-desc">Show buyers you have thought about downside scenarios</div></div>
          </div>
        </div>

        <button class="btn btn-primary btn-lg" onclick="startJourney()" style="margin-top:var(--space-lg)">
          Begin Building Your Model &rarr;
        </button>
        <p class="t-caption t-tertiary" style="margin-top:var(--space-md)">Takes about 30 minutes. All numbers are saved automatically.</p>
      </div>
    </div>

    <!-- ===================== PAGE: ASSUMPTIONS ===================== -->
    <div class="page" id="page-assumptions">
      <div class="page-header">
        <div class="t-label">Phase 1 of 5</div>
        <div class="t-display">Document Your Assumptions</div>
        <p class="t-body t-secondary">Every number in your projection should be traceable to an assumption. Buyers will challenge each one. Ground them in evidence.</p>
      </div>

      <div class="callout callout-info mb-xl">
        <strong>How buyers use projections:</strong> Strategic acquirers validate synergy assumptions. PE firms build 5-year LBO models. Individual buyers check if cash flow covers debt service. Search funds must satisfy multiple stakeholders. Quality matters.
      </div>

      <div class="card mb-xl">
        <div class="t-h2 mb-md">Revenue Growth Drivers</div>
        <p class="t-small t-secondary mb-lg">A bottoms-up model builds projections from specific, identifiable drivers -- not a flat growth rate applied to the top line.</p>
        <div id="revenueDrivers"></div>
      </div>

      <div class="card mb-xl">
        <div class="t-h2 mb-md">Key Assumptions</div>
        <p class="t-small t-secondary mb-lg">Document each assumption with the supporting evidence and a realistic range.</p>
        <div id="assumptionsList"></div>
        <button class="btn btn-secondary btn-sm mt-lg" onclick="addAssumption()">+ Add Assumption</button>
      </div>

      <div class="page-footer">
        <button class="btn btn-ghost" onclick="goToPage('welcome')">&larr; Back</button>
        <button class="btn btn-primary" onclick="completeAssumptions()">Continue to Revenue &rarr;</button>
      </div>
    </div>

    <!-- ===================== PAGE: REVENUE ===================== -->
    <div class="page" id="page-revenue">
      <div class="page-header">
        <div class="t-label">Phase 2 of 5</div>
        <div class="t-display">Revenue Projections</div>
        <p class="t-body t-secondary">Build your revenue projection from the bottom up. If you project 20% growth, the buyer will ask "how?" Be ready with specific answers.</p>
      </div>

      <div class="callout callout-warning mb-xl">
        <strong>Avoid the hockey stick:</strong> Revenue flat for 3 years then magically doubles in Year 1 of projection. Buyers have seen this a thousand times. Growth should be a continuation of existing trends, accelerated by specific, identifiable levers.
      </div>

      <div class="card mb-xl" style="overflow-x:auto">
        <div class="t-h2 mb-lg">Revenue Build</div>
        <table class="fin-table" id="revenueTable">
          <thead>
            <tr>
              <th style="min-width:180px">Revenue Line</th>
              <th style="min-width:120px">Trailing Year</th>
              <th style="min-width:120px">Year 1</th>
              <th style="min-width:120px">Year 2</th>
              <th style="min-width:120px">Year 3</th>
              <th style="min-width:180px">Key Assumptions</th>
            </tr>
          </thead>
          <tbody id="revenueBody"></tbody>
        </table>
      </div>

      <div class="card mb-xl">
        <div class="t-h2 mb-md">Revenue Growth Visualization</div>
        <div id="revenueChart" class="chart-wrap"></div>
      </div>

      <div class="page-footer">
        <button class="btn btn-ghost" onclick="goToPage('assumptions')">&larr; Back</button>
        <button class="btn btn-primary" onclick="completeRevenue()">Continue to Expenses &rarr;</button>
      </div>
    </div>

    <!-- ===================== PAGE: EXPENSES ===================== -->
    <div class="page" id="page-expenses">
      <div class="page-header">
        <div class="t-label">Phase 3 of 5</div>
        <div class="t-display">Expense Projections</div>
        <p class="t-body t-secondary">Tie expense growth to revenue growth. If revenue grows 30% but no new hires are planned, buyers will ask: who is doing the work?</p>
      </div>

      <div class="callout callout-warning mb-xl">
        <strong>Common mistake:</strong> Projecting revenue growth without corresponding headcount additions. Revenue grows 30% but no new hires are planned. Solution: Tie revenue growth to specific headcount additions with loaded costs.
      </div>

      <div class="card mb-xl" style="overflow-x:auto">
        <div class="t-h2 mb-lg">Expense Build</div>
        <table class="fin-table" id="expenseTable">
          <thead>
            <tr>
              <th style="min-width:180px">Expense Category</th>
              <th style="min-width:120px">Trailing Year</th>
              <th style="min-width:120px">Year 1</th>
              <th style="min-width:120px">Year 2</th>
              <th style="min-width:120px">Year 3</th>
              <th style="min-width:180px">Key Assumptions</th>
            </tr>
          </thead>
          <tbody id="expenseBody"></tbody>
        </table>
      </div>

      <div class="card mb-xl">
        <div class="t-h2 mb-md">EBITDA Trajectory</div>
        <div id="ebitdaChart" class="chart-wrap"></div>
      </div>

      <div class="page-footer">
        <button class="btn btn-ghost" onclick="goToPage('revenue')">&larr; Back</button>
        <button class="btn btn-primary" onclick="completeExpenses()">Continue to CapEx &amp; Cash Flow &rarr;</button>
      </div>
    </div>

    <!-- ===================== PAGE: CAPEX & CASH FLOW ===================== -->
    <div class="page" id="page-capex">
      <div class="page-header">
        <div class="t-label">Phase 4 of 5</div>
        <div class="t-display">CapEx &amp; Cash Flow</div>
        <p class="t-body t-secondary">Free Cash Flow = EBITDA - CapEx - Working Capital Changes. If your business requires heavy ongoing CapEx, EBITDA alone overstates cash generation. Be transparent.</p>
      </div>

      <div class="callout callout-accent mb-xl">
        <strong>Key insight:</strong> Not all CapEx is growth. Maintenance CapEx (equipment replacement, IT refresh) is the cost of standing still. Growth CapEx (new facilities, new tech) drives revenue. Buyers distinguish between the two.
      </div>

      <div class="card mb-xl" style="overflow-x:auto">
        <div class="t-h2 mb-lg">Cash Flow Waterfall</div>
        <table class="fin-table" id="cashflowTable">
          <thead>
            <tr>
              <th style="min-width:200px">Line Item</th>
              <th style="min-width:120px">Year 1</th>
              <th style="min-width:120px">Year 2</th>
              <th style="min-width:120px">Year 3</th>
            </tr>
          </thead>
          <tbody id="cashflowBody"></tbody>
        </table>
      </div>

      <div class="card mb-xl">
        <div class="t-h2 mb-md">Free Cash Flow Conversion</div>
        <p class="t-small t-secondary mb-md">FCF as a percentage of EBITDA shows how efficiently your business converts profit to cash.</p>
        <div id="fcfConversionChart" class="chart-wrap"></div>
      </div>

      <div class="page-footer">
        <button class="btn btn-ghost" onclick="goToPage('expenses')">&larr; Back</button>
        <button class="btn btn-primary" onclick="completeCapex()">Continue to Sensitivity Analysis &rarr;</button>
      </div>
    </div>

    <!-- ===================== PAGE: SENSITIVITY ===================== -->
    <div class="page" id="page-sensitivity">
      <div class="page-header">
        <div class="t-label">Phase 5 of 5</div>
        <div class="t-display">Sensitivity Analysis</div>
        <p class="t-body t-secondary">Showing buyers you have thought about downside scenarios builds credibility and demonstrates intellectual honesty. Include this with your projection.</p>
      </div>

      <div class="card mb-xl">
        <div class="t-h2 mb-lg">Scenario Comparison</div>
        <p class="t-small t-secondary mb-lg">Each scenario adjusts your base-case revenue and EBITDA. Click a scenario to see its detailed impact.</p>
        <div class="sensitivity-grid" id="sensitivityGrid"></div>
      </div>

      <div class="section-divider"></div>

      <div class="card mb-xl">
        <div class="t-h2 mb-md">Scenario Detail</div>
        <div id="scenarioDetail"></div>
      </div>

      <div class="section-divider"></div>

      <div class="card mb-xl">
        <div class="t-h2 mb-md">Presenting to Buyers</div>
        <div class="callout callout-info mb-md">
          <strong>Ground every assumption:</strong> Link every assumption to evidence -- historical performance, signed contracts, pipeline data, market trends.
        </div>
        <div class="callout callout-accent mb-md">
          <strong>Show the bridge:</strong> If you project 20% revenue growth, the buyer will ask "how?" Be ready with: existing contract renewals + new pipeline conversion + price increases = 20%.
        </div>
        <div class="callout callout-info mb-md">
          <strong>Include downside:</strong> Include the sensitivity analysis. It shows sophistication and intellectual honesty.
        </div>
        <div class="callout callout-warning">
          <strong>Make it interactive:</strong> Present the model in a format where the buyer can stress-test assumptions. This builds trust.
        </div>
      </div>

      <div class="page-footer">
        <button class="btn btn-ghost" onclick="goToPage('capex')">&larr; Back</button>
        <button class="btn btn-primary" onclick="completeSensitivity()">View Projection Summary &rarr;</button>
      </div>
    </div>

    <!-- ===================== PAGE: DASHBOARD ===================== -->
    <div class="page" id="page-dashboard">
      <div class="page-header">
        <div class="t-label">Your Complete Model</div>
        <div class="t-display">Three-Year Projection Summary</div>
        <p class="t-body t-secondary">A comprehensive view of your financial projection. Share this with your advisory team and include it in your CIM.</p>
      </div>

      <div class="dashboard-grid mb-xl" style="grid-template-columns:repeat(4,1fr)">
        <div class="metric-card">
          <div class="metric-card-label">Trailing Revenue</div>
          <div class="metric-card-value" id="dashTrailing">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-card-label">Year 3 Revenue</div>
          <div class="metric-card-value" id="dashYr3Rev">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-card-label">Year 3 EBITDA</div>
          <div class="metric-card-value" id="dashYr3Ebitda">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-card-label">Year 3 FCF</div>
          <div class="metric-card-value" id="dashYr3Fcf">--</div>
        </div>
      </div>

      <div class="card mb-xl">
        <div class="t-h2 mb-lg">Revenue &amp; EBITDA Trajectory</div>
        <div id="dashChart" class="chart-wrap"></div>
      </div>

      <div class="card mb-xl">
        <div class="t-h2 mb-lg">EBITDA Margin Progression</div>
        <div class="bar-chart" id="dashMarginBars"></div>
      </div>

      <div class="card mb-xl" style="overflow-x:auto">
        <div class="t-h2 mb-lg">Complete P&amp;L Summary</div>
        <div id="dashPLTable"></div>
      </div>

      <div class="card mb-xl">
        <div class="t-h2 mb-md">Model Quality Assessment</div>
        <div id="qualityChecks"></div>
      </div>

      <div class="card mb-xl">
        <div class="t-h2 mb-md">How Buyers Will Use This</div>
        <table class="fin-table">
          <thead><tr><th>Buyer Type</th><th style="text-align:left">How They Use Projections</th><th style="text-align:left">Quality Required</th></tr></thead>
          <tbody>
            <tr><td>Strategic Acquirer</td><td style="text-align:left">Validates synergy assumptions; justifies premium to board</td><td style="text-align:left"><span class="badge badge-warning">Moderate</span></td></tr>
            <tr><td>Private Equity</td><td style="text-align:left">Builds 5-year LBO model; calculates IRR and MOIC</td><td style="text-align:left"><span class="badge badge-danger">High</span></td></tr>
            <tr><td>Individual Buyer</td><td style="text-align:left">Determines if cash flow covers debt service</td><td style="text-align:left"><span class="badge badge-warning">Moderate</span></td></tr>
            <tr><td>Search Fund</td><td style="text-align:left">SBA loan requires projections; investor presentation</td><td style="text-align:left"><span class="badge badge-danger">High</span></td></tr>
          </tbody>
        </table>
      </div>

      <div class="callout callout-accent mb-xl">
        <strong>Final thought:</strong> Projections are not predictions. They are promises backed by evidence and a plan to deliver.
      </div>

      <div class="page-footer">
        <button class="btn btn-ghost" onclick="goToPage('sensitivity')">&larr; Back</button>
        <button class="btn btn-accent" onclick="exportModel()">Export Model</button>
      </div>
    </div>

  </div>
</main>
</div>

<div class="toast-container" id="toastContainer" aria-live="polite" role="status"></div>

<script>
/* ============================================================
   DATA CONSTANTS
   ============================================================ */
const REVENUE_LINES = [
  { id: 'existing_recurring', label: 'Existing recurring revenue', indent: false },
  { id: 'new_customer', label: 'New customer revenue', indent: false },
  { id: 'price_increases', label: 'Price increases', indent: false },
  { id: 'new_product', label: 'New product/service', indent: false },
  { id: 'churn', label: 'Churn / lost revenue', indent: false, negative: true }
];

const EXPENSE_LINES = [
  { id: 'cogs', label: 'COGS / Direct Costs', indent: false },
  { id: 'sales_marketing', label: 'Sales & Marketing', indent: false },
  { id: 'general_admin', label: 'General & Admin', indent: false },
  { id: 'new_hires', label: 'New Hires (incremental)', indent: false },
  { id: 'tech_rd', label: 'Technology / R&D', indent: false }
];

const CASHFLOW_LINES = [
  { id: 'maintenance_capex', label: 'Maintenance CapEx' },
  { id: 'growth_capex', label: 'Growth CapEx' },
  { id: 'working_capital', label: 'Working Capital Changes' },
  { id: 'taxes', label: 'Estimated Taxes' }
];

const SCENARIOS = [
  { id: 'base', title: 'Base Case', revMod: 0, ebitdaMod: 0, narrative: 'Most likely outcome; well-supported assumptions', color: 'var(--color-primary)' },
  { id: 'upside', title: 'Upside Case', revMod: 12.5, ebitdaMod: 20, narrative: 'Key growth lever hits; pricing increases stick; faster new customer acquisition', color: 'var(--color-success)' },
  { id: 'downside', title: 'Downside Case', revMod: -12.5, ebitdaMod: -25, narrative: 'Key client lost; slower new customer acquisition; churn increases', color: 'var(--color-warning)' },
  { id: 'recession', title: 'Recession Case', revMod: -22.5, ebitdaMod: -35, narrative: 'Macro downturn; customer spending pullback; delayed purchase decisions', color: 'var(--color-danger)' }
];

const DRIVER_CATEGORIES = [
  { id: 'customers', label: 'Number of customers x average revenue per customer', checked: false },
  { id: 'pipeline', label: 'Sales pipeline conversion rates x deal size', checked: false },
  { id: 'renewals', label: 'Existing contract renewals + new contract wins', checked: false },
  { id: 'pricing', label: 'Price increases on existing revenue', checked: false },
  { id: 'new_products', label: 'New product/service launches with ramp assumptions', checked: false }
];

/* ============================================================
   STATE
   ============================================================ */
let state = {
  currentPage: 'welcome',
  pagesUnlocked: ['welcome'],
  pagesCompleted: [],
  drivers: {},
  assumptions: [],
  revenue: {},
  expenses: {},
  cashflow: {},
  activeScenario: 'base',
  timestamp: null
};

/* ============================================================
   PERSISTENCE
   ============================================================ */
const STORAGE_KEY = 'exitosx-pb11-financial-projection';
// Migrate from old localStorage key
(function() { try { const old = localStorage.getItem('threeYearProjection'); if (old && !localStorage.getItem(STORAGE_KEY)) { localStorage.setItem(STORAGE_KEY, old); localStorage.removeItem('threeYearProjection'); } } catch(e) {} })();

function loadData() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) state = { ...state, ...JSON.parse(saved) };
  } catch(e) { console.warn('Failed to load', e); }
}

function saveData() {
  state.timestamp = new Date().toISOString();
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch(e) { console.warn('Failed to save', e); }
  updateProgress();
  const savedEl = document.getElementById('sidebarSaved');
  const timeEl = document.getElementById('savedTime');
  if (savedEl && timeEl) {
    savedEl.style.display = 'block';
    timeEl.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
}

/* ============================================================
   NAVIGATION
   ============================================================ */
function goToPage(pageId) {
  if (!state.pagesUnlocked.includes(pageId)) return;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + pageId).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.remove('active');
    if (n.dataset.page === pageId) n.classList.add('active');
  });
  state.currentPage = pageId;
  saveData();
  window.scrollTo({ top: 0, behavior: 'smooth' });
  toggleSidebar(false);
  // Focus management for accessibility
  const page = document.getElementById('page-' + pageId);
  setTimeout(() => { const heading = page.querySelector('h1, h2, .t-display'); if (heading) { heading.setAttribute('tabindex', '-1'); heading.focus(); } }, 100);

  if (pageId === 'revenue') { renderRevenueTable(); renderRevenueChart(); }
  if (pageId === 'expenses') { renderExpenseTable(); renderEbitdaChart(); }
  if (pageId === 'capex') { renderCashflowTable(); renderFCFChart(); }
  if (pageId === 'sensitivity') { renderSensitivity(); }
  if (pageId === 'dashboard') { renderDashboard(); }
}

function unlockPage(pageId) {
  if (!state.pagesUnlocked.includes(pageId)) state.pagesUnlocked.push(pageId);
  document.querySelectorAll('.nav-item').forEach(n => {
    if (state.pagesUnlocked.includes(n.dataset.page)) n.classList.remove('locked');
  });
}

function completePage(pageId) {
  if (!state.pagesCompleted.includes(pageId)) state.pagesCompleted.push(pageId);
  document.querySelectorAll('.nav-item').forEach(n => {
    if (state.pagesCompleted.includes(n.dataset.page)) n.classList.add('completed');
  });
  saveData();
}

function updateProgress() {
  const totalPages = 6;
  const done = state.pagesCompleted.length;
  const pct = Math.round((done / totalPages) * 100);
  document.getElementById('globalProgressBar').style.width = pct + '%';
  document.getElementById('globalProgressText').textContent = pct + '% complete';

  // Update sidebar metric
  const ebitda = calcEbitda();
  const rev = calcTotalRevenue();
  const metricEl = document.getElementById('sidebarMetric');
  if (ebitda.yr3 !== 0 && metricEl) {
    metricEl.style.display = 'block';
    document.getElementById('sidebarEbitda').textContent = fmtCur(ebitda.yr3);
    const margin = rev.yr3 !== 0 ? ((ebitda.yr3 / rev.yr3) * 100).toFixed(1) + '% margin' : '';
    document.getElementById('sidebarMargin').textContent = margin;
  }
}

function toggleSidebar(open) {
  const sb = document.getElementById('sidebar');
  const ov = document.getElementById('sidebarOverlay');
  if (open) { sb.classList.add('open'); ov.classList.add('show'); }
  else { sb.classList.remove('open'); ov.classList.remove('show'); }
}

function showToast(msg) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { if (t.parentNode) t.remove(); }, 3200);
}

function fmtCur(val) {
  if (!val || isNaN(val)) return '$0';
  const num = parseFloat(val);
  const abs = Math.abs(num);
  const sign = num < 0 ? '-' : '';
  if (abs >= 1000000) return sign + '$' + (abs / 1000000).toFixed(1) + 'M';
  if (abs >= 1000) return sign + '$' + (abs / 1000).toFixed(0) + 'K';
  return sign + '$' + abs.toLocaleString();
}

function fmtNum(val) {
  if (!val || isNaN(val)) return '0';
  return parseFloat(val).toLocaleString();
}

function pct(a, b) {
  if (!b || b === 0) return '0%';
  return ((a / b) * 100).toFixed(1) + '%';
}

/* ============================================================
   WELCOME
   ============================================================ */
function startJourney() {
  completePage('welcome');
  unlockPage('assumptions');
  goToPage('assumptions');
  showToast('Let\'s start by documenting your assumptions.');
}

/* ============================================================
   ASSUMPTIONS
   ============================================================ */
function renderDrivers() {
  const container = document.getElementById('revenueDrivers');
  container.innerHTML = '<div style="display:flex;flex-direction:column;gap:8px">' +
    DRIVER_CATEGORIES.map(d => {
      const checked = state.drivers[d.id] ? 'checked' : '';
      return `
        <div style="display:flex;align-items:flex-start;gap:12px;padding:12px;border-radius:6px;cursor:pointer;transition:background 150ms ease;${state.drivers[d.id] ? 'background:var(--color-primary-light)' : ''}"
             onclick="toggleDriver('${d.id}')" role="checkbox" aria-checked="${!!state.drivers[d.id]}" tabindex="0">
          <div style="width:22px;height:22px;border:2px solid ${state.drivers[d.id] ? 'var(--color-primary)' : 'var(--color-border)'};border-radius:4px;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:${state.drivers[d.id] ? 'var(--color-primary)' : 'transparent'};transition:all 150ms ease">
            <svg viewBox="0 0 14 14" width="14" height="14" style="opacity:${state.drivers[d.id] ? 1 : 0}"><polyline points="3 7 6 10 11 4" stroke="#fff" stroke-width="2.5" fill="none"/></svg>
          </div>
          <span style="font-size:14px;line-height:1.5">${d.label}</span>
        </div>
      `;
    }).join('') + '</div>';
}

function toggleDriver(id) {
  state.drivers[id] = !state.drivers[id];
  renderDrivers();
  saveData();
}

function renderAssumptions() {
  const container = document.getElementById('assumptionsList');
  if (state.assumptions.length === 0) {
    state.assumptions = [
      { id: 1, assumption: '', value: '', evidence: '', range: '' },
      { id: 2, assumption: '', value: '', evidence: '', range: '' },
      { id: 3, assumption: '', value: '', evidence: '', range: '' }
    ];
  }
  container.innerHTML = state.assumptions.map((a, i) => `
    <div class="assumption-card">
      <div class="assumption-card-header">
        <div class="t-h3">Assumption ${i + 1}</div>
        <button class="assumption-remove" onclick="removeAssumption(${i})" aria-label="Remove">&times;</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-md)">
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Assumption</label>
          <input type="text" class="form-input" placeholder="e.g. Customer churn rate" value="${a.assumption || ''}" oninput="updateAssumption(${i},'assumption',this.value)">
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Value</label>
          <input type="text" class="form-input" placeholder="e.g. 8% annually" value="${a.value || ''}" oninput="updateAssumption(${i},'value',this.value)">
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Supporting Evidence</label>
          <input type="text" class="form-input" placeholder="e.g. 3-year historical average" value="${a.evidence || ''}" oninput="updateAssumption(${i},'evidence',this.value)">
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Sensitivity Range</label>
          <input type="text" class="form-input" placeholder="e.g. 5% to 12%" value="${a.range || ''}" oninput="updateAssumption(${i},'range',this.value)">
        </div>
      </div>
    </div>
  `).join('');
}

function addAssumption() {
  state.assumptions.push({ id: Date.now(), assumption: '', value: '', evidence: '', range: '' });
  renderAssumptions();
  saveData();
}

function removeAssumption(i) {
  state.assumptions.splice(i, 1);
  renderAssumptions();
  saveData();
}

function updateAssumption(i, field, value) {
  state.assumptions[i][field] = value;
  saveData();
}

function completeAssumptions() {
  completePage('assumptions');
  unlockPage('revenue');
  goToPage('revenue');
  showToast('Assumptions documented. Now build your revenue projection.');
}

/* ============================================================
   REVENUE
   ============================================================ */
function getRevVal(lineId, period) {
  return state.revenue[lineId] ? (parseFloat(state.revenue[lineId][period]) || 0) : 0;
}

function setRevVal(lineId, period, val) {
  if (!state.revenue[lineId]) state.revenue[lineId] = {};
  state.revenue[lineId][period] = val;
  renderRevenueTable();
  renderRevenueChart();
  saveData();
}

function setRevNotes(lineId, val) {
  if (!state.revenue[lineId]) state.revenue[lineId] = {};
  state.revenue[lineId].notes = val;
  saveData();
}

function calcTotalRevenue() {
  const periods = ['trailing', 'yr1', 'yr2', 'yr3'];
  const totals = {};
  periods.forEach(p => {
    totals[p] = 0;
    REVENUE_LINES.forEach(line => {
      const v = getRevVal(line.id, p);
      totals[p] += line.negative ? -Math.abs(v) : v;
    });
  });
  return totals;
}

function renderRevenueTable() {
  const body = document.getElementById('revenueBody');
  const periods = ['trailing', 'yr1', 'yr2', 'yr3'];
  const totals = calcTotalRevenue();

  body.innerHTML = REVENUE_LINES.map(line => {
    const notes = (state.revenue[line.id] || {}).notes || '';
    return `<tr>
      <td class="${line.indent ? 'indent' : ''}">${line.label}</td>
      ${periods.map(p => `<td><input type="number" placeholder="$0" value="${getRevVal(line.id, p) || ''}" onchange="setRevVal('${line.id}','${p}',this.value)"></td>`).join('')}
      <td><textarea placeholder="Describe driver..." onchange="setRevNotes('${line.id}',this.value)">${notes}</textarea></td>
    </tr>`;
  }).join('') + `
    <tr class="total-row">
      <td>TOTAL REVENUE</td>
      ${periods.map(p => `<td>${fmtCur(totals[p])}</td>`).join('')}
      <td></td>
    </tr>
    <tr>
      <td class="row-label">YoY Growth</td>
      <td>--</td>
      ${['yr1','yr2','yr3'].map((p, i) => {
        const prev = i === 0 ? totals.trailing : totals[periods[i+1]];
        const curr = totals[p];
        const growth = prev !== 0 ? ((curr - prev) / Math.abs(prev) * 100).toFixed(1) + '%' : '--';
        return `<td>${growth}</td>`;
      }).join('')}
      <td></td>
    </tr>
  `;
}

function renderRevenueChart() {
  const totals = calcTotalRevenue();
  const vals = [totals.trailing, totals.yr1, totals.yr2, totals.yr3];
  const max = Math.max(...vals.map(v => Math.abs(v)), 1);
  const container = document.getElementById('revenueChart');
  const labels = ['Trailing', 'Year 1', 'Year 2', 'Year 3'];
  const barW = 60;
  const chartH = 200;
  const gap = 40;
  const totalW = (barW + gap) * 4 + gap;

  container.innerHTML = `
    <svg class="chart-svg" viewBox="0 0 ${totalW} ${chartH + 50}" style="max-height:280px">
      ${vals.map((v, i) => {
        const h = Math.max((Math.abs(v) / max) * chartH, 4);
        const x = gap + i * (barW + gap);
        const y = chartH - h;
        const color = v >= 0 ? 'var(--color-primary)' : 'var(--color-danger)';
        return `
          <rect x="${x}" y="${y}" width="${barW}" height="${h}" fill="${color}" rx="4" opacity="0.85">
            <animate attributeName="height" from="0" to="${h}" dur="0.6s" fill="freeze" begin="${i*0.1}s"/>
            <animate attributeName="y" from="${chartH}" to="${y}" dur="0.6s" fill="freeze" begin="${i*0.1}s"/>
          </rect>
          <text x="${x + barW/2}" y="${y - 8}" text-anchor="middle" font-size="12" font-weight="600" fill="var(--color-text)">${fmtCur(v)}</text>
          <text x="${x + barW/2}" y="${chartH + 20}" text-anchor="middle" font-size="11" fill="var(--color-text-secondary)">${labels[i]}</text>
        `;
      }).join('')}
      <line x1="${gap - 10}" y1="${chartH}" x2="${totalW - gap + 10}" y2="${chartH}" stroke="var(--color-border)" stroke-width="1"/>
    </svg>
  `;
}

function completeRevenue() {
  completePage('revenue');
  unlockPage('expenses');
  goToPage('expenses');
  showToast('Revenue projection saved. Now model your expenses.');
}

/* ============================================================
   EXPENSES
   ============================================================ */
function getExpVal(lineId, period) {
  return state.expenses[lineId] ? (parseFloat(state.expenses[lineId][period]) || 0) : 0;
}

function setExpVal(lineId, period, val) {
  if (!state.expenses[lineId]) state.expenses[lineId] = {};
  state.expenses[lineId][period] = val;
  renderExpenseTable();
  renderEbitdaChart();
  saveData();
}

function setExpNotes(lineId, val) {
  if (!state.expenses[lineId]) state.expenses[lineId] = {};
  state.expenses[lineId].notes = val;
  saveData();
}

function calcTotalExpenses() {
  const periods = ['trailing', 'yr1', 'yr2', 'yr3'];
  const totals = {};
  periods.forEach(p => {
    totals[p] = 0;
    EXPENSE_LINES.forEach(line => { totals[p] += getExpVal(line.id, p); });
  });
  return totals;
}

function calcEbitda() {
  const rev = calcTotalRevenue();
  const exp = calcTotalExpenses();
  return {
    trailing: rev.trailing - exp.trailing,
    yr1: rev.yr1 - exp.yr1,
    yr2: rev.yr2 - exp.yr2,
    yr3: rev.yr3 - exp.yr3
  };
}

function renderExpenseTable() {
  const body = document.getElementById('expenseBody');
  const periods = ['trailing', 'yr1', 'yr2', 'yr3'];
  const expTotals = calcTotalExpenses();
  const ebitda = calcEbitda();
  const rev = calcTotalRevenue();

  body.innerHTML = EXPENSE_LINES.map(line => {
    const notes = (state.expenses[line.id] || {}).notes || '';
    return `<tr>
      <td>${line.label}</td>
      ${periods.map(p => `<td><input type="number" placeholder="$0" value="${getExpVal(line.id, p) || ''}" onchange="setExpVal('${line.id}','${p}',this.value)"></td>`).join('')}
      <td><textarea placeholder="Assumptions..." onchange="setExpNotes('${line.id}',this.value)">${notes}</textarea></td>
    </tr>`;
  }).join('') + `
    <tr class="subtotal-row">
      <td>TOTAL EXPENSES</td>
      ${periods.map(p => `<td>${fmtCur(expTotals[p])}</td>`).join('')}
      <td></td>
    </tr>
    <tr class="total-row">
      <td>PROJECTED EBITDA</td>
      ${periods.map(p => `<td class="${ebitda[p] < 0 ? 'negative' : ''}">${fmtCur(ebitda[p])}</td>`).join('')}
      <td></td>
    </tr>
    <tr>
      <td class="row-label">EBITDA Margin</td>
      ${periods.map(p => `<td>${rev[p] !== 0 ? ((ebitda[p] / rev[p]) * 100).toFixed(1) + '%' : '--'}</td>`).join('')}
      <td></td>
    </tr>
  `;
}

function renderEbitdaChart() {
  const rev = calcTotalRevenue();
  const ebitda = calcEbitda();
  const container = document.getElementById('ebitdaChart');
  const labels = ['Trailing', 'Year 1', 'Year 2', 'Year 3'];
  const periods = ['trailing', 'yr1', 'yr2', 'yr3'];
  const allVals = [...periods.map(p => rev[p]), ...periods.map(p => ebitda[p])];
  const max = Math.max(...allVals.map(v => Math.abs(v)), 1);
  const chartH = 200;
  const barW = 28;
  const groupW = barW * 2 + 8;
  const gap = 50;
  const totalW = (groupW + gap) * 4 + gap * 2;

  container.innerHTML = `
    <svg class="chart-svg" viewBox="0 0 ${totalW} ${chartH + 50}" style="max-height:280px">
      ${periods.map((p, i) => {
        const revH = Math.max((Math.abs(rev[p]) / max) * chartH, 4);
        const ebitdaH = Math.max((Math.abs(ebitda[p]) / max) * chartH, 4);
        const x = gap + i * (groupW + gap);
        return `
          <rect x="${x}" y="${chartH - revH}" width="${barW}" height="${revH}" fill="var(--color-chart-1)" rx="3" opacity="0.8"/>
          <rect x="${x + barW + 8}" y="${chartH - ebitdaH}" width="${barW}" height="${ebitdaH}" fill="var(--color-chart-2)" rx="3" opacity="0.8"/>
          <text x="${x + groupW/2}" y="${chartH + 20}" text-anchor="middle" font-size="11" fill="var(--color-text-secondary)">${labels[i]}</text>
        `;
      }).join('')}
      <line x1="${gap - 10}" y1="${chartH}" x2="${totalW - gap + 10}" y2="${chartH}" stroke="var(--color-border)" stroke-width="1"/>
    </svg>
    <div class="chart-legend">
      <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--color-chart-1)"></div>Revenue</div>
      <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--color-chart-2)"></div>EBITDA</div>
    </div>
  `;
}

function completeExpenses() {
  completePage('expenses');
  unlockPage('capex');
  goToPage('capex');
  showToast('Expenses modeled. Now calculate free cash flow.');
}

/* ============================================================
   CAPEX & CASH FLOW
   ============================================================ */
function getCFVal(lineId, period) {
  return state.cashflow[lineId] ? (parseFloat(state.cashflow[lineId][period]) || 0) : 0;
}

function setCFVal(lineId, period, val) {
  if (!state.cashflow[lineId]) state.cashflow[lineId] = {};
  state.cashflow[lineId][period] = val;
  renderCashflowTable();
  renderFCFChart();
  saveData();
}

function calcFCF() {
  const ebitda = calcEbitda();
  const periods = ['yr1', 'yr2', 'yr3'];
  const result = {};
  periods.forEach(p => {
    let deductions = 0;
    CASHFLOW_LINES.forEach(line => { deductions += getCFVal(line.id, p); });
    result[p] = ebitda[p] - deductions;
  });
  return result;
}

function renderCashflowTable() {
  const body = document.getElementById('cashflowBody');
  const ebitda = calcEbitda();
  const fcf = calcFCF();
  const periods = ['yr1', 'yr2', 'yr3'];

  body.innerHTML = `
    <tr class="subtotal-row">
      <td>Projected EBITDA</td>
      ${periods.map(p => `<td>${fmtCur(ebitda[p])}</td>`).join('')}
    </tr>
    ${CASHFLOW_LINES.map(line => `
      <tr>
        <td style="padding-left:20px">- ${line.label}</td>
        ${periods.map(p => `<td><input type="number" placeholder="$0" value="${getCFVal(line.id, p) || ''}" onchange="setCFVal('${line.id}','${p}',this.value)"></td>`).join('')}
      </tr>
    `).join('')}
    <tr class="total-row">
      <td>= Free Cash Flow</td>
      ${periods.map(p => `<td class="${fcf[p] < 0 ? 'negative' : ''}">${fmtCur(fcf[p])}</td>`).join('')}
    </tr>
    <tr>
      <td class="row-label">FCF Conversion (FCF/EBITDA)</td>
      ${periods.map(p => `<td>${ebitda[p] !== 0 ? ((fcf[p] / ebitda[p]) * 100).toFixed(1) + '%' : '--'}</td>`).join('')}
    </tr>
  `;
}

function renderFCFChart() {
  const ebitda = calcEbitda();
  const fcf = calcFCF();
  const container = document.getElementById('fcfConversionChart');
  const periods = ['yr1', 'yr2', 'yr3'];
  const labels = ['Year 1', 'Year 2', 'Year 3'];

  container.innerHTML = '<div class="bar-chart">' + periods.map((p, i) => {
    const conversion = ebitda[p] !== 0 ? ((fcf[p] / ebitda[p]) * 100) : 0;
    const barColor = conversion >= 70 ? 'var(--color-success)' : conversion >= 50 ? 'var(--color-warning)' : 'var(--color-danger)';
    return `
      <div class="bar-row">
        <div class="bar-label">${labels[i]}</div>
        <div class="bar-track">
          <div class="bar-fill animated" style="width:${Math.min(Math.abs(conversion), 100)}%;background:${barColor}">
            <span class="bar-value">${conversion.toFixed(1)}%</span>
          </div>
        </div>
      </div>
    `;
  }).join('') + '</div>';
}

function completeCapex() {
  completePage('capex');
  unlockPage('sensitivity');
  goToPage('sensitivity');
  showToast('Cash flow calculated. Let\'s run the sensitivity analysis.');
}

/* ============================================================
   SENSITIVITY ANALYSIS
   ============================================================ */
function renderSensitivity() {
  const ebitda = calcEbitda();
  const rev = calcTotalRevenue();
  const gridEl = document.getElementById('sensitivityGrid');

  gridEl.innerHTML = SCENARIOS.map(s => {
    const adjRev = rev.yr3 * (1 + s.revMod / 100);
    const adjEbitda = ebitda.yr3 * (1 + s.ebitdaMod / 100);
    return `
      <div class="sensitivity-card ${state.activeScenario === s.id ? 'active' : ''}" onclick="selectScenario('${s.id}')" style="border-color:${state.activeScenario === s.id ? s.color : ''}">
        <div class="sensitivity-card-title">${s.title}</div>
        <div class="sensitivity-card-val" style="color:${s.color}">${fmtCur(adjEbitda)}</div>
        <div class="sensitivity-card-sub">EBITDA (${s.ebitdaMod > 0 ? '+' : ''}${s.ebitdaMod}%)</div>
        <div class="t-caption t-tertiary" style="margin-top:8px">Revenue: ${fmtCur(adjRev)}</div>
      </div>
    `;
  }).join('');

  renderScenarioDetail();
}

function selectScenario(id) {
  state.activeScenario = id;
  renderSensitivity();
  saveData();
}

function renderScenarioDetail() {
  const s = SCENARIOS.find(s => s.id === state.activeScenario);
  const rev = calcTotalRevenue();
  const ebitda = calcEbitda();
  const container = document.getElementById('scenarioDetail');

  const periods = ['yr1', 'yr2', 'yr3'];
  const labels = ['Year 1', 'Year 2', 'Year 3'];

  container.innerHTML = `
    <div class="flex items-center gap-md mb-lg">
      <div style="width:12px;height:12px;border-radius:3px;background:${s.color}"></div>
      <div class="t-h3">${s.title}</div>
      <span class="badge" style="background:${s.color}20;color:${s.color}">Revenue ${s.revMod > 0 ? '+' : ''}${s.revMod}% / EBITDA ${s.ebitdaMod > 0 ? '+' : ''}${s.ebitdaMod}%</span>
    </div>
    <p class="t-small t-secondary mb-lg">${s.narrative}</p>
    <table class="fin-table" style="font-size:13px">
      <thead>
        <tr><th style="text-align:left">Metric</th>${labels.map(l => `<th>${l}</th>`).join('')}</tr>
      </thead>
      <tbody>
        <tr>
          <td>Revenue</td>
          ${periods.map(p => `<td>${fmtCur(rev[p] * (1 + s.revMod / 100))}</td>`).join('')}
        </tr>
        <tr>
          <td>EBITDA</td>
          ${periods.map(p => `<td class="${ebitda[p] * (1 + s.ebitdaMod / 100) < 0 ? 'negative' : ''}">${fmtCur(ebitda[p] * (1 + s.ebitdaMod / 100))}</td>`).join('')}
        </tr>
        <tr>
          <td class="row-label">vs. Base Case</td>
          ${periods.map(p => {
            const diff = ebitda[p] * (s.ebitdaMod / 100);
            return `<td class="${diff < 0 ? 'negative' : ''}" style="color:${diff >= 0 ? 'var(--color-success)' : 'var(--color-danger)'}">${diff >= 0 ? '+' : ''}${fmtCur(diff)}</td>`;
          }).join('')}
        </tr>
      </tbody>
    </table>
  `;
}

function completeSensitivity() {
  completePage('sensitivity');
  unlockPage('dashboard');
  goToPage('dashboard');
  showToast('Model complete. Here is your projection summary.');
}

/* ============================================================
   DASHBOARD
   ============================================================ */
function renderDashboard() {
  const rev = calcTotalRevenue();
  const ebitda = calcEbitda();
  const fcf = calcFCF();

  document.getElementById('dashTrailing').textContent = fmtCur(rev.trailing);
  document.getElementById('dashYr3Rev').textContent = fmtCur(rev.yr3);
  document.getElementById('dashYr3Ebitda').textContent = fmtCur(ebitda.yr3);
  document.getElementById('dashYr3Fcf').textContent = fmtCur(fcf.yr3);

  // Combined chart
  const dashChart = document.getElementById('dashChart');
  const labels = ['Trailing', 'Year 1', 'Year 2', 'Year 3'];
  const periods = ['trailing', 'yr1', 'yr2', 'yr3'];
  const allVals = [...periods.map(p => rev[p]), ...periods.map(p => ebitda[p])];
  const max = Math.max(...allVals.map(v => Math.abs(v)), 1);
  const chartH = 220;
  const barW = 32;
  const groupW = barW * 2 + 10;
  const gap = 50;
  const totalW = (groupW + gap) * 4 + gap * 2;

  dashChart.innerHTML = `
    <svg class="chart-svg" viewBox="0 0 ${totalW} ${chartH + 50}" style="max-height:300px">
      ${periods.map((p, i) => {
        const revH = Math.max((Math.abs(rev[p]) / max) * chartH, 4);
        const ebitdaH = Math.max((Math.abs(ebitda[p]) / max) * chartH, 4);
        const x = gap + i * (groupW + gap);
        return `
          <rect x="${x}" y="${chartH - revH}" width="${barW}" height="${revH}" fill="var(--color-chart-1)" rx="3" opacity="0.85"/>
          <text x="${x + barW/2}" y="${chartH - revH - 6}" text-anchor="middle" font-size="10" fill="var(--color-text-secondary)">${fmtCur(rev[p])}</text>
          <rect x="${x + barW + 10}" y="${chartH - ebitdaH}" width="${barW}" height="${ebitdaH}" fill="var(--color-chart-2)" rx="3" opacity="0.85"/>
          <text x="${x + barW + 10 + barW/2}" y="${chartH - ebitdaH - 6}" text-anchor="middle" font-size="10" fill="var(--color-text-secondary)">${fmtCur(ebitda[p])}</text>
          <text x="${x + groupW/2}" y="${chartH + 20}" text-anchor="middle" font-size="11" fill="var(--color-text-secondary)">${labels[i]}</text>
        `;
      }).join('')}
      <line x1="${gap - 10}" y1="${chartH}" x2="${totalW - gap + 10}" y2="${chartH}" stroke="var(--color-border)" stroke-width="1"/>
    </svg>
    <div class="chart-legend">
      <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--color-chart-1)"></div>Revenue</div>
      <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--color-chart-2)"></div>EBITDA</div>
    </div>
  `;

  // Margin bars
  const marginBars = document.getElementById('dashMarginBars');
  marginBars.innerHTML = periods.map((p, i) => {
    const margin = rev[p] !== 0 ? ((ebitda[p] / rev[p]) * 100) : 0;
    const barColor = margin >= 20 ? 'var(--color-success)' : margin >= 10 ? 'var(--color-warning)' : 'var(--color-danger)';
    return `
      <div class="bar-row">
        <div class="bar-label">${labels[i]}</div>
        <div class="bar-track">
          <div class="bar-fill animated" style="width:${Math.min(Math.max(margin, 0), 100)}%;background:${barColor}">
            <span class="bar-value">${margin.toFixed(1)}%</span>
          </div>
        </div>
      </div>
    `;
  }).join('');

  // P&L Summary
  const exp = calcTotalExpenses();
  document.getElementById('dashPLTable').innerHTML = `
    <table class="fin-table">
      <thead>
        <tr><th style="min-width:180px">Line Item</th><th>Trailing</th><th>Year 1</th><th>Year 2</th><th>Year 3</th></tr>
      </thead>
      <tbody>
        ${REVENUE_LINES.map(line => `
          <tr><td${line.negative ? ' class="negative"' : ''}>${line.label}</td>${periods.map(p => `<td${line.negative ? ' class="negative"' : ''}>${fmtCur(line.negative ? -Math.abs(getRevVal(line.id, p)) : getRevVal(line.id, p))}</td>`).join('')}</tr>
        `).join('')}
        <tr class="subtotal-row"><td>Total Revenue</td>${periods.map(p => `<td>${fmtCur(rev[p])}</td>`).join('')}</tr>
        ${EXPENSE_LINES.map(line => `
          <tr><td>${line.label}</td>${periods.map(p => `<td>${fmtCur(getExpVal(line.id, p))}</td>`).join('')}</tr>
        `).join('')}
        <tr class="subtotal-row"><td>Total Expenses</td>${periods.map(p => `<td>${fmtCur(exp[p])}</td>`).join('')}</tr>
        <tr class="total-row"><td>EBITDA</td>${periods.map(p => `<td class="${ebitda[p] < 0 ? 'negative' : ''}">${fmtCur(ebitda[p])}</td>`).join('')}</tr>
        <tr><td class="row-label">EBITDA Margin</td>${periods.map(p => `<td>${rev[p] !== 0 ? ((ebitda[p] / rev[p]) * 100).toFixed(1) + '%' : '--'}</td>`).join('')}</tr>
        <tr><td class="row-label" style="padding-top:16px">- CapEx (Maintenance + Growth)</td>${['yr1','yr2','yr3'].map(p => `<td style="padding-top:16px">${fmtCur(getCFVal('maintenance_capex', p) + getCFVal('growth_capex', p))}</td>`).join('')}<td></td></tr>
        <tr><td class="row-label">- Working Capital &amp; Taxes</td>${['yr1','yr2','yr3'].map(p => `<td>${fmtCur(getCFVal('working_capital', p) + getCFVal('taxes', p))}</td>`).join('')}<td></td></tr>
        <tr class="total-row"><td>Free Cash Flow</td><td>--</td>${['yr1','yr2','yr3'].map(p => `<td class="${fcf[p] < 0 ? 'negative' : ''}">${fmtCur(fcf[p])}</td>`).join('')}</tr>
      </tbody>
    </table>
  `;

  // Quality checks
  const checks = [];
  const revGrowth = rev.trailing !== 0 ? ((rev.yr3 - rev.trailing) / Math.abs(rev.trailing)) * 100 : 0;
  const hasChurn = getRevVal('churn', 'yr1') > 0 || getRevVal('churn', 'yr2') > 0 || getRevVal('churn', 'yr3') > 0;
  const hasNewHires = getExpVal('new_hires', 'yr1') > 0 || getExpVal('new_hires', 'yr2') > 0;
  const hasCapex = getCFVal('maintenance_capex', 'yr1') > 0 || getCFVal('growth_capex', 'yr1') > 0;
  const assumptionsDone = state.assumptions.filter(a => a.assumption && a.evidence).length;

  checks.push({ pass: revGrowth <= 100 && revGrowth >= -20, text: 'Revenue growth is realistic (not a hockey stick)', detail: `3-year growth: ${revGrowth.toFixed(0)}%` });
  checks.push({ pass: hasChurn, text: 'Customer churn is accounted for', detail: hasChurn ? 'Churn modeled' : 'No churn included -- buyers will question this' });
  checks.push({ pass: hasNewHires || revGrowth < 10, text: 'Headcount growth supports revenue growth', detail: hasNewHires ? 'New hires included' : 'No new hires planned' });
  checks.push({ pass: hasCapex, text: 'Capital expenditures are included', detail: hasCapex ? 'CapEx modeled' : 'No CapEx -- is this realistic?' });
  checks.push({ pass: assumptionsDone >= 3, text: 'At least 3 assumptions documented with evidence', detail: `${assumptionsDone} assumptions documented` });
  checks.push({ pass: Object.values(state.drivers).filter(v => v).length >= 2, text: 'Multiple revenue drivers identified', detail: `${Object.values(state.drivers).filter(v => v).length} drivers selected` });

  document.getElementById('qualityChecks').innerHTML = checks.map(c => `
    <div style="display:flex;align-items:flex-start;gap:12px;padding:12px;border-bottom:1px solid var(--color-border-light)">
      <div style="width:24px;height:24px;border-radius:50%;background:${c.pass ? 'var(--color-success)' : 'var(--color-danger)'};display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <svg viewBox="0 0 14 14" width="14" height="14"><polyline points="${c.pass ? '3 7 6 10 11 4' : '4 4 10 10'}" stroke="#fff" stroke-width="2" fill="none"/>${!c.pass ? '<polyline points="10 4 4 10" stroke="#fff" stroke-width="2" fill="none"/>' : ''}</svg>
      </div>
      <div>
        <div style="font-weight:500;font-size:14px">${c.text}</div>
        <div style="font-size:12px;color:var(--color-text-secondary);margin-top:2px">${c.detail}</div>
      </div>
    </div>
  `).join('');
}

function exportModel() {
  const rev = calcTotalRevenue();
  const exp = calcTotalExpenses();
  const ebitda = calcEbitda();
  const fcf = calcFCF();

  let text = 'THREE-YEAR FINANCIAL PROJECTION MODEL\n';
  text += '======================================\n\n';
  text += 'REVENUE PROJECTION\n';
  text += `  Trailing: ${fmtCur(rev.trailing)}\n`;
  text += `  Year 1:   ${fmtCur(rev.yr1)}\n`;
  text += `  Year 2:   ${fmtCur(rev.yr2)}\n`;
  text += `  Year 3:   ${fmtCur(rev.yr3)}\n\n`;
  text += 'EBITDA PROJECTION\n';
  text += `  Trailing: ${fmtCur(ebitda.trailing)}\n`;
  text += `  Year 1:   ${fmtCur(ebitda.yr1)}\n`;
  text += `  Year 2:   ${fmtCur(ebitda.yr2)}\n`;
  text += `  Year 3:   ${fmtCur(ebitda.yr3)}\n\n`;
  text += 'FREE CASH FLOW\n';
  text += `  Year 1:   ${fmtCur(fcf.yr1)}\n`;
  text += `  Year 2:   ${fmtCur(fcf.yr2)}\n`;
  text += `  Year 3:   ${fmtCur(fcf.yr3)}\n\n`;
  text += 'EBITDA MARGINS\n';
  ['trailing','yr1','yr2','yr3'].forEach(p => {
    const margin = rev[p] !== 0 ? ((ebitda[p] / rev[p]) * 100).toFixed(1) : 0;
    text += `  ${p === 'trailing' ? 'Trailing' : p.replace('yr', 'Year ')}: ${margin}%\n`;
  });
  text += '\nKEY ASSUMPTIONS\n';
  state.assumptions.filter(a => a.assumption).forEach(a => {
    text += `  - ${a.assumption}: ${a.value} (${a.evidence})\n`;
  });
  text += '\nSENSITIVITY ANALYSIS\n';
  SCENARIOS.forEach(s => {
    text += `  ${s.title}: Revenue ${s.revMod > 0 ? '+' : ''}${s.revMod}%, EBITDA ${s.ebitdaMod > 0 ? '+' : ''}${s.ebitdaMod}%\n`;
    text += `    Year 3 EBITDA: ${fmtCur(ebitda.yr3 * (1 + s.ebitdaMod / 100))}\n`;
  });

  const blob = new Blob([text], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'three-year-projection.txt';
  a.click();
  showToast('Projection exported successfully.');
}

/* ============================================================
   INITIALIZATION
   ============================================================ */
function init() {
  loadData();

  state.pagesUnlocked.forEach(p => unlockPage(p));
  state.pagesCompleted.forEach(p => {
    document.querySelectorAll('.nav-item').forEach(n => {
      if (n.dataset.page === p) n.classList.add('completed');
    });
  });

  renderDrivers();
  renderAssumptions();

  if (state.currentPage && state.pagesUnlocked.includes(state.currentPage)) {
    goToPage(state.currentPage);
  }

  updateProgress();

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      if (e.target.getAttribute('role') === 'checkbox' || e.target.classList.contains('nav-item')) {
        e.preventDefault();
        e.target.click();
      }
    }
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('embedded') === 'true') {
    // Hide playbook's own chrome
    var sidebar = document.querySelector('.sidebar');
    var overlay = document.querySelector('.sidebar-overlay');
    var mobileHeader = document.querySelector('.mobile-header');
    var mainContent = document.querySelector('.main-content');
    if (sidebar) sidebar.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    if (mobileHeader) mobileHeader.style.display = 'none';
    if (mainContent) {
      mainContent.style.marginLeft = '0';
      mainContent.style.minHeight = 'auto';
    }

    // Navigate to specific section if requested
    var section = params.get('section');
    if (section !== null) {
      var sectionIndex = parseInt(section, 10);
      if (typeof navigateToSection === 'function') {
        setTimeout(function() { navigateToSection(sectionIndex); }, 100);
      }
    }

    // Forward score updates to parent
    var origDispatch = window.dispatchEvent.bind(window);
    window.addEventListener('playbook:score-update', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:score-update',
          detail: e.detail
        }, '*');
      }
    });

    // Forward section changes to parent
    window.addEventListener('playbook:section-change', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:section-change',
          detail: e.detail
        }, '*');
      }
    });

    // Listen for commands from parent
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'navigate-section') {
        if (typeof navigateToSection === 'function') {
          navigateToSection(e.data.sectionIndex);
        }
      }
    });
  }
})();
</script>
</body>
</html>
