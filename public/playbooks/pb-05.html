<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tax &amp; Estate Pre-Planning | Exit Planning Playbook #5</title>
<style>
:root {
  --color-bg: #F5F5F7;
  --color-surface: #FFFFFF;
  --color-surface-alt: #F2F2F7;
  --color-border: #E5E7EB;
  --color-border-light: #F2F2F7;
  --color-text: #1D1D1F;
  --color-text-secondary: #6E6E73;
  --color-text-tertiary: #8E8E93;
  --color-primary: #0071E3;
  --color-primary-light: #EBF5FF;
  --color-primary-hover: #0051B3;
  --color-accent: #FF9500;
  --color-accent-light: #FFF6E8;
  --color-danger: #FF3B30;
  --color-danger-light: #FFEBEA;
  --color-warning: #C67F20;
  --color-warning-light: #FFF8EB;
  --color-success: #34C759;
  --color-success-light: #E8F8ED;
  --color-score-1: #FF3B30;
  --color-score-2: #FF9500;
  --color-score-3: #FFCC00;
  --color-score-4: #34C759;
  --color-score-5: #30D158;
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-xl: 24px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.1);
  --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', sans-serif;
  --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', sans-serif;
  --transition-fast: 150ms ease;
  --transition-normal: 250ms ease;
  --transition-slow: 400ms cubic-bezier(0.16, 1, 0.3, 1);
  --space-xs: 4px; --space-sm: 8px; --space-md: 16px; --space-lg: 24px;
  --space-xl: 32px; --space-2xl: 48px; --space-3xl: 64px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body { font-family: var(--font-body); font-size: 16px; line-height: 1.6; color: var(--color-text); background: var(--color-bg); -webkit-font-smoothing: antialiased; min-height: 100vh; }
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea, select { font-family: inherit; font-size: inherit; }
a { color: var(--color-primary); text-decoration: none; }

.t-display { font-family: var(--font-display); font-size: clamp(28px, 4vw, 40px); font-weight: 700; line-height: 1.2; letter-spacing: -0.02em; }
.t-h1 { font-family: var(--font-display); font-size: clamp(22px, 3vw, 30px); font-weight: 700; line-height: 1.25; }
.t-h2 { font-size: 20px; font-weight: 600; line-height: 1.3; }
.t-h3 { font-size: 16px; font-weight: 600; line-height: 1.4; }
.t-body { font-size: 16px; line-height: 1.6; }
.t-small { font-size: 14px; line-height: 1.5; }
.t-caption { font-size: 12px; line-height: 1.4; letter-spacing: 0.02em; }
.t-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); }
.t-secondary { color: var(--color-text-secondary); }
.t-tertiary { color: var(--color-text-tertiary); }

.app { display: flex; min-height: 100vh; }
.sidebar { width: 260px; min-width: 260px; background: #FFFFFF; border-right: 1px solid var(--color-border); color: var(--color-text); padding: var(--space-lg); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; transition: transform var(--transition-slow); overflow-y: auto; }
.sidebar.collapsed { transform: translateX(-260px); }
.main-content { flex: 1; margin-left: 260px; min-height: 100vh; transition: margin-left var(--transition-slow); }
.sidebar.collapsed + .main-content { margin-left: 0; }
.content-area { max-width: 820px; margin: 0 auto; padding: var(--space-2xl) var(--space-lg); }

.mobile-header { display: none; position: sticky; top: 0; z-index: 90; background: var(--color-surface); border-bottom: 1px solid var(--color-border); padding: var(--space-md) var(--space-lg); align-items: center; gap: var(--space-md); }
.hamburger { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); }
.hamburger:hover { background: var(--color-surface-alt); }
.hamburger span { display: block; width: 18px; height: 2px; background: var(--color-text); position: relative; }
.hamburger span::before, .hamburger span::after { content: ''; position: absolute; width: 18px; height: 2px; background: var(--color-text); left: 0; }
.hamburger span::before { top: -6px; }
.hamburger span::after { top: 6px; }
.sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 99; }

@media (max-width: 900px) {
  .sidebar { transform: translateX(-260px); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.show { display: block; }
  .main-content { margin-left: 0 !important; }
  .mobile-header { display: flex; }
  .content-area { padding: var(--space-lg) var(--space-md); }
}

.sidebar-brand { margin-bottom: var(--space-xl); }
.sidebar-brand-label { font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-xs); }
.sidebar-brand-title { font-family: var(--font-display); font-size: 18px; font-weight: 700; color: var(--color-text); line-height: 1.3; }
.sidebar-progress { margin-bottom: var(--space-xl); padding: var(--space-md); background: var(--color-surface-alt); border-radius: var(--radius-md); }
.sidebar-progress-label { font-size: 12px; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-progress-bar { height: 4px; background: var(--color-border); border-radius: 2px; overflow: hidden; }
.sidebar-progress-fill { height: 100%; background: var(--color-accent); border-radius: 2px; transition: width var(--transition-slow); }
.sidebar-progress-text { font-size: 12px; color: var(--color-text-tertiary); margin-top: var(--space-sm); text-align: right; }
.sidebar-nav { flex: 1; display: flex; flex-direction: column; gap: 2px; }
.nav-section-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-text-tertiary); padding: var(--space-md) var(--space-sm) var(--space-xs); }
.nav-item { display: flex; align-items: center; gap: var(--space-md); padding: 10px 12px; border-radius: var(--radius-sm); color: var(--color-text-secondary); font-size: 14px; transition: all var(--transition-fast); cursor: pointer; }
.nav-item:hover { background: var(--color-surface-alt); color: var(--color-text); }
.nav-item.active { background: var(--color-primary-light); color: var(--color-primary); font-weight: 500; border-left: 3px solid var(--color-primary); }
.nav-item.completed .nav-check { display: flex; }
.nav-item.locked { opacity: 0.4; cursor: default; }
.nav-item.locked:hover { background: none; color: var(--color-text-tertiary); }
.nav-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; }
.nav-check { display: none; width: 16px; height: 16px; background: var(--color-success); border-radius: 50%; align-items: center; justify-content: center; margin-left: auto; flex-shrink: 0; }
.nav-check svg { width: 10px; height: 10px; stroke: #fff; stroke-width: 2.5; fill: none; }
.sidebar-score { margin-top: auto; padding-top: var(--space-lg); border-top: 1px solid var(--color-border); }
.sidebar-score-label { font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-text-tertiary); margin-bottom: var(--space-sm); }
.sidebar-score-value { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--color-text); line-height: 1; }
.sidebar-score-desc { font-size: 12px; color: var(--color-text-secondary); margin-top: var(--space-xs); }

.card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--space-lg); transition: box-shadow var(--transition-normal); }
.card:hover { box-shadow: var(--shadow-sm); }
.callout { padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); border-left: 3px solid; font-size: 14px; line-height: 1.6; }
.callout-info { background: var(--color-primary-light); border-color: var(--color-primary); color: var(--color-primary); }
.callout-warning { background: var(--color-warning-light); border-color: var(--color-warning); color: #7C5500; }
.callout-danger { background: var(--color-danger-light); border-color: var(--color-danger); color: var(--color-danger); }
.callout-accent { background: var(--color-accent-light); border-color: var(--color-accent); color: #7C5500; }

.btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); padding: 10px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500; transition: all var(--transition-fast); white-space: nowrap; }
.btn-primary { background: var(--color-primary); color: #fff; }
.btn-primary:hover { background: var(--color-primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.btn-secondary { background: var(--color-surface); color: var(--color-text); border: 1px solid var(--color-border); }
.btn-secondary:hover { background: var(--color-surface-alt); }
.btn-ghost { color: var(--color-text-secondary); padding: 8px 12px; }
.btn-ghost:hover { background: var(--color-surface-alt); color: var(--color-text); }
.btn-accent { background: var(--color-accent); color: #fff; }
.btn-accent:hover { background: #E68600; }
.btn-lg { padding: 14px 28px; font-size: 16px; border-radius: var(--radius-md); }
.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

.form-group { margin-bottom: var(--space-lg); }
.form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: var(--space-sm); }
.form-hint { font-size: 13px; color: var(--color-text-tertiary); margin-top: var(--space-xs); }
.form-input { width: 100%; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 15px; background: var(--color-surface); transition: all var(--transition-fast); color: var(--color-text); }
.form-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light); }
.form-input::placeholder { color: var(--color-text-tertiary); }
textarea.form-input { min-height: 70px; resize: vertical; line-height: 1.5; }
select.form-input { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%236E6E73' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }

.action-input-mini { width: 100%; padding: 6px 10px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 13px; background: var(--color-surface); }
.action-input-mini:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light); }

.badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 999px; font-size: 12px; font-weight: 500; }
.badge-success { background: var(--color-success-light); color: var(--color-success); }
.badge-warning { background: var(--color-warning-light); color: var(--color-warning); }
.badge-danger { background: var(--color-danger-light); color: var(--color-danger); }
.badge-neutral { background: var(--color-surface-alt); color: var(--color-text-secondary); }
.badge-primary { background: var(--color-primary-light); color: var(--color-primary); }

.page { display: none; animation: fadeIn 0.3s ease; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.page-header { margin-bottom: var(--space-2xl); }
.page-header .t-label { margin-bottom: var(--space-sm); }
.page-header .t-display { margin-bottom: var(--space-md); }
.page-header .t-body { color: var(--color-text-secondary); max-width: 620px; }
.section-divider { height: 1px; background: var(--color-border); margin: var(--space-2xl) 0; }

.welcome-hero { text-align: center; padding: var(--space-3xl) var(--space-lg); max-width: 640px; margin: 0 auto; }
.welcome-icon { width: 72px; height: 72px; background: var(--color-primary-light); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-lg); font-size: 32px; }
.welcome-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin: var(--space-2xl) 0; text-align: center; }
.welcome-stat { padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); }
.welcome-stat-value { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--color-primary); }
.welcome-stat-label { font-size: 13px; color: var(--color-text-secondary); margin-top: 4px; }
.welcome-phases { display: flex; flex-direction: column; gap: var(--space-md); margin: var(--space-2xl) 0; text-align: left; }
.welcome-phase { display: flex; gap: var(--space-lg); padding: var(--space-lg); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); }
.welcome-phase-num { width: 36px; height: 36px; background: var(--color-primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--color-primary); flex-shrink: 0; font-size: 15px; }
.welcome-phase-title { font-weight: 600; margin-bottom: 2px; }
.welcome-phase-desc { font-size: 14px; color: var(--color-text-secondary); }
@media (max-width: 600px) { .welcome-stats { grid-template-columns: 1fr; } .welcome-hero { padding: var(--space-2xl) var(--space-md); } }

.checklist { display: flex; flex-direction: column; gap: 2px; }
.check-item { display: flex; align-items: flex-start; gap: var(--space-md); padding: var(--space-md); border-radius: var(--radius-sm); cursor: pointer; transition: background var(--transition-fast); }
.check-item:hover { background: var(--color-surface-alt); }
.check-box { width: 22px; height: 22px; border: 2px solid var(--color-border); border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all var(--transition-fast); margin-top: 1px; }
.check-item.checked .check-box { background: var(--color-primary); border-color: var(--color-primary); }
.check-item.checked .check-box svg { opacity: 1; }
.check-box svg { width: 14px; height: 14px; stroke: #fff; stroke-width: 2.5; fill: none; opacity: 0; }
.check-text { font-size: 14px; line-height: 1.5; }
.check-item.checked .check-text { color: var(--color-text-tertiary); text-decoration: line-through; }

.data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.data-table th { text-align: left; padding: 10px 14px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-tertiary); border-bottom: 2px solid var(--color-border); background: var(--color-surface-alt); }
.data-table td { padding: 12px 14px; border-bottom: 1px solid var(--color-border-light); font-size: 14px; vertical-align: top; }
.data-table tr:last-child td { border-bottom: none; }

.bar-chart { display: flex; flex-direction: column; gap: var(--space-md); }
.bar-row { display: flex; align-items: center; gap: var(--space-md); }
.bar-label { width: 130px; flex-shrink: 0; font-size: 13px; color: var(--color-text-secondary); text-align: right; }
.bar-track { flex: 1; height: 24px; background: var(--color-surface-alt); border-radius: 4px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; }
.bar-value { font-size: 12px; font-weight: 600; color: #fff; }
@media (max-width: 600px) { .bar-label { width: 80px; font-size: 11px; } }

.timeline { position: relative; padding-left: 28px; }
.timeline::before { content: ''; position: absolute; left: 9px; top: 4px; bottom: 4px; width: 2px; background: var(--color-border); }
.timeline-item { position: relative; padding-bottom: var(--space-xl); }
.timeline-item:last-child { padding-bottom: 0; }
.timeline-dot { position: absolute; left: -28px; top: 2px; width: 20px; height: 20px; border-radius: 50%; background: var(--color-surface); border: 2px solid var(--color-border); display: flex; align-items: center; justify-content: center; }
.timeline-item.tl-active .timeline-dot { border-color: var(--color-primary); background: var(--color-primary-light); }
.timeline-item.tl-done .timeline-dot { border-color: var(--color-success); background: var(--color-success); }
.timeline-period { font-size: 12px; font-weight: 600; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.04em; }
.timeline-title { font-weight: 600; margin: 2px 0 4px; }
.timeline-desc { font-size: 14px; color: var(--color-text-secondary); }

.stacked-bar { display: flex; height: 32px; border-radius: 6px; overflow: hidden; }
.stacked-seg { display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #fff; transition: width 0.6s ease; min-width: 0; overflow: hidden; white-space: nowrap; }

.calc-row { display: grid; grid-template-columns: 1fr 140px 140px 140px; gap: var(--space-sm); align-items: center; padding: var(--space-sm) 0; border-bottom: 1px solid var(--color-border-light); }
.calc-row:last-child { border-bottom: none; }
.calc-row.calc-total { border-top: 2px solid var(--color-border); border-bottom: none; font-weight: 700; padding-top: var(--space-md); }
.calc-label { font-size: 14px; }
.calc-input { width: 100%; padding: 8px 10px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 14px; text-align: right; font-family: 'SF Mono', 'Fira Code', monospace; }
.calc-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-light); }
.calc-result { text-align: right; font-size: 14px; font-family: 'SF Mono', 'Fira Code', monospace; font-weight: 600; padding: 8px 10px; }
.calc-result.positive { color: var(--color-success); }
.calc-result.negative { color: var(--color-danger); }
@media (max-width: 700px) { .calc-row { grid-template-columns: 1fr 100px 100px 100px; } .calc-label { font-size: 12px; } .calc-input, .calc-result { font-size: 12px; padding: 6px 8px; } }

.toast { position: fixed; bottom: var(--space-xl); right: var(--space-xl); z-index: 200; background: var(--color-text); color: #fff; padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); font-size: 14px; box-shadow: var(--shadow-lg); transform: translateY(80px); opacity: 0; transition: all var(--transition-slow); max-width: 400px; }
.toast.show { transform: translateY(0); opacity: 1; }

.mb-xs { margin-bottom: var(--space-xs); } .mb-sm { margin-bottom: var(--space-sm); } .mb-md { margin-bottom: var(--space-md); } .mb-lg { margin-bottom: var(--space-lg); } .mb-xl { margin-bottom: var(--space-xl); } .mb-2xl { margin-bottom: var(--space-2xl); }
.mt-md { margin-top: var(--space-md); } .mt-lg { margin-top: var(--space-lg); } .mt-xl { margin-top: var(--space-xl); }
.flex { display: flex; } .items-center { align-items: center; } .justify-between { justify-content: space-between; } .gap-sm { gap: var(--space-sm); } .gap-md { gap: var(--space-md); } .text-center { text-align: center; }

.strategy-card { border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: var(--space-md); background: var(--color-surface); transition: box-shadow var(--transition-normal); }
.strategy-card:hover { box-shadow: var(--shadow-sm); }

.mistake-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: var(--space-md); }
.mistake-num { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: var(--color-danger-light); color: var(--color-danger); font-size: 12px; font-weight: 700; margin-right: var(--space-sm); }
.mistake-title { font-weight: 600; font-size: 15px; display: inline; }
.mistake-desc { color: var(--color-text-secondary); font-size: 14px; margin: var(--space-sm) 0; }
.mistake-fix { background: var(--color-success-light); border-radius: var(--radius-sm); padding: var(--space-sm) var(--space-md); font-size: 13px; color: var(--color-success); }

@media print { .sidebar, .mobile-header, .sidebar-overlay, .toast, .btn-group, .skip-link { display: none !important; } .main-content { margin-left: 0 !important; } .page { display: block !important; page-break-inside: avoid; } .content-area { max-width: 100%; padding: 0; } .btn { display: none; } }

/* Accessibility */
.skip-link { position: absolute; top: -40px; left: 0; background: var(--color-primary); color: #fff; padding: 8px 16px; z-index: 200; font-size: 14px; border-radius: 0 0 var(--radius-sm) 0; }
.skip-link:focus { top: 0; }
:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 2px; }
*:focus:not(:focus-visible) { outline: none; }

/* Reduced motion */
@media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } }
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to content</a>
<div class="app">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
  <nav class="sidebar" id="sidebar" role="navigation" aria-label="Playbook navigation">
    <div class="sidebar-brand">
      <div class="sidebar-brand-label">Exit Planning Playbook #5</div>
      <div class="sidebar-brand-title">Tax &amp; Estate Pre-Planning</div>
    </div>
    <div class="sidebar-progress">
      <div class="sidebar-progress-label">Your progress</div>
      <div class="sidebar-progress-bar"><div class="sidebar-progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="sidebar-progress-text" id="progressText">0 of 9 complete</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-label">Journey</div>
      <div class="nav-item active" data-page="welcome" onclick="goToPage('welcome')" tabindex="0" role="button"><div class="nav-icon">1</div> Welcome<div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div></div>
      <div class="nav-item" data-page="landscape" onclick="goToPage('landscape')" tabindex="0" role="button"><div class="nav-icon">2</div> Tax Landscape<div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div></div>
      <div class="nav-item locked" data-page="entity" onclick="goToPage('entity')" tabindex="0" role="button"><div class="nav-icon">3</div> Entity &amp; QSBS<div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div></div>
      <div class="nav-item locked" data-page="strategies" onclick="goToPage('strategies')" tabindex="0" role="button"><div class="nav-icon">4</div> Tax Strategies<div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div></div>
      <div class="nav-item locked" data-page="estate" onclick="goToPage('estate')" tabindex="0" role="button"><div class="nav-icon">5</div> Estate Planning<div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div></div>
      <div class="nav-item locked" data-page="calculator" onclick="goToPage('calculator')" tabindex="0" role="button"><div class="nav-icon">6</div> Tax Calculator<div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div></div>
      <div class="nav-item locked" data-page="checklist" onclick="goToPage('checklist')" tabindex="0" role="button"><div class="nav-icon">7</div> Pre-Exit Checklist<div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div></div>
      <div class="nav-item locked" data-page="mistakes" onclick="goToPage('mistakes')" tabindex="0" role="button"><div class="nav-icon">8</div> Common Mistakes<div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div></div>
      <div class="nav-item locked" data-page="dashboard" onclick="goToPage('dashboard')" tabindex="0" role="button"><div class="nav-icon">9</div> Dashboard<div class="nav-check"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div></div>
    </div>
    <div class="sidebar-score">
      <div class="sidebar-score-label">Est. Tax Savings</div>
      <div class="sidebar-score-value" id="sidebarSavings">$--</div>
      <div class="sidebar-score-desc" id="sidebarSavingsDesc">Complete calculator to estimate</div>
    </div>
  </nav>

  <div class="main-content" id="main-content">
    <div class="mobile-header">
      <button class="hamburger" onclick="toggleSidebar()" aria-label="Open navigation"><span></span></button>
      <div style="font-weight:600;font-size:15px">Tax &amp; Estate Pre-Planning</div>
    </div>
    <div class="content-area">

      <!-- PAGE: WELCOME -->
      <div class="page active" id="page-welcome">
        <div class="welcome-hero">
          <div class="welcome-icon">&#x1F4B0;</div>
          <div class="t-display">Tax &amp; Estate Pre-Planning</div>
          <p class="t-body t-secondary">The strategies that save the most money require the most lead time. The difference between a well-planned and poorly-planned exit can be 15-30% of gross proceeds.</p>
          <div class="welcome-stats">
            <div class="welcome-stat"><div class="welcome-stat-value">15-30%</div><div class="welcome-stat-label">of proceeds at stake from tax planning</div></div>
            <div class="welcome-stat"><div class="welcome-stat-value">2-3 yr</div><div class="welcome-stat-label">lead time for best strategies</div></div>
            <div class="welcome-stat"><div class="welcome-stat-value">$10M</div><div class="welcome-stat-label">potential QSBS tax exclusion</div></div>
          </div>
          <div class="callout callout-danger mb-2xl" style="text-align:left"><strong>The core principle:</strong> Every month of delay in tax planning costs you real money. A $5M exit with no planning might net $3M. With 2 years of planning, you might keep $3.8M or more. That $800K difference is the cost of waiting.</div>
          <div class="welcome-phases">
            <div class="welcome-phase"><div class="welcome-phase-num">1</div><div><div class="welcome-phase-title">Understand the Tax Landscape</div><div class="welcome-phase-desc">Know what rates apply and how much lead time each strategy needs.</div></div></div>
            <div class="welcome-phase"><div class="welcome-phase-num">2</div><div><div class="welcome-phase-title">Evaluate Your Entity &amp; Strategies</div><div class="welcome-phase-desc">Assess QSBS, entity structure, and tax minimization approaches.</div></div></div>
            <div class="welcome-phase"><div class="welcome-phase-num">3</div><div><div class="welcome-phase-title">Model Your After-Tax Proceeds</div><div class="welcome-phase-desc">Use the calculator to see what you actually keep under different scenarios.</div></div></div>
            <div class="welcome-phase"><div class="welcome-phase-num">4</div><div><div class="welcome-phase-title">Build Your Implementation Plan</div><div class="welcome-phase-desc">Create a timeline with specific actions, deadlines, and accountability.</div></div></div>
          </div>
          <button class="btn btn-primary btn-lg" onclick="completeWelcome()">Start Planning</button>
        </div>
      </div>

      <!-- PAGE: TAX LANDSCAPE -->
      <div class="page" id="page-landscape">
        <div class="page-header">
          <div class="t-label">Section 2</div>
          <div class="t-display">The Tax Landscape for Business Sales</div>
          <p class="t-body t-secondary">Before planning, you need to understand what you are up against. Here are the taxes that apply to a business sale.</p>
        </div>
        <div class="card mb-2xl" style="padding:0;overflow:auto">
          <table class="data-table">
            <thead><tr><th>Tax</th><th>Rate</th><th>Applies To</th></tr></thead>
            <tbody>
              <tr><td><strong>Federal Capital Gains</strong></td><td>20%</td><td>Long-term gains on sale of business assets/stock</td></tr>
              <tr><td><strong>Net Investment Income (ACA)</strong></td><td>3.8%</td><td>Income above $250K (married filing jointly)</td></tr>
              <tr><td><strong>State Income Tax</strong></td><td>0% - 13.3%</td><td>Varies by state</td></tr>
              <tr><td><strong>Ordinary Income (some assets)</strong></td><td>Up to 37%</td><td>Depreciation recapture, inventory, A/R in asset sales</td></tr>
              <tr style="background:var(--color-danger-light)"><td><strong>Total Effective Rate</strong></td><td><strong>25% - 45%+</strong></td><td>Depends on structure, state, and planning</td></tr>
            </tbody>
          </table>
        </div>
        <div class="t-h2 mb-lg">Strategies by Lead Time Required</div>
        <div class="card mb-2xl" style="padding:0;overflow:auto">
          <table class="data-table">
            <thead><tr><th>Lead Time</th><th>Strategy</th><th>Potential Savings</th></tr></thead>
            <tbody>
              <tr><td><span class="badge badge-danger">3+ years</span></td><td>QSBS exclusion (C-corp conversion)</td><td>Up to $10M tax-free</td></tr>
              <tr><td><span class="badge badge-danger">2-3 years</span></td><td>Grantor trusts (GRAT, IDGT) for estate freeze</td><td>Estate tax savings on appreciation</td></tr>
              <tr><td><span class="badge badge-warning">2+ years</span></td><td>S-corp election (from C-corp)</td><td>Avoid double taxation</td></tr>
              <tr><td><span class="badge badge-warning">1-2 years</span></td><td>Charitable remainder trust setup</td><td>Defer and reduce capital gains</td></tr>
              <tr><td><span class="badge badge-primary">1+ years</span></td><td>State residency change</td><td>Eliminate state tax (0% vs 13.3%)</td></tr>
              <tr><td><span class="badge badge-neutral">6+ months</span></td><td>Installment sale structure</td><td>Spread recognition over years</td></tr>
              <tr><td><span class="badge badge-neutral">At closing</span></td><td>Asset vs. stock allocation negotiation</td><td>Optimize character of income</td></tr>
            </tbody>
          </table>
        </div>
        <div class="flex justify-between"><button class="btn btn-ghost" onclick="goToPage('welcome')">&larr; Back</button><button class="btn btn-primary" onclick="completeLandscape()">Continue to Entity Structure &rarr;</button></div>
      </div>

      <!-- PAGE: ENTITY & QSBS -->
      <div class="page" id="page-entity">
        <div class="page-header">
          <div class="t-label">Section 3</div>
          <div class="t-display">Entity Structure &amp; QSBS</div>
          <p class="t-body t-secondary">Your entity type determines your tax exposure. The wrong structure can cost you double taxation. The right one can save you millions.</p>
        </div>
        <div class="t-h2 mb-lg">Your Current Entity</div>
        <div class="card mb-2xl">
          <div class="form-group">
            <label class="form-label">What is your current entity structure?</label>
            <select class="form-input" id="entityType" onchange="setEntity(this.value)">
              <option value="">Select your entity type...</option>
              <option value="c-corp">C-Corporation</option>
              <option value="s-corp">S-Corporation</option>
              <option value="llc">LLC / Partnership</option>
              <option value="sole">Sole Proprietorship</option>
            </select>
          </div>
          <div id="entityAdvice"></div>
        </div>
        <div class="t-h2 mb-lg">Asset vs. Stock Sale Implications</div>
        <div class="card mb-2xl" style="padding:0;overflow:auto">
          <table class="data-table">
            <thead><tr><th>Factor</th><th>Asset Sale</th><th>Stock Sale</th></tr></thead>
            <tbody>
              <tr><td>Buyer preference</td><td>Usually preferred (step-up in basis)</td><td>Less preferred (inherits liabilities)</td></tr>
              <tr><td>Seller preference</td><td>Mixed (some ordinary income)</td><td>Usually preferred (capital gains)</td></tr>
              <tr><td>Depreciation recapture</td><td>Taxed at ordinary rates</td><td>No recapture</td></tr>
              <tr><td>C-corp double tax risk</td><td style="color:var(--color-danger);font-weight:600">HIGH -- avoid if possible</td><td>No double tax</td></tr>
              <tr><td>Negotiation lever</td><td>Accept for higher price</td><td>Buyer accepts for lower price</td></tr>
            </tbody>
          </table>
        </div>
        <div class="t-h2 mb-lg">QSBS Eligibility Assessment</div>
        <div class="callout callout-accent mb-lg"><strong>QSBS Planning Note:</strong> If you are currently an LLC or S-corp and might qualify, converting to C-corp and holding for 5 years could save $2-3M in federal tax on a $10M exit. This is the single highest-value pre-exit tax strategy.</div>
        <div class="card mb-2xl">
          <div class="t-h3 mb-md">Do you qualify for QSBS (Section 1202)?</div>
          <div class="checklist" id="qsbsChecklist"></div>
          <div id="qsbsResult" class="mt-lg"></div>
        </div>
        <div class="flex justify-between"><button class="btn btn-ghost" onclick="goToPage('landscape')">&larr; Back</button><button class="btn btn-primary" onclick="completeEntity()">Continue to Tax Strategies &rarr;</button></div>
      </div>

      <!-- PAGE: TAX STRATEGIES -->
      <div class="page" id="page-strategies">
        <div class="page-header">
          <div class="t-label">Section 4</div>
          <div class="t-display">Tax Minimization Strategies</div>
          <p class="t-body t-secondary">Evaluate which strategies apply to your situation. Mark each as applicable, note the estimated savings, and track your implementation status.</p>
        </div>
        <div id="strategyCards"></div>
        <div class="section-divider"></div>
        <div class="t-h2 mb-lg">Charitable Giving Strategies</div>
        <div class="card mb-2xl">
          <p class="t-body t-secondary mb-lg">For owners with philanthropic goals, giving before the sale is dramatically more tax-efficient than giving after.</p>
          <div id="charityOptions"></div>
        </div>
        <div class="t-h2 mb-lg">State Tax Planning</div>
        <div class="card mb-2xl">
          <div class="form-group">
            <label class="form-label">Your current state of residence</label>
            <input class="form-input" id="currentState" placeholder="e.g., California, New York..." oninput="setState('current',this.value)">
          </div>
          <div class="form-group">
            <label class="form-label">Estimated state tax rate on your sale</label>
            <input class="form-input" type="number" id="stateRate" placeholder="e.g., 13.3" step="0.1" min="0" max="15" oninput="setState('rate',this.value)">
            <div class="form-hint">No-income-tax states: AK, FL, NV, NH*, SD, TN*, TX, WA*, WY. High: CA (13.3%), NJ (10.75%), OR (9.9%)</div>
          </div>
          <div class="callout callout-warning"><strong>State Planning Warning:</strong> Changing state residency must be genuine and verifiable. The origin state may audit aggressively. You generally need to establish residency 1-2 years before the sale.</div>
        </div>
        <div class="flex justify-between"><button class="btn btn-ghost" onclick="goToPage('entity')">&larr; Back</button><button class="btn btn-primary" onclick="completeStrategies()">Continue to Estate Planning &rarr;</button></div>
      </div>

      <!-- PAGE: ESTATE PLANNING -->
      <div class="page" id="page-estate">
        <div class="page-header">
          <div class="t-label">Section 5</div>
          <div class="t-display">Estate Planning for Exit</div>
          <p class="t-body t-secondary">Exit proceeds can create massive estate tax exposure. With the federal exemption scheduled to drop by roughly half in 2026, pre-exit estate planning is urgent.</p>
        </div>
        <div class="callout callout-danger mb-2xl">
          <strong>Current exemption:</strong> $13.6M per individual ($27.2M per couple) in 2024 -- scheduled to drop by roughly half. Plan now while the window is open.
        </div>
        <div class="t-h2 mb-lg">Key Estate Strategies</div>
        <div class="card mb-2xl" style="padding:0;overflow:auto">
          <table class="data-table">
            <thead><tr><th>Strategy</th><th>How It Works</th><th>Lead Time</th></tr></thead>
            <tbody>
              <tr><td><strong>Gifting before sale</strong></td><td>Transfer minority interests at discounted value before appreciation</td><td><span class="badge badge-danger">2-3 years</span></td></tr>
              <tr><td><strong>GRAT</strong></td><td>Transfer future appreciation to heirs with minimal gift tax</td><td><span class="badge badge-danger">2+ years</span></td></tr>
              <tr><td><strong>IDGT</strong></td><td>Sell business interest to trust; future appreciation passes outside estate</td><td><span class="badge badge-warning">1-2 years</span></td></tr>
              <tr><td><strong>Family Limited Partnership</strong></td><td>Transfer interests to FLP; apply valuation discounts</td><td><span class="badge badge-danger">2-3 years</span></td></tr>
              <tr><td><strong>ILIT</strong></td><td>Fund insurance to cover estate taxes; keep insurance outside estate</td><td><span class="badge badge-primary">1+ years</span></td></tr>
            </tbody>
          </table>
        </div>
        <div class="t-h2 mb-lg">Your Estate Planning Status</div>
        <div class="card mb-2xl">
          <div class="checklist" id="estateChecklist"></div>
        </div>
        <div class="flex justify-between"><button class="btn btn-ghost" onclick="goToPage('strategies')">&larr; Back</button><button class="btn btn-primary" onclick="completeEstate()">Continue to Tax Calculator &rarr;</button></div>
      </div>

      <!-- PAGE: TAX CALCULATOR -->
      <div class="page" id="page-calculator">
        <div class="page-header">
          <div class="t-label">Worksheet A</div>
          <div class="t-display">After-Tax Proceeds Calculator</div>
          <p class="t-body t-secondary">Model your after-tax proceeds under multiple scenarios. Enter your numbers to see what you actually keep.</p>
        </div>
        <div class="callout callout-info mb-2xl"><strong>Why this matters:</strong> Owners negotiate on gross price without understanding what they keep. A $10M deal with poor tax planning may net less than an $8M deal with excellent planning.</div>
        <div class="card mb-lg">
          <div class="flex justify-between items-center mb-lg" style="flex-wrap:wrap;gap:8px">
            <div class="t-h2">Scenario Calculator</div>
            <div class="flex gap-sm">
              <button class="btn btn-sm btn-secondary" onclick="setActiveScenario(0)" id="scenBtn0">Scenario 1</button>
              <button class="btn btn-sm btn-secondary" onclick="setActiveScenario(1)" id="scenBtn1">Scenario 2</button>
              <button class="btn btn-sm btn-secondary" onclick="setActiveScenario(2)" id="scenBtn2">Scenario 3</button>
            </div>
          </div>
          <div id="calcForm"></div>
        </div>
        <div class="card mb-2xl">
          <div class="t-h2 mb-lg">Scenario Comparison</div>
          <div id="scenarioComparison"></div>
        </div>
        <div class="flex justify-between"><button class="btn btn-ghost" onclick="goToPage('estate')">&larr; Back</button><button class="btn btn-primary" onclick="completeCalculator()">Continue to Checklist &rarr;</button></div>
      </div>

      <!-- PAGE: PRE-EXIT CHECKLIST -->
      <div class="page" id="page-checklist">
        <div class="page-header">
          <div class="t-label">Section 9</div>
          <div class="t-display">The Pre-Exit Tax Checklist</div>
          <p class="t-body t-secondary">Track every critical tax planning step. Check items as you complete them.</p>
        </div>
        <div class="card mb-2xl">
          <div class="checklist" id="taxChecklist"></div>
        </div>
        <div class="t-h2 mb-lg">Implementation Timeline</div>
        <div class="card mb-2xl">
          <div class="timeline" id="implTimeline"></div>
        </div>
        <div class="t-h2 mb-lg">Working with Tax Advisors</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--space-md)" class="mb-2xl">
          <div class="card"><div style="font-size:24px;margin-bottom:8px">&#x2696;</div><div class="t-h3">Transaction Tax Attorney</div><div class="t-small t-secondary">Structure the deal for tax efficiency. Look for: 10+ deals closed, knows your entity type.</div></div>
          <div class="card"><div style="font-size:24px;margin-bottom:8px">&#x1F4CA;</div><div class="t-h3">CPA / Tax Advisor</div><div class="t-small t-secondary">Model after-tax proceeds, file returns. Look for: experienced with business sales, not just annual returns.</div></div>
          <div class="card"><div style="font-size:24px;margin-bottom:8px">&#x1F3DB;</div><div class="t-h3">Estate Planning Attorney</div><div class="t-small t-secondary">Implement trust strategies. Look for: understands both estate and income tax interplay.</div></div>
          <div class="card"><div style="font-size:24px;margin-bottom:8px">&#x1F4B5;</div><div class="t-h3">Wealth Manager</div><div class="t-small t-secondary">Post-exit investment strategy. Look for: experience with sudden liquidity events.</div></div>
        </div>
        <div class="flex justify-between"><button class="btn btn-ghost" onclick="goToPage('calculator')">&larr; Back</button><button class="btn btn-primary" onclick="completeChecklist()">Continue to Mistakes &rarr;</button></div>
      </div>

      <!-- PAGE: MISTAKES -->
      <div class="page" id="page-mistakes">
        <div class="page-header">
          <div class="t-label">Section 11</div>
          <div class="t-display">Common Mistakes to Avoid</div>
          <p class="t-body t-secondary">These patterns destroy value in nearly every poorly-planned exit.</p>
        </div>
        <div id="mistakeCards"></div>
        <div class="section-divider"></div>
        <div class="t-h2 mb-lg">Strategy Tracker</div>
        <p class="t-body t-secondary mb-lg">Track each strategy you are considering, its applicability, and implementation status.</p>
        <div class="card mb-2xl">
          <div id="strategyTracker"></div>
          <button class="btn btn-sm btn-secondary mt-md" onclick="addTrackerRow()">+ Add Strategy</button>
        </div>
        <div class="flex justify-between"><button class="btn btn-ghost" onclick="goToPage('checklist')">&larr; Back</button><button class="btn btn-primary" onclick="completeMistakes()">View Dashboard &rarr;</button></div>
      </div>

      <!-- PAGE: DASHBOARD -->
      <div class="page" id="page-dashboard">
        <div class="page-header">
          <div class="t-label">Your Results</div>
          <div class="t-display">Tax Planning Dashboard</div>
          <p class="t-body t-secondary">A complete view of your tax readiness, estimated savings, and implementation progress.</p>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:var(--space-md)" class="mb-2xl">
          <div class="card text-center"><div class="t-caption t-tertiary mb-xs">Checklist Progress</div><div style="font-family:var(--font-display);font-size:28px;font-weight:700" id="dashChecklist">--</div><div class="t-caption t-tertiary">of 12 items</div></div>
          <div class="card text-center"><div class="t-caption t-tertiary mb-xs">Best Scenario Net</div><div style="font-family:var(--font-display);font-size:28px;font-weight:700;color:var(--color-success)" id="dashBestNet">$--</div><div class="t-caption t-tertiary">after-tax proceeds</div></div>
          <div class="card text-center"><div class="t-caption t-tertiary mb-xs">Strategies Active</div><div style="font-family:var(--font-display);font-size:28px;font-weight:700;color:var(--color-primary)" id="dashStrategies">--</div><div class="t-caption t-tertiary">in your plan</div></div>
          <div class="card text-center"><div class="t-caption t-tertiary mb-xs">Entity Structure</div><div style="font-family:var(--font-display);font-size:20px;font-weight:700;color:var(--color-accent)" id="dashEntity">--</div><div class="t-caption t-tertiary">current type</div></div>
        </div>
        <div class="card mb-2xl">
          <div class="t-h2 mb-lg">Tax Breakdown Visualization</div>
          <div id="dashTaxBreakdown"></div>
        </div>
        <div class="card mb-2xl">
          <div class="t-h2 mb-lg">Scenario Comparison</div>
          <div class="bar-chart" id="dashScenarioBars"></div>
        </div>
        <div class="card mb-2xl">
          <div class="t-h2 mb-lg">Recommendations</div>
          <div id="dashRecs"></div>
        </div>
        <div class="card mb-2xl">
          <div class="t-h2 mb-lg">Next Steps</div>
          <div id="dashNextSteps"></div>
          <button class="btn btn-sm btn-secondary mt-md" onclick="addDashStep()">+ Add Step</button>
        </div>
        <div class="flex justify-between"><button class="btn btn-ghost" onclick="goToPage('mistakes')">&larr; Back</button><button class="btn btn-accent" onclick="exportData()">Export Assessment Data</button></div>
        <div class="callout callout-info mt-xl"><strong>Final Thought:</strong> The IRS rewards those who plan and punishes those who wait. Start now -- every month matters.</div>
      </div>

    </div>
  </div>
</div>
<div class="toast" id="toast" aria-live="polite" role="status"></div>

<script>
const STORAGE_KEY = 'exitosx-pb05-tax-estate';
// Migrate from old localStorage key
(function() { try { const old = localStorage.getItem('playbook-05-tax-estate'); if (old && !localStorage.getItem(STORAGE_KEY)) { localStorage.setItem(STORAGE_KEY, old); localStorage.removeItem('playbook-05-tax-estate'); } } catch(e) {} })();

const TAX_STRATEGIES = [
  { id: 'installment', title: 'Installment Sale (Section 453)', desc: 'Spread gain recognition over multiple years by receiving payments over time. Keeps you in lower tax brackets each year.', risk: 'Buyer default', best: 'Seller can tolerate payment risk and wants to spread tax liability', lead: '6+ months' },
  { id: 'crt', title: 'Charitable Remainder Trust (CRT)', desc: 'Transfer business interest to a CRT before sale. Trust sells tax-free; provides income stream to seller; remainder goes to charity.', risk: 'Irrevocable; charitable intent required', best: 'Seller has charitable intent and wants guaranteed income stream', lead: '1-2 years' },
  { id: 'oz', title: 'Opportunity Zone Reinvestment', desc: 'Reinvest capital gains into a Qualified Opportunity Fund within 180 days. Defer gains; potential 10-year exclusion on new investment gains.', risk: 'Investment risk in OZ project', best: 'Seller has a specific OZ investment in mind', lead: '6 months' },
  { id: 'daf', title: 'Donor-Advised Fund (DAF)', desc: 'Contribute appreciated business interests to a DAF before sale. Immediate tax deduction at fair market value; no capital gains on donated portion.', risk: 'Funds committed to charity', best: 'Seller plans significant charitable giving', lead: '6+ months' },
  { id: 'dbp', title: 'Defined Benefit Plan Maximization', desc: 'Establish or maximize a defined benefit pension plan 2-3 years before exit. Contributions are tax-deductible and can exceed $200K/year.', risk: 'Annual funding obligations', best: 'Owner is over 50 and plan has runway to fund', lead: '2-3 years' }
];

const CHARITY_OPTIONS = [
  { id: 'direct', label: 'Direct donation of appreciated stock/interests', desc: 'Deduct FMV, avoid capital gains on donated portion' },
  { id: 'daf2', label: 'Donor-Advised Fund', desc: 'Fund with pre-sale interests for immediate deduction; distribute grants over time' },
  { id: 'crt2', label: 'Charitable Remainder Trust', desc: 'Sell tax-free inside trust; income to donor for life; remainder to charity' },
  { id: 'foundation', label: 'Private Foundation', desc: 'Create a legacy; ongoing deductions for contributions' }
];

const QSBS_ITEMS = [
  'Business is a C-corporation (or can convert to one)',
  'Stock has been (or will be) held for 5+ years',
  'Gross assets under $50M at time of stock issuance',
  'Active business (not investment, real estate, or professional services)'
];

const ESTATE_ITEMS = [
  'Current estate plan reviewed and updated within last 2 years',
  'Estimated estate value exceeds the federal exemption threshold',
  'Evaluated gifting strategies (pre-sale transfers to trusts/family)',
  'Met with estate planning attorney about exit-specific strategies',
  'Considered GRAT, IDGT, or FLP for freezing business value',
  'Life insurance trust (ILIT) evaluated for estate tax coverage',
  'Beneficiary designations reviewed on all accounts'
];

const TAX_CHECKLIST = [
  'Engaged a transaction-experienced tax attorney or CPA',
  'Reviewed entity structure for optimization opportunities',
  'Evaluated QSBS eligibility (C-corp)',
  'Modeled after-tax proceeds under 3-4 scenarios',
  'Reviewed estate plan and updated for exit proceeds',
  'Evaluated gifting strategies (pre-sale transfers to trusts/family)',
  'Assessed state tax implications and residency planning',
  'Evaluated charitable giving strategies (CRT, DAF, direct donation)',
  'Maximized retirement plan contributions',
  'Reviewed asset vs. stock sale implications with both tax and deal counsel',
  'Documented all tax elections and their deadlines',
  'Created a tax timeline with key dates and milestones'
];

const TIMELINE_DATA = [
  { period: '3+ years out', title: 'Entity & QSBS evaluation', desc: 'Evaluate QSBS eligibility; consider entity restructuring. Document entity structure decision.' },
  { period: '2-3 years out', title: 'Estate & trust strategies', desc: 'Engage estate attorney; implement trust strategies; begin gifting. Execute trust documents.' },
  { period: '2 years out', title: 'State residency', desc: 'Evaluate state residency change if applicable. Put residency plan in place.' },
  { period: '1-2 years out', title: 'Retirement & charitable', desc: 'Maximize retirement plan contributions; evaluate charitable strategies. Establish CRT/DAF if applicable.' },
  { period: '6-12 months out', title: 'Tax modeling', desc: 'Model after-tax proceeds under multiple deal scenarios. Complete tax projection models.' },
  { period: 'At LOI', title: 'Deal structure', desc: 'Negotiate asset vs. stock; purchase price allocation. Achieve tax-optimized deal structure.' },
  { period: 'Post-close', title: 'Filing & payments', desc: 'File returns; manage installment payments if applicable. Returns filed; payments scheduled.' }
];

const MISTAKES = [
  { title: 'Starting Tax Planning After the LOI', desc: 'Most high-value strategies need 1-3 years of lead time. Once an LOI is signed, your options shrink to deal structure and installment sales.', fix: 'Engage tax counsel the moment you start thinking about exit -- not when you start doing it.' },
  { title: 'Not Modeling After-Tax Proceeds', desc: 'Owners negotiate on gross price without understanding what they keep. A $10M deal with poor tax planning may net less than an $8M deal with excellent planning.', fix: 'Model every offer in after-tax terms before responding.' },
  { title: 'Ignoring State Tax', desc: 'State taxes are an afterthought for most owners -- but they can consume 5-13% of proceeds.', fix: 'Evaluate state residency planning at least 2 years before a potential sale.' },
  { title: 'Treating Asset and Stock Structure as a Lawyer Problem', desc: 'The asset vs. stock decision has massive tax implications for both sides. It is a negotiation variable, not just a legal formality.', fix: 'Involve your tax advisor in deal structure negotiations from the start.' }
];

let state = {
  currentPage: 'welcome',
  pagesUnlocked: ['welcome','landscape'],
  pagesCompleted: [],
  entity: '',
  qsbsChecks: {},
  strategyApplicable: {},
  strategyNotes: {},
  charityChecks: {},
  stateInfo: { current: '', rate: '' },
  estateChecks: {},
  scenarios: [
    { gross: '', costs: '', fedRate: '20', acaRate: '3.8', stateRate: '', ordinaryPortion: '' },
    { gross: '', costs: '', fedRate: '20', acaRate: '3.8', stateRate: '', ordinaryPortion: '' },
    { gross: '', costs: '', fedRate: '20', acaRate: '3.8', stateRate: '', ordinaryPortion: '' }
  ],
  activeScenario: 0,
  taxChecks: {},
  trackerRows: [],
  dashSteps: []
};

function saveData() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {} }
function loadData() { try { const d = localStorage.getItem(STORAGE_KEY); if (d) Object.assign(state, JSON.parse(d)); } catch(e) {} }

function goToPage(pageId) {
  const nav = document.querySelector(`.nav-item[data-page="${pageId}"]`);
  if (nav && nav.classList.contains('locked') && !state.pagesUnlocked.includes(pageId)) return;
  state.currentPage = pageId;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + pageId).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (nav) nav.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
  closeSidebar(); saveData();
  // Focus management for accessibility
  const page = document.getElementById('page-' + pageId);
  setTimeout(() => { const heading = page.querySelector('h1, h2, .t-display'); if (heading) { heading.setAttribute('tabindex', '-1'); heading.focus(); } }, 100);
  if (pageId === 'entity') renderEntity();
  if (pageId === 'strategies') renderStrategies();
  if (pageId === 'estate') renderEstate();
  if (pageId === 'calculator') renderCalculator();
  if (pageId === 'checklist') renderChecklist();
  if (pageId === 'mistakes') renderMistakesPage();
  if (pageId === 'dashboard') renderDashboard();
}
function unlockPage(p) { if (!state.pagesUnlocked.includes(p)) state.pagesUnlocked.push(p); const n = document.querySelector(`.nav-item[data-page="${p}"]`); if (n) n.classList.remove('locked'); saveData(); }
function completePage(p) { if (!state.pagesCompleted.includes(p)) state.pagesCompleted.push(p); const n = document.querySelector(`.nav-item[data-page="${p}"]`); if (n) n.classList.add('completed'); updateProgress(); saveData(); }
function updateProgress() { const total = 9; const done = state.pagesCompleted.length; document.getElementById('progressFill').style.width = Math.round((done/total)*100) + '%'; document.getElementById('progressText').textContent = done + ' of ' + total + ' complete'; updateSidebarSavings(); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('show'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); }
function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
function escHtml(s) { if(!s)return''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtMoney(n) { if (isNaN(n) || n === 0) return '$0'; return '$' + Math.round(n).toLocaleString(); }

function updateSidebarSavings() {
  const nets = state.scenarios.map(s => calcScenarioNet(s)).filter(n => n > 0);
  const el = document.getElementById('sidebarSavings');
  const desc = document.getElementById('sidebarSavingsDesc');
  if (nets.length >= 2) {
    const best = Math.max(...nets); const worst = Math.min(...nets);
    const savings = best - worst;
    el.textContent = fmtMoney(savings > 0 ? savings : best);
    desc.textContent = savings > 0 ? 'potential savings between scenarios' : 'best scenario net proceeds';
  } else if (nets.length === 1) {
    el.textContent = fmtMoney(nets[0]);
    desc.textContent = 'estimated net proceeds';
  } else {
    el.textContent = '$--';
    desc.textContent = 'Complete calculator to estimate';
  }
}

function completeWelcome() { completePage('welcome'); unlockPage('landscape'); goToPage('landscape'); }
function completeLandscape() { completePage('landscape'); unlockPage('entity'); goToPage('entity'); showToast('Now let\'s evaluate your entity structure.'); }
function completeEntity() { completePage('entity'); unlockPage('strategies'); goToPage('strategies'); showToast('Entity assessed. Explore tax strategies next.'); }
function completeStrategies() { completePage('strategies'); unlockPage('estate'); goToPage('estate'); showToast('Strategies evaluated. Address estate planning.'); }
function completeEstate() { completePage('estate'); unlockPage('calculator'); goToPage('calculator'); showToast('Estate planning reviewed. Time to model the numbers.'); }
function completeCalculator() { completePage('calculator'); unlockPage('checklist'); goToPage('checklist'); showToast('Numbers modeled. Complete your checklist.'); }
function completeChecklist() { completePage('checklist'); unlockPage('mistakes'); goToPage('mistakes'); showToast('Checklist saved. Review common mistakes.'); }
function completeMistakes() { completePage('mistakes'); unlockPage('dashboard'); goToPage('dashboard'); showToast('Here is your complete tax planning dashboard.'); }

/* ENTITY */
function renderEntity() {
  document.getElementById('entityType').value = state.entity || '';
  renderEntityAdvice();
  renderQSBS();
}
function setEntity(v) { state.entity = v; saveData(); renderEntityAdvice(); }
function renderEntityAdvice() {
  const adv = { 'c-corp': { color: 'warning', text: '<strong>C-Corp:</strong> Watch for double taxation on asset sales. Stock sale preferred. Evaluate QSBS eligibility -- could save up to $10M in federal tax. If QSBS does not apply, consider S-corp election (requires 5-year BIG tax window).' }, 's-corp': { color: 'info', text: '<strong>S-Corp:</strong> Single layer of tax. Good position for either asset or stock sale. Check if you converted from C-corp recently -- built-in gains tax may apply. Consider QSBS if you have 5+ year runway (would require converting to C-corp).' }, 'llc': { color: 'info', text: '<strong>LLC/Partnership:</strong> Flexible pass-through treatment. Single layer of tax. Purchase price allocation is negotiable. Consider whether QSBS is worth a C-corp conversion with 5-year hold.' }, 'sole': { color: 'danger', text: '<strong>Sole Proprietorship:</strong> All gains flow to personal return. No entity-level protection. Consider incorporating (LLC or S-corp) well before any sale for liability protection and potential tax benefits.' } };
  const d = adv[state.entity];
  document.getElementById('entityAdvice').innerHTML = d ? `<div class="callout callout-${d.color}">${d.text}</div>` : '';
}
function renderQSBS() {
  document.getElementById('qsbsChecklist').innerHTML = QSBS_ITEMS.map((item, i) => {
    const checked = state.qsbsChecks['q-'+i] || false;
    return `<div class="check-item ${checked?'checked':''}" onclick="toggleQSBS('q-${i}')" role="checkbox" aria-checked="${checked}" tabindex="0"><div class="check-box"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div><div class="check-text">${item}</div></div>`;
  }).join('');
  const total = QSBS_ITEMS.length;
  const checked = Object.values(state.qsbsChecks).filter(Boolean).length;
  let result = '';
  if (checked === total) result = '<div class="callout callout-info"><strong>Potentially QSBS eligible.</strong> This could exclude up to $10M (or 10x basis) from federal tax entirely. Engage a tax attorney to confirm and document eligibility immediately.</div>';
  else if (checked >= 2) result = '<div class="callout callout-warning"><strong>Partial QSBS eligibility.</strong> You meet ' + checked + ' of ' + total + ' criteria. Review the missing requirements with a tax advisor to see if they can be addressed within your timeline.</div>';
  else if (checked > 0) result = '<div class="callout callout-accent">You meet ' + checked + ' of ' + total + ' QSBS criteria. This strategy may require significant structural changes. Discuss feasibility with your tax attorney.</div>';
  document.getElementById('qsbsResult').innerHTML = result;
}
function toggleQSBS(id) { state.qsbsChecks[id] = !state.qsbsChecks[id]; saveData(); renderQSBS(); }

/* STRATEGIES */
function renderStrategies() {
  document.getElementById('strategyCards').innerHTML = TAX_STRATEGIES.map(s => {
    const applicable = state.strategyApplicable[s.id] || '';
    const note = state.strategyNotes[s.id] || '';
    return `<div class="strategy-card">
      <div class="flex justify-between items-center mb-sm" style="flex-wrap:wrap;gap:8px"><div class="t-h3">${s.title}</div><span class="badge badge-neutral">${s.lead} lead time</span></div>
      <p class="t-small t-secondary mb-md">${s.desc}</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-md);margin-bottom:var(--space-md)">
        <div><div class="t-caption t-tertiary mb-xs">Risk</div><div class="t-small">${s.risk}</div></div>
        <div><div class="t-caption t-tertiary mb-xs">Best when</div><div class="t-small">${s.best}</div></div>
      </div>
      <div class="form-group mb-sm"><label class="form-label">Applicable to your situation?</label>
        <div style="display:flex;gap:var(--space-sm)">
          <button class="btn btn-sm ${applicable==='yes'?'btn-primary':'btn-secondary'}" onclick="setStratApplicable('${s.id}','yes')">Yes</button>
          <button class="btn btn-sm ${applicable==='maybe'?'btn-accent':'btn-secondary'}" onclick="setStratApplicable('${s.id}','maybe')">Maybe</button>
          <button class="btn btn-sm ${applicable==='no'?'btn-ghost':'btn-secondary'}" onclick="setStratApplicable('${s.id}','no')">No</button>
        </div>
      </div>
      ${applicable === 'yes' || applicable === 'maybe' ? `<div class="form-group" style="margin-bottom:0"><label class="form-label">Notes / estimated savings</label><textarea class="form-input" rows="2" placeholder="How might this strategy apply to your exit?" oninput="setStratNote('${s.id}',this.value)">${escHtml(note)}</textarea></div>` : ''}
    </div>`;
  }).join('');

  document.getElementById('charityOptions').innerHTML = CHARITY_OPTIONS.map(c => {
    const checked = state.charityChecks[c.id] || false;
    return `<div class="check-item ${checked?'checked':''}" onclick="toggleCharity('${c.id}')" role="checkbox" aria-checked="${checked}" tabindex="0"><div class="check-box"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div><div><div class="check-text" style="text-decoration:none;color:var(--color-text)">${c.label}</div><div class="t-caption t-tertiary">${c.desc}</div></div></div>`;
  }).join('');

  document.getElementById('currentState').value = state.stateInfo.current || '';
  document.getElementById('stateRate').value = state.stateInfo.rate || '';
}
function setStratApplicable(id, v) { state.strategyApplicable[id] = v; saveData(); renderStrategies(); }
function setStratNote(id, v) { state.strategyNotes[id] = v; saveData(); }
function toggleCharity(id) { state.charityChecks[id] = !state.charityChecks[id]; saveData(); renderStrategies(); }
function setState(f, v) { state.stateInfo[f] = v; saveData(); }

/* ESTATE */
function renderEstate() {
  document.getElementById('estateChecklist').innerHTML = ESTATE_ITEMS.map((item, i) => {
    const checked = state.estateChecks['e-'+i] || false;
    return `<div class="check-item ${checked?'checked':''}" onclick="toggleEstate('e-${i}')" role="checkbox" aria-checked="${checked}" tabindex="0"><div class="check-box"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div><div class="check-text">${item}</div></div>`;
  }).join('');
}
function toggleEstate(id) { state.estateChecks[id] = !state.estateChecks[id]; saveData(); renderEstate(); }

/* CALCULATOR */
function renderCalculator() {
  const idx = state.activeScenario;
  [0,1,2].forEach(i => {
    const btn = document.getElementById('scenBtn'+i);
    btn.style.background = i === idx ? 'var(--color-primary)' : '';
    btn.style.color = i === idx ? '#fff' : '';
    btn.style.borderColor = i === idx ? 'var(--color-primary)' : '';
  });
  const s = state.scenarios[idx];
  document.getElementById('calcForm').innerHTML = `
    <div class="calc-row"><div class="calc-label" style="font-weight:600">Line Item</div><div style="text-align:center;font-size:11px;text-transform:uppercase;color:var(--color-text-tertiary);font-weight:600">Amount / Rate</div><div></div><div></div></div>
    <div class="calc-row"><div class="calc-label">Gross Sale Price</div><div><input class="calc-input" type="number" placeholder="$0" value="${s.gross}" oninput="setCalc('gross',this.value)"></div><div></div><div></div></div>
    <div class="calc-row"><div class="calc-label">Transaction Costs (5-10%)</div><div><input class="calc-input" type="number" placeholder="$0" value="${s.costs}" oninput="setCalc('costs',this.value)"></div><div></div><div></div></div>
    <div class="calc-row"><div class="calc-label">Federal Capital Gains Rate</div><div><input class="calc-input" type="number" value="${s.fedRate}" step="0.1" oninput="setCalc('fedRate',this.value)">
    </div><div class="calc-result">${fmtMoney(calcFedTax(s))}</div><div></div></div>
    <div class="calc-row"><div class="calc-label">ACA Surcharge Rate</div><div><input class="calc-input" type="number" value="${s.acaRate}" step="0.1" oninput="setCalc('acaRate',this.value)"></div><div class="calc-result">${fmtMoney(calcACATax(s))}</div><div></div></div>
    <div class="calc-row"><div class="calc-label">State Income Tax Rate (%)</div><div><input class="calc-input" type="number" placeholder="0" value="${s.stateRate}" step="0.1" oninput="setCalc('stateRate',this.value)"></div><div class="calc-result">${fmtMoney(calcStateTax(s))}</div><div></div></div>
    <div class="calc-row"><div class="calc-label">Ordinary Income Portion</div><div><input class="calc-input" type="number" placeholder="$0" value="${s.ordinaryPortion}" oninput="setCalc('ordinaryPortion',this.value)"></div><div class="calc-result">${fmtMoney(calcOrdinaryTax(s))}</div><div></div></div>
    <div class="calc-row calc-total"><div class="calc-label">Total Tax</div><div></div><div class="calc-result negative">${fmtMoney(calcTotalTax(s))}</div><div></div></div>
    <div class="calc-row calc-total"><div class="calc-label" style="font-size:16px">Net After-Tax Proceeds</div><div></div><div class="calc-result positive" style="font-size:16px">${fmtMoney(calcScenarioNet(s))}</div><div></div></div>
    <div class="calc-row"><div class="calc-label">% Retained</div><div></div><div class="calc-result" style="color:var(--color-primary)">${calcRetainedPct(s)}</div><div></div></div>
  `;
  renderComparison();
}
function setActiveScenario(i) { state.activeScenario = i; saveData(); renderCalculator(); }
function setCalc(field, val) { state.scenarios[state.activeScenario][field] = val; saveData(); renderCalculator(); updateSidebarSavings(); }
function p(v) { return parseFloat(v) || 0; }
function calcGain(s) { return Math.max(0, p(s.gross) - p(s.costs) - p(s.ordinaryPortion)); }
function calcFedTax(s) { return calcGain(s) * (p(s.fedRate)/100); }
function calcACATax(s) { return calcGain(s) * (p(s.acaRate)/100); }
function calcStateTax(s) { return (calcGain(s) + p(s.ordinaryPortion)) * (p(s.stateRate)/100); }
function calcOrdinaryTax(s) { return p(s.ordinaryPortion) * 0.37; }
function calcTotalTax(s) { return calcFedTax(s) + calcACATax(s) + calcStateTax(s) + calcOrdinaryTax(s); }
function calcScenarioNet(s) { return p(s.gross) - p(s.costs) - calcTotalTax(s); }
function calcRetainedPct(s) { const g = p(s.gross); return g > 0 ? (calcScenarioNet(s)/g*100).toFixed(1)+'%' : '--%'; }

function renderComparison() {
  const rows = state.scenarios.map((s,i) => {
    const gross = p(s.gross); const net = calcScenarioNet(s);
    return `<tr><td><strong>Scenario ${i+1}</strong></td><td>${fmtMoney(gross)}</td><td>${fmtMoney(calcTotalTax(s))}</td><td style="font-weight:700;color:var(--color-success)">${fmtMoney(net)}</td><td>${gross > 0 ? (net/gross*100).toFixed(1)+'%' : '--'}</td></tr>`;
  });
  document.getElementById('scenarioComparison').innerHTML = `<div style="overflow-x:auto"><table class="data-table"><thead><tr><th></th><th>Gross Price</th><th>Total Tax</th><th>Net Proceeds</th><th>% Retained</th></tr></thead><tbody>${rows.join('')}</tbody></table></div>`;
}

/* CHECKLIST */
function renderChecklist() {
  document.getElementById('taxChecklist').innerHTML = TAX_CHECKLIST.map((item, i) => {
    const checked = state.taxChecks['tc-'+i] || false;
    return `<div class="check-item ${checked?'checked':''}" onclick="toggleTaxCheck('tc-${i}')" role="checkbox" aria-checked="${checked}" tabindex="0"><div class="check-box"><svg viewBox="0 0 14 14"><polyline points="3 7 6 10 11 4"/></svg></div><div class="check-text">${item}</div></div>`;
  }).join('');
  renderTimeline();
}
function toggleTaxCheck(id) { state.taxChecks[id] = !state.taxChecks[id]; saveData(); renderChecklist(); }
function renderTimeline() {
  document.getElementById('implTimeline').innerHTML = TIMELINE_DATA.map((item, i) => `<div class="timeline-item ${i===0?'tl-active':''}"><div class="timeline-dot"></div><div class="timeline-period">${item.period}</div><div class="timeline-title">${item.title}</div><div class="timeline-desc">${item.desc}</div></div>`).join('');
}

/* MISTAKES */
function renderMistakesPage() {
  document.getElementById('mistakeCards').innerHTML = MISTAKES.map((m,i) => `<div class="mistake-card"><div class="mb-sm"><span class="mistake-num">${i+1}</span><div class="mistake-title">${m.title}</div></div><div class="mistake-desc">${m.desc}</div><div class="mistake-fix"><strong>Solution:</strong> ${m.fix}</div></div>`).join('');
  renderTracker();
}
function renderTracker() {
  if (state.trackerRows.length === 0) {
    const applicable = TAX_STRATEGIES.filter(s => state.strategyApplicable[s.id] === 'yes' || state.strategyApplicable[s.id] === 'maybe');
    state.trackerRows = applicable.length > 0 ? applicable.map(s => ({ strategy: s.title, applicable: state.strategyApplicable[s.id] === 'yes' ? 'Y' : 'M', lead: s.lead, savings: state.strategyNotes[s.id] || '', status: 'not-started' })) : [{ strategy: '', applicable: '', lead: '', savings: '', status: 'not-started' }];
  }
  document.getElementById('strategyTracker').innerHTML = `<div style="overflow-x:auto"><table class="data-table"><thead><tr><th>Strategy</th><th>Applicable</th><th>Lead Time</th><th>Est. Savings</th><th>Status</th></tr></thead><tbody>${state.trackerRows.map((r,i) => `<tr>
    <td><input class="action-input-mini" value="${escHtml(r.strategy)}" oninput="setTracker(${i},'strategy',this.value)"></td>
    <td><select class="action-input-mini" onchange="setTracker(${i},'applicable',this.value)"><option value="">--</option><option value="Y" ${r.applicable==='Y'?'selected':''}>Yes</option><option value="M" ${r.applicable==='M'?'selected':''}>Maybe</option><option value="N" ${r.applicable==='N'?'selected':''}>No</option></select></td>
    <td><input class="action-input-mini" value="${escHtml(r.lead)}" oninput="setTracker(${i},'lead',this.value)"></td>
    <td><input class="action-input-mini" value="${escHtml(r.savings)}" oninput="setTracker(${i},'savings',this.value)"></td>
    <td><select class="action-input-mini" onchange="setTracker(${i},'status',this.value)"><option value="not-started" ${r.status==='not-started'?'selected':''}>Not Started</option><option value="researching" ${r.status==='researching'?'selected':''}>Researching</option><option value="in-progress" ${r.status==='in-progress'?'selected':''}>In Progress</option><option value="done" ${r.status==='done'?'selected':''}>Done</option></select></td>
  </tr>`).join('')}</tbody></table></div>`;
}
function setTracker(i,f,v) { state.trackerRows[i][f] = v; saveData(); }
function addTrackerRow() { state.trackerRows.push({ strategy:'', applicable:'', lead:'', savings:'', status:'not-started' }); saveData(); renderTracker(); }

/* DASHBOARD */
function renderDashboard() {
  const checkDone = Object.values(state.taxChecks).filter(Boolean).length;
  document.getElementById('dashChecklist').textContent = checkDone;
  const nets = state.scenarios.map(s => calcScenarioNet(s)).filter(n => n > 0);
  document.getElementById('dashBestNet').textContent = nets.length > 0 ? fmtMoney(Math.max(...nets)) : '$--';
  const activeStrats = Object.values(state.strategyApplicable).filter(v => v === 'yes').length;
  document.getElementById('dashStrategies').textContent = activeStrats;
  const entityMap = { 'c-corp': 'C-Corp', 's-corp': 'S-Corp', 'llc': 'LLC', 'sole': 'Sole Prop' };
  document.getElementById('dashEntity').textContent = entityMap[state.entity] || '--';

  // Tax breakdown stacked bar
  const bestIdx = nets.length > 0 ? state.scenarios.indexOf(state.scenarios.reduce((a,b) => calcScenarioNet(a) > calcScenarioNet(b) ? a : b)) : 0;
  const bs = state.scenarios[bestIdx];
  const gross = p(bs.gross);
  if (gross > 0) {
    const fed = calcFedTax(bs); const aca = calcACATax(bs); const st = calcStateTax(bs); const ord = calcOrdinaryTax(bs); const costs = p(bs.costs); const net = calcScenarioNet(bs);
    const items = [
      { label: 'Net Proceeds', val: net, color: 'var(--color-success)' },
      { label: 'Fed Tax', val: fed, color: '#EF4444' },
      { label: 'ACA', val: aca, color: '#F97316' },
      { label: 'State Tax', val: st, color: '#FBBF24' },
      { label: 'Ordinary', val: ord, color: '#A855F7' },
      { label: 'Costs', val: costs, color: 'var(--color-text-tertiary)' }
    ].filter(it => it.val > 0);
    document.getElementById('dashTaxBreakdown').innerHTML = `
      <div class="stacked-bar mb-lg">${items.map(it => `<div class="stacked-seg" style="width:${(it.val/gross*100).toFixed(1)}%;background:${it.color}">${(it.val/gross*100) > 8 ? Math.round(it.val/gross*100)+'%' : ''}</div>`).join('')}</div>
      <div style="display:flex;gap:var(--space-lg);flex-wrap:wrap">${items.map(it => `<div class="flex items-center gap-sm"><div style="width:12px;height:12px;border-radius:3px;background:${it.color}"></div><span class="t-small">${it.label}: ${fmtMoney(it.val)}</span></div>`).join('')}</div>
    `;
  } else {
    document.getElementById('dashTaxBreakdown').innerHTML = '<p class="t-small t-tertiary">Complete the tax calculator to see your tax breakdown visualization.</p>';
  }

  // Scenario bars
  const barHtml = state.scenarios.map((s,i) => {
    const net = calcScenarioNet(s); const maxNet = Math.max(...state.scenarios.map(sc => calcScenarioNet(sc)), 1);
    const pct = maxNet > 0 ? (net / maxNet) * 100 : 0;
    return `<div class="bar-row"><div class="bar-label">Scenario ${i+1}</div><div class="bar-track"><div class="bar-fill" data-width="${pct}" data-delay="${i*100}" style="width:0%;background:${net > 0 ? 'var(--color-success)' : 'var(--color-border)'}">${net > 0 ? `<span class="bar-value">${fmtMoney(net)}</span>` : ''}</div></div></div>`;
  }).join('');
  document.getElementById('dashScenarioBars').innerHTML = barHtml;
  setTimeout(() => { document.querySelectorAll('#dashScenarioBars .bar-fill').forEach(el => { setTimeout(() => { el.style.width = el.dataset.width + '%'; }, parseInt(el.dataset.delay)||0); }); }, 100);

  // Recommendations
  const recs = [];
  if (state.entity === 'c-corp' && Object.values(state.qsbsChecks).filter(Boolean).length < QSBS_ITEMS.length) {
    recs.push({ type: 'warning', text: 'You are a C-Corp but do not fully qualify for QSBS yet. Review the missing criteria -- this could save up to $10M in federal tax.' });
  }
  if (state.entity === 'c-corp' && !state.strategyApplicable['installment']) {
    recs.push({ type: 'info', text: 'As a C-Corp, ensure you are planning a stock sale (not asset sale) to avoid devastating double taxation.' });
  }
  if (p(state.stateInfo.rate) > 5) {
    recs.push({ type: 'warning', text: `Your state tax rate of ${state.stateInfo.rate}% is significant. On a ${fmtMoney(p(state.scenarios[0].gross))} sale, that is ${fmtMoney(p(state.scenarios[0].gross) * p(state.stateInfo.rate)/100)} in state taxes alone. Evaluate residency planning if you have 2+ years.` });
  }
  if (checkDone < 6) { recs.push({ type: 'danger', text: `Only ${checkDone} of 12 checklist items complete. Address the remaining items to avoid costly oversights.` }); }
  if (activeStrats >= 3) { recs.push({ type: 'success', text: `You have ${activeStrats} active strategies identified. Strong tax planning can make the difference between a good exit and a great one.` }); }
  if (recs.length === 0) { recs.push({ type: 'info', text: 'Complete more sections to receive personalized tax planning recommendations.' }); }
  const tm = { danger: 'callout-danger', warning: 'callout-warning', success: 'callout-info', info: 'callout-accent' };
  document.getElementById('dashRecs').innerHTML = recs.map(r => `<div class="callout ${tm[r.type]} mb-md">${r.text}</div>`).join('');

  // Next steps
  if (state.dashSteps.length === 0) {
    state.dashSteps = [
      { action: 'Schedule meeting with transaction tax attorney', owner: '', date: '', status: 'not-started' },
      { action: 'Model after-tax proceeds for expected sale range', owner: '', date: '', status: 'not-started' },
      { action: 'Review entity structure with CPA', owner: '', date: '', status: 'not-started' }
    ];
  }
  document.getElementById('dashNextSteps').innerHTML = `<table class="data-table"><thead><tr><th>Action</th><th style="width:110px">Owner</th><th style="width:110px">Date</th><th style="width:100px">Status</th></tr></thead><tbody>${state.dashSteps.map((s,i) => `<tr><td><input class="action-input-mini" value="${escHtml(s.action)}" oninput="setDashStep(${i},'action',this.value)"></td><td><input class="action-input-mini" value="${escHtml(s.owner)}" oninput="setDashStep(${i},'owner',this.value)"></td><td><input class="action-input-mini" type="date" value="${s.date}" oninput="setDashStep(${i},'date',this.value)"></td><td><select class="action-input-mini" onchange="setDashStep(${i},'status',this.value)"><option value="not-started" ${s.status==='not-started'?'selected':''}>Not Started</option><option value="in-progress" ${s.status==='in-progress'?'selected':''}>In Progress</option><option value="done" ${s.status==='done'?'selected':''}>Done</option></select></td></tr>`).join('')}</tbody></table>`;
}
function setDashStep(i,f,v) { state.dashSteps[i][f] = v; saveData(); }
function addDashStep() { state.dashSteps.push({ action:'', owner:'', date:'', status:'not-started' }); saveData(); renderDashboard(); }

function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'tax-estate-planning-' + new Date().toISOString().split('T')[0] + '.json';
  a.click(); URL.revokeObjectURL(url);
  showToast('Data exported successfully.');
}

function init() {
  loadData();
  state.pagesUnlocked.forEach(pg => unlockPage(pg));
  state.pagesCompleted.forEach(pg => { const n = document.querySelector(`.nav-item[data-page="${pg}"]`); if (n) n.classList.add('completed'); });
  updateProgress();
  if (state.currentPage && state.pagesUnlocked.includes(state.currentPage)) goToPage(state.currentPage);
  document.querySelectorAll('.nav-item').forEach(item => { item.addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') { e.preventDefault(); item.click(); } }); });
  document.addEventListener('keydown', e => { if ((e.key==='Enter'||e.key===' ') && e.target.classList.contains('check-item')) { e.preventDefault(); e.target.click(); } });
}
document.addEventListener('DOMContentLoaded', init);
</script>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('embedded') === 'true') {
    // Hide playbook's own chrome
    var sidebar = document.querySelector('.sidebar');
    var overlay = document.querySelector('.sidebar-overlay');
    var mobileHeader = document.querySelector('.mobile-header');
    var mainContent = document.querySelector('.main-content');
    if (sidebar) sidebar.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    if (mobileHeader) mobileHeader.style.display = 'none';
    if (mainContent) {
      mainContent.style.marginLeft = '0';
      mainContent.style.minHeight = 'auto';
    }

    // Navigate to specific section if requested
    var section = params.get('section');
    if (section !== null) {
      var sectionIndex = parseInt(section, 10);
      if (typeof navigateToSection === 'function') {
        setTimeout(function() { navigateToSection(sectionIndex); }, 100);
      }
    }

    // Forward score updates to parent
    var origDispatch = window.dispatchEvent.bind(window);
    window.addEventListener('playbook:score-update', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:score-update',
          detail: e.detail
        }, '*');
      }
    });

    // Forward section changes to parent
    window.addEventListener('playbook:section-change', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:section-change',
          detail: e.detail
        }, '*');
      }
    });

    // Listen for commands from parent
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'navigate-section') {
        if (typeof navigateToSection === 'function') {
          navigateToSection(e.data.sectionIndex);
        }
      }
    });
  }
})();
</script>
</body>
</html>
