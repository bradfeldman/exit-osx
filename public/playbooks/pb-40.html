<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Business Continuity & Disaster Recovery | Exit Planning Playbook #40</title>
<style>
:root {
  --color-bg: #F5F5F7;
  --color-surface: #FFFFFF;
  --color-surface-alt: #F2F2F7;
  --color-border: #E5E7EB;
  --color-border-light: #F2F2F7;
  --color-text: #1D1D1F;
  --color-text-secondary: #6E6E73;
  --color-text-tertiary: #8E8E93;
  --color-primary: #0071E3;
  --color-primary-light: #E8F4EC;
  --color-primary-hover: #0051B3;
  --color-accent: #FF9500;
  --color-accent-light: #FFF6E8;
  --color-danger: #FF3B30;
  --color-danger-light: #FFEBEA;
  --color-warning: #C67F20;
  --color-warning-light: #FFF8EB;
  --color-success: #34C759;
  --color-success-light: #E8F8ED;
  --color-score-1: #FF3B30;
  --color-score-2: #FF9500;
  --color-score-3: #FFCC00;
  --color-score-4: #34C759;
  --color-score-5: #30D158;
  --radius-sm: 6px; --radius-md: 10px; --radius-lg: 16px; --radius-xl: 24px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06); --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', sans-serif;
  --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', sans-serif;
  --transition-fast: 150ms ease; --transition-normal: 250ms ease; --transition-slow: 400ms cubic-bezier(0.16,1,0.3,1);
  --space-xs: 4px; --space-sm: 8px; --space-md: 16px; --space-lg: 24px; --space-xl: 32px; --space-2xl: 48px; --space-3xl: 64px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{font-family:var(--font-body);font-size:16px;line-height:1.6;color:var(--color-text);background:var(--color-bg);-webkit-font-smoothing:antialiased;min-height:100vh}
button{font-family:inherit;cursor:pointer;border:none;background:none}
input,textarea,select{font-family:inherit;font-size:inherit}
a.skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;z-index:1000}
a.skip-link:focus{position:fixed;top:10px;left:10px;width:auto;height:auto;padding:12px 20px;background:var(--color-primary);color:#fff;border-radius:var(--radius-sm);font-weight:600;z-index:1000}
.t-display{font-family:var(--font-display);font-size:clamp(26px,4vw,38px);font-weight:700;line-height:1.2;letter-spacing:-0.02em}
.t-h1{font-family:var(--font-display);font-size:clamp(22px,3vw,30px);font-weight:700;line-height:1.25}
.t-h2{font-size:20px;font-weight:600;line-height:1.3}
.t-h3{font-size:16px;font-weight:600;line-height:1.4}
.t-body{font-size:16px;line-height:1.6}
.t-small{font-size:14px;line-height:1.5}
.t-caption{font-size:12px;line-height:1.4;letter-spacing:0.02em}
.t-label{font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--color-text-tertiary)}
.t-secondary{color:var(--color-text-secondary)}
.app{display:flex;min-height:100vh}
.sidebar{width:260px;min-width:260px;background:var(--color-text);color:#fff;padding:var(--space-lg);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform var(--transition-slow);overflow-y:auto}
.main-content{flex:1;margin-left:260px;min-height:100vh}
.content-area{max-width:800px;margin:0 auto;padding:var(--space-2xl) var(--space-lg)}
.mobile-header{display:none;position:sticky;top:0;z-index:90;background:var(--color-surface);border-bottom:1px solid var(--color-border);padding:var(--space-md) var(--space-lg);align-items:center;gap:var(--space-md)}
.hamburger{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm)}
.hamburger:hover{background:var(--color-surface-alt)}
.hamburger span{display:block;width:18px;height:2px;background:var(--color-text);position:relative}
.hamburger span::before,.hamburger span::after{content:'';position:absolute;width:18px;height:2px;background:var(--color-text);left:0}
.hamburger span::before{top:-6px}
.hamburger span::after{top:6px}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:99}
@media(max-width:900px){.sidebar{transform:translateX(-260px)}.sidebar.open{transform:translateX(0)}.sidebar-overlay.show{display:block}.main-content{margin-left:0!important}.mobile-header{display:flex}.content-area{padding:var(--space-lg) var(--space-md)}}
.sidebar-brand{margin-bottom:var(--space-xl)}
.sidebar-brand-label{font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:var(--space-xs)}
.sidebar-brand-title{font-family:var(--font-display);font-size:18px;font-weight:700;color:#fff;line-height:1.3}
.sidebar-progress{margin-bottom:var(--space-xl);padding:var(--space-md);background:rgba(255,255,255,0.06);border-radius:var(--radius-md)}
.sidebar-progress-label{font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:var(--space-sm)}
.sidebar-progress-bar{height:4px;background:rgba(255,255,255,0.12);border-radius:2px;overflow:hidden}
.sidebar-progress-fill{height:100%;background:var(--color-accent);border-radius:2px;transition:width var(--transition-slow)}
.sidebar-progress-text{font-size:12px;color:rgba(255,255,255,0.5);margin-top:var(--space-sm);text-align:right}
.sidebar-nav{flex:1;display:flex;flex-direction:column;gap:2px}
.nav-section-label{font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.3);padding:var(--space-md) var(--space-sm) var(--space-xs)}
.nav-item{display:flex;align-items:center;gap:var(--space-md);padding:10px 12px;border-radius:var(--radius-sm);color:rgba(255,255,255,0.6);font-size:14px;transition:all var(--transition-fast);cursor:pointer}
.nav-item:hover{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.85)}
.nav-item.active{background:rgba(255,255,255,0.1);color:#fff;font-weight:500}
.nav-item.completed .nav-check{display:flex}
.nav-item.locked{opacity:0.35;cursor:default}
.nav-item.locked:hover{background:none;color:rgba(255,255,255,0.35)}
.nav-icon{width:20px;text-align:center;flex-shrink:0;font-size:14px}
.nav-check{display:none;width:16px;height:16px;background:var(--color-success);border-radius:50%;align-items:center;justify-content:center;margin-left:auto;flex-shrink:0}
.nav-check svg{width:10px;height:10px;stroke:#fff;stroke-width:2.5;fill:none}
.sidebar-score{margin-top:auto;padding-top:var(--space-lg);border-top:1px solid rgba(255,255,255,0.08)}
.sidebar-score-label{font-size:11px;letter-spacing:0.06em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:var(--space-sm)}
.sidebar-score-value{font-family:var(--font-display);font-size:36px;font-weight:700;color:#fff;line-height:1}
.sidebar-score-max{font-size:18px;color:rgba(255,255,255,0.3);font-weight:400}
.sidebar-score-desc{font-size:12px;color:rgba(255,255,255,0.4);margin-top:var(--space-xs)}
.sidebar-footer{margin-top:var(--space-lg);padding-top:var(--space-md);border-top:1px solid rgba(255,255,255,0.08);font-size:12px;color:rgba(255,255,255,0.3);display:flex;align-items:center;gap:6px}
.sidebar-footer-dot{width:6px;height:6px;border-radius:50%;background:var(--color-success)}
.card{background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-lg);padding:var(--space-lg);transition:box-shadow var(--transition-normal);margin-bottom:var(--space-md)}
.card:hover{box-shadow:var(--shadow-sm)}
.callout{padding:var(--space-md) var(--space-lg);border-radius:var(--radius-md);border-left:3px solid;font-size:14px;line-height:1.6;margin-bottom:var(--space-md)}
.callout-info{background:var(--color-primary-light);border-color:var(--color-primary);color:var(--color-primary)}
.callout-warning{background:var(--color-warning-light);border-color:var(--color-warning);color:#7C5A10}
.callout-danger{background:var(--color-danger-light);border-color:var(--color-danger);color:var(--color-danger)}
.callout-accent{background:var(--color-accent-light);border-color:var(--color-accent);color:#8B5A20}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--space-sm);padding:10px 20px;border-radius:var(--radius-sm);font-size:14px;font-weight:500;transition:all var(--transition-fast);white-space:nowrap}
.btn-primary{background:var(--color-primary);color:#fff}
.btn-primary:hover{background:var(--color-primary-hover);transform:translateY(-1px);box-shadow:var(--shadow-sm)}
.btn-secondary{background:var(--color-surface);color:var(--color-text);border:1px solid var(--color-border)}
.btn-secondary:hover{background:var(--color-surface-alt)}
.btn-ghost{color:var(--color-text-secondary);padding:8px 12px}
.btn-ghost:hover{background:var(--color-surface-alt);color:var(--color-text)}
.btn-sm{padding:6px 14px;font-size:13px}
.btn:disabled{opacity:0.4;cursor:not-allowed;transform:none!important}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:500}
.badge-success{background:var(--color-success-light);color:var(--color-success)}
.badge-warning{background:var(--color-warning-light);color:var(--color-warning)}
.badge-danger{background:var(--color-danger-light);color:var(--color-danger)}
.badge-primary{background:var(--color-primary-light);color:var(--color-primary)}
.form-group{margin-bottom:var(--space-lg)}
.form-label{display:block;font-size:14px;font-weight:500;margin-bottom:var(--space-sm)}
.form-hint{font-size:13px;color:var(--color-text-tertiary);margin-top:var(--space-xs)}
.form-input{width:100%;padding:10px 14px;border:1px solid var(--color-border);border-radius:var(--radius-sm);font-size:15px;background:var(--color-surface);transition:all var(--transition-fast);color:var(--color-text)}
.form-input:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 3px var(--color-primary-light)}
textarea.form-input{min-height:80px;resize:vertical;line-height:1.5}
select.form-input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%236E6E73' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
.score-selector{display:flex;gap:var(--space-sm)}
.score-option{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 8px;border:2px solid var(--color-border);border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition-fast);text-align:center}
.score-option:hover{border-color:var(--color-text-tertiary);background:var(--color-surface-alt)}
.score-option.selected{border-color:var(--color-primary);background:var(--color-primary-light)}
.score-option input[type="radio"]{position:absolute;opacity:0;width:0;height:0}
.score-number{font-size:22px;font-weight:700;line-height:1}
.score-label-text{font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:0.04em;color:var(--color-text-secondary);line-height:1.2}
.score-option.s1 .score-number{color:var(--color-score-1)}
.score-option.s2 .score-number{color:var(--color-score-2)}
.score-option.s3 .score-number{color:var(--color-score-3)}
.score-option.s4 .score-number{color:var(--color-score-4)}
.score-option.s5 .score-number{color:var(--color-score-5)}
.score-option.selected.s1{border-color:var(--color-score-1);background:#FFF5F5}
.score-option.selected.s2{border-color:var(--color-score-2);background:#FFFBEB}
.score-option.selected.s3{border-color:var(--color-score-3);background:#FFF8EB}
.score-option.selected.s4{border-color:var(--color-score-4);background:#E8F8EE}
.score-option.selected.s5{border-color:var(--color-score-5);background:#E0F5E8}
@media(max-width:600px){.score-selector{gap:4px}.score-option{padding:10px 4px}.score-number{font-size:18px}.score-label-text{font-size:9px}}
.checklist{display:flex;flex-direction:column;gap:2px}
.check-item{display:flex;align-items:flex-start;gap:var(--space-md);padding:var(--space-md);border-radius:var(--radius-sm);cursor:pointer;transition:background var(--transition-fast)}
.check-item:hover{background:var(--color-surface-alt)}
.check-box{width:22px;height:22px;border:2px solid var(--color-border);border-radius:4px;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all var(--transition-fast);margin-top:1px}
.check-item.checked .check-box{background:var(--color-primary);border-color:var(--color-primary)}
.check-item.checked .check-box svg{opacity:1}
.check-box svg{width:14px;height:14px;stroke:#fff;stroke-width:2.5;fill:none;opacity:0}
.check-text{font-size:14px;line-height:1.5}
.check-item.checked .check-text{color:var(--color-text-tertiary);text-decoration:line-through}
.page{display:none;animation:fadeIn 0.3s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.page-header{margin-bottom:var(--space-2xl)}
.page-header .t-label{margin-bottom:var(--space-sm)}
.page-header .t-display{margin-bottom:var(--space-md)}
.page-header .t-body{color:var(--color-text-secondary);max-width:600px}
.page-nav{display:flex;justify-content:space-between;align-items:center;margin-top:var(--space-2xl);padding-top:var(--space-xl);border-top:1px solid var(--color-border)}
.welcome-hero{text-align:center;padding:var(--space-3xl) var(--space-lg);max-width:640px;margin:0 auto}
.welcome-icon{width:72px;height:72px;background:var(--color-primary-light);border-radius:var(--radius-xl);display:flex;align-items:center;justify-content:center;margin:0 auto var(--space-lg);font-size:32px}
.welcome-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-md);margin:var(--space-2xl) 0;text-align:center}
.welcome-stat{padding:var(--space-lg);background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-md)}
.welcome-stat-value{font-family:var(--font-display);font-size:28px;font-weight:700;color:var(--color-primary)}
.welcome-stat-label{font-size:13px;color:var(--color-text-secondary);margin-top:4px}
@media(max-width:600px){.welcome-stats{grid-template-columns:1fr}.welcome-hero{padding:var(--space-2xl) var(--space-md)}}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:var(--space-md);margin-bottom:var(--space-lg)}
.summary-item{padding:var(--space-lg);background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-md);text-align:center}
.summary-item-value{font-family:var(--font-display);font-size:28px;font-weight:700}
.summary-item-label{font-size:12px;color:var(--color-text-tertiary);text-transform:uppercase;letter-spacing:0.04em;margin-top:var(--space-xs)}
.bar-chart{display:flex;flex-direction:column;gap:var(--space-md)}
.bar-row{display:flex;align-items:center;gap:var(--space-md)}
.bar-label{width:140px;flex-shrink:0;font-size:13px;color:var(--color-text-secondary);text-align:right}
.bar-track{flex:1;height:24px;background:var(--color-surface-alt);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px;transition:width 0.8s cubic-bezier(0.16,1,0.3,1);display:flex;align-items:center;justify-content:flex-end;padding-right:8px}
.bar-value{font-size:12px;font-weight:600;color:#fff}
@media(max-width:600px){.bar-label{width:90px;font-size:11px}}
.data-table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px;margin-bottom:var(--space-md)}
.data-table th{text-align:left;padding:var(--space-sm) var(--space-md);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--color-text-tertiary);border-bottom:2px solid var(--color-border)}
.data-table td{padding:var(--space-sm) var(--space-md);border-bottom:1px solid var(--color-border-light);vertical-align:top}
.data-table tr:last-child td{border-bottom:none}
.data-table input,.data-table select{width:100%;padding:6px 10px;border:1px solid var(--color-border);border-radius:var(--radius-sm);font-size:13px;font-family:inherit;background:var(--color-surface)}
.data-table input:focus,.data-table select:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 2px var(--color-primary-light)}
.gauge-wrap{display:flex;justify-content:center;margin:var(--space-lg) 0}
.gauge-ring{position:relative;width:160px;height:160px}
.gauge-ring svg{width:160px;height:160px;transform:rotate(-90deg)}
.gauge-ring circle{fill:none;stroke-width:8;stroke-linecap:round}
.gauge-bg{stroke:var(--color-border)}
.gauge-fill{transition:stroke-dashoffset 1s ease}
.gauge-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.gauge-center-value{font-family:var(--font-display);font-size:36px;font-weight:700;line-height:1}
.gauge-center-label{font-size:12px;color:var(--color-text-tertiary);margin-top:4px}
.add-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;border:2px dashed var(--color-border);border-radius:var(--radius-md);background:transparent;cursor:pointer;font-size:14px;color:var(--color-text-tertiary);font-weight:500;transition:all var(--transition-fast);font-family:inherit;margin-bottom:var(--space-md)}
.add-btn:hover{border-color:var(--color-primary);color:var(--color-primary);background:var(--color-primary-light)}
.formula-box{background:var(--color-text);color:#fff;padding:var(--space-lg);border-radius:var(--radius-md);margin:var(--space-md) 0;font-size:14px}
.formula-box strong{color:var(--color-accent)}
@media print{.sidebar,.mobile-header,.page-nav,.sidebar-overlay{display:none!important}.main-content{margin-left:0!important}.page{display:block!important;page-break-inside:avoid;margin-bottom:24px}}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:0.01ms!important;transition-duration:0.01ms!important}}
:focus-visible{outline:2px solid var(--color-primary);outline-offset:2px}
</style>
</head>
<body>
<a href="#contentArea" class="skip-link">Skip to content</a>
<div class="app">
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Playbook navigation">
    <div class="sidebar-brand">
      <div class="sidebar-brand-label">Exit Planning Playbook #40</div>
      <div class="sidebar-brand-title">Business Continuity & Disaster Recovery</div>
    </div>
    <div class="sidebar-progress">
      <div class="sidebar-progress-label">Your Progress</div>
      <div class="sidebar-progress-bar"><div class="sidebar-progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="sidebar-progress-text" id="progressText">0% complete</div>
    </div>
    <nav class="sidebar-nav" id="sidebarNav"></nav>
    <div class="sidebar-score">
      <div class="sidebar-score-label">BC/DR Readiness</div>
      <div class="sidebar-score-value" id="sidebarScore">--<span class="sidebar-score-max">/100</span></div>
      <div class="sidebar-score-desc" id="sidebarScoreDesc">Complete sections to build your score</div>
    </div>
    <div class="sidebar-footer"><div class="sidebar-footer-dot"></div>Auto-saved locally</div>
  </aside>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <div class="main-content">
    <div class="mobile-header">
      <button class="hamburger" id="hamburgerBtn" aria-label="Toggle navigation"><span></span></button>
      <div style="flex:1"><strong style="font-size:15px;">BC/DR Planning</strong></div>
      <div class="badge badge-primary" id="mobileScore">--/100</div>
    </div>
    <main class="content-area" id="contentArea" role="main"></main>
  </div>
</div>

<script>
(function(){
'use strict';

var SK = 'exitosx-pb40-business-continuity';

var PAGES = [
  {id:'welcome',title:'Welcome',phase:'START',icon:'1'},
  {id:'why-bcdr',title:'Why BC/DR Is Exit Planning',phase:'UNDERSTAND',icon:'2'},
  {id:'system-failures',title:'Critical System Failures',phase:'ASSESS',icon:'3'},
  {id:'key-person',title:'Key Person Departures',phase:'ASSESS',icon:'4'},
  {id:'external-shocks',title:'External Shocks',phase:'ASSESS',icon:'5'},
  {id:'supply-chain',title:'Supply Chain Resilience',phase:'STRATEGY',icon:'6'},
  {id:'it-dr',title:'IT Disaster Recovery',phase:'STRATEGY',icon:'7'},
  {id:'insurance',title:'Business Interruption Insurance',phase:'STRATEGY',icon:'8'},
  {id:'communication',title:'Crisis Communication',phase:'PLAN',icon:'9'},
  {id:'testing',title:'Testing & Improvement',phase:'PLAN',icon:'10'},
  {id:'dashboard',title:'Dashboard',phase:'RESULTS',icon:'11'}
];

function defaultState(){return{currentPage:'welcome',completed:{},
  systems:[
    {name:'ERP / Core Operations',criticality:'Mission-Critical',rpo:'1 hour',rto:'4 hours',backup:'',status:''},
    {name:'Financial / Accounting',criticality:'Critical',rpo:'4 hours',rto:'8 hours',backup:'',status:''},
    {name:'CRM / Sales Pipeline',criticality:'High',rpo:'4 hours',rto:'24 hours',backup:'',status:''},
    {name:'Email / Communication',criticality:'High',rpo:'1 hour',rto:'2 hours',backup:'',status:''},
    {name:'Website / E-commerce',criticality:'High',rpo:'1 hour',rto:'1 hour',backup:'',status:''},
    {name:'File Storage',criticality:'Medium',rpo:'4 hours',rto:'24 hours',backup:'',status:''}
  ],
  keyPersons:[
    {role:'Owner / CEO',dependency:0,docLevel:0,coverage:''},
    {role:'Head of Sales',dependency:0,docLevel:0,coverage:''},
    {role:'CFO / Controller',dependency:0,docLevel:0,coverage:''},
    {role:'Lead Engineer / CTO',dependency:0,docLevel:0,coverage:''}
  ],
  externalScores:{recession:0,pandemic:0,disaster:0},
  recessionChecklist:{},
  supplyRisks:[
    {category:'Single-source dependency',likelihood:'',impact:'',mitigation:''},
    {category:'Geographic concentration',likelihood:'',impact:'',mitigation:''},
    {category:'Supplier insolvency',likelihood:'',impact:'',mitigation:''},
    {category:'Quality failure',likelihood:'',impact:'',mitigation:''}
  ],
  itDrScores:{backup:0,failover:0,cyber:0,network:0},
  backupRule:{copies:'',mediaTypes:'',offsite:''},
  biCoverage:{hasBI:'',adequate:'',cyberExcluded:'',updated:''},
  commPlan:{immediate:'',internal:'',stakeholders:'',ongoing:''},
  testingChecklist:{},
  procedureInventory:[],
  mistakeFlags:{},notes:{}};}

var state = loadState();
function loadState(){try{var s=localStorage.getItem(SK);return s?Object.assign(defaultState(),JSON.parse(s)):defaultState();}catch(e){return defaultState();}}
function saveState(){try{localStorage.setItem(SK,JSON.stringify(state));}catch(e){}updateProgress();updateScore();}

function calcScore(){
  var s=0;
  // System assessment (0-15)
  var sysAssessed=state.systems.filter(function(sys){return sys.backup&&sys.status;}).length;
  s+=Math.round((sysAssessed/state.systems.length)*15);
  // Key person (0-15)
  var kpAssessed=state.keyPersons.filter(function(kp){return kp.dependency>0;}).length;
  s+=Math.round((kpAssessed/state.keyPersons.length)*15);
  // External shocks (0-15, 3 dims at 5)
  Object.values(state.externalScores).forEach(function(v){s+=v;});
  // Supply chain (0-15)
  var scDone=state.supplyRisks.filter(function(r){return r.likelihood&&r.mitigation;}).length;
  s+=Math.round((scDone/state.supplyRisks.length)*15);
  // IT DR (0-20, 4 dims at 5)
  Object.values(state.itDrScores).forEach(function(v){s+=v;});
  // BI insurance (0-10)
  if(state.biCoverage.hasBI==='yes') s+=5;
  if(state.biCoverage.adequate==='yes') s+=5;
  // Testing (0-10)
  var testCount=Object.keys(state.testingChecklist).filter(function(k){return state.testingChecklist[k];}).length;
  s+=Math.min(testCount*2,10);
  return Math.min(Math.round(s),100);
}

function getScoreColor(s){if(s>=81)return'var(--color-score-5)';if(s>=61)return'var(--color-score-4)';if(s>=41)return'var(--color-score-3)';if(s>=21)return'var(--color-score-2)';return'var(--color-score-1)';}
function getScoreLabel(s){if(s>=81)return'Strong resilience -- buyer confidence';if(s>=61)return'Good foundation, address gaps';if(s>=41)return'Moderate -- several areas at risk';if(s>=21)return'Significant vulnerabilities';return'Complete sections to build your score';}
function updateScore(){var s=calcScore();document.getElementById('sidebarScore').innerHTML=s+'<span class="sidebar-score-max">/100</span>';document.getElementById('mobileScore').textContent=s+'/100';document.getElementById('sidebarScoreDesc').textContent=getScoreLabel(s);}
function updateProgress(){var t=PAGES.length-2,d=Object.keys(state.completed).length,p=Math.round((d/t)*100);document.getElementById('progressFill').style.width=p+'%';document.getElementById('progressText').textContent=p+'% complete';}
function isUnlocked(id){var i=PAGES.findIndex(function(p){return p.id===id;});if(i<=0)return true;return state.completed[PAGES[i-1].id]===true;}

function renderNav(){
  var nav=document.getElementById('sidebarNav'),html='',lp='';
  PAGES.forEach(function(p){
    if(p.phase!==lp){html+='<div class="nav-section-label">'+p.phase+'</div>';lp=p.phase;}
    var a=state.currentPage===p.id,d=state.completed[p.id],l=!isUnlocked(p.id);
    html+='<div class="nav-item'+(a?' active':'')+(d?' completed':'')+(l?' locked':'')+'" data-page="'+p.id+'" role="button" tabindex="'+(l?'-1':'0')+'" aria-current="'+(a?'step':'false')+'">';
    html+='<span class="nav-icon">'+p.icon+'</span><span>'+p.title+'</span>';
    if(d)html+='<span class="nav-check"><svg viewBox="0 0 10 10"><polyline points="1.5 5 4 7.5 8.5 2.5"/></svg></span>';
    html+='</div>';
  });
  nav.innerHTML=html;
  nav.querySelectorAll('.nav-item:not(.locked)').forEach(function(el){
    el.addEventListener('click',function(){goToPage(el.dataset.page);});
    el.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();goToPage(el.dataset.page);}});
  });
}

function goToPage(id){if(!isUnlocked(id))return;state.currentPage=id;saveState();renderPage();renderNav();window.scrollTo({top:0,behavior:'smooth'});closeSidebar();}
function completePage(id){state.completed[id]=true;var i=PAGES.findIndex(function(p){return p.id===id;});if(i<PAGES.length-1)state.currentPage=PAGES[i+1].id;saveState();renderPage();renderNav();window.scrollTo({top:0,behavior:'smooth'});}
function prevPage(){var i=PAGES.findIndex(function(p){return p.id===state.currentPage;});if(i>0)goToPage(PAGES[i-1].id);}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('show');}
document.getElementById('hamburgerBtn').addEventListener('click',toggleSidebar);
document.getElementById('sidebarOverlay').addEventListener('click',closeSidebar);

function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function pn(showPrev,nextLabel,currentId){var h='<div class="page-nav">';h+=showPrev?'<button class="btn btn-secondary" onclick="PB.prevPage()">&larr; Back</button>':'<div></div>';if(nextLabel!==false)h+='<button class="btn btn-primary" onclick="PB.completePage(\''+currentId+'\')">'+( nextLabel||'Continue')+' &rarr;</button>';h+='</div>';return h;}
function ss(key,obj,sk,labels){var c=obj[sk]||0;var h='<div class="score-selector" role="radiogroup" aria-label="Score for '+key+'">';for(var i=1;i<=5;i++){var sel=c===i?' selected':'';h+='<label class="score-option s'+i+sel+'" onclick="PB.setScore(\''+sk+'\',\''+key+'\','+i+')" tabindex="0" role="radio" aria-checked="'+(c===i)+'" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();PB.setScore(\''+sk+'\',\''+key+'\','+i+');}">';h+='<input type="radio" name="score-'+key+'" value="'+i+'"'+(c===i?' checked':'')+'>';h+='<span class="score-number">'+i+'</span>';h+='<span class="score-label-text">'+(labels?labels[i-1]:['Poor','Below Avg','Average','Good','Excellent'][i-1])+'</span></label>';}h+='</div>';return h;}

function renderPage(){
  var area=document.getElementById('contentArea');
  var r={'welcome':rWelcome,'why-bcdr':rWhyBCDR,'system-failures':rSystems,'key-person':rKeyPerson,'external-shocks':rExternalShocks,'supply-chain':rSupplyChain,'it-dr':rITDR,'insurance':rInsurance,'communication':rComm,'testing':rTesting,'dashboard':rDashboard};
  var fn=r[state.currentPage];
  area.innerHTML='<div class="page active">'+(fn?fn():'')+'</div>';
  bindInputs();
}

function bindInputs(){
  document.querySelectorAll('[data-bind]').forEach(function(el){
    var keys=el.dataset.bind.split('.');
    var handler=function(){var obj=state;for(var i=0;i<keys.length-1;i++){if(keys[i].match(/^\d+$/))obj=obj[parseInt(keys[i])];else obj=obj[keys[i]];}obj[keys[keys.length-1]]=el.value;saveState();};
    el.addEventListener('input',handler);el.addEventListener('change',handler);
  });
  document.querySelectorAll('.check-item[data-check]').forEach(function(el){
    var handler=function(){var key=el.dataset.check;
      if(key.startsWith('rc_'))state.recessionChecklist[key]=!state.recessionChecklist[key];
      else if(key.startsWith('tc_'))state.testingChecklist[key]=!state.testingChecklist[key];
      else state.mistakeFlags[key]=!state.mistakeFlags[key];
      saveState();renderPage();};
    el.addEventListener('click',handler);
    el.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();handler();}});
  });
}

function rWelcome(){
  return '<div class="welcome-hero"><div class="welcome-icon">&#128737;</div>' +
    '<div class="t-display">Business Continuity & Disaster Recovery</div>' +
    '<p class="t-body t-secondary" style="margin-top:var(--space-md)">A business that cannot survive a major disruption has no exit value. This playbook builds the operational resilience buyers prize.</p>' +
    '<div class="welcome-stats">' +
    '<div class="welcome-stat"><div class="welcome-stat-value">20-40%</div><div class="welcome-stat-label">Discount for owner-dependent businesses</div></div>' +
    '<div class="welcome-stat"><div class="welcome-stat-value">3-2-1</div><div class="welcome-stat-label">The backup rule: 3 copies, 2 media, 1 offsite</div></div>' +
    '<div class="welcome-stat"><div class="welcome-stat-value">10</div><div class="welcome-stat-label">Resilience dimensions assessed</div></div></div>' +
    '<div class="callout callout-accent" style="text-align:left"><strong>The Core Principle:</strong> Business continuity planning IS exit planning for scenarios you did not choose. Every dollar invested in continuity generates a return in exit value. Resilient businesses command higher multiples.</div>' +
    '</div>'+pn(false,'Begin Assessment','welcome');
}

function rWhyBCDR(){
  return '<div class="page-header"><div class="t-label">Understanding</div><div class="t-display">Why BC/DR Impacts Exit Value</div><p class="t-body t-secondary">Buyers conduct due diligence on operational resilience. Here is what they evaluate.</p></div>' +
    '<div class="card"><table class="data-table"><thead><tr><th>Resilience Factor</th><th>Buyer Impact</th><th>Valuation Effect</th></tr></thead><tbody>' +
    '<tr><td><strong>Documented DR procedures</strong></td><td>Demonstrates operational maturity</td><td style="color:var(--color-success);font-weight:600">Positive -- builds confidence</td></tr>' +
    '<tr><td><strong>Tested backup systems</strong></td><td>Proves data can be recovered</td><td style="color:var(--color-success);font-weight:600">+0.2x to +0.5x</td></tr>' +
    '<tr><td><strong>Diversified supply chain</strong></td><td>Reduces concentration risk</td><td style="color:var(--color-success);font-weight:600">+0.1x to +0.3x</td></tr>' +
    '<tr><td><strong>Key-person redundancy</strong></td><td>Business survives departure</td><td style="color:var(--color-success);font-weight:600">+0.5x to +1.0x</td></tr>' +
    '<tr><td><strong>No BC/DR plan</strong></td><td>Single points of failure everywhere</td><td style="color:var(--color-danger);font-weight:600">-0.3x to -1.0x</td></tr>' +
    '<tr><td><strong>Owner is the plan</strong></td><td>Everything depends on one person</td><td style="color:var(--color-danger);font-weight:600">-0.5x to -1.5x</td></tr>' +
    '</tbody></table></div>'+pn(true,'Continue','why-bcdr');
}

function rSystems(){
  var html='<div class="page-header"><div class="t-label">Assessment</div><div class="t-display">Critical System Failure Planning</div><p class="t-body t-secondary">Assess each critical system\'s recovery objectives and backup readiness.</p></div>';
  html+='<div class="formula-box"><strong>RPO</strong> = Recovery Point Objective (how much data you can afford to lose)<br><strong>RTO</strong> = Recovery Time Objective (how quickly you must restore operations)</div>';
  html+='<div class="card" style="overflow-x:auto"><table class="data-table"><thead><tr><th>System</th><th>Criticality</th><th>RPO</th><th>RTO</th><th>Backup Method</th><th>Status</th></tr></thead><tbody>';
  state.systems.forEach(function(sys,i){
    html+='<tr><td><strong>'+esc(sys.name)+'</strong></td><td><span class="badge '+(sys.criticality==='Mission-Critical'?'badge-danger':sys.criticality==='Critical'?'badge-warning':'badge-primary')+'">'+esc(sys.criticality)+'</span></td>';
    html+='<td>'+esc(sys.rpo)+'</td><td>'+esc(sys.rto)+'</td>';
    html+='<td><input class="form-input" type="text" value="'+esc(sys.backup)+'" data-bind="systems.'+i+'.backup" placeholder="e.g., Cloud sync"></td>';
    html+='<td><select class="form-input" data-bind="systems.'+i+'.status"><option value="">--</option><option value="Protected"'+(sys.status==='Protected'?' selected':'')+'>Protected</option><option value="Partial"'+(sys.status==='Partial'?' selected':'')+'>Partial</option><option value="At Risk"'+(sys.status==='At Risk'?' selected':'')+'>At Risk</option></select></td></tr>';
  });
  html+='</tbody></table></div>';
  html+='<div class="callout callout-info"><strong>Failure Response:</strong> Detection (automated alerts, 15 min) &#8594; Classification (severity 1-4) &#8594; Response (activate backups) &#8594; Recovery (restore + verify) &#8594; Post-Incident Review (72 hours)</div>';
  html+=pn(true,'Continue','system-failures');
  return html;
}

function rKeyPerson(){
  var html='<div class="page-header"><div class="t-label">Assessment</div><div class="t-display">Key Person Departure Scenarios</div><p class="t-body t-secondary">The departure of a key person is the most common business continuity event for SMBs. Score each role\'s dependency level.</p></div>';
  html+='<div class="callout callout-danger"><strong>Valuation Impact:</strong> Owner-dependent businesses typically sell at a 20-40% discount compared to businesses with professional management teams.</div>';
  state.keyPersons.forEach(function(kp,i){
    html+='<div class="card"><div class="t-h3">'+esc(kp.role)+'</div>';
    html+='<div style="margin-top:var(--space-md)"><div class="form-label">Dependency Level</div>'+ss('kp_dep_'+i,kp,'dependency',['Minimal','Low','Moderate','High','Extreme'])+'</div>';
    html+='<div style="margin-top:var(--space-md)"><div class="form-label">Knowledge Documentation Level</div>'+ss('kp_doc_'+i,kp,'docLevel',['None','Minimal','Partial','Good','Comprehensive'])+'</div>';
    html+='<div class="form-group" style="margin-top:var(--space-md)"><label class="form-label">Interim Coverage Plan</label><input class="form-input" type="text" value="'+esc(kp.coverage)+'" data-bind="keyPersons.'+i+'.coverage" placeholder="Who covers if this person leaves?"></div></div>';
  });
  html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Reducing Key Person Dependency</div><ul style="margin-left:var(--space-lg);color:var(--color-text-secondary);font-size:14px;display:flex;flex-direction:column;gap:8px">' +
    '<li><strong>Document everything</strong> -- critical processes in writing, not in someone\'s head</li>' +
    '<li><strong>Cross-train</strong> -- at least two people for every critical function</li>' +
    '<li><strong>Distribute relationships</strong> -- customers and vendor relationships shared across team</li>' +
    '<li><strong>Systematize</strong> -- automate repetitive decision-making</li>' +
    '<li><strong>Delegate authority</strong> -- managers can operate independently</li></ul></div>';
  html+=pn(true,'Continue','key-person');
  return html;
}

function rExternalShocks(){
  var recItems=['3-6 months cash reserves maintained','Fixed costs converted to variable where possible','No customer >25% of revenue','Lender relationships pre-negotiated','Acquisition targets identified for distressed valuations'];
  var html='<div class="page-header"><div class="t-label">Assessment</div><div class="t-display">External Shocks: Recession, Pandemic, Disaster</div><p class="t-body t-secondary">External shocks are outside your control but within your preparation. Score your readiness for each scenario.</p></div>';
  var dims=[{key:'recession',label:'Recession Preparedness',hint:'Cash reserves, cost flexibility, revenue diversification, lender relationships'},{key:'pandemic',label:'Pandemic Preparedness',hint:'Remote work capability, supply chain redundancy, health protocols'},{key:'disaster',label:'Natural Disaster Preparedness',hint:'Physical redundancy, insurance adequacy, backup sites, asset protection'}];
  dims.forEach(function(d){
    html+='<div class="card"><div class="form-label">'+d.label+'</div><div class="form-hint" style="margin-bottom:var(--space-sm)">'+d.hint+'</div>'+ss(d.key,state.externalScores,d.key,['Unprepared','Minimal','Moderate','Good','Resilient'])+'</div>';
  });
  html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Recession Readiness Checklist</div><div class="checklist">';
  recItems.forEach(function(item,i){
    var key='rc_'+i;var checked=state.recessionChecklist[key];
    html+='<div class="check-item'+(checked?' checked':'')+'" data-check="'+key+'" role="checkbox" aria-checked="'+!!checked+'" tabindex="0"><div class="check-box"><svg viewBox="0 0 14 14"><polyline points="2.5 7 5.5 10 11.5 4"/></svg></div><div class="check-text">'+item+'</div></div>';
  });
  html+='</div></div>';
  html+='<div class="callout callout-accent"><strong>Annual Exercise:</strong> Run a tabletop exercise: "What happens if revenue drops 30% for 12 months?" Walk through cash flow, staffing, customer communication, and lender covenants. The exercise itself builds resilience.</div>';
  html+=pn(true,'Continue','external-shocks');
  return html;
}

function rSupplyChain(){
  var html='<div class="page-header"><div class="t-label">Strategy</div><div class="t-display">Supply Chain Resilience</div><p class="t-body t-secondary">Supply chain disruptions halt production and erode margins. Buyers scrutinize supply chain concentration during diligence.</p></div>';
  html+='<div class="callout callout-danger"><strong>Due Diligence Red Flag:</strong> A business with 60%+ of inputs from a single supplier will face valuation pushback. Diversifying before going to market directly increases your sale price.</div>';
  html+='<div class="card" style="overflow-x:auto"><table class="data-table"><thead><tr><th>Risk Category</th><th>Likelihood</th><th>Impact</th><th>Mitigation Strategy</th></tr></thead><tbody>';
  state.supplyRisks.forEach(function(r,i){
    html+='<tr><td><strong>'+esc(r.category)+'</strong></td>';
    html+='<td><select class="form-input" data-bind="supplyRisks.'+i+'.likelihood"><option value="">--</option><option value="Low"'+(r.likelihood==='Low'?' selected':'')+'>Low</option><option value="Medium"'+(r.likelihood==='Medium'?' selected':'')+'>Medium</option><option value="High"'+(r.likelihood==='High'?' selected':'')+'>High</option></select></td>';
    html+='<td><select class="form-input" data-bind="supplyRisks.'+i+'.impact"><option value="">--</option><option value="Low"'+(r.impact==='Low'?' selected':'')+'>Low</option><option value="Medium"'+(r.impact==='Medium'?' selected':'')+'>Medium</option><option value="High"'+(r.impact==='High'?' selected':'')+'>High</option><option value="Severe"'+(r.impact==='Severe'?' selected':'')+'>Severe</option></select></td>';
    html+='<td><input class="form-input" type="text" value="'+esc(r.mitigation)+'" data-bind="supplyRisks.'+i+'.mitigation" placeholder="Mitigation plan"></td></tr>';
  });
  html+='</tbody></table></div>';
  html+='<div class="card"><div class="t-h3">Building Resilience</div><ul style="margin:var(--space-md) 0 0 var(--space-lg);color:var(--color-text-secondary);font-size:14px;display:flex;flex-direction:column;gap:8px">' +
    '<li><strong>Dual sourcing:</strong> No single supplier >30-40% of any critical input</li>' +
    '<li><strong>Safety stock:</strong> 2-4 weeks above normal inventory for critical inputs</li>' +
    '<li><strong>Supplier monitoring:</strong> Scorecards for quality, delivery, financial stability</li>' +
    '<li><strong>Switching readiness:</strong> How quickly can you onboard an alternative?</li></ul></div>';
  html+=pn(true,'Continue','supply-chain');
  return html;
}

function rITDR(){
  var dims=[{key:'backup',label:'Data Backup & Recovery',hint:'Regular backups, tested restoration, RPO met?'},{key:'failover',label:'System Failover',hint:'Auto-switch to redundant systems when primary fails?'},{key:'cyber',label:'Cybersecurity Incident Response',hint:'Plan for breaches, ransomware, data theft? Tested?'},{key:'network',label:'Network Recovery',hint:'Alternative connectivity if primary systems down?'}];
  var html='<div class="page-header"><div class="t-label">Strategy</div><div class="t-display">IT Disaster Recovery</div><p class="t-body t-secondary">IT DR focuses on restoring technology systems, data, and infrastructure after a disruption.</p></div>';
  dims.forEach(function(d){
    html+='<div class="card"><div class="form-label">'+d.label+'</div><div class="form-hint" style="margin-bottom:var(--space-sm)">'+d.hint+'</div>'+ss(d.key,state.itDrScores,d.key,['No Plan','Basic','Documented','Tested','Mature'])+'</div>';
  });
  html+='<div class="formula-box"><strong>The 3-2-1 Backup Rule:</strong><br>3 copies of critical data, on 2 different media types, with 1 copy stored offsite. This protects against hardware failure, ransomware, and site-level disasters simultaneously.</div>';
  html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Your 3-2-1 Status</div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--space-md)">' +
    '<div class="form-group"><label class="form-label">Copies</label><input class="form-input" type="text" placeholder="How many copies?" value="'+esc(state.backupRule.copies)+'" data-bind="backupRule.copies"></div>' +
    '<div class="form-group"><label class="form-label">Media Types</label><input class="form-input" type="text" placeholder="e.g., SSD + Cloud" value="'+esc(state.backupRule.mediaTypes)+'" data-bind="backupRule.mediaTypes"></div>' +
    '<div class="form-group"><label class="form-label">Offsite Location</label><input class="form-input" type="text" placeholder="e.g., AWS us-east-1" value="'+esc(state.backupRule.offsite)+'" data-bind="backupRule.offsite"></div></div></div>';
  html+=pn(true,'Continue','it-dr');
  return html;
}

function rInsurance(){
  var html='<div class="page-header"><div class="t-label">Strategy</div><div class="t-display">Business Interruption Insurance</div><p class="t-body t-secondary">BI insurance replaces lost income when a covered event disrupts operations. Understand its coverage and limitations.</p></div>';
  html+='<div class="card"><table class="data-table"><thead><tr><th>Coverage</th><th>What It Covers</th><th>Key Limitations</th></tr></thead><tbody>' +
    '<tr><td><strong>Lost Revenue</strong></td><td>Net income during interruption</td><td>Based on historical financials</td></tr>' +
    '<tr><td><strong>Fixed Expenses</strong></td><td>Rent, loans, premiums</td><td>Only continuing expenses</td></tr>' +
    '<tr><td><strong>Extra Expenses</strong></td><td>Costs to resume faster</td><td>Must be reasonable/necessary</td></tr>' +
    '<tr><td><strong>Contingent BI</strong></td><td>Supplier/customer disruption</td><td>Requires specific endorsement</td></tr>' +
    '</tbody></table></div>';
  html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Your BI Coverage Assessment</div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-md)">' +
    '<div class="form-group"><label class="form-label">Do you have BI insurance?</label><select class="form-input" data-bind="biCoverage.hasBI"><option value="">--</option><option value="yes"'+(state.biCoverage.hasBI==='yes'?' selected':'')+'>Yes</option><option value="no"'+(state.biCoverage.hasBI==='no'?' selected':'')+'>No</option></select></div>' +
    '<div class="form-group"><label class="form-label">Coverage adequate for current revenue?</label><select class="form-input" data-bind="biCoverage.adequate"><option value="">--</option><option value="yes"'+(state.biCoverage.adequate==='yes'?' selected':'')+'>Yes</option><option value="no"'+(state.biCoverage.adequate==='no'?' selected':'')+'>No</option><option value="unsure"'+(state.biCoverage.adequate==='unsure'?' selected':'')+'>Unsure</option></select></div>' +
    '<div class="form-group"><label class="form-label">Cyber events excluded?</label><select class="form-input" data-bind="biCoverage.cyberExcluded"><option value="">--</option><option value="yes"'+(state.biCoverage.cyberExcluded==='yes'?' selected':'')+'>Yes (gap)</option><option value="no"'+(state.biCoverage.cyberExcluded==='no'?' selected':'')+'>No (covered)</option></select></div>' +
    '<div class="form-group"><label class="form-label">Policy updated in past 12 months?</label><select class="form-input" data-bind="biCoverage.updated"><option value="">--</option><option value="yes"'+(state.biCoverage.updated==='yes'?' selected':'')+'>Yes</option><option value="no"'+(state.biCoverage.updated==='no'?' selected':'')+'>No</option></select></div></div></div>';
  if(state.biCoverage.hasBI==='no') html+='<div class="callout callout-danger"><strong>No BI insurance.</strong> Schedule a meeting with your broker. BI coverage is essential for transaction readiness.</div>';
  if(state.biCoverage.cyberExcluded==='yes') html+='<div class="callout callout-warning"><strong>Cyber exclusion.</strong> Standard BI excludes cyber events. You need separate cyber insurance for this coverage.</div>';
  html+=pn(true,'Continue','insurance');
  return html;
}

function rComm(){
  var html='<div class="page-header"><div class="t-label">Plan</div><div class="t-display">Crisis Communication Protocols</div><p class="t-body t-secondary">The absence of communication IS a communication -- it signals disarray. Pre-established protocols ensure consistent, timely messaging.</p></div>';
  html+='<div class="card"><table class="data-table"><thead><tr><th>Phase</th><th>Timing</th><th>Audience</th><th>Channel</th></tr></thead><tbody>' +
    '<tr><td><strong>Immediate</strong></td><td>0-2 hours</td><td>Crisis team</td><td>Phone/text tree</td></tr>' +
    '<tr><td><strong>Internal</strong></td><td>2-24 hours</td><td>All employees</td><td>Email + all-hands</td></tr>' +
    '<tr><td><strong>Key Stakeholders</strong></td><td>24-48 hours</td><td>Customers, vendors, lenders</td><td>Direct call + email</td></tr>' +
    '<tr><td><strong>Broader</strong></td><td>48-72 hours</td><td>Industry, media</td><td>Press release</td></tr>' +
    '<tr><td><strong>Ongoing</strong></td><td>Weekly</td><td>All stakeholders</td><td>Email + status page</td></tr>' +
    '</tbody></table></div>';
  html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Your Communication Plan</div>' +
    '<div class="form-group"><label class="form-label">Designated Spokesperson</label><input class="form-input" type="text" value="'+esc(state.commPlan.immediate)+'" data-bind="commPlan.immediate" placeholder="Name and role"></div>' +
    '<div class="form-group"><label class="form-label">Employee Communication Channel</label><input class="form-input" type="text" value="'+esc(state.commPlan.internal)+'" data-bind="commPlan.internal" placeholder="e.g., Slack #crisis + email blast"></div>' +
    '<div class="form-group"><label class="form-label">Stakeholder Contact List Location</label><input class="form-input" type="text" value="'+esc(state.commPlan.stakeholders)+'" data-bind="commPlan.stakeholders" placeholder="Where is the contact list stored?"></div></div>';
  html+='<div class="callout callout-info"><strong>Principles:</strong> Be transparent. One voice. Regular cadence. Empathy first. Never speculate. Communicate on schedule, even with no new information.</div>';
  html+=pn(true,'Continue','communication');
  return html;
}

function rTesting(){
  var testItems=['Document review: procedures reviewed for accuracy (quarterly)','Tabletop exercise: scenario walkthrough with crisis team (semi-annual)','Component test: individual system backup restoration (quarterly)','Simulation drill: full-scale disruption simulation (annual)','After-action review documented for last test/incident'];
  var html='<div class="page-header"><div class="t-label">Plan</div><div class="t-display">Testing, Training & Continuous Improvement</div><p class="t-body t-secondary">A plan that has never been tested is a plan that will fail when needed. Testing reveals gaps, training builds confidence.</p></div>';
  html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Testing Readiness Checklist</div><div class="checklist">';
  testItems.forEach(function(item,i){
    var key='tc_'+i;var checked=state.testingChecklist[key];
    html+='<div class="check-item'+(checked?' checked':'')+'" data-check="'+key+'" role="checkbox" aria-checked="'+!!checked+'" tabindex="0"><div class="check-box"><svg viewBox="0 0 14 14"><polyline points="2.5 7 5.5 10 11.5 4"/></svg></div><div class="check-text">'+item+'</div></div>';
  });
  html+='</div></div>';
  html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Continuous Improvement Cycle</div><ul style="margin-left:var(--space-lg);color:var(--color-text-secondary);font-size:14px;display:flex;flex-direction:column;gap:8px">' +
    '<li><strong>After-action review:</strong> After every test or incident, document lessons learned</li>' +
    '<li><strong>Update plans:</strong> Revise procedures, contact lists, resource requirements</li>' +
    '<li><strong>Retrain:</strong> Ensure all team members trained on updated procedures</li>' +
    '<li><strong>Retest:</strong> Schedule next test to verify improvements</li></ul></div>';
  html+='<div class="callout callout-accent"><strong>Documentation Test:</strong> Hand your recovery procedure to someone not involved in creating it. If they cannot complete recovery without asking questions, the procedure is inadequate.</div>';
  html+=pn(true,'View Dashboard','testing');
  return html;
}

function rDashboard(){
  var score=calcScore(),sc=getScoreColor(score),r=60,circ=2*Math.PI*r,offset=circ-(score/100)*circ;
  var html='<div class="page-header"><div class="t-label">Results</div><div class="t-display">BC/DR Readiness Dashboard</div></div>';
  html+='<div class="gauge-wrap"><div class="gauge-ring"><svg viewBox="0 0 160 160"><circle class="gauge-bg" cx="80" cy="80" r="'+r+'"/><circle class="gauge-fill" cx="80" cy="80" r="'+r+'" stroke="'+sc+'" stroke-dasharray="'+circ+'" stroke-dashoffset="'+offset+'"/></svg><div class="gauge-center"><div class="gauge-center-value" style="color:'+sc+'">'+score+'</div><div class="gauge-center-label">of 100</div></div></div></div>';

  var sysProtected=state.systems.filter(function(s){return s.status==='Protected';}).length;
  var extTotal=Object.values(state.externalScores).reduce(function(a,v){return a+v;},0);
  var itTotal=Object.values(state.itDrScores).reduce(function(a,v){return a+v;},0);
  var testDone=Object.keys(state.testingChecklist).filter(function(k){return state.testingChecklist[k];}).length;

  html+='<div class="summary-grid">' +
    '<div class="summary-item"><div class="summary-item-value">'+sysProtected+'/'+state.systems.length+'</div><div class="summary-item-label">Systems Protected</div></div>' +
    '<div class="summary-item"><div class="summary-item-value">'+extTotal+'/15</div><div class="summary-item-label">External Readiness</div></div>' +
    '<div class="summary-item"><div class="summary-item-value">'+itTotal+'/20</div><div class="summary-item-label">IT DR Score</div></div>' +
    '<div class="summary-item"><div class="summary-item-value">'+testDone+'/5</div><div class="summary-item-label">Tests Complete</div></div></div>';

  var cats=[
    {label:'System Readiness',score:Math.round(sysProtected*100/state.systems.length)},
    {label:'Key Person Backup',score:Math.round(state.keyPersons.filter(function(k){return k.docLevel>=3;}).length*100/state.keyPersons.length)},
    {label:'External Shocks',score:Math.round(extTotal*100/15)},
    {label:'IT DR',score:itTotal*5},
    {label:'BI Insurance',score:state.biCoverage.hasBI==='yes'&&state.biCoverage.adequate==='yes'?100:state.biCoverage.hasBI==='yes'?50:0},
    {label:'Testing',score:testDone*20}
  ];
  html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Readiness Breakdown</div><div class="bar-chart">';
  cats.forEach(function(c){var color=c.score>=70?'var(--color-success)':c.score>=40?'var(--color-warning)':'var(--color-danger)';html+='<div class="bar-row"><div class="bar-label">'+c.label+'</div><div class="bar-track"><div class="bar-fill" style="width:'+c.score+'%;background:'+color+'"><span class="bar-value">'+c.score+'%</span></div></div></div>';});
  html+='</div></div>';

  html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Recommendations</div>';
  if(sysProtected<state.systems.length) html+='<div class="callout callout-warning" style="margin-bottom:var(--space-sm)">'+(state.systems.length-sysProtected)+' critical system(s) not fully protected. Address backup and failover gaps.</div>';
  var highDep=state.keyPersons.filter(function(k){return k.dependency>=4&&k.docLevel<=2;});
  if(highDep.length>0) html+='<div class="callout callout-danger" style="margin-bottom:var(--space-sm)">'+highDep.length+' key role(s) with high dependency and low documentation. Cross-train and document immediately.</div>';
  if(state.biCoverage.hasBI!=='yes') html+='<div class="callout callout-danger" style="margin-bottom:var(--space-sm)">No business interruption insurance. This is a fundamental gap for transaction readiness.</div>';
  if(itTotal<12) html+='<div class="callout callout-warning" style="margin-bottom:var(--space-sm)">IT disaster recovery below standard. Prioritize backup testing and cybersecurity incident response planning.</div>';
  if(score>=70) html+='<div class="callout callout-info" style="background:var(--color-success-light);border-color:var(--color-success);color:var(--color-success)"><strong>Strong resilience.</strong> Your BC/DR preparation demonstrates operational maturity that buyers will value.</div>';
  html+='</div>';

  html+='<div style="display:flex;gap:var(--space-sm);flex-wrap:wrap;margin-top:var(--space-lg)"><button class="btn btn-primary" onclick="PB.exportResults()">Export Summary</button><button class="btn btn-secondary" onclick="window.print()">Print</button><button class="btn btn-ghost" onclick="PB.resetAll()" style="color:var(--color-danger)">Reset All Data</button></div>';
  html+='<div class="page-nav"><button class="btn btn-secondary" onclick="PB.prevPage()">&larr; Back</button><div></div></div>';
  return html;
}

function exportResults(){
  var score=calcScore();
  var text='PLAYBOOK #40: BUSINESS CONTINUITY & DISASTER RECOVERY\nGenerated: '+new Date().toLocaleDateString()+'\n'+'='.repeat(50)+'\n\n';
  text+='BC/DR READINESS SCORE: '+score+'/100\n\n';
  text+='SYSTEMS PROTECTED: '+state.systems.filter(function(s){return s.status==='Protected';}).length+'/'+state.systems.length+'\n';
  text+='IT DR SCORE: '+Object.values(state.itDrScores).reduce(function(a,v){return a+v;},0)+'/20\n';
  text+='EXTERNAL READINESS: '+Object.values(state.externalScores).reduce(function(a,v){return a+v;},0)+'/15\n';
  text+='BI INSURANCE: '+(state.biCoverage.hasBI==='yes'?'Yes':'No')+'\n';
  var blob=new Blob([text],{type:'text/plain'});var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download='playbook-40-business-continuity.txt';a.click();URL.revokeObjectURL(url);
}

function resetAll(){if(confirm('Erase all data?')){localStorage.removeItem(SK);state=defaultState();saveState();goToPage('welcome');}}

window.PB={
  prevPage:prevPage,completePage:completePage,exportResults:exportResults,resetAll:resetAll,
  setScore:function(sk,dk,val){
    if(sk==='externalScores'||sk==='itDrScores') state[sk][dk]=val;
    else if(sk==='dependency'||sk==='docLevel'){
      var idx=parseInt(dk.split('_').pop());state.keyPersons[idx][sk]=val;
    } else state[sk]=val;
    saveState();renderPage();
  }
};

renderNav();renderPage();updateProgress();updateScore();
})();
</script>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('embedded') === 'true') {
    // Hide playbook's own chrome
    var sidebar = document.querySelector('.sidebar');
    var overlay = document.querySelector('.sidebar-overlay');
    var mobileHeader = document.querySelector('.mobile-header');
    var mainContent = document.querySelector('.main-content');
    if (sidebar) sidebar.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    if (mobileHeader) mobileHeader.style.display = 'none';
    if (mainContent) {
      mainContent.style.marginLeft = '0';
      mainContent.style.minHeight = 'auto';
    }

    // Navigate to specific section if requested
    var section = params.get('section');
    if (section !== null) {
      var sectionIndex = parseInt(section, 10);
      if (typeof navigateToSection === 'function') {
        setTimeout(function() { navigateToSection(sectionIndex); }, 100);
      }
    }

    // Forward score updates to parent
    var origDispatch = window.dispatchEvent.bind(window);
    window.addEventListener('playbook:score-update', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:score-update',
          detail: e.detail
        }, '*');
      }
    });

    // Forward section changes to parent
    window.addEventListener('playbook:section-change', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:section-change',
          detail: e.detail
        }, '*');
      }
    });

    // Listen for commands from parent
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'navigate-section') {
        if (typeof navigateToSection === 'function') {
          navigateToSection(e.data.sectionIndex);
        }
      }
    });
  }
})();
</script>
</body>
</html>