<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working Capital Optimization | Exit Planning Playbook #9</title>
<style>
:root{--color-bg:#F5F5F7;--color-surface:#FFFFFF;--color-surface-alt:#F2F2F7;--color-border:#E5E7EB;--color-border-light:#F2F2F7;--color-text:#1D1D1F;--color-text-secondary:#6E6E73;--color-text-tertiary:#8E8E93;--color-primary:#0071E3;--color-primary-light:#EBF5FF;--color-primary-hover:#0051B3;--color-accent:#FF9500;--color-accent-light:#FFF6E8;--color-danger:#FF3B30;--color-danger-light:#FFEBEA;--color-warning:#C67F20;--color-warning-light:#FFF8EB;--color-success:#34C759;--color-success-light:#E8F8ED;--color-score-1:#FF3B30;--color-score-2:#FF9500;--color-score-3:#FFCC00;--color-score-4:#34C759;--color-score-5:#30D158;--radius-sm:6px;--radius-md:10px;--radius-lg:16px;--radius-xl:24px;--shadow-sm:0 1px 3px rgba(0,0,0,0.06);--shadow-md:0 4px 12px rgba(0,0,0,0.08);--shadow-lg:0 8px 30px rgba(0,0,0,0.1);--font-body:-apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display','Segoe UI',sans-serif;--font-display:-apple-system,BlinkMacSystemFont,'SF Pro Display','SF Pro Text','Segoe UI',sans-serif;--transition-fast:150ms ease;--transition-normal:250ms ease;--transition-slow:400ms cubic-bezier(0.16,1,0.3,1);--space-xs:4px;--space-sm:8px;--space-md:16px;--space-lg:24px;--space-xl:32px;--space-2xl:48px;--space-3xl:64px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}body{font-family:var(--font-body);font-size:16px;line-height:1.6;color:var(--color-text);background:var(--color-bg);-webkit-font-smoothing:antialiased;min-height:100vh}button{font-family:inherit;cursor:pointer;border:none;background:none}input,textarea,select{font-family:inherit;font-size:inherit}
a.skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;z-index:1000}a.skip-link:focus{position:fixed;top:10px;left:10px;width:auto;height:auto;padding:12px 20px;background:var(--color-primary);color:#fff;border-radius:var(--radius-sm);font-weight:600;z-index:1000}
.t-display{font-family:var(--font-display);font-size:clamp(26px,4vw,38px);font-weight:700;line-height:1.2;letter-spacing:-0.02em}.t-h1{font-family:var(--font-display);font-size:clamp(22px,3vw,30px);font-weight:700;line-height:1.25}.t-h2{font-size:20px;font-weight:600;line-height:1.3}.t-h3{font-size:16px;font-weight:600;line-height:1.4}.t-body{font-size:16px;line-height:1.6}.t-small{font-size:14px;line-height:1.5}.t-caption{font-size:12px;line-height:1.4;letter-spacing:0.02em}.t-label{font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--color-text-tertiary)}.t-secondary{color:var(--color-text-secondary)}
.app{display:flex;min-height:100vh}.sidebar{width:260px;min-width:260px;background:var(--color-text);color:#fff;padding:var(--space-lg);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform var(--transition-slow);overflow-y:auto}.main-content{flex:1;margin-left:260px;min-height:100vh}.content-area{max-width:800px;margin:0 auto;padding:var(--space-2xl) var(--space-lg)}
.mobile-header{display:none;position:sticky;top:0;z-index:90;background:var(--color-surface);border-bottom:1px solid var(--color-border);padding:var(--space-md) var(--space-lg);align-items:center;gap:var(--space-md)}.hamburger{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm)}.hamburger:hover{background:var(--color-surface-alt)}.hamburger span{display:block;width:18px;height:2px;background:var(--color-text);position:relative}.hamburger span::before,.hamburger span::after{content:'';position:absolute;width:18px;height:2px;background:var(--color-text);left:0}.hamburger span::before{top:-6px}.hamburger span::after{top:6px}.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:99}
@media(max-width:900px){.sidebar{transform:translateX(-260px)}.sidebar.open{transform:translateX(0)}.sidebar-overlay.show{display:block}.main-content{margin-left:0!important}.mobile-header{display:flex}.content-area{padding:var(--space-lg) var(--space-md)}}
.sidebar-brand{margin-bottom:var(--space-xl)}.sidebar-brand-label{font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:var(--space-xs)}.sidebar-brand-title{font-family:var(--font-display);font-size:18px;font-weight:700;color:#fff;line-height:1.3}
.sidebar-progress{margin-bottom:var(--space-xl);padding:var(--space-md);background:rgba(255,255,255,0.06);border-radius:var(--radius-md)}.sidebar-progress-label{font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:var(--space-sm)}.sidebar-progress-bar{height:4px;background:rgba(255,255,255,0.12);border-radius:2px;overflow:hidden}.sidebar-progress-fill{height:100%;background:var(--color-accent);border-radius:2px;transition:width var(--transition-slow)}.sidebar-progress-text{font-size:12px;color:rgba(255,255,255,0.5);margin-top:var(--space-sm);text-align:right}
.sidebar-nav{flex:1;display:flex;flex-direction:column;gap:2px}.nav-section-label{font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.3);padding:var(--space-md) var(--space-sm) var(--space-xs)}.nav-item{display:flex;align-items:center;gap:var(--space-md);padding:10px 12px;border-radius:var(--radius-sm);color:rgba(255,255,255,0.6);font-size:14px;transition:all var(--transition-fast);cursor:pointer}.nav-item:hover{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.85)}.nav-item.active{background:rgba(255,255,255,0.1);color:#fff;font-weight:500}.nav-item.completed .nav-check{display:flex}.nav-item.locked{opacity:0.35;cursor:default}.nav-item.locked:hover{background:none;color:rgba(255,255,255,0.35)}.nav-icon{width:20px;text-align:center;flex-shrink:0;font-size:14px}.nav-check{display:none;width:16px;height:16px;background:var(--color-success);border-radius:50%;align-items:center;justify-content:center;margin-left:auto;flex-shrink:0}.nav-check svg{width:10px;height:10px;stroke:#fff;stroke-width:2.5;fill:none}
.sidebar-score{margin-top:auto;padding-top:var(--space-lg);border-top:1px solid rgba(255,255,255,0.08)}.sidebar-score-label{font-size:11px;letter-spacing:0.06em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:var(--space-sm)}.sidebar-score-value{font-family:var(--font-display);font-size:36px;font-weight:700;color:#fff;line-height:1}.sidebar-score-max{font-size:18px;color:rgba(255,255,255,0.3);font-weight:400}.sidebar-score-desc{font-size:12px;color:rgba(255,255,255,0.4);margin-top:var(--space-xs)}
.sidebar-footer{margin-top:var(--space-lg);padding-top:var(--space-md);border-top:1px solid rgba(255,255,255,0.08);font-size:12px;color:rgba(255,255,255,0.3);display:flex;align-items:center;gap:6px}.sidebar-footer-dot{width:6px;height:6px;border-radius:50%;background:var(--color-success)}
.card{background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-lg);padding:var(--space-lg);transition:box-shadow var(--transition-normal);margin-bottom:var(--space-md)}.card:hover{box-shadow:var(--shadow-sm)}
.callout{padding:var(--space-md) var(--space-lg);border-radius:var(--radius-md);border-left:3px solid;font-size:14px;line-height:1.6;margin-bottom:var(--space-md)}.callout-info{background:var(--color-primary-light);border-color:var(--color-primary);color:var(--color-primary)}.callout-warning{background:var(--color-warning-light);border-color:var(--color-warning);color:#7C5A10}.callout-danger{background:var(--color-danger-light);border-color:var(--color-danger);color:var(--color-danger)}.callout-accent{background:var(--color-accent-light);border-color:var(--color-accent);color:#8B5A20}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--space-sm);padding:10px 20px;border-radius:var(--radius-sm);font-size:14px;font-weight:500;transition:all var(--transition-fast);white-space:nowrap}.btn-primary{background:var(--color-primary);color:#fff}.btn-primary:hover{background:var(--color-primary-hover);transform:translateY(-1px);box-shadow:var(--shadow-sm)}.btn-secondary{background:var(--color-surface);color:var(--color-text);border:1px solid var(--color-border)}.btn-secondary:hover{background:var(--color-surface-alt)}.btn-ghost{color:var(--color-text-secondary);padding:8px 12px}.btn-ghost:hover{background:var(--color-surface-alt);color:var(--color-text)}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:500}.badge-success{background:var(--color-success-light);color:var(--color-success)}.badge-warning{background:var(--color-warning-light);color:var(--color-warning)}.badge-danger{background:var(--color-danger-light);color:var(--color-danger)}.badge-neutral{background:var(--color-surface-alt);color:var(--color-text-secondary)}.badge-primary{background:var(--color-primary-light);color:var(--color-primary)}
.form-group{margin-bottom:var(--space-lg)}.form-label{display:block;font-size:14px;font-weight:500;margin-bottom:var(--space-sm)}.form-hint{font-size:13px;color:var(--color-text-tertiary);margin-top:var(--space-xs)}.form-input{width:100%;padding:10px 14px;border:1px solid var(--color-border);border-radius:var(--radius-sm);font-size:15px;background:var(--color-surface);transition:all var(--transition-fast);color:var(--color-text)}.form-input:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 3px var(--color-primary-light)}textarea.form-input{min-height:80px;resize:vertical;line-height:1.5}select.form-input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 5l3 3 3-3' stroke='%236E6E73' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
.score-selector{display:flex;gap:var(--space-sm)}.score-option{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 8px;border:2px solid var(--color-border);border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition-fast);text-align:center}.score-option:hover{border-color:var(--color-text-tertiary);background:var(--color-surface-alt)}.score-option.selected{border-color:var(--color-primary);background:var(--color-primary-light)}.score-option input[type="radio"]{position:absolute;opacity:0;width:0;height:0}.score-number{font-size:22px;font-weight:700;line-height:1}.score-label-text{font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:0.04em;color:var(--color-text-secondary);line-height:1.2}.score-option.s1 .score-number{color:var(--color-score-1)}.score-option.s2 .score-number{color:var(--color-score-2)}.score-option.s3 .score-number{color:var(--color-score-3)}.score-option.s4 .score-number{color:var(--color-score-4)}.score-option.s5 .score-number{color:var(--color-score-5)}.score-option.selected.s1{border-color:var(--color-score-1);background:#FFF5F5}.score-option.selected.s2{border-color:var(--color-score-2);background:#FFFBEB}.score-option.selected.s3{border-color:var(--color-score-3);background:#FFF8EB}.score-option.selected.s4{border-color:var(--color-score-4);background:#E8F8EE}.score-option.selected.s5{border-color:var(--color-score-5);background:#E0F5E8}
@media(max-width:600px){.score-selector{gap:4px}.score-option{padding:10px 4px}.score-number{font-size:18px}.score-label-text{font-size:9px}}
.checklist{display:flex;flex-direction:column;gap:2px}.check-item{display:flex;align-items:flex-start;gap:var(--space-md);padding:var(--space-md);border-radius:var(--radius-sm);cursor:pointer;transition:background var(--transition-fast)}.check-item:hover{background:var(--color-surface-alt)}.check-box{width:22px;height:22px;border:2px solid var(--color-border);border-radius:4px;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all var(--transition-fast);margin-top:1px}.check-item.checked .check-box{background:var(--color-primary);border-color:var(--color-primary)}.check-item.checked .check-box svg{opacity:1}.check-box svg{width:14px;height:14px;stroke:#fff;stroke-width:2.5;fill:none;opacity:0}.check-text{font-size:14px;line-height:1.5}.check-item.checked .check-text{color:var(--color-text-tertiary);text-decoration:line-through}
.page{display:none;animation:fadeIn 0.3s ease}.page.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.page-header{margin-bottom:var(--space-2xl)}.page-header .t-label{margin-bottom:var(--space-sm)}.page-header .t-display{margin-bottom:var(--space-md)}.page-header .t-body{color:var(--color-text-secondary);max-width:600px}
.page-nav{display:flex;justify-content:space-between;align-items:center;margin-top:var(--space-2xl);padding-top:var(--space-xl);border-top:1px solid var(--color-border)}
.welcome-hero{text-align:center;padding:var(--space-3xl) var(--space-lg);max-width:640px;margin:0 auto}.welcome-icon{width:72px;height:72px;background:var(--color-primary-light);border-radius:var(--radius-xl);display:flex;align-items:center;justify-content:center;margin:0 auto var(--space-lg);font-size:32px}.welcome-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-md);margin:var(--space-2xl) 0;text-align:center}.welcome-stat{padding:var(--space-lg);background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-md)}.welcome-stat-value{font-family:var(--font-display);font-size:28px;font-weight:700;color:var(--color-primary)}.welcome-stat-label{font-size:13px;color:var(--color-text-secondary);margin-top:4px}
@media(max-width:600px){.welcome-stats{grid-template-columns:1fr}.welcome-hero{padding:var(--space-2xl) var(--space-md)}}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:var(--space-md);margin-bottom:var(--space-lg)}.summary-item{padding:var(--space-lg);background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-md);text-align:center}.summary-item-value{font-family:var(--font-display);font-size:28px;font-weight:700}.summary-item-label{font-size:12px;color:var(--color-text-tertiary);text-transform:uppercase;letter-spacing:0.04em;margin-top:var(--space-xs)}
.bar-chart{display:flex;flex-direction:column;gap:var(--space-md)}.bar-row{display:flex;align-items:center;gap:var(--space-md)}.bar-label{width:140px;flex-shrink:0;font-size:13px;color:var(--color-text-secondary);text-align:right}.bar-track{flex:1;height:24px;background:var(--color-surface-alt);border-radius:4px;overflow:hidden}.bar-fill{height:100%;border-radius:4px;transition:width 0.8s cubic-bezier(0.16,1,0.3,1);display:flex;align-items:center;justify-content:flex-end;padding-right:8px}.bar-value{font-size:12px;font-weight:600;color:#fff}@media(max-width:600px){.bar-label{width:90px;font-size:11px}}
.data-table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px;margin-bottom:var(--space-md)}.data-table th{text-align:left;padding:var(--space-sm) var(--space-md);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--color-text-tertiary);border-bottom:2px solid var(--color-border)}.data-table td{padding:var(--space-sm) var(--space-md);border-bottom:1px solid var(--color-border-light);vertical-align:top}.data-table tr:last-child td{border-bottom:none}.data-table input{width:100%;padding:6px 10px;border:1px solid var(--color-border);border-radius:var(--radius-sm);font-size:13px;font-family:inherit;background:var(--color-surface)}.data-table input:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 2px var(--color-primary-light)}
.gauge-wrap{display:flex;justify-content:center;margin:var(--space-lg) 0}.gauge-ring{position:relative;width:160px;height:160px}.gauge-ring svg{width:160px;height:160px;transform:rotate(-90deg)}.gauge-ring circle{fill:none;stroke-width:8;stroke-linecap:round}.gauge-bg{stroke:var(--color-border)}.gauge-fill{transition:stroke-dashoffset 1s ease}.gauge-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}.gauge-center-value{font-family:var(--font-display);font-size:36px;font-weight:700;line-height:1}.gauge-center-label{font-size:12px;color:var(--color-text-tertiary);margin-top:4px}
.formula-box{background:var(--color-text);color:#fff;border-radius:var(--radius-md);padding:var(--space-lg);margin-bottom:var(--space-md);font-family:var(--font-display);text-align:center}.formula-box .formula{font-size:18px;font-weight:700;margin-bottom:8px}.formula-box .formula-desc{font-size:13px;color:rgba(255,255,255,0.6);font-family:var(--font-body)}
@media print{.sidebar,.mobile-header,.page-nav,.sidebar-overlay{display:none!important}.main-content{margin-left:0!important}.page{display:block!important;page-break-inside:avoid;margin-bottom:24px}}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:0.01ms!important;transition-duration:0.01ms!important}}
:focus-visible{outline:2px solid var(--color-primary);outline-offset:2px}
</style>
</head>
<body>
<a href="#contentArea" class="skip-link">Skip to content</a>
<div class="app">
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Playbook navigation">
    <div class="sidebar-brand"><div class="sidebar-brand-label">Exit Planning Playbook #9</div><div class="sidebar-brand-title">Working Capital Optimization</div></div>
    <div class="sidebar-progress"><div class="sidebar-progress-label">Your Progress</div><div class="sidebar-progress-bar"><div class="sidebar-progress-fill" id="progressFill" style="width:0%"></div></div><div class="sidebar-progress-text" id="progressText">0% complete</div></div>
    <nav class="sidebar-nav" id="sidebarNav"></nav>
    <div class="sidebar-score"><div class="sidebar-score-label">WC Readiness</div><div class="sidebar-score-value" id="sidebarScore">--<span class="sidebar-score-max">/100</span></div><div class="sidebar-score-desc" id="sidebarScoreDesc">Complete sections to build your score</div></div>
    <div class="sidebar-footer"><div class="sidebar-footer-dot"></div>Auto-saved locally</div>
  </aside>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <div class="main-content">
    <div class="mobile-header"><button class="hamburger" id="hamburgerBtn" aria-label="Toggle navigation"><span></span></button><div style="flex:1"><strong style="font-size:15px;">Working Capital</strong></div><div class="badge badge-primary" id="mobileScore">--/100</div></div>
    <main class="content-area" id="contentArea" role="main"></main>
  </div>
</div>
<script>
(function(){
'use strict';
var STORAGE_KEY='exitosx-pb09-working-capital';
var PAGES=[
  {id:'welcome',title:'Welcome',phase:'START',icon:'1'},
  {id:'fundamentals',title:'WC Fundamentals',phase:'UNDERSTAND',icon:'2'},
  {id:'why-buyers-care',title:'Why Buyers Care',phase:'UNDERSTAND',icon:'3'},
  {id:'calculate',title:'Calculate Your NWC',phase:'ASSESS',icon:'4'},
  {id:'peg',title:'The Working Capital Peg',phase:'ASSESS',icon:'5'},
  {id:'optimization',title:'Optimization Strategies',phase:'OPTIMIZE',icon:'6'},
  {id:'ar',title:'Accounts Receivable',phase:'OPTIMIZE',icon:'7'},
  {id:'inventory',title:'Inventory',phase:'OPTIMIZE',icon:'8'},
  {id:'ap',title:'Accounts Payable',phase:'OPTIMIZE',icon:'9'},
  {id:'mistakes',title:'Common Mistakes',phase:'PLAN',icon:'10'},
  {id:'dashboard',title:'Dashboard',phase:'RESULTS',icon:'11'}
];
function defaultState(){return{currentPage:'welcome',completed:{},nwcData:[{month:'Current',ar:'',inventory:'',prepaid:'',otherCA:'',ap:'',accrued:'',deferred:'',otherCL:''},{month:'Month -1',ar:'',inventory:'',prepaid:'',otherCA:'',ap:'',accrued:'',deferred:'',otherCL:''},{month:'Month -2',ar:'',inventory:'',prepaid:'',otherCA:'',ap:'',accrued:'',deferred:'',otherCL:''}],annualRevenue:'',cogs:'',dso:0,dio:0,dpo:0,arScores:{terms:0,collection:0,aging:0,writeoffs:0},invScores:{accuracy:0,velocity:0,obsolete:0,reorder:0},apScores:{terms:0,timing:0,discounts:0,relationships:0},mistakeFlags:{},optimizationChecks:{}};}
var state=loadState();
function loadState(){try{var s=localStorage.getItem(STORAGE_KEY);return s?Object.assign(defaultState(),JSON.parse(s)):defaultState();}catch(e){return defaultState();}}
function saveState(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}catch(e){}updateProgress();updateScore();}
function calcNWC(row){var ca=(p(row.ar)+p(row.inventory)+p(row.prepaid)+p(row.otherCA));var cl=(p(row.ap)+p(row.accrued)+p(row.deferred)+p(row.otherCL));return ca-cl;}
function p(v){return parseFloat(v)||0;}
function calcCCC(){var rev=p(state.annualRevenue);var cogs_v=p(state.cogs);var row=state.nwcData[0];var dso=rev>0?Math.round((p(row.ar)/(rev/365))):0;var dio=cogs_v>0?Math.round((p(row.inventory)/(cogs_v/365))):0;var dpo=cogs_v>0?Math.round((p(row.ap)/(cogs_v/365))):0;return{dso:dso,dio:dio,dpo:dpo,ccc:dso+dio-dpo};}
function calcScore(){var score=0;
var nwcFilled=state.nwcData[0].ar||state.nwcData[0].ap?1:0;score+=nwcFilled*15;
var ccc=calcCCC();if(ccc.dso>0){if(ccc.dso<=30)score+=10;else if(ccc.dso<=45)score+=7;else if(ccc.dso<=60)score+=4;else score+=1;}
var arTotal=Object.values(state.arScores).reduce(function(a,v){return a+v;},0);score+=Math.round((arTotal/20)*25);
var invTotal=Object.values(state.invScores).reduce(function(a,v){return a+v;},0);score+=Math.round((invTotal/20)*20);
var apTotal=Object.values(state.apScores).reduce(function(a,v){return a+v;},0);score+=Math.round((apTotal/20)*15);
var optChecks=Object.values(state.optimizationChecks).filter(Boolean).length;score+=Math.round((optChecks/6)*15);
return Math.min(Math.round(score),100);}
function getScoreColor(s){if(s>=81)return'var(--color-score-5)';if(s>=61)return'var(--color-score-4)';if(s>=41)return'var(--color-score-3)';if(s>=21)return'var(--color-score-2)';return'var(--color-score-1)';}
function getScoreLabel(s){if(s>=81)return'Excellent WC management';if(s>=61)return'Strong foundation';if(s>=41)return'Moderate -- key gaps remain';if(s>=21)return'Significant work needed';return'Complete sections to build score';}
function updateScore(){var s=calcScore();document.getElementById('sidebarScore').innerHTML=s+'<span class="sidebar-score-max">/100</span>';document.getElementById('mobileScore').textContent=s+'/100';document.getElementById('sidebarScoreDesc').textContent=getScoreLabel(s);}
function updateProgress(){var total=PAGES.length-2;var done=Object.keys(state.completed).length;var pct=Math.round((done/total)*100);document.getElementById('progressFill').style.width=pct+'%';document.getElementById('progressText').textContent=pct+'% complete';}
function isUnlocked(id){var idx=PAGES.findIndex(function(p){return p.id===id;});if(idx<=0)return true;return state.completed[PAGES[idx-1].id]===true;}
function renderNav(){var nav=document.getElementById('sidebarNav');var html='';var lastPhase='';PAGES.forEach(function(pg){if(pg.phase!==lastPhase){html+='<div class="nav-section-label">'+pg.phase+'</div>';lastPhase=pg.phase;}var isActive=state.currentPage===pg.id;var isDone=state.completed[pg.id];var locked=!isUnlocked(pg.id);html+='<div class="nav-item'+(isActive?' active':'')+(isDone?' completed':'')+(locked?' locked':'')+'" data-page="'+pg.id+'" role="button" tabindex="'+(locked?'-1':'0')+'">';html+='<span class="nav-icon">'+pg.icon+'</span><span>'+pg.title+'</span>';if(isDone)html+='<span class="nav-check"><svg viewBox="0 0 10 10"><polyline points="1.5 5 4 7.5 8.5 2.5"/></svg></span>';html+='</div>';});nav.innerHTML=html;nav.querySelectorAll('.nav-item:not(.locked)').forEach(function(el){el.addEventListener('click',function(){goToPage(el.dataset.page);});el.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();goToPage(el.dataset.page);}});});}
function goToPage(id){if(!isUnlocked(id))return;state.currentPage=id;saveState();renderPage();renderNav();window.scrollTo({top:0,behavior:'smooth'});closeSidebar();}
function completePage(id){state.completed[id]=true;var idx=PAGES.findIndex(function(pg){return pg.id===id;});if(idx<PAGES.length-1)state.currentPage=PAGES[idx+1].id;saveState();renderPage();renderNav();window.scrollTo({top:0,behavior:'smooth'});}
function prevPage(){var idx=PAGES.findIndex(function(pg){return pg.id===state.currentPage;});if(idx>0)goToPage(PAGES[idx-1].id);}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('show');}
document.getElementById('hamburgerBtn').addEventListener('click',toggleSidebar);
document.getElementById('sidebarOverlay').addEventListener('click',closeSidebar);
function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function fmt(n){if(!n&&n!==0)return'--';n=parseFloat(n);if(isNaN(n))return'--';if(Math.abs(n)>=1000000)return'$'+(n/1000000).toFixed(1)+'M';if(Math.abs(n)>=1000)return'$'+(n/1000).toFixed(0)+'K';return'$'+n.toLocaleString();}
function pageNav(showPrev,nextLabel,currentId){var h='<div class="page-nav">';h+=showPrev?'<button class="btn btn-secondary" onclick="PB.prevPage()">&larr; Back</button>':'<div></div>';if(nextLabel!==false)h+='<button class="btn btn-primary" onclick="PB.completePage(\''+currentId+'\')">'+( nextLabel||'Continue')+' &rarr;</button>';h+='</div>';return h;}
function scoreSelector(objName,key,labels){var current=0;if(objName==='arScores')current=state.arScores[key]||0;else if(objName==='invScores')current=state.invScores[key]||0;else if(objName==='apScores')current=state.apScores[key]||0;var html='<div class="score-selector" role="radiogroup">';for(var i=1;i<=5;i++){var sel=current===i?' selected':'';html+='<label class="score-option s'+i+sel+'" onclick="PB.setScore(\''+objName+'\',\''+key+'\','+i+')" tabindex="0" role="radio" aria-checked="'+(current===i)+'" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();PB.setScore(\''+objName+'\',\''+key+'\','+i+');}">';html+='<input type="radio" name="score-'+objName+'-'+key+'" value="'+i+'"'+(current===i?' checked':'')+'>'; html+='<span class="score-number">'+i+'</span><span class="score-label-text">'+(labels?labels[i-1]:['Poor','Below Avg','Average','Good','Excellent'][i-1])+'</span></label>';}html+='</div>';return html;}
function renderPage(){var area=document.getElementById('contentArea');var R={welcome:rWelcome,fundamentals:rFundamentals,'why-buyers-care':rWhyBuyersCare,calculate:rCalculate,peg:rPeg,optimization:rOptimization,ar:rAR,inventory:rInventory,ap:rAP,mistakes:rMistakes,dashboard:rDashboard};var fn=R[state.currentPage];area.innerHTML='<div class="page active">'+(fn?fn():'')+'</div>';bindInputs();}
function bindInputs(){document.querySelectorAll('[data-bind]').forEach(function(el){var keys=el.dataset.bind.split('.');var handler=function(){var obj=state;for(var i=0;i<keys.length-1;i++){if(keys[i].match(/^\d+$/))obj=obj[parseInt(keys[i])];else obj=obj[keys[i]];}obj[keys[keys.length-1]]=el.value;saveState();};el.addEventListener('input',handler);el.addEventListener('change',handler);});document.querySelectorAll('.check-item').forEach(function(el){var handler=function(){var key=el.dataset.check;if(key.startsWith('opt_'))state.optimizationChecks[key]=!state.optimizationChecks[key];else state.mistakeFlags[key]=!state.mistakeFlags[key];saveState();renderPage();};el.addEventListener('click',handler);el.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();handler();}});});}
function rWelcome(){return'<div class="welcome-hero"><div class="welcome-icon">&#128176;</div><div class="t-display">Working Capital Optimization</div><p class="t-body t-secondary" style="margin-top:var(--space-md)">Working capital is one of the least understood and most costly elements of a business sale. Optimize it before a buyer pegs it against you.</p><div class="welcome-stats"><div class="welcome-stat"><div class="welcome-stat-value">$1:$1</div><div class="welcome-stat-label">Dollar-for-dollar purchase price adjustment</div></div><div class="welcome-stat"><div class="welcome-stat-value">12 mo</div><div class="welcome-stat-label">Trailing average used for the peg</div></div><div class="welcome-stat"><div class="welcome-stat-value">3</div><div class="welcome-stat-label">Components of the cash conversion cycle</div></div></div><div class="callout callout-accent" style="text-align:left"><strong>The Core Principle:</strong> Working capital is the business\'s money. But how you manage it in the 12-24 months before close determines where the peg gets set, and that peg directly affects your take-home proceeds.</div></div>'+pageNav(false,'Begin Assessment','welcome');}
function rFundamentals(){return'<div class="page-header"><div class="t-label">Understanding</div><div class="t-display">Working Capital Fundamentals</div><p class="t-body t-secondary">Understanding the components and dynamics of working capital is essential before you can optimize it.</p></div><div class="formula-box"><div class="formula">NWC = Current Assets - Current Liabilities</div><div class="formula-desc">Current Assets: Cash, AR, Inventory, Prepaids | Current Liabilities: AP, Accrued, Deferred Rev, Current Debt</div></div><div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">The Cash Conversion Cycle</div><table class="data-table"><thead><tr><th>Component</th><th>Formula</th><th>What It Measures</th></tr></thead><tbody><tr><td><strong>Days Sales Outstanding (DSO)</strong></td><td>AR / (Revenue / 365)</td><td>How fast you collect from customers</td></tr><tr><td><strong>Days Inventory Outstanding (DIO)</strong></td><td>Inventory / (COGS / 365)</td><td>How long inventory sits before sale</td></tr><tr><td><strong>Days Payable Outstanding (DPO)</strong></td><td>AP / (COGS / 365)</td><td>How long you take to pay vendors</td></tr><tr><td style="font-weight:700;color:var(--color-primary)">Cash Conversion Cycle</td><td style="font-weight:600">DSO + DIO - DPO</td><td>Days of cash tied up in operations</td></tr></tbody></table></div><div class="callout callout-info"><strong>Goal:</strong> Minimize your CCC. A lower CCC means less cash tied up in operations, which means a leaner working capital requirement and a lower peg.</div>'+pageNav(true,'Continue','fundamentals');}
function rWhyBuyersCare(){return'<div class="page-header"><div class="t-label">Understanding</div><div class="t-display">Why Buyers Care About Working Capital</div><p class="t-body t-secondary">The buyer expects to acquire a business that comes with enough working capital to continue normal operations.</p></div><div class="card"><p class="t-body t-secondary">If you drain working capital before close -- by collecting receivables aggressively, delaying purchases, or drawing down inventory -- the buyer pays less or demands a true-up.</p><p class="t-body t-secondary" style="margin-top:var(--space-md)">The working capital peg mechanism catches manipulation. Buyers and their Quality of Earnings advisors will analyze your NWC trends and normalize for any unusual patterns.</p></div><div class="callout callout-danger"><strong>The Trap:</strong> If your NWC has been trending up because of poor AR collection, you will get a higher peg -- which means you need to deliver more working capital at close or face a dollar-for-dollar price reduction.</div><div class="card"><div class="t-h3">How the Peg Works</div><table class="data-table" style="margin-top:var(--space-md)"><thead><tr><th>Scenario</th><th>Impact</th></tr></thead><tbody><tr><td>NWC at closing <strong>&gt;</strong> Peg</td><td style="color:var(--color-success);font-weight:600">You receive the excess as additional purchase price</td></tr><tr><td>NWC at closing <strong>&lt;</strong> Peg</td><td style="color:var(--color-danger);font-weight:600">Purchase price is reduced dollar-for-dollar</td></tr><tr><td>NWC at closing <strong>=</strong> Peg</td><td>No adjustment</td></tr></tbody></table></div>'+pageNav(true,'Continue','why-buyers-care');}
function rCalculate(){var rows=state.nwcData;var html='<div class="page-header"><div class="t-label">Assessment</div><div class="t-display">Calculate Your NWC</div><p class="t-body t-secondary">Enter your current and recent monthly balance sheet data. Also enter annual revenue and COGS for CCC calculation.</p></div>';html+='<div class="card" style="margin-bottom:var(--space-md)"><div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-md)"><div class="form-group" style="margin:0"><label class="form-label">Annual Revenue</label><input class="form-input" type="number" min="0" placeholder="$0" value="'+esc(state.annualRevenue)+'" data-bind="annualRevenue"></div><div class="form-group" style="margin:0"><label class="form-label">Annual COGS</label><input class="form-input" type="number" min="0" placeholder="$0" value="'+esc(state.cogs)+'" data-bind="cogs"></div></div></div>';html+='<div class="card" style="overflow-x:auto"><table class="data-table"><thead><tr><th>Line Item</th>';rows.forEach(function(r){html+='<th>'+r.month+'</th>';});html+='<th>NWC</th></tr></thead><tbody>';var caItems=[{key:'ar',label:'Accounts Receivable'},{key:'inventory',label:'Inventory'},{key:'prepaid',label:'Prepaid Expenses'},{key:'otherCA',label:'Other Current Assets'}];var clItems=[{key:'ap',label:'Accounts Payable'},{key:'accrued',label:'Accrued Expenses'},{key:'deferred',label:'Deferred Revenue'},{key:'otherCL',label:'Other Current Liabilities'}];
html+='<tr><td colspan="'+(rows.length+2)+'" style="font-weight:600;background:var(--color-surface-alt);color:var(--color-primary)">Current Assets</td></tr>';caItems.forEach(function(item){html+='<tr><td style="font-weight:500">'+item.label+'</td>';rows.forEach(function(r,i){html+='<td><input type="number" min="0" placeholder="$0" value="'+esc(r[item.key])+'" data-bind="nwcData.'+i+'.'+item.key+'"></td>';});html+='<td></td></tr>';});html+='<tr style="font-weight:600;background:var(--color-surface-alt)"><td>TOTAL CURRENT ASSETS</td>';rows.forEach(function(r){var ca=p(r.ar)+p(r.inventory)+p(r.prepaid)+p(r.otherCA);html+='<td>'+fmt(ca)+'</td>';});html+='<td></td></tr>';
html+='<tr><td colspan="'+(rows.length+2)+'" style="font-weight:600;background:var(--color-surface-alt);color:var(--color-danger)">Current Liabilities</td></tr>';clItems.forEach(function(item){html+='<tr><td style="font-weight:500">'+item.label+'</td>';rows.forEach(function(r,i){html+='<td><input type="number" min="0" placeholder="$0" value="'+esc(r[item.key])+'" data-bind="nwcData.'+i+'.'+item.key+'"></td>';});html+='<td></td></tr>';});html+='<tr style="font-weight:600;background:var(--color-surface-alt)"><td>TOTAL CURRENT LIABILITIES</td>';rows.forEach(function(r){var cl=p(r.ap)+p(r.accrued)+p(r.deferred)+p(r.otherCL);html+='<td>'+fmt(cl)+'</td>';});html+='<td></td></tr>';
html+='<tr style="font-weight:700;border-top:2px solid var(--color-border)"><td style="color:var(--color-primary)">NET WORKING CAPITAL</td>';rows.forEach(function(r){var nwc=calcNWC(r);var color=nwc>=0?'var(--color-success)':'var(--color-danger)';html+='<td style="color:'+color+';font-weight:700">'+fmt(nwc)+'</td>';});var avgNWC=rows.reduce(function(a,r){return a+calcNWC(r);},0)/rows.length;html+='<td style="font-weight:700;color:var(--color-primary)">'+fmt(avgNWC)+'<br><span style="font-size:11px;color:var(--color-text-tertiary);font-weight:400">3-mo avg</span></td></tr>';html+='</tbody></table></div>';
var ccc=calcCCC();if(ccc.dso>0||ccc.dio>0||ccc.dpo>0){html+='<div class="summary-grid"><div class="summary-item"><div class="summary-item-value" style="color:'+(ccc.dso<=45?'var(--color-success)':'var(--color-warning)')+'">'+ccc.dso+'</div><div class="summary-item-label">DSO (Days)</div></div><div class="summary-item"><div class="summary-item-value">'+ccc.dio+'</div><div class="summary-item-label">DIO (Days)</div></div><div class="summary-item"><div class="summary-item-value">'+ccc.dpo+'</div><div class="summary-item-label">DPO (Days)</div></div><div class="summary-item"><div class="summary-item-value" style="color:'+(ccc.ccc<=30?'var(--color-score-5)':ccc.ccc<=60?'var(--color-score-3)':'var(--color-score-1)')+'">'+ccc.ccc+'</div><div class="summary-item-label">CCC (Days)</div></div></div>';}
html+=pageNav(true,'Continue','calculate');return html;}
function rPeg(){var avgNWC=state.nwcData.reduce(function(a,r){return a+calcNWC(r);},0)/state.nwcData.length;return'<div class="page-header"><div class="t-label">Assessment</div><div class="t-display">The Working Capital Peg</div><p class="t-body t-secondary">In most transactions, the buyer and seller agree on a "target" or "peg" for net working capital at closing.</p></div><div class="formula-box"><div class="formula">Peg = Trailing 12-Month Average NWC</div><div class="formula-desc">(excluding cash and debt)</div></div><div class="card"><div class="t-h3">Your Estimated Peg (Based on 3-Month Average)</div><div style="text-align:center;padding:var(--space-lg)"><div style="font-family:var(--font-display);font-size:48px;font-weight:700;color:var(--color-primary)">'+fmt(avgNWC)+'</div><p class="t-small t-secondary" style="margin-top:8px">Based on the data you entered. A full 12-month average will be more accurate.</p></div></div><div class="callout callout-accent"><strong>Key Insight:</strong> The peg negotiation is one of the most consequential financial discussions in the deal. If your NWC has been trending up because of poor AR collection, you will get a higher peg -- which means you need to deliver more working capital at close or face a price reduction.</div><div class="card"><div class="t-h3">Peg Scenarios</div><table class="data-table" style="margin-top:var(--space-md)"><thead><tr><th>NWC at Closing</th><th>vs Peg</th><th>Impact on You</th></tr></thead><tbody><tr><td>'+fmt(avgNWC*1.15)+'</td><td style="color:var(--color-success)">+15% above peg</td><td style="color:var(--color-success)">You receive ~'+fmt(avgNWC*0.15)+' additional</td></tr><tr><td>'+fmt(avgNWC)+'</td><td>At peg</td><td>No adjustment</td></tr><tr><td>'+fmt(avgNWC*0.85)+'</td><td style="color:var(--color-danger)">-15% below peg</td><td style="color:var(--color-danger)">Price reduced by ~'+fmt(avgNWC*0.15)+'</td></tr></tbody></table></div>'+pageNav(true,'Continue','peg');}
function rOptimization(){var checks=['Run a lean, consistent WC cycle for 12+ months before close','Calculate and track NWC monthly starting 18+ months pre-sale','Negotiate seasonally-adjusted peg methodology if applicable','Optimize AR collection without appearing manipulative','Clear obsolete inventory and write off uncollectables','Take full advantage of vendor payment terms'];var html='<div class="page-header"><div class="t-label">Optimize</div><div class="t-display">Optimization Strategies</div><p class="t-body t-secondary">The goal is to run a lean, efficient working capital cycle consistently -- not just in the months before closing.</p></div><div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Working Capital Optimization Checklist</div><div class="checklist">';checks.forEach(function(c,i){var checked=state.optimizationChecks['opt_'+i];html+='<div class="check-item'+(checked?' checked':'')+'" data-check="opt_'+i+'" role="checkbox" aria-checked="'+!!checked+'" tabindex="0"><div class="check-box"><svg viewBox="0 0 14 14"><polyline points="2.5 7 5.5 10 11.5 4"/></svg></div><div class="check-text">'+c+'</div></div>';});html+='</div></div>';html+='<div class="callout callout-info"><strong>Strategy overview:</strong> Reduce DSO (tighten collections), reduce DIO (lean inventory), optimize DPO (use full payment terms). Do this consistently for 12+ months so the peg reflects efficient operations.</div>';html+=pageNav(true,'Continue','optimization');return html;}
function rAR(){var dims=[{key:'terms',label:'Payment Terms',hint:'Are terms clear, consistent, and competitive?'},{key:'collection',label:'Collection Process',hint:'Is there a systematic follow-up process for overdue invoices?'},{key:'aging',label:'AR Aging',hint:'What percentage of AR is past due?'},{key:'writeoffs',label:'Write-Off Discipline',hint:'Are uncollectable accounts written off promptly?'}];var html='<div class="page-header"><div class="t-label">Optimize</div><div class="t-display">Accounts Receivable Management</div><p class="t-body t-secondary">DSO is the most impactful working capital lever. Score your AR management practices.</p></div>';html+='<div class="card"><table class="data-table"><thead><tr><th>DSO Range</th><th>Assessment</th><th>Action</th></tr></thead><tbody><tr><td style="color:var(--color-score-5);font-weight:600">Under 30 days</td><td>Excellent</td><td>Maintain; this is a selling point</td></tr><tr><td style="color:var(--color-score-4)">30-45 days</td><td>Good</td><td>Minor improvements possible</td></tr><tr><td style="color:var(--color-score-3)">45-60 days</td><td>Needs attention</td><td>Tighten terms; implement follow-up</td></tr><tr><td style="color:var(--color-score-2)">60-90 days</td><td>Problem</td><td>Aggressive collections; consider factoring</td></tr><tr><td style="color:var(--color-score-1)">Over 90 days</td><td>Critical</td><td>Write off uncollectables; overhaul credit policy</td></tr></tbody></table></div>';dims.forEach(function(d){html+='<div class="card"><div class="form-label">'+d.label+'</div><div class="form-hint" style="margin-bottom:var(--space-sm)">'+d.hint+'</div>'+scoreSelector('arScores',d.key)+'</div>';});html+=pageNav(true,'Continue','ar');return html;}
function rInventory(){var dims=[{key:'accuracy',label:'Inventory Accuracy',hint:'Do you conduct regular cycle counts or physical inventory?'},{key:'velocity',label:'Velocity Classification',hint:'Have you classified inventory by velocity (A/B/C)?'},{key:'obsolete',label:'Obsolete Stock Management',hint:'Is slow-moving and obsolete inventory identified and liquidated?'},{key:'reorder',label:'Reorder Optimization',hint:'Are reorder points and economic order quantities implemented?'}];var html='<div class="page-header"><div class="t-label">Optimize</div><div class="t-display">Inventory Optimization</div><p class="t-body t-secondary">Inventory optimization reduces DIO and frees cash. Score your inventory management practices.</p></div>';html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Inventory Optimization Steps</div><ul style="margin-left:var(--space-lg);color:var(--color-text-secondary);font-size:14px"><li>Count it accurately (cycle counts or full physical inventory)</li><li>Classify by velocity: A (fast), B (moderate), C (slow/obsolete)</li><li>Write off or liquidate C-category inventory</li><li>Implement reorder points and economic order quantities</li><li>Reduce lead times through vendor negotiation</li></ul></div>';dims.forEach(function(d){html+='<div class="card"><div class="form-label">'+d.label+'</div><div class="form-hint" style="margin-bottom:var(--space-sm)">'+d.hint+'</div>'+scoreSelector('invScores',d.key)+'</div>';});html+=pageNav(true,'Continue','inventory');return html;}
function rAP(){var dims=[{key:'terms',label:'Payment Terms Utilization',hint:'Are you taking full advantage of vendor payment terms?'},{key:'timing',label:'Payment Timing Discipline',hint:'Do you pay on time but not early?'},{key:'discounts',label:'Discount Analysis',hint:'Do you take early payment discounts only when ROI justifies it?'},{key:'relationships',label:'Vendor Relationships',hint:'Are vendor relationships strong enough to negotiate extended terms?'}];var html='<div class="page-header"><div class="t-label">Optimize</div><div class="t-display">Accounts Payable Strategy</div><p class="t-body t-secondary">Optimizing DPO means using full payment terms without damaging vendor relationships.</p></div>';html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">AP Best Practices</div><ul style="margin-left:var(--space-lg);color:var(--color-text-secondary);font-size:14px"><li>Pay on time but not early. If terms are Net 30, pay on day 28-30</li><li>Negotiate extended terms with major vendors (Net 45 or Net 60)</li><li>Take early-payment discounts only when the math favors it (2/10 Net 30 = 36% annualized return)</li></ul></div>';dims.forEach(function(d){html+='<div class="card"><div class="form-label">'+d.label+'</div><div class="form-hint" style="margin-bottom:var(--space-sm)">'+d.hint+'</div>'+scoreSelector('apScores',d.key)+'</div>';});html+=pageNav(true,'Continue','ap');return html;}
function rMistakes(){var mistakes=[{key:'m1',title:'Manipulating Working Capital Before Close',desc:'Aggressively collecting receivables or delaying payables to pull cash out. Buyers see through this.',fix:'Run a consistent, optimized WC cycle for 12+ months so the peg reflects normal operations.'},{key:'m2',title:'Ignoring Working Capital Until LOI',desc:'If you do not understand your NWC until deal negotiations, you have no leverage on the peg.',fix:'Calculate and track NWC monthly starting 18+ months before a potential sale.'},{key:'m3',title:'Letting Seasonal Patterns Distort the Peg',desc:'A 12-month average may not reflect normal operations at your likely close date.',fix:'Negotiate a seasonally-adjusted peg methodology.'}];var html='<div class="page-header"><div class="t-label">Plan</div><div class="t-display">Common Mistakes</div></div>';mistakes.forEach(function(m){var checked=state.mistakeFlags[m.key];html+='<div class="card"><div class="check-item'+(checked?' checked':'')+'" data-check="'+m.key+'" role="checkbox" aria-checked="'+!!checked+'" tabindex="0" style="padding:0"><div class="check-box"><svg viewBox="0 0 14 14"><polyline points="2.5 7 5.5 10 11.5 4"/></svg></div><div style="flex:1"><div class="t-h3">'+m.title+'</div><p class="t-small t-secondary" style="margin:var(--space-sm) 0">'+m.desc+'</p><div style="padding:var(--space-sm) var(--space-md);background:var(--color-success-light);border-radius:var(--radius-sm);font-size:13px;color:var(--color-success)"><strong>Solution:</strong> '+m.fix+'</div></div></div></div>';});html+=pageNav(true,'View Dashboard','mistakes');return html;}
function rDashboard(){var score=calcScore();var sc=getScoreColor(score);var r=60,c=2*Math.PI*r,offset=c-(score/100)*c;var ccc=calcCCC();var avgNWC=state.nwcData.reduce(function(a,row){return a+calcNWC(row);},0)/state.nwcData.length;var arTotal=Object.values(state.arScores).reduce(function(a,v){return a+v;},0);var invTotal=Object.values(state.invScores).reduce(function(a,v){return a+v;},0);var apTotal=Object.values(state.apScores).reduce(function(a,v){return a+v;},0);var optDone=Object.values(state.optimizationChecks).filter(Boolean).length;
var html='<div class="page-header"><div class="t-label">Results</div><div class="t-display">Working Capital Dashboard</div></div>';html+='<div class="gauge-wrap"><div class="gauge-ring"><svg viewBox="0 0 160 160"><circle class="gauge-bg" cx="80" cy="80" r="'+r+'"/><circle class="gauge-fill" cx="80" cy="80" r="'+r+'" stroke="'+sc+'" stroke-dasharray="'+c+'" stroke-dashoffset="'+offset+'"/></svg><div class="gauge-center"><div class="gauge-center-value" style="color:'+sc+'">'+score+'</div><div class="gauge-center-label">of 100</div></div></div></div>';
html+='<div class="summary-grid"><div class="summary-item"><div class="summary-item-value" style="color:var(--color-primary)">'+fmt(avgNWC)+'</div><div class="summary-item-label">Avg NWC (3-mo)</div></div><div class="summary-item"><div class="summary-item-value" style="color:'+(ccc.ccc<=30?'var(--color-success)':ccc.ccc<=60?'var(--color-warning)':'var(--color-danger)')+'">'+ccc.ccc+'d</div><div class="summary-item-label">Cash Conversion Cycle</div></div><div class="summary-item"><div class="summary-item-value" style="color:'+(ccc.dso<=45?'var(--color-success)':'var(--color-warning)')+'">'+ccc.dso+'d</div><div class="summary-item-label">DSO</div></div><div class="summary-item"><div class="summary-item-value">'+optDone+'/6</div><div class="summary-item-label">Optimizations Done</div></div></div>';
var cats=[{label:'AR Management',score:arTotal*5,max:100},{label:'Inventory Mgmt',score:invTotal*5,max:100},{label:'AP Strategy',score:apTotal*5,max:100},{label:'DSO Performance',score:ccc.dso<=30?100:ccc.dso<=45?75:ccc.dso<=60?50:25,max:100}];html+='<div class="card"><div class="t-h3" style="margin-bottom:var(--space-md)">Score Breakdown</div><div class="bar-chart">';cats.forEach(function(cat){var color=cat.score>=70?'var(--color-success)':cat.score>=40?'var(--color-warning)':'var(--color-danger)';html+='<div class="bar-row"><div class="bar-label">'+cat.label+'</div><div class="bar-track"><div class="bar-fill" style="width:'+cat.score+'%;background:'+color+'"><span class="bar-value">'+cat.score+'%</span></div></div></div>';});html+='</div></div>';
if(ccc.dso>45)html+='<div class="callout callout-warning">Your DSO of '+ccc.dso+' days is above the 45-day target. Tighten payment terms and implement systematic collection follow-up.</div>';
if(ccc.ccc>60)html+='<div class="callout callout-danger">Your cash conversion cycle of '+ccc.ccc+' days means cash is tied up in operations for nearly two months. This directly inflates your working capital peg.</div>';
html+='<div class="callout callout-info" style="background:var(--color-text);border-color:var(--color-text);color:rgba(255,255,255,0.85)"><strong style="color:#fff">Final Thought:</strong> Working capital is the silent deal variable. Manage it well, and it is invisible. Manage it poorly, and it costs you at the closing table.</div>';
html+='<div style="display:flex;gap:var(--space-sm);flex-wrap:wrap;margin-top:var(--space-lg)"><button class="btn btn-primary" onclick="PB.exportResults()">Export Summary</button><button class="btn btn-secondary" onclick="window.print()">Print</button><button class="btn btn-ghost" onclick="PB.resetAll()" style="color:var(--color-danger)">Reset All Data</button></div>';
html+='<div class="page-nav"><button class="btn btn-secondary" onclick="PB.prevPage()">&larr; Back</button><div></div></div>';return html;}

function exportResults(){var score=calcScore();var ccc=calcCCC();var avgNWC=state.nwcData.reduce(function(a,r){return a+calcNWC(r);},0)/state.nwcData.length;var text='PLAYBOOK #9: WORKING CAPITAL OPTIMIZATION\nGenerated: '+new Date().toLocaleDateString()+'\n'+'='.repeat(50)+'\n\n';text+='WC READINESS SCORE: '+score+'/100\n\n';text+='AVERAGE NWC (3-MO): '+fmt(avgNWC)+'\n';text+='CASH CONVERSION CYCLE: '+ccc.ccc+' days\n';text+='  DSO: '+ccc.dso+' days\n  DIO: '+ccc.dio+' days\n  DPO: '+ccc.dpo+' days\n\n';text+='AR MANAGEMENT SCORE: '+Object.values(state.arScores).reduce(function(a,v){return a+v;},0)+'/20\n';text+='INVENTORY SCORE: '+Object.values(state.invScores).reduce(function(a,v){return a+v;},0)+'/20\n';text+='AP STRATEGY SCORE: '+Object.values(state.apScores).reduce(function(a,v){return a+v;},0)+'/20\n';
var blob=new Blob([text],{type:'text/plain'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='playbook-09-working-capital.txt';a.click();URL.revokeObjectURL(url);}

window.PB={prevPage:prevPage,completePage:completePage,exportResults:exportResults,resetAll:function(){if(confirm('This will erase all your data. Are you sure?')){localStorage.removeItem(STORAGE_KEY);state=defaultState();saveState();goToPage('welcome');}},setScore:function(obj,key,val){state[obj][key]=val;saveState();renderPage();}};

renderNav();renderPage();updateProgress();updateScore();
})();
</script>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('embedded') === 'true') {
    // Hide playbook's own chrome
    var sidebar = document.querySelector('.sidebar');
    var overlay = document.querySelector('.sidebar-overlay');
    var mobileHeader = document.querySelector('.mobile-header');
    var mainContent = document.querySelector('.main-content');
    if (sidebar) sidebar.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    if (mobileHeader) mobileHeader.style.display = 'none';
    if (mainContent) {
      mainContent.style.marginLeft = '0';
      mainContent.style.minHeight = 'auto';
    }

    // Navigate to specific section if requested
    var section = params.get('section');
    if (section !== null) {
      var sectionIndex = parseInt(section, 10);
      if (typeof navigateToSection === 'function') {
        setTimeout(function() { navigateToSection(sectionIndex); }, 100);
      }
    }

    // Forward score updates to parent
    var origDispatch = window.dispatchEvent.bind(window);
    window.addEventListener('playbook:score-update', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:score-update',
          detail: e.detail
        }, '*');
      }
    });

    // Forward section changes to parent
    window.addEventListener('playbook:section-change', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:section-change',
          detail: e.detail
        }, '*');
      }
    });

    // Listen for commands from parent
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'navigate-section') {
        if (typeof navigateToSection === 'function') {
          navigateToSection(e.data.sectionIndex);
        }
      }
    });
  }
})();
</script>
</body>
</html>
