<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner Dependency Reduction | Exit Planning Playbook</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  /* Brand */
  --color-primary: #0071E3;
  --color-primary-light: #3A7A50;
  --color-primary-bg: rgba(45,90,61,0.07);
  --color-accent: #FF9500;
  --color-accent-bg: rgba(184,115,51,0.08);

  /* Surfaces */
  --color-bg: #FAF9F7;
  --color-surface: #FFFFFF;
  --color-muted: #F5F3F0;
  --color-border: #E5E7EB;
  --color-border-light: #F2F2F7;

  /* Text */
  --color-text: #1A1A18;
  --color-text-secondary: #5C5A55;
  --color-text-muted: #8A8780;

  /* Semantic */
  --color-emerald: #0D9668;
  --color-emerald-bg: rgba(13,150,104,0.08);
  --color-red: #DC2626;
  --color-red-bg: rgba(220,38,38,0.06);
  --color-amber: #D97706;
  --color-amber-bg: rgba(217,119,6,0.08);
  --color-blue: #2563EB;
  --color-blue-bg: rgba(37,99,235,0.06);

  /* Score colors */
  --score-1: #DC2626;
  --score-2: #E87B35;
  --score-3: #D4A843;
  --score-4: #5BA865;
  --score-5: #1B7A3D;

  /* Spacing */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  --space-2xl: 48px;
  --space-3xl: 64px;

  /* Radius */
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --radius-xl: 20px;

  /* Shadows */
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);

  /* Transitions */
  --transition: 200ms ease;
  --transition-slow: 400ms ease;
}

/* Typography */
html { scroll-behavior: smooth; }

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--color-bg);
  color: var(--color-text);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

.t-display { font-family: Georgia, 'Times New Roman', serif; font-size: 1.75rem; font-weight: 700; line-height: 1.2; letter-spacing: -0.025em; }
.t-h1 { font-family: Georgia, 'Times New Roman', serif; font-size: 1.375rem; font-weight: 700; line-height: 1.25; letter-spacing: -0.02em; }
.t-h2 { font-size: 1.125rem; font-weight: 600; line-height: 1.3; }
.t-h3 { font-size: 1rem; font-weight: 600; line-height: 1.35; }
.t-body { font-size: 0.938rem; line-height: 1.7; color: var(--color-text-secondary); }
.t-small { font-size: 0.85rem; line-height: 1.6; color: var(--color-text-secondary); }
.t-caption { font-size: 0.78rem; color: var(--color-text-muted); }
.t-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; }

/* Skip link */
.skip-link {
  position: absolute; left: -9999px; top: 0;
  background: var(--color-primary); color: #fff;
  padding: 8px 16px; z-index: 9999;
  font-size: 0.85rem; border-radius: 0 0 var(--radius-sm) 0;
}
.skip-link:focus { left: 0; }

/* Layout */
.app { display: flex; min-height: 100vh; }

/* Sidebar */
.sidebar {
  width: 260px;
  background: #1A1A18;
  color: #fff;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  display: flex; flex-direction: column;
  z-index: 100;
  transition: transform 0.3s ease;
}

.sidebar-header {
  padding: var(--space-lg) var(--space-lg);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.sidebar-brand {
  font-size: 0.7rem; text-transform: uppercase;
  letter-spacing: 0.12em; color: var(--color-accent);
  font-weight: 600; margin-bottom: var(--space-xs);
}
.sidebar-title { font-size: 1rem; font-weight: 600; color: #fff; line-height: 1.3; }

.sidebar-progress {
  padding: var(--space-md) var(--space-lg);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.progress-label {
  font-size: 0.75rem; color: rgba(255,255,255,0.5);
  margin-bottom: var(--space-sm); display: flex; justify-content: space-between;
}
.progress-bar-bg { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
.progress-bar-fill { height: 100%; background: var(--color-primary); border-radius: 2px; transition: width 0.5s ease; }

.sidebar-score {
  padding: var(--space-md) var(--space-lg);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  text-align: center;
}
.sidebar-score-value { font-size: 1.5rem; font-weight: 700; color: #fff; font-variant-numeric: tabular-nums; }
.sidebar-score-label { font-size: 0.7rem; color: rgba(255,255,255,0.45); margin-top: 2px; }

.sidebar-nav { flex: 1; overflow-y: auto; padding: 12px 0; }

.nav-phase-label {
  font-size: 0.65rem; text-transform: uppercase;
  letter-spacing: 0.1em; color: rgba(255,255,255,0.35);
  padding: var(--space-md) var(--space-lg) var(--space-xs); font-weight: 600;
}

.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px var(--space-lg); color: rgba(255,255,255,0.55);
  cursor: pointer; transition: all var(--transition);
  font-size: 0.85rem; border-left: 3px solid transparent;
  user-select: none;
}
.nav-item:hover:not(.locked) { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.85); }
.nav-item.active { background: rgba(255,255,255,0.08); color: #fff; border-left-color: var(--color-primary); }
.nav-item.completed { color: rgba(255,255,255,0.7); }
.nav-item.locked { opacity: 0.4; cursor: default; }

.nav-check {
  width: 18px; height: 18px; border-radius: 50%;
  border: 1.5px solid rgba(255,255,255,0.25);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.65rem; flex-shrink: 0;
}
.nav-item.completed .nav-check { border-color: var(--color-emerald); background: rgba(13,150,104,0.2); color: var(--color-emerald); }
.nav-item.active .nav-check { border-color: var(--color-primary-light); background: rgba(45,90,61,0.25); }

/* Main */
.main { flex: 1; margin-left: 260px; min-height: 100vh; }
.main-content { max-width: 780px; margin: 0 auto; padding: 40px 32px 100px; }

/* Mobile header */
.mobile-header {
  display: none;
  position: fixed; top: 0; left: 0; right: 0;
  height: 56px; background: #1A1A18; color: #fff;
  align-items: center; justify-content: space-between;
  padding: 0 var(--space-md); z-index: 150;
}
.mobile-header-title { font-size: 0.9rem; font-weight: 600; }
.hamburger {
  width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
  background: none; border: none; color: #fff; cursor: pointer; font-size: 1.3rem;
}

.mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; }

/* Pages */
.page { display: none; animation: fadeIn 0.35s ease; }
.page.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Section header */
.section-eyebrow {
  font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--color-primary); font-weight: 600; margin-bottom: var(--space-sm);
}
.section-desc { margin-top: var(--space-sm); font-size: 0.95rem; max-width: 600px; color: var(--color-text-secondary); line-height: 1.7; }

/* Card */
.card {
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: var(--space-md);
  transition: box-shadow var(--transition);
}
.card:hover { box-shadow: var(--shadow-sm); }
.card-title { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }

/* Callout boxes */
.callout-info {
  background: var(--color-primary-bg); border-left: 3px solid var(--color-primary);
  padding: var(--space-md) var(--space-lg); border-radius: 0 var(--radius-md) var(--radius-md) 0;
  margin: var(--space-lg) 0;
}
.callout-info-label {
  font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em;
  color: var(--color-primary); font-weight: 700; margin-bottom: 4px;
}
.callout-info p { font-size: 0.9rem; color: var(--color-text); }

.callout-warning {
  background: var(--color-red-bg); border-left: 3px solid var(--color-red);
  padding: var(--space-md) var(--space-lg); border-radius: 0 var(--radius-md) var(--radius-md) 0;
  margin: var(--space-lg) 0;
}
.callout-warning-label {
  font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em;
  color: var(--color-red); font-weight: 700; margin-bottom: 4px;
}
.callout-warning p { font-size: 0.9rem; color: var(--color-text); }

/* Stat callout */
.stat-callout {
  background: #1A1A18; color: #fff;
  border-radius: var(--radius-xl); padding: var(--space-xl); text-align: center; margin: var(--space-lg) 0;
}
.stat-number { font-family: Georgia, 'Times New Roman', serif; font-size: 2.5rem; font-weight: 800; letter-spacing: -0.03em; }
.stat-desc { font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 4px; }

/* Forms */
.form-group { margin-bottom: var(--space-lg); }
.form-label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: var(--space-xs); }
.form-hint { font-size: 0.78rem; color: var(--color-text-muted); margin-bottom: var(--space-sm); }

.form-input {
  width: 100%; padding: 10px 14px;
  border: 1px solid var(--color-border); border-radius: var(--radius-sm);
  font-size: 0.938rem; font-family: inherit; color: var(--color-text);
  background: var(--color-surface); outline: none;
  transition: border-color var(--transition), box-shadow var(--transition);
}
.form-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(45,90,61,0.12); }

textarea.form-input { min-height: 70px; resize: vertical; line-height: 1.6; }

select.form-input {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238A8780' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
}

/* Buttons */
.btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 10px 20px; border-radius: var(--radius-sm);
  font-size: 0.88rem; font-weight: 500; font-family: inherit;
  cursor: pointer; border: none; transition: all var(--transition); outline: none;
}
.btn:focus-visible { box-shadow: 0 0 0 3px rgba(45,90,61,0.25); }
.btn-primary { background: var(--color-primary); color: #fff; }
.btn-primary:hover { background: var(--color-primary-light); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.btn-secondary { background: var(--color-muted); color: var(--color-text); border: 1px solid var(--color-border); }
.btn-secondary:hover { background: var(--color-border-light); }
.btn-ghost { background: transparent; color: var(--color-primary); padding: 10px 12px; }
.btn-ghost:hover { background: var(--color-primary-bg); }

.page-nav { display: flex; gap: 12px; margin-top: var(--space-xl); padding-top: var(--space-lg); border-top: 1px solid var(--color-border-light); }

/* Score selector */
.score-selector { display: flex; gap: 6px; margin: var(--space-sm) 0; }
.score-option {
  width: 38px; height: 38px; border-radius: 50%;
  border: 2px solid var(--color-border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 0.82rem; font-weight: 600;
  color: var(--color-text-muted); transition: all var(--transition);
  background: var(--color-surface); user-select: none;
}
.score-option:hover { border-color: var(--color-primary); color: var(--color-primary); }
.score-option.active { color: #fff; }
.score-option.active[data-score="1"] { background: var(--score-1); border-color: var(--score-1); }
.score-option.active[data-score="2"] { background: var(--score-2); border-color: var(--score-2); }
.score-option.active[data-score="3"] { background: var(--score-3); border-color: var(--score-3); }
.score-option.active[data-score="4"] { background: var(--score-4); border-color: var(--score-4); }
.score-option.active[data-score="5"] { background: var(--score-5); border-color: var(--score-5); }

/* KPI */
.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: var(--space-lg) 0; }
.kpi-card {
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: var(--radius-md); padding: var(--space-md) 18px; text-align: center;
}
.kpi-value { font-family: Georgia, 'Times New Roman', serif; font-size: 1.5rem; font-weight: 700; font-variant-numeric: tabular-nums; }
.kpi-label { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.05em; }

/* Gauge */
.gauge-wrap { display: flex; justify-content: center; padding: var(--space-lg) 0; }
.gauge-ring { position: relative; width: 180px; height: 180px; }
.gauge-ring svg { transform: rotate(-90deg); }
.gauge-ring .center-label {
  position: absolute; inset: 0; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.gauge-big { font-family: Georgia, 'Times New Roman', serif; font-size: 2.5rem; font-weight: 700; font-variant-numeric: tabular-nums; }
.gauge-sub { font-size: 0.78rem; color: var(--color-text-muted); }

/* Bar chart */
.bar-chart { margin: var(--space-md) 0; }
.bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: var(--space-sm); }
.bar-label { width: 130px; font-size: 0.82rem; color: var(--color-text-secondary); text-align: right; flex-shrink: 0; }
.bar-track { flex: 1; height: 22px; background: var(--color-muted); border-radius: 4px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
.bar-val { width: 40px; font-size: 0.82rem; font-weight: 600; text-align: center; }

/* Dependency type cards */
.dep-type-card {
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: 12px;
  border-left: 4px solid var(--color-border);
}

/* Authority matrix */
.matrix-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.matrix-table th {
  text-align: left; padding: 10px 12px; font-weight: 600;
  font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
  color: var(--color-text-muted); border-bottom: 2px solid var(--color-border); background: var(--color-muted);
}
.matrix-table td {
  padding: 10px 12px; border-bottom: 1px solid var(--color-border-light); vertical-align: middle;
}

/* Function inventory cards */
.func-card {
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: 10px;
}
.func-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm); }

/* Extraction steps */
.extraction-step {
  display: flex; gap: 14px; padding: var(--space-md) 0;
  border-bottom: 1px solid var(--color-border-light);
}
.extraction-step:last-child { border-bottom: none; }
.step-num {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--color-primary-bg); border: 2px solid var(--color-primary);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.78rem; font-weight: 700; color: var(--color-primary); flex-shrink: 0;
}

/* Absence test cards */
.absence-card {
  background: var(--color-surface); border: 1px solid var(--color-border);
  border-radius: var(--radius-md); padding: 18px; margin-bottom: 10px;
  transition: all var(--transition);
}
.absence-card.passed { border-left: 4px solid var(--color-emerald); }
.absence-card.current { border-left: 4px solid var(--color-amber); }

/* Checklist */
.check-item {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 12px 0; border-bottom: 1px solid var(--color-border-light);
  cursor: pointer; user-select: none;
}
.check-item:last-child { border-bottom: none; }
.check-box {
  width: 20px; height: 20px; border-radius: 4px;
  border: 2px solid var(--color-border); flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition); background: var(--color-surface); font-size: 0.7rem;
}
.check-box:hover { border-color: var(--color-primary); }
.check-box.checked { background: var(--color-primary); border-color: var(--color-primary); color: #fff; }

/* Valuation impact bars */
.impact-row {
  display: grid; grid-template-columns: 100px 1fr 100px; gap: 12px;
  padding: 14px 0; border-bottom: 1px solid var(--color-border-light);
  align-items: center;
}
.impact-row:last-child { border-bottom: none; }
.impact-level { font-weight: 600; font-size: 0.88rem; }
.impact-bar { height: 8px; background: var(--color-muted); border-radius: 4px; overflow: hidden; }
.impact-fill { height: 100%; border-radius: 4px; }
.impact-mult { font-weight: 600; font-size: 0.88rem; text-align: right; font-variant-numeric: tabular-nums; }

/* Toast */
.toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 999; }
.toast {
  background: #1A1A18; color: #fff; padding: 12px 20px;
  border-radius: var(--radius-md); font-size: 0.85rem;
  box-shadow: var(--shadow-md); animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

/* Responsive */
@media (max-width: 900px) {
  .sidebar { transform: translateX(-100%); width: 280px; }
  .sidebar.open { transform: translateX(0); }
  .mobile-header { display: flex; }
  .mobile-overlay.open { display: block; }
  .main { margin-left: 0; }
  .main-content { padding: 72px 20px 100px; max-width: 100%; }
  .kpi-grid { grid-template-columns: 1fr 1fr; }
  .bar-label { width: 90px; font-size: 0.75rem; }
  .impact-row { grid-template-columns: 80px 1fr 80px; }
}

/* Print */
@media print {
  .sidebar, .mobile-header, .page-nav, .toast-container { display: none !important; }
  .main { margin-left: 0; }
  .page { display: block !important; page-break-inside: avoid; margin-bottom: 24px; }
  .card { break-inside: avoid; }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
  html { scroll-behavior: auto; }
}

:focus-visible { outline: 2px solid var(--color-primary); outline-offset: 2px; }
</style>
</head>
<body>

<a href="#main-content" class="skip-link">Skip to content</a>

<div class="mobile-header">
  <button class="hamburger" aria-label="Open navigation" onclick="PB.toggleSidebar()">&#9776;</button>
  <span class="mobile-header-title">Owner Dependency Reduction</span>
  <div style="width:44px;"></div>
</div>

<div class="mobile-overlay" id="mobileOverlay" onclick="PB.toggleSidebar()"></div>

<div class="app">
  <nav class="sidebar" id="sidebar" role="navigation" aria-label="Playbook navigation">
    <div class="sidebar-header">
      <div class="sidebar-brand">Exit Planning Playbook</div>
      <div class="sidebar-title">Owner Dependency Reduction</div>
    </div>
    <div class="sidebar-progress">
      <div class="progress-label">
        <span>Your Progress</span>
        <span id="progressPct">0%</span>
      </div>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progressBar" style="width:0%"></div>
      </div>
    </div>
    <div class="sidebar-score" id="sidebarScore" style="display:none;">
      <div class="sidebar-score-value" id="sidebarScoreValue">--</div>
      <div class="sidebar-score-label">Dependency Score</div>
    </div>
    <div class="sidebar-nav" id="sidebarNav"></div>
  </nav>

  <main class="main" role="main">
    <div class="main-content" id="main-content"></div>
  </main>
</div>

<div class="toast-container" id="toastContainer" aria-live="polite"></div>

<script>
(function() {
'use strict';

/* ── Pages ── */
const PAGES = [
  { id: 'welcome',              title: 'Welcome',                phase: 'Start' },
  { id: 'problem',              title: 'The Problem',            phase: 'Understand' },
  { id: 'valuation-impact',     title: 'Valuation Impact',       phase: 'Understand' },
  { id: 'dependency-score',     title: 'Your Dependency Score',  phase: 'Measure' },
  { id: 'four-types',           title: 'Four Types of Dependency', phase: 'Diagnose' },
  { id: 'function-inventory',   title: 'Function Inventory',     phase: 'Map' },
  { id: 'extraction-framework', title: 'Extraction Framework',   phase: 'Extract' },
  { id: 'delegation',           title: 'Delegation Playbook',    phase: 'Extract' },
  { id: 'authority-matrix',     title: 'Authority Matrix',       phase: 'Extract' },
  { id: 'documentation',        title: 'Process Documentation',  phase: 'Systematize' },
  { id: 'absence-tests',        title: 'Absence Tests',          phase: 'Test' },
  { id: 'mistakes',             title: 'Common Mistakes',        phase: 'Plan' },
  { id: 'timeline',             title: 'Implementation',         phase: 'Plan' },
  { id: 'dashboard',            title: 'Your Summary',           phase: 'Results' }
];

const STORAGE_KEY = 'exitosx-pb03-owner-dependency';

/* ── Default state ── */
const defaultState = {
  currentPage: 'welcome',
  completed: {},
  depScores: [0,0,0,0,0,0,0,0,0,0],
  functions: [
    { name: '', type: 'Relationship', hours: '', recipient: '', transferred: false },
    { name: '', type: 'Knowledge', hours: '', recipient: '', transferred: false },
    { name: '', type: 'Decision', hours: '', recipient: '', transferred: false }
  ],
  authority: {},
  delegationOrder: [],
  docChecklist: [],
  absenceTests: { level1: 'not-done', level2: 'not-done', level3: 'not-done', level4: 'not-done' },
  absenceNotes: { level1: '', level2: '', level3: '', level4: '' },
  mistakeChecks: [],
  milestones: [],
  processNotes: ''
};

/* ── State management ── */
function loadState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const p = JSON.parse(saved);
      return {
        currentPage: p.currentPage || defaultState.currentPage,
        completed: p.completed || {},
        depScores: Array.isArray(p.depScores) ? p.depScores : [...defaultState.depScores],
        functions: Array.isArray(p.functions) ? p.functions : JSON.parse(JSON.stringify(defaultState.functions)),
        authority: p.authority || {},
        delegationOrder: Array.isArray(p.delegationOrder) ? p.delegationOrder : [],
        docChecklist: Array.isArray(p.docChecklist) ? p.docChecklist : [],
        absenceTests: { ...defaultState.absenceTests, ...(p.absenceTests || {}) },
        absenceNotes: { ...defaultState.absenceNotes, ...(p.absenceNotes || {}) },
        mistakeChecks: Array.isArray(p.mistakeChecks) ? p.mistakeChecks : [],
        milestones: Array.isArray(p.milestones) ? p.milestones : [],
        processNotes: p.processNotes || ''
      };
    }
  } catch(e) {}
  return JSON.parse(JSON.stringify(defaultState));
}

let state = loadState();

function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* ── Navigation helpers ── */
function pageIndex(id) { return PAGES.findIndex(p => p.id === id); }

function isUnlocked(id) {
  const idx = pageIndex(id);
  if (idx <= 0) return true;
  return !!state.completed[PAGES[idx - 1].id];
}

function goToPage(id) {
  if (!isUnlocked(id)) return;
  state.currentPage = id;
  saveState();
  renderNav();
  renderPage();
  closeSidebar();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function completePage(id) {
  if (!state.completed[id]) { state.completed[id] = true; saveState(); renderNav(); }
}

function nextPage() {
  const idx = pageIndex(state.currentPage);
  completePage(state.currentPage);
  if (idx < PAGES.length - 1) goToPage(PAGES[idx + 1].id);
}

function prevPage() {
  const idx = pageIndex(state.currentPage);
  if (idx > 0) goToPage(PAGES[idx - 1].id);
}

/* ── Sidebar navigation ── */
function renderNav() {
  const nav = document.getElementById('sidebarNav');
  let currentPhase = '';
  let html = '';
  PAGES.forEach(p => {
    if (p.phase !== currentPhase) {
      currentPhase = p.phase;
      html += '<div class="nav-phase-label">' + currentPhase + '</div>';
    }
    const active = p.id === state.currentPage;
    const done = !!state.completed[p.id];
    const locked = !isUnlocked(p.id);
    let cls = 'nav-item';
    if (active) cls += ' active';
    if (done) cls += ' completed';
    if (locked) cls += ' locked';
    html += '<div class="' + cls + '" role="button" tabindex="' + (locked ? '-1' : '0') + '" data-page="' + p.id + '">'
      + '<div class="nav-check">' + (done ? '&#10003;' : '') + '</div>'
      + '<span>' + p.title + '</span></div>';
  });
  nav.innerHTML = html;

  // Progress
  const completed = Object.keys(state.completed).length;
  const pct = Math.round((completed / PAGES.length) * 100);
  document.getElementById('progressPct').textContent = pct + '%';
  document.getElementById('progressBar').style.width = pct + '%';

  // Sidebar score
  updateSidebarScore();
}

function updateSidebarScore() {
  const total = calcTotal();
  const el = document.getElementById('sidebarScore');
  const val = document.getElementById('sidebarScoreValue');
  if (total > 0) {
    el.style.display = '';
    val.textContent = total + '/50';
  } else {
    el.style.display = 'none';
  }
}

/* ── Sidebar toggle ── */
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('mobileOverlay').classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('mobileOverlay').classList.remove('open');
}

/* ── Helpers ── */
function calcTotal() { return state.depScores.reduce((a, b) => a + b, 0); }

function getLevel(total) {
  if (total >= 40) return { label: 'Low Dependency', color: 'var(--color-emerald)', advice: 'You are exit-ready from an owner dependency standpoint.', months: '0-6' };
  if (total >= 25) return { label: 'Moderate Dependency', color: 'var(--color-amber)', advice: 'Addressable with 6-12 months of focused work.', months: '6-12' };
  if (total >= 15) return { label: 'High Dependency', color: 'var(--color-red)', advice: 'Significant extraction needed; plan 12-18 months.', months: '12-18' };
  return { label: 'Critical Dependency', color: 'var(--color-red)', advice: 'Major restructuring required; plan 18-24 months.', months: '18-24' };
}

function scoreSelector(stateKey, index, currentValue) {
  return '<div class="score-selector" role="radiogroup">'
    + [1,2,3,4,5].map(function(n) {
      return '<div class="score-option' + (currentValue === n ? ' active' : '') + '" data-score="' + n + '" data-action="set-dep-score" data-index="' + index + '" role="radio" aria-checked="' + (currentValue === n) + '" aria-label="Score ' + n + '" tabindex="0">' + n + '</div>';
    }).join('')
    + '</div>';
}

function pageNav(showPrev, nextLabel) {
  if (showPrev === undefined) showPrev = true;
  if (!nextLabel) nextLabel = 'Continue';
  return '<div class="page-nav">'
    + (showPrev ? '<button class="btn btn-secondary" data-action="prev">Back</button>' : '')
    + '<button class="btn btn-primary" data-action="next">' + nextLabel + ' &rarr;</button></div>';
}

function toast(msg) {
  var c = document.getElementById('toastContainer');
  var t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  c.appendChild(t);
  setTimeout(function() { t.remove(); }, 3000);
}

/* ── Page renderers ── */
function renderPage() {
  var el = document.getElementById('main-content');
  var renderers = {
    'welcome': rWelcome, 'problem': rProblem, 'valuation-impact': rValuationImpact,
    'dependency-score': rDepScore, 'four-types': rFourTypes, 'function-inventory': rFunctionInventory,
    'extraction-framework': rExtractionFramework, 'delegation': rDelegation, 'authority-matrix': rAuthorityMatrix,
    'documentation': rDocumentation, 'absence-tests': rAbsenceTests, 'mistakes': rMistakes,
    'timeline': rTimeline, 'dashboard': rDashboard
  };
  var fn = renderers[state.currentPage];
  el.innerHTML = '<div class="page active">' + (fn ? fn() : '') + '</div>';
}

function rWelcome() {
  return '<div class="section-eyebrow">Playbook #3</div>'
    + '<h1 class="t-display">Owner Dependency Reduction</h1>'
    + '<p class="section-desc">Systematically extract yourself from daily operations. Build a business that runs without you.</p>'
    + '<div class="stat-callout">'
    + '  <div class="stat-number">#1</div>'
    + '  <div class="stat-desc">Owner dependency is the #1 value destroyer in small and mid-market business exits</div>'
    + '</div>'
    + '<div class="card">'
    + '  <p style="font-size:1rem;color:var(--color-text);font-weight:500;">If the business cannot function without you, it is not a business -- it is a job. And jobs are not sellable at premium multiples.</p>'
    + '  <p class="t-body" style="margin-top:12px;">This playbook provides a systematic approach to identifying every point of owner dependency, prioritizing them by deal impact, and transferring each one to a person, process, or system.</p>'
    + '</div>'
    + '<div class="callout-info">'
    + '  <div class="callout-info-label">The Goal</div>'
    + '  <p>Build a business that can run for 6-12 months without your involvement.</p>'
    + '</div>'
    + '<div class="card">'
    + '  <h4 class="t-h2">What This Playbook Covers</h4>'
    + '  <div style="margin-top:12px;">'
    + ['Measure your current dependency score (10 indicators)',
       'Identify the four types of dependency and where you are most exposed',
       'Map and inventory every function you hold',
       'Apply the 5-step extraction framework to each function',
       'Build your authority matrix and delegation playbook',
       'Test your independence with graduated absence tests',
       'Create an 18-month implementation timeline'].map(function(t) {
      return '<div style="display:flex;gap:10px;padding:8px 0;"><div style="width:6px;height:6px;border-radius:50%;background:var(--color-primary);margin-top:7px;flex-shrink:0;"></div><span class="t-small" style="color:var(--color-text);">' + t + '</span></div>';
    }).join('')
    + '  </div>'
    + '</div>'
    + '<p class="t-caption" style="margin-top:var(--space-md);">Your data is saved automatically. You can leave and return at any time.</p>'
    + pageNav(false, 'Get Started');
}

function rProblem() {
  return '<div class="section-eyebrow">Understanding</div>'
    + '<h1 class="t-display">How Dependency Develops</h1>'
    + '<p class="section-desc">Owner dependency is not a character flaw -- it is the natural result of building a business from scratch.</p>'
    + '<div class="card">'
    + '  <p style="font-size:0.95rem;color:var(--color-text);">You were the best salesperson, so you kept selling. You were the most trusted by customers, so relationships stayed with you. You made the best decisions, so you kept deciding.</p>'
    + '  <p class="t-body" style="margin-top:12px;">Over 10-20 years, these rational choices created an irrational outcome: <strong>a business that cannot survive your absence.</strong></p>'
    + '</div>'
    + '<div class="callout-info">'
    + '  <div class="callout-info-label">The Core Principle</div>'
    + '  <p>A buyer is not paying for your ability to run the business. They are paying for the business\'s ability to run without you. Every function you hold is a function the buyer must learn, replace, or absorb -- and that is risk they will discount.</p>'
    + '</div>'
    + pageNav();
}

function rValuationImpact() {
  var levels = [
    { level: 'Low', desc: 'Owner works ON the business; team runs operations', impact: '+1.0x to +1.5x', pct: 100, color: 'var(--color-emerald)' },
    { level: 'Moderate', desc: 'Owner involved in key decisions but team handles daily work', impact: 'Market multiple', pct: 70, color: 'var(--color-amber)' },
    { level: 'High', desc: 'Owner is primary salesperson and relationship holder', impact: '-1.0x to -2.0x', pct: 40, color: 'var(--color-red)' },
    { level: 'Critical', desc: 'Business stops functioning within weeks without owner', impact: '-2.0x or no deal', pct: 15, color: 'var(--color-red)' }
  ];
  return '<div class="section-eyebrow">Impact</div>'
    + '<h1 class="t-display">Valuation Impact</h1>'
    + '<p class="section-desc">Owner dependency directly affects what a buyer will pay and how they structure the deal.</p>'
    + '<div class="card">'
    + '  <h4 class="t-h2">Multiple Impact by Dependency Level</h4>'
    + '  <div style="margin-top:var(--space-md);">'
    + levels.map(function(l) {
      return '<div class="impact-row">'
        + '<div class="impact-level" style="color:' + l.color + ';">' + l.level + '</div>'
        + '<div><div class="impact-bar"><div class="impact-fill" style="width:' + l.pct + '%;background:' + l.color + ';"></div></div>'
        + '<div class="t-caption" style="margin-top:4px;">' + l.desc + '</div></div>'
        + '<div class="impact-mult" style="color:' + l.color + ';">' + l.impact + '</div>'
        + '</div>';
    }).join('')
    + '  </div>'
    + '</div>'
    + '<div class="card">'
    + '  <h4 class="t-h2">What This Means</h4>'
    + '  <p class="t-body" style="margin-top:8px;">For a business with $1M EBITDA at a 5x market multiple ($5M), the swing between low and critical dependency is <strong>$2.5M to $3.5M in deal value</strong>. No other single factor has this much influence on price.</p>'
    + '</div>'
    + pageNav();
}

function rDepScore() {
  var indicators = [
    { text: 'I could take 4 weeks off with zero business contact', guide: '1=impossible, 5=done it recently' },
    { text: 'Key customers would stay if I left', guide: '1=would leave, 5=fully loyal to company' },
    { text: 'My team makes operational decisions without me daily', guide: '1=nothing moves without me, 5=fully autonomous' },
    { text: 'Sales happen without my personal involvement', guide: '1=I close all deals, 5=team handles pipeline to close' },
    { text: 'Financial management runs without me', guide: '1=I manage cash/bills, 5=controller handles everything' },
    { text: 'New employees are hired and onboarded without me', guide: '1=I interview everyone, 5=HR/managers own hiring' },
    { text: 'Strategic decisions have input from multiple leaders', guide: '1=I decide alone, 5=leadership team decides together' },
    { text: 'Vendor and supplier relationships don\'t require me', guide: '1=all key vendors know only me, 5=team manages all' },
    { text: 'There is a documented succession plan', guide: '1=none, 5=tested and updated annually' },
    { text: 'I could describe my role as "chairman" not "operator"', guide: '1=I\'m in the weeds daily, 5=I oversee, don\'t operate' }
  ];

  var total = calcTotal();
  var level = getLevel(total);
  var maxScore = 50;
  var gaugeRadius = 72;
  var gaugeCircumference = 2 * Math.PI * gaugeRadius;
  var fillPct = total / maxScore;
  var dashOffset = gaugeCircumference * (1 - fillPct);

  var scoreLabels = ['','Very dependent','Mostly dependent','Somewhat dependent','Mostly independent','Fully independent'];

  var html = '<div class="section-eyebrow">Assessment</div>'
    + '<h1 class="t-display">Your Dependency Score</h1>'
    + '<p class="section-desc">Rate yourself honestly on each of these ten indicators. This is your baseline measurement.</p>';

  if (total > 0) {
    html += '<div class="gauge-wrap"><div class="gauge-ring">'
      + '<svg width="180" height="180" viewBox="0 0 180 180">'
      + '<circle cx="90" cy="90" r="' + gaugeRadius + '" fill="none" stroke="var(--color-border)" stroke-width="10"/>'
      + '<circle cx="90" cy="90" r="' + gaugeRadius + '" fill="none" stroke="' + level.color + '" stroke-width="10"'
      + ' stroke-dasharray="' + gaugeCircumference + '" stroke-dashoffset="' + dashOffset + '"'
      + ' stroke-linecap="round" style="transition: stroke-dashoffset 0.8s ease;"/>'
      + '</svg><div class="center-label">'
      + '<div class="gauge-big" style="color:' + level.color + ';">' + total + '</div>'
      + '<div class="gauge-sub">of ' + maxScore + '</div>'
      + '</div></div></div>'
      + '<div class="card" style="text-align:center;border-left:3px solid ' + level.color + ';">'
      + '<h4 style="color:' + level.color + ';">' + level.label + '</h4>'
      + '<p class="t-small" style="margin-top:4px;">' + level.advice + '</p>'
      + '<p class="t-caption" style="margin-top:4px;">Estimated timeline to readiness: ' + level.months + ' months</p>'
      + '</div>';
  }

  html += '<div class="card">';
  indicators.forEach(function(ind, i) {
    html += '<div style="padding:14px 0;border-bottom:' + (i < indicators.length - 1 ? '1px solid var(--color-border-light)' : 'none') + ';">'
      + '<div class="form-label">' + ind.text + '</div>'
      + '<div class="form-hint">' + ind.guide + '</div>'
      + scoreSelector('depScores', i, state.depScores[i])
      + '<span class="t-caption" style="margin-left:4px;">' + (state.depScores[i] > 0 ? scoreLabels[state.depScores[i]] : '') + '</span>'
      + '</div>';
  });
  html += '</div>';

  if (total > 0) {
    html += '<div class="card"><h4 class="t-h2">Your Weakest Areas</h4><div class="bar-chart" style="margin-top:12px;">';
    indicators.forEach(function(ind, i) {
      var score = state.depScores[i];
      var barColor = score <= 2 ? 'var(--color-red)' : score <= 3 ? 'var(--color-amber)' : 'var(--color-emerald)';
      html += '<div class="bar-row">'
        + '<div class="bar-label" style="width:180px;font-size:0.78rem;">' + ind.text.substring(0, 35) + '...</div>'
        + '<div class="bar-track"><div class="bar-fill" style="width:' + ((score/5)*100) + '%;background:' + barColor + ';"></div></div>'
        + '<div class="bar-val" style="color:' + barColor + ';">' + score + '/5</div></div>';
    });
    html += '</div></div>';
  }

  html += pageNav();
  return html;
}

function rFourTypes() {
  var types = [
    { icon: '&#129309;', name: 'Relationship Dependency', desc: 'Customers, vendors, and partners have relationships with you personally, not with the company.', fix: 'Transition relationships to team members over 12-18 months. Introduce your team as the primary point of contact. Systematize key account management.', color: 'var(--color-blue)' },
    { icon: '&#128218;', name: 'Knowledge Dependency', desc: 'Critical information about how the business works lives exclusively in your head.', fix: 'Document everything: pricing logic, customer history, operational procedures, vendor terms. Create a knowledge base that the business can reference without you.', color: 'var(--color-amber)' },
    { icon: '&#9878;', name: 'Decision Dependency', desc: 'No significant decision happens without your approval.', fix: 'Define decision rights: who can approve what, up to what dollar amount, under what circumstances. Push authority down systematically.', color: 'var(--color-primary)' },
    { icon: '&#128200;', name: 'Sales Dependency', desc: 'You are the primary or sole revenue generator.', fix: 'This is the hardest to fix. Hire sales leadership, transfer key accounts, formalize the sales process, and accept that revenue may temporarily dip during the transition.', color: 'var(--color-red)' }
  ];
  return '<div class="section-eyebrow">Diagnosis</div>'
    + '<h1 class="t-display">The Four Types of Owner Dependency</h1>'
    + '<p class="section-desc">Every dependency falls into one of four categories. Understanding which types dominate helps focus your extraction work.</p>'
    + types.map(function(t) {
      return '<div class="dep-type-card" style="border-left-color:' + t.color + ';">'
        + '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">'
        + '<span style="font-size:1.3rem;">' + t.icon + '</span>'
        + '<h4 class="t-h2">' + t.name + '</h4></div>'
        + '<p class="t-small" style="color:var(--color-text);">' + t.desc + '</p>'
        + '<div style="margin-top:10px;padding:10px 14px;background:var(--color-muted);border-radius:var(--radius-sm);">'
        + '<p class="t-small"><strong>How to fix:</strong> ' + t.fix + '</p></div></div>';
    }).join('')
    + '<div class="callout-warning">'
    + '  <div class="callout-warning-label">Hardest to Fix</div>'
    + '  <p>Sales dependency is the most critical and most difficult to resolve. It requires dedicated sales leadership, which many owners resist hiring because "nobody can sell like I can." That belief is the dependency speaking.</p>'
    + '</div>'
    + pageNav();
}

function rFunctionInventory() {
  var html = '<div class="section-eyebrow">Mapping</div>'
    + '<h1 class="t-display">Function Inventory</h1>'
    + '<p class="section-desc">List every function and activity that currently depends on you. Be exhaustive -- the ones you forget to list are often the ones that sabotage the deal.</p>'
    + '<div class="callout-info"><div class="callout-info-label">Tip</div>'
    + '<p>Think through a typical week. What meetings do you attend? What decisions come to you? What would break if you were gone for a month?</p></div>'
    + '<div id="funcList">';

  state.functions.forEach(function(f, i) {
    html += '<div class="func-card">'
      + '<div class="func-header">'
      + '<span class="t-caption">Function ' + (i + 1) + '</span>'
      + (state.functions.length > 1 ? '<button class="btn-ghost" style="font-size:0.75rem;padding:4px 8px;color:var(--color-red);" data-action="remove-func" data-index="' + i + '">Remove</button>' : '')
      + '</div>'
      + '<div class="form-group">'
      + '<label class="form-label">Function / Activity</label>'
      + '<input class="form-input" type="text" placeholder="e.g., Key account management, Pricing decisions..."'
      + ' value="' + escHtml(f.name) + '" data-bind="func-name" data-index="' + i + '"></div>'
      + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">'
      + '<div class="form-group" style="margin-bottom:0;"><label class="form-label">Type</label>'
      + '<select class="form-input" data-bind="func-type" data-index="' + i + '">'
      + ['Relationship','Knowledge','Decision','Sales'].map(function(t) {
        return '<option value="' + t + '"' + (f.type === t ? ' selected' : '') + '>' + t + '</option>';
      }).join('')
      + '</select></div>'
      + '<div class="form-group" style="margin-bottom:0;"><label class="form-label">Hours/Week</label>'
      + '<input class="form-input" type="number" min="0" step="1" placeholder="0"'
      + ' value="' + escHtml(String(f.hours)) + '" data-bind="func-hours" data-index="' + i + '"></div>'
      + '<div class="form-group" style="margin-bottom:0;"><label class="form-label">Recipient</label>'
      + '<input class="form-input" type="text" placeholder="Who takes this?"'
      + ' value="' + escHtml(f.recipient) + '" data-bind="func-recipient" data-index="' + i + '"></div>'
      + '</div></div>';
  });

  html += '</div>'
    + '<button class="btn btn-secondary" data-action="add-func" style="margin-top:8px;">+ Add Another Function</button>';

  if (state.functions.some(function(f) { return f.name; })) {
    var funcsMapped = state.functions.filter(function(f) { return f.name; }).length;
    var hoursHeld = state.functions.reduce(function(a, f) { return a + (parseFloat(f.hours) || 0); }, 0);
    var recipientsNamed = state.functions.filter(function(f) { return f.recipient; }).length;
    html += '<div class="kpi-grid" style="margin-top:var(--space-lg);">'
      + '<div class="kpi-card"><div class="kpi-value">' + funcsMapped + '</div><div class="kpi-label">Functions Mapped</div></div>'
      + '<div class="kpi-card"><div class="kpi-value">' + hoursHeld + '</div><div class="kpi-label">Hours/Week Held</div></div>'
      + '<div class="kpi-card"><div class="kpi-value">' + recipientsNamed + '</div><div class="kpi-label">Recipients Identified</div></div>'
      + '</div>';
  }

  html += pageNav();
  return html;
}

function rExtractionFramework() {
  var steps = [
    { num: 1, name: 'Document', desc: 'Write down exactly what you do, how you do it, and why. Include decision criteria, exceptions, and tribal knowledge.' },
    { num: 2, name: 'Identify the Recipient', desc: 'Who will take this over? An existing employee, a new hire, or a system/process?' },
    { num: 3, name: 'Train & Shadow', desc: 'Have the recipient shadow you for 2-4 weeks, then reverse: you shadow them.' },
    { num: 4, name: 'Transfer with Guardrails', desc: 'Hand off the function with defined boundaries (e.g., "you handle deals under $50K; over $50K, loop me in").' },
    { num: 5, name: 'Release', desc: 'Remove yourself entirely. Do not check in. Do not overrule. Let them own it, including the mistakes.' }
  ];
  return '<div class="section-eyebrow">Framework</div>'
    + '<h1 class="t-display">The 5-Step Extraction Process</h1>'
    + '<p class="section-desc">For each owner-held function, follow this five-step extraction process.</p>'
    + '<div class="card">'
    + steps.map(function(s) {
      return '<div class="extraction-step">'
        + '<div class="step-num">' + s.num + '</div>'
        + '<div><h4 class="t-h3">' + s.name + '</h4>'
        + '<p class="t-small" style="margin-top:4px;">' + s.desc + '</p></div></div>';
    }).join('')
    + '</div>'
    + '<div class="callout-warning"><div class="callout-warning-label">The Hardest Part</div>'
    + '<p>Step 5 -- Release -- is where most owners fail. You will see things done differently than you would do them. You will see mistakes. You will be tempted to step back in. <strong>Resist.</strong> The short-term cost of imperfect delegation is far less than the long-term cost of dependency.</p></div>'
    + pageNav();
}

function rDelegation() {
  var priorities = [
    { id: 'ops', priority: 1, name: 'Routine Operations & Admin', why: 'Lowest risk; builds delegation muscle' },
    { id: 'finance', priority: 2, name: 'Financial Management & Reporting', why: 'Controller/bookkeeper can handle; frees significant time' },
    { id: 'hr', priority: 3, name: 'HR and Hiring', why: 'Train managers to hire; remove yourself from interviews' },
    { id: 'vendor', priority: 4, name: 'Vendor & Supplier Management', why: 'Introduce team members; transfer relationships' },
    { id: 'customer', priority: 5, name: 'Customer Relationships', why: 'Hardest; start with newer/smaller clients' },
    { id: 'sales', priority: 6, name: 'Sales & Business Development', why: 'Most critical and most difficult; needs dedicated leadership' },
    { id: 'strategy', priority: 7, name: 'Strategic Decisions', why: 'Last to delegate; requires a mature leadership team' }
  ];
  return '<div class="section-eyebrow">Prioritization</div>'
    + '<h1 class="t-display">Delegation Playbook</h1>'
    + '<p class="section-desc">Delegate in this order -- from lowest risk to highest. Each successful delegation builds your confidence and your team\'s capability.</p>'
    + '<div class="card"><h4 class="t-h2">Delegation Priority Order</h4>'
    + '<p class="t-caption" style="margin-bottom:12px;">Check off each area as you begin the delegation process</p>'
    + priorities.map(function(p) {
      var checked = state.delegationOrder.indexOf(p.id) >= 0;
      return '<div class="check-item" data-action="toggle-delegation" data-id="' + p.id + '">'
        + '<div class="check-box' + (checked ? ' checked' : '') + '" role="checkbox" aria-checked="' + checked + '" tabindex="0">' + (checked ? '&#10003;' : '') + '</div>'
        + '<div style="flex:1;">'
        + '<div style="display:flex;align-items:center;gap:8px;">'
        + '<span style="font-size:0.7rem;padding:2px 8px;border-radius:999px;background:var(--color-primary-bg);color:var(--color-primary);font-weight:600;">P' + p.priority + '</span>'
        + '<span style="font-weight:500;font-size:0.92rem;' + (checked ? 'text-decoration:line-through;color:var(--color-text-muted);' : '') + '">' + p.name + '</span></div>'
        + '<p class="t-caption" style="margin-top:2px;">' + p.why + '</p></div></div>';
    }).join('')
    + '</div>'
    + '<div class="kpi-grid"><div class="kpi-card">'
    + '<div class="kpi-value" style="color:var(--color-primary);">' + state.delegationOrder.length + '/7</div>'
    + '<div class="kpi-label">Areas In Progress</div></div></div>'
    + pageNav();
}

function rAuthorityMatrix() {
  var decisions = [
    { id: 'purchases', name: 'Purchases under threshold' },
    { id: 'hiring', name: 'Hiring (non-management)' },
    { id: 'pricing', name: 'Customer pricing / discounts' },
    { id: 'vendors', name: 'Vendor selection' },
    { id: 'escalations', name: 'Client escalations' },
    { id: 'partnerships', name: 'Strategic partnerships' },
    { id: 'capex', name: 'Capital expenditures' }
  ];
  var levels = ['team-decides', 'consult-owner', 'owner-decides'];
  var levelColors = { 'team-decides': 'var(--color-emerald)', 'consult-owner': 'var(--color-amber)', 'owner-decides': 'var(--color-red)' };
  var levelLabels = { 'team-decides': 'Team Decides Alone', 'consult-owner': 'Consult Owner', 'owner-decides': 'Owner Decides' };

  var html = '<div class="section-eyebrow">Structure</div>'
    + '<h1 class="t-display">Authority Matrix</h1>'
    + '<p class="section-desc">Define explicit authority levels for your team. Ambiguity in decision rights is the #1 cause of delegation failure.</p>'
    + '<div class="card" style="overflow-x:auto;"><table class="matrix-table"><thead><tr>'
    + '<th>Decision Type</th><th style="text-align:center;">Team Decides</th><th style="text-align:center;">Consult Owner</th><th style="text-align:center;">Owner Decides</th>'
    + '</tr></thead><tbody>';

  decisions.forEach(function(d) {
    var current = state.authority[d.id] || '';
    html += '<tr><td style="font-weight:500;">' + d.name + '</td>';
    levels.forEach(function(l) {
      html += '<td style="text-align:center;">'
        + '<div style="width:28px;height:28px;border-radius:50%;margin:0 auto;cursor:pointer;'
        + 'border:2px solid ' + (current === l ? levelColors[l] : 'var(--color-border)') + ';'
        + 'background:' + (current === l ? levelColors[l] + '20' : 'transparent') + ';'
        + 'display:flex;align-items:center;justify-content:center;transition:all 0.15s;"'
        + ' role="radio" tabindex="0" aria-label="' + d.name + ' - ' + levelLabels[l] + '"'
        + ' data-action="set-authority" data-decision="' + d.id + '" data-level="' + l + '">'
        + (current === l ? '<div style="width:10px;height:10px;border-radius:50%;background:' + levelColors[l] + ';"></div>' : '')
        + '</div></td>';
    });
    html += '</tr>';
  });

  html += '</tbody></table></div>';

  if (Object.keys(state.authority).length > 0) {
    var teamCount = Object.values(state.authority).filter(function(v) { return v === 'team-decides'; }).length;
    var consultCount = Object.values(state.authority).filter(function(v) { return v === 'consult-owner'; }).length;
    var ownerCount = Object.values(state.authority).filter(function(v) { return v === 'owner-decides'; }).length;
    html += '<div class="kpi-grid">'
      + '<div class="kpi-card"><div class="kpi-value" style="color:var(--color-emerald);">' + teamCount + '</div><div class="kpi-label">Team Decides</div></div>'
      + '<div class="kpi-card"><div class="kpi-value" style="color:var(--color-amber);">' + consultCount + '</div><div class="kpi-label">Consult Owner</div></div>'
      + '<div class="kpi-card"><div class="kpi-value" style="color:var(--color-red);">' + ownerCount + '</div><div class="kpi-label">Owner Decides</div></div>'
      + '</div>'
      + '<div class="callout-info"><div class="callout-info-label">Goal</div>'
      + '<p>Over time, shift as many decisions as possible from "Owner Decides" to "Team Decides." Each shift reduces dependency and increases your business\'s value.</p></div>';
  }

  html += pageNav();
  return html;
}

function rDocumentation() {
  var items = [
    { id: 'decisions', text: 'How key decisions are made (criteria, thresholds, exceptions)' },
    { id: 'processes', text: 'How key processes work (step-by-step, with screenshots)' },
    { id: 'info', text: 'Where critical information lives (systems, folders, contacts)' },
    { id: 'relationships', text: 'Key relationships and their history (CRM notes, context)' },
    { id: 'financial', text: 'Financial rhythms (invoicing, payments, cash flow patterns)' },
    { id: 'pricing', text: 'Pricing logic and discount authority' },
    { id: 'vendor', text: 'Vendor terms and key contact details' },
    { id: 'emergency', text: 'Emergency procedures and escalation paths' }
  ];
  return '<div class="section-eyebrow">Systematize</div>'
    + '<h1 class="t-display">Process Documentation</h1>'
    + '<p class="section-desc">Every function you hold must be documented in enough detail that someone else could perform it using only the documentation. This is non-negotiable.</p>'
    + '<div class="card"><h4 class="t-h2">Documentation Checklist</h4>'
    + '<p class="t-caption" style="margin-bottom:8px;">Check off each category as you complete its documentation</p>'
    + items.map(function(item) {
      var checked = state.docChecklist.indexOf(item.id) >= 0;
      return '<div class="check-item" data-action="toggle-doc" data-id="' + item.id + '">'
        + '<div class="check-box' + (checked ? ' checked' : '') + '" role="checkbox" aria-checked="' + checked + '" tabindex="0">' + (checked ? '&#10003;' : '') + '</div>'
        + '<span class="t-small" style="' + (checked ? 'text-decoration:line-through;color:var(--color-text-muted);' : 'color:var(--color-text);') + '">' + item.text + '</span></div>';
    }).join('')
    + '</div>'
    + '<div class="card"><h4 class="t-h2">Documentation Notes</h4>'
    + '<div class="form-hint">Use this space to track where documentation lives, what still needs to be written, and any blockers.</div>'
    + '<textarea class="form-input" style="min-height:100px;margin-top:8px;" placeholder="e.g., SOPs stored in Notion, pricing logic in Google Sheet, need to document customer escalation process..."'
    + ' data-bind="processNotes">' + escHtml(state.processNotes) + '</textarea></div>'
    + '<div class="kpi-grid"><div class="kpi-card">'
    + '<div class="kpi-value" style="color:var(--color-primary);">' + state.docChecklist.length + '/' + items.length + '</div>'
    + '<div class="kpi-label">Documented</div></div></div>'
    + pageNav();
}

function rAbsenceTests() {
  var tests = [
    { key: 'level1', level: 1, duration: '1 Week', rules: 'No calls or emails about operations', observe: 'Did anything break?', color: 'var(--color-emerald)' },
    { key: 'level2', level: 2, duration: '2 Weeks', rules: 'Check-in only once at end of week 1', observe: 'Were decisions made without you?', color: 'var(--color-primary)' },
    { key: 'level3', level: 3, duration: '4 Weeks', rules: 'Zero contact; team handles everything', observe: 'Revenue, quality, customer satisfaction trends', color: 'var(--color-amber)' },
    { key: 'level4', level: 4, duration: '8 Weeks', rules: 'Fully offline; no involvement', observe: 'If the business runs well, you are ready', color: 'var(--color-red)' }
  ];
  var statusLabels = { 'not-done': 'Not Attempted', 'in-progress': 'In Progress', 'passed': 'Passed', 'failed': 'Needs Work' };

  var html = '<div class="section-eyebrow">Validation</div>'
    + '<h1 class="t-display">The Graduated Absence Test</h1>'
    + '<p class="section-desc">The ultimate test: can you disappear for an extended period without the business suffering? Progress through these levels sequentially.</p>';

  tests.forEach(function(t) {
    var status = state.absenceTests[t.key];
    var isPassed = status === 'passed';
    var isCurrent = status === 'in-progress';
    html += '<div class="absence-card' + (isPassed ? ' passed' : '') + (isCurrent ? ' current' : '') + '">'
      + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">'
      + '<div style="display:flex;align-items:center;gap:10px;">'
      + '<span style="width:28px;height:28px;border-radius:50%;background:' + t.color + '15;color:' + t.color + ';display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.82rem;">L' + t.level + '</span>'
      + '<h4 class="t-h3">' + t.duration + '</h4></div>'
      + '<select class="form-input" style="width:130px;padding:6px 10px;font-size:0.78rem;" data-bind="absence-status" data-key="' + t.key + '">'
      + Object.keys(statusLabels).map(function(s) {
        return '<option value="' + s + '"' + (status === s ? ' selected' : '') + '>' + statusLabels[s] + '</option>';
      }).join('')
      + '</select></div>'
      + '<p class="t-small" style="color:var(--color-text);"><strong>Rules:</strong> ' + t.rules + '</p>'
      + '<p class="t-small" style="color:var(--color-text);"><strong>Observe:</strong> ' + t.observe + '</p>'
      + '<div class="form-group" style="margin-top:10px;margin-bottom:0;">'
      + '<textarea class="form-input" style="min-height:50px;font-size:0.85rem;" placeholder="Notes: what happened, what broke, what worked..."'
      + ' data-bind="absence-note" data-key="' + t.key + '">' + escHtml(state.absenceNotes[t.key]) + '</textarea></div></div>';
  });

  html += '<div class="kpi-grid"><div class="kpi-card">'
    + '<div class="kpi-value" style="color:var(--color-primary);">' + Object.values(state.absenceTests).filter(function(v) { return v === 'passed'; }).length + '/4</div>'
    + '<div class="kpi-label">Tests Passed</div></div></div>'
    + pageNav();
  return html;
}

function rMistakes() {
  var mistakes = [
    { num: 1, title: 'Delegating Tasks Instead of Functions', desc: '"Handle this invoice" is not delegation. Delegation means "you own accounts payable -- the process, the decisions, the problems."', fix: 'Transfer whole functions with authority and accountability.' },
    { num: 2, title: 'Hovering After Delegating', desc: 'Checking in daily, second-guessing decisions, and overruling your team destroys their confidence and your credibility.', fix: 'Set check-in intervals (weekly, then monthly) and stick to them.' },
    { num: 3, title: 'Not Investing in the People', desc: 'You cannot delegate to people who are not capable. Delegation requires investment in training, coaching, and sometimes hiring.', fix: 'Budget for the team development that makes delegation possible.' }
  ];
  return '<div class="section-eyebrow">Awareness</div>'
    + '<h1 class="t-display">Common Mistakes</h1>'
    + mistakes.map(function(m, i) {
      var checked = state.mistakeChecks.indexOf(i) >= 0;
      return '<div class="card" style="cursor:pointer;" data-action="toggle-mistake" data-index="' + i + '">'
        + '<div style="display:flex;gap:12px;align-items:flex-start;">'
        + '<div class="check-box' + (checked ? ' checked' : '') + '" role="checkbox" aria-checked="' + checked + '">' + (checked ? '&#10003;' : '') + '</div>'
        + '<div><h4 class="t-h2">' + m.title + '</h4>'
        + '<p class="t-small" style="margin-top:4px;color:var(--color-text);">' + m.desc + '</p>'
        + '<div style="margin-top:8px;padding:8px 12px;background:var(--color-emerald-bg);border-radius:var(--radius-sm);">'
        + '<p class="t-small" style="color:var(--color-emerald);"><strong>Solution:</strong> ' + m.fix + '</p></div></div></div></div>';
    }).join('')
    + pageNav();
}

function rTimeline() {
  var items = [
    { month: 'Month 1', action: 'Complete dependency score; list all owner-held functions', deliverable: 'Dependency scorecard; function list' },
    { month: 'Month 2-3', action: 'Prioritize functions for transfer; identify recipients', deliverable: 'Transfer priority matrix' },
    { month: 'Month 3-6', action: 'Transfer low-risk functions; document processes', deliverable: 'First 3-5 functions transferred' },
    { month: 'Month 6-9', action: 'Transfer customer/vendor relationships; delegate decisions', deliverable: 'Authority matrix implemented' },
    { month: 'Month 9-12', action: 'Transfer sales functions; conduct Level 1-2 absence tests', deliverable: 'Sales functioning independently' },
    { month: 'Month 12-18', action: 'Conduct Level 3-4 absence tests; address remaining dependencies', deliverable: '4-week test passed; dependency score >35' }
  ];
  return '<div class="section-eyebrow">Execution</div>'
    + '<h1 class="t-display">Implementation Timeline</h1>'
    + '<p class="section-desc">An 18-month roadmap from dependent to independent.</p>'
    + '<div class="card">'
    + items.map(function(item, i) {
      var done = state.milestones.indexOf(i) >= 0;
      return '<div style="display:flex;gap:14px;padding:14px 0;border-bottom:' + (i < items.length - 1 ? '1px solid var(--color-border-light)' : 'none') + ';">'
        + '<div class="check-box' + (done ? ' checked' : '') + '" data-action="toggle-milestone" data-index="' + i + '" style="cursor:pointer;margin-top:2px;"'
        + ' role="checkbox" aria-checked="' + done + '" tabindex="0">' + (done ? '&#10003;' : '') + '</div>'
        + '<div><h4 class="t-h3"><span style="color:var(--color-primary);font-weight:500;">' + item.month + ':</span> ' + item.action + '</h4>'
        + '<p class="t-caption">Deliverable: ' + item.deliverable + '</p></div></div>';
    }).join('')
    + '</div>'
    + pageNav(true, 'View Summary');
}

function rDashboard() {
  var total = calcTotal();
  var level = getLevel(total);
  var funcsMapped = state.functions.filter(function(f) { return f.name; }).length;
  var funcsWithRecipient = state.functions.filter(function(f) { return f.recipient; }).length;
  var hoursHeld = state.functions.reduce(function(a, f) { return a + (parseFloat(f.hours) || 0); }, 0);
  var authoritySet = Object.keys(state.authority).length;
  var docsComplete = state.docChecklist.length;
  var testsPassed = Object.values(state.absenceTests).filter(function(v) { return v === 'passed'; }).length;
  var delegationStarted = state.delegationOrder.length;
  var milestoneDone = state.milestones.length;

  var maxScore = 50;
  var gaugeRadius = 72;
  var gaugeCircumference = 2 * Math.PI * gaugeRadius;
  var fillPct = total / maxScore;
  var dashOffset = gaugeCircumference * (1 - fillPct);

  var html = '<div class="section-eyebrow">Summary</div>'
    + '<h1 class="t-display">Your Owner Dependency Summary</h1>'
    + '<div class="stat-callout" style="background:var(--color-primary);">'
    + '<div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-bottom:4px;">Dependency Score</div>'
    + '<div class="stat-number">' + total + '<span style="font-size:1.2rem;">/' + maxScore + '</span></div>'
    + '<div class="stat-desc" style="color:rgba(255,255,255,0.7);">' + level.label + '</div></div>';

  if (total > 0) {
    html += '<div class="gauge-wrap"><div class="gauge-ring">'
      + '<svg width="180" height="180" viewBox="0 0 180 180">'
      + '<circle cx="90" cy="90" r="' + gaugeRadius + '" fill="none" stroke="var(--color-border)" stroke-width="10"/>'
      + '<circle cx="90" cy="90" r="' + gaugeRadius + '" fill="none" stroke="' + level.color + '" stroke-width="10"'
      + ' stroke-dasharray="' + gaugeCircumference + '" stroke-dashoffset="' + dashOffset + '"'
      + ' stroke-linecap="round" style="transition: stroke-dashoffset 0.8s ease;"/>'
      + '</svg><div class="center-label">'
      + '<div class="gauge-big" style="color:' + level.color + ';">' + total + '</div>'
      + '<div class="gauge-sub">of ' + maxScore + '</div>'
      + '</div></div></div>';
  }

  html += '<div class="kpi-grid">'
    + '<div class="kpi-card"><div class="kpi-value">' + funcsMapped + '</div><div class="kpi-label">Functions Mapped</div></div>'
    + '<div class="kpi-card"><div class="kpi-value">' + funcsWithRecipient + '</div><div class="kpi-label">Recipients Named</div></div>'
    + '<div class="kpi-card"><div class="kpi-value">' + hoursHeld + 'h</div><div class="kpi-label">Weekly Hours Held</div></div>'
    + '<div class="kpi-card"><div class="kpi-value">' + delegationStarted + '/7</div><div class="kpi-label">Delegation Areas</div></div>'
    + '</div>'
    + '<div class="kpi-grid">'
    + '<div class="kpi-card"><div class="kpi-value">' + authoritySet + '/7</div><div class="kpi-label">Authority Defined</div></div>'
    + '<div class="kpi-card"><div class="kpi-value">' + docsComplete + '/8</div><div class="kpi-label">Documented</div></div>'
    + '<div class="kpi-card"><div class="kpi-value" style="color:' + (testsPassed >= 3 ? 'var(--color-emerald)' : testsPassed >= 1 ? 'var(--color-amber)' : 'var(--color-text-muted)') + ';">' + testsPassed + '/4</div><div class="kpi-label">Absence Tests Passed</div></div>'
    + '<div class="kpi-card"><div class="kpi-value">' + milestoneDone + '/6</div><div class="kpi-label">Milestones Done</div></div>'
    + '</div>';

  html += '<div class="card" style="border-left:3px solid ' + level.color + ';">'
    + '<h4 class="t-h2">Assessment</h4>'
    + '<p class="t-small" style="margin-top:8px;color:var(--color-text);"><strong>' + level.label + ':</strong> ' + level.advice + '</p>'
    + '<p class="t-caption" style="margin-top:4px;">Estimated timeline to exit-readiness: ' + level.months + ' months</p></div>';

  if (total > 0) {
    var barLabels = ['4-week absence','Customer loyalty','Team autonomy','Sales independence','Financial mgmt','Hiring/HR','Strategic input','Vendor mgmt','Succession plan','Chairman role'];
    html += '<div class="card"><h4 class="t-h2">Score Breakdown</h4><div class="bar-chart" style="margin-top:12px;">';
    barLabels.forEach(function(label, i) {
      var score = state.depScores[i];
      var barColor = score <= 2 ? 'var(--color-red)' : score <= 3 ? 'var(--color-amber)' : 'var(--color-emerald)';
      html += '<div class="bar-row">'
        + '<div class="bar-label" style="width:140px;font-size:0.78rem;">' + label + '</div>'
        + '<div class="bar-track"><div class="bar-fill" style="width:' + ((score/5)*100) + '%;background:' + barColor + ';"></div></div>'
        + '<div class="bar-val" style="color:' + barColor + ';">' + (score || '-') + '</div></div>';
    });
    html += '</div></div>';
  }

  html += '<div class="callout-info"><div class="callout-info-label">Final Thought</div>'
    + '<p>Build a business that doesn\'t need you. That is a business worth buying.</p></div>'
    + '<div class="page-nav">'
    + '<button class="btn btn-secondary" data-action="prev">Back</button>'
    + '<button class="btn btn-ghost" data-action="export">Export Results</button>'
    + '<button class="btn btn-ghost" data-action="reset" style="color:var(--color-red);">Reset All Data</button>'
    + '<button class="btn btn-primary" onclick="window.print()">Print Summary</button>'
    + '</div>';

  return html;
}

/* ── Utility ── */
function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ── Export ── */
function exportResults() {
  var total = calcTotal();
  var level = getLevel(total);
  var lines = [
    'OWNER DEPENDENCY REDUCTION -- RESULTS',
    '======================================',
    'Date: ' + new Date().toLocaleDateString(),
    '',
    'DEPENDENCY SCORE: ' + total + '/50 (' + level.label + ')',
    level.advice,
    'Estimated timeline: ' + level.months + ' months',
    ''
  ];

  if (total > 0) {
    var barLabels = ['4-week absence','Customer loyalty','Team autonomy','Sales independence','Financial mgmt','Hiring/HR','Strategic input','Vendor mgmt','Succession plan','Chairman role'];
    lines.push('SCORE BREAKDOWN:');
    barLabels.forEach(function(label, i) {
      lines.push('  ' + label + ': ' + (state.depScores[i] || '-') + '/5');
    });
    lines.push('');
  }

  var named = state.functions.filter(function(f) { return f.name; });
  if (named.length) {
    lines.push('FUNCTION INVENTORY (' + named.length + ' functions):');
    named.forEach(function(f) {
      lines.push('  - ' + f.name + ' [' + f.type + '] ' + (f.hours ? f.hours + 'h/wk' : '') + (f.recipient ? ' -> ' + f.recipient : ''));
    });
    lines.push('');
  }

  if (state.delegationOrder.length) {
    lines.push('DELEGATION IN PROGRESS: ' + state.delegationOrder.length + '/7 areas');
    lines.push('');
  }

  if (Object.keys(state.authority).length) {
    lines.push('AUTHORITY MATRIX:');
    Object.keys(state.authority).forEach(function(k) {
      lines.push('  ' + k + ': ' + state.authority[k]);
    });
    lines.push('');
  }

  if (state.docChecklist.length) {
    lines.push('DOCUMENTATION: ' + state.docChecklist.length + '/8 categories complete');
    lines.push('');
  }

  var testsPassed = Object.values(state.absenceTests).filter(function(v) { return v === 'passed'; }).length;
  lines.push('ABSENCE TESTS: ' + testsPassed + '/4 passed');
  lines.push('MILESTONES: ' + state.milestones.length + '/6 complete');
  lines.push('');
  lines.push('Generated by Exit OSx Playbook');

  var blob = new Blob([lines.join('\n')], { type: 'text/plain' });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'owner-dependency-results.txt';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Results exported');
}

/* ── Event delegation ── */
document.addEventListener('click', function(e) {
  var target = e.target.closest('[data-action]');
  if (!target) return;
  var action = target.dataset.action;

  if (action === 'next') { nextPage(); return; }
  if (action === 'prev') { prevPage(); return; }
  if (action === 'export') { exportResults(); return; }
  if (action === 'reset') {
    if (confirm('This will clear all your data. Are you sure?')) {
      localStorage.removeItem(STORAGE_KEY);
      state = JSON.parse(JSON.stringify(defaultState));
      goToPage('welcome');
    }
    return;
  }

  if (action === 'set-dep-score') {
    var idx = parseInt(target.dataset.index);
    var score = parseInt(target.dataset.score);
    state.depScores[idx] = score;
    saveState(); renderPage(); updateSidebarScore();
    return;
  }

  if (action === 'add-func') {
    state.functions.push({ name: '', type: 'Relationship', hours: '', recipient: '', transferred: false });
    saveState(); renderPage();
    return;
  }

  if (action === 'remove-func') {
    var fi = parseInt(target.dataset.index);
    state.functions.splice(fi, 1);
    saveState(); renderPage();
    return;
  }

  if (action === 'toggle-delegation') {
    var did = target.dataset.id;
    var dIdx = state.delegationOrder.indexOf(did);
    if (dIdx >= 0) state.delegationOrder.splice(dIdx, 1);
    else state.delegationOrder.push(did);
    saveState(); renderPage();
    return;
  }

  if (action === 'set-authority') {
    state.authority[target.dataset.decision] = target.dataset.level;
    saveState(); renderPage();
    return;
  }

  if (action === 'toggle-doc') {
    var docId = target.dataset.id;
    var docIdx = state.docChecklist.indexOf(docId);
    if (docIdx >= 0) state.docChecklist.splice(docIdx, 1);
    else state.docChecklist.push(docId);
    saveState(); renderPage();
    return;
  }

  if (action === 'toggle-mistake') {
    var mi = parseInt(target.dataset.index);
    var mIdx = state.mistakeChecks.indexOf(mi);
    if (mIdx >= 0) state.mistakeChecks.splice(mIdx, 1);
    else state.mistakeChecks.push(mi);
    saveState(); renderPage();
    return;
  }

  if (action === 'toggle-milestone') {
    var mli = parseInt(target.dataset.index);
    var mlIdx = state.milestones.indexOf(mli);
    if (mlIdx >= 0) state.milestones.splice(mlIdx, 1);
    else state.milestones.push(mli);
    saveState(); renderPage();
    return;
  }
});

document.addEventListener('keydown', function(e) {
  var target = e.target.closest('[data-action]');
  if (!target) return;
  if (e.key === 'Enter' || e.key === ' ') {
    var action = target.dataset.action;
    if (action === 'set-dep-score' || action === 'toggle-delegation' || action === 'toggle-doc'
        || action === 'toggle-mistake' || action === 'toggle-milestone' || action === 'set-authority') {
      e.preventDefault();
      target.click();
    }
  }
});

/* Input bindings */
document.addEventListener('input', function(e) {
  var bind = e.target.dataset.bind;
  if (!bind) return;

  if (bind === 'processNotes') { state.processNotes = e.target.value; saveState(); return; }

  if (bind === 'func-name') { state.functions[parseInt(e.target.dataset.index)].name = e.target.value; saveState(); return; }
  if (bind === 'func-hours') { state.functions[parseInt(e.target.dataset.index)].hours = e.target.value; saveState(); return; }
  if (bind === 'func-recipient') { state.functions[parseInt(e.target.dataset.index)].recipient = e.target.value; saveState(); return; }

  if (bind === 'absence-note') { state.absenceNotes[e.target.dataset.key] = e.target.value; saveState(); return; }
});

document.addEventListener('change', function(e) {
  var bind = e.target.dataset.bind;
  if (!bind) return;

  if (bind === 'func-type') { state.functions[parseInt(e.target.dataset.index)].type = e.target.value; saveState(); return; }
  if (bind === 'absence-status') { state.absenceTests[e.target.dataset.key] = e.target.value; saveState(); return; }
});

/* Nav click delegation */
document.getElementById('sidebarNav').addEventListener('click', function(e) {
  var item = e.target.closest('.nav-item');
  if (item && !item.classList.contains('locked')) {
    goToPage(item.dataset.page);
  }
});
document.getElementById('sidebarNav').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    var item = e.target.closest('.nav-item');
    if (item && !item.classList.contains('locked')) {
      goToPage(item.dataset.page);
    }
  }
});

/* ── Public API ── */
window.PB = { goToPage: goToPage, toggleSidebar: toggleSidebar };

/* ── Init ── */
renderNav();
renderPage();

})();
</script>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('embedded') === 'true') {
    // Hide playbook's own chrome
    var sidebar = document.querySelector('.sidebar');
    var overlay = document.querySelector('.sidebar-overlay');
    var mobileHeader = document.querySelector('.mobile-header');
    var mainContent = document.querySelector('.main-content');
    if (sidebar) sidebar.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    if (mobileHeader) mobileHeader.style.display = 'none';
    if (mainContent) {
      mainContent.style.marginLeft = '0';
      mainContent.style.minHeight = 'auto';
    }

    // Navigate to specific section if requested
    var section = params.get('section');
    if (section !== null) {
      var sectionIndex = parseInt(section, 10);
      if (typeof navigateToSection === 'function') {
        setTimeout(function() { navigateToSection(sectionIndex); }, 100);
      }
    }

    // Forward score updates to parent
    var origDispatch = window.dispatchEvent.bind(window);
    window.addEventListener('playbook:score-update', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:score-update',
          detail: e.detail
        }, '*');
      }
    });

    // Forward section changes to parent
    window.addEventListener('playbook:section-change', function(e) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'playbook:section-change',
          detail: e.detail
        }, '*');
      }
    });

    // Listen for commands from parent
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'navigate-section') {
        if (typeof navigateToSection === 'function') {
          navigateToSection(e.data.sectionIndex);
        }
      }
    });
  }
})();
</script>
</body>
</html>
